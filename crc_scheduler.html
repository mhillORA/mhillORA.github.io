<!DOCTYPE html>
<html lang="en" class="">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CRC Scheduler - N.A.S.A.</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			darkMode: 'class',
		}
	</script>
	<script src="https://unpkg.com/lucide@latest"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
		body { font-family: 'Inter', sans-serif; }
		.crc-calendar-grid {
			display: grid;
			grid-template-columns: repeat(7, minmax(0, 1fr));
			gap: 1px;
		}
		.crc-calendar-day {
			min-height: 120px;
			position: relative;
			padding: 28px 4px 4px 4px;
			cursor: pointer;
		}
		.day-number {
			position: absolute;
			top: 4px;
			right: 4px;
			font-size: 0.875rem;
		}
		.crc-event-tag {
			font-size: 0.75rem;
			padding: 2px 6px;
			border-radius: 4px;
			color: white;
			margin-bottom: 4px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			display: block;
		}
		.more-events-btn {
			font-size: 0.75rem;
			text-align: center;
			padding: 2px;
			color: #3b82f6; /* blue-500 */
			background-color: #eff6ff; /* blue-50 */
			border-radius: 4px;
			margin-top: 4px;
		}
		.dark .more-events-btn {
			color: #60a5fa; /* blue-400 */
			background-color: #1e293b; /* slate-800 */
		}
		.custom-scrollbar::-webkit-scrollbar {
			width: 6px;
			height: 6px;
		}
		.custom-scrollbar::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 10px;
		}
		.dark .custom-scrollbar::-webkit-scrollbar-track {
			background: #374151;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb {
			background: #888;
			border-radius: 10px;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb:hover {
			background: #555;
		}
		.add-event-btn {
			position: absolute;
			top: 4px;
			left: 4px;
			opacity: 0;
			transition: opacity 0.2s;
			cursor: pointer;
			z-index: 10;
		}
		.crc-calendar-day:hover .add-event-btn {
			opacity: 1;
		}
		.unavailability-calendar-day {
			min-height: 80px;
			position: relative;
			padding: 4px;
			cursor: pointer;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}
		.unavailability-day-number {
			font-size: 0.875rem;
			align-self: flex-end;
		}
		.unavailability-status {
			font-size: 0.75rem;
			font-weight: 500;
			text-align: center;
			padding: 4px;
			border-radius: 4px;
		}
		/* Styles for Global View */
		.global-view-header {
			padding: 8px;
			text-align: center;
			font-size: 0.8rem;
		}
		.global-view-study-header {
			text-align: left;
			font-weight: bold;
			font-size: 1rem;
			background-color: #e5e7eb; /* gray-200 */
		}
		.dark .global-view-study-header {
			background-color: #374151; /* gray-700 */
		}
		.global-view-site-header {
			text-align: left;
			font-weight: bold;
			position: sticky;
			left: 0;
			z-index: 10;
		}
		.global-view-cell {
			min-height: 80px;
			overflow-y: auto;
            border-left: 1px solid #e5e7eb; /* gray-200 */
		}
        .dark .global-view-cell {
            border-left: 1px solid #374151; /* gray-700 */
        }
		.global-view-event {
			font-size: 0.7rem;
			padding: 3px;
			border-radius: 3px;
			margin-bottom: 3px;
			text-align: left;
			line-height: 1.2;
		}
		@media print {
			body * {
				visibility: hidden;
			}
			#print-area, #print-area * {
				visibility: visible;
			}
			#print-area {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
			}
		}
	</style>
	<script>
		// Apply theme as early as possible to prevent Flash of Unstyled Content (FOUC)
		(function() {
			const savedTheme = localStorage.getItem('theme');
			if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
				document.documentElement.classList.add('dark');
			} else {
				document.documentElement.classList.remove('dark');
			}
		})();
	</script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
	<div id="loading-overlay" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-[100] flex items-center justify-center">
		<div class="text-center p-4">
			<div class="flex items-center justify-center space-x-2">
				<svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
					<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
					<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
				</svg>
				<span id="loading-message" class="text-xl font-medium text-gray-700 dark:text-gray-300">Loading Scheduler...</span>
			</div>
			<p id="loading-error" class="mt-4 text-red-500 max-w-lg mx-auto"></p>
		</div>
	</div>
	<div class="p-4 sm:p-8">
		<div class="flex flex-wrap justify-between items-center mb-6 gap-4">
			<h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">CRC Scheduler</h2>
			<div class="flex items-center space-x-2 sm:space-x-4">
				<button data-action="manage-unavailability" class="bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 transition-colors flex items-center">
					<i data-lucide="calendar-off" class="w-4 h-4 mr-2"></i>Unavailable
				</button>
				<button data-action="view-availability" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition-colors flex items-center">
					<i data-lucide="calendar-check" class="w-4 h-4 mr-2"></i>Availability
				</button>
				<button data-action="auto-create-shift" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors flex items-center">
					<i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Create Shift
				</button>
				<button data-action="import-csv-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center">
					<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Import
				</button>
				<input type="file" id="csv-upload-input" class="hidden" accept=".csv">
				<button data-action="export-csv-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors flex items-center">
					<i data-lucide="download" class="w-4 h-4 mr-2"></i>Export
				</button>
				<button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
					<i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
					<i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
				</button>
				<button data-action="open-settings" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
					<i data-lucide="settings" class="w-5 h-5"></i>
				</button>
				<a href="index.html" id="back-to-dashboard" class="text-blue-600 dark:text-blue-400 hover:underline flex items-center">
					<i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
					Dashboard
				</a>
			</div>
		</div>
		<div id="main-nav-tabs" class="border-b dark:border-gray-700 mb-6"></div>
		<div id="main-app-content">
		</div>
	</div>

	<div id="modal-container" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex justify-center items-center p-4"></div>
	
	<script>
		// This callback is required by the Google Maps script but we will initialize our autocompletes manually
		function initAutocomplete() {}
	</script>
	<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initAutocomplete"></script>

	<script type="module">
		// --- WRAP ENTIRE SCRIPT IN AN ASYNC IIFE TO ALLOW TOP-LEVEL AWAIT and RETURN ---
		(async () => {
			// Firebase Imports
			const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
			const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
			const { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, writeBatch, query, where } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

			// User-provided Firebase configuration
			const firebaseConfig = {
				apiKey: "AIzaSyBiXVUUzeLT3mae0N6sdjICdevmRicdk5g",
				authDomain: "nasa2-0.firebaseapp.com",
				projectId: "nasa2-0",
				storageBucket: "nasa2-0.appspot.com",
				messagingSenderId: "735088252433",
				appId: "1:735088252433:web:1b6733520226e27f5843b0",
				measurementId: "G-SNHQZXKCL4"
			};

			const appId = typeof __app_id !== 'undefined' ? __app_id : 'crc-scheduler-app';
			const loadingOverlay = document.getElementById('loading-overlay');
			const loadingMessage = document.getElementById('loading-message');
			const loadingError = document.getElementById('loading-error');
			
			if (!firebaseConfig.apiKey) {
				loadingMessage.textContent = 'Configuration Error';
				loadingError.innerHTML = `<strong>Action Required:</strong> Please provide your Firebase configuration object in the script.`;
				return;
			}

			// Initialize Firebase
			const app = initializeApp(firebaseConfig);
			const db = getFirestore(app);
			const auth = getAuth(app);

			// --- STATE MANAGEMENT ---
			let state = {
				authReady: false,
				userId: null,
				crcCalendarDate: new Date(),
				unavailabilityDate: new Date(),
				selectedCrcForUnavailability: null,
				calendarView: 'global', // 'month', 'week', or 'global'
				calendarDisplayMode: 'employee', // 'employee', 'study', 'site', 'at-a-glance'
				atAGlanceGroupBy: 'study', // 'study' or 'site'
				activeTab: 'scheduler', // 'scheduler', 'reporting'
				sidebarTab: 'crcs',
				crcs: [],
				crc_sites: [],
				studies: [],
				crc_events: [],
				crcStats: {},
				settings: {
					'Site Assignment': 8,
					'Travel Day': 8,
					'Paid Time Off': 8,
					'Unavailable': 8,
					'Open Shift': 8,
				},
				selectedCrcFilter: 'all',
				selectedSiteFilter: 'all',
				selectedRegionFilter: 'all',
				initialLoadComplete: false,
			};

			// --- Temporary storage for event data during confirmation modals ---
			let tempEventData = {};

			const modalContainer = document.getElementById('modal-container');
			const mainAppContent = document.getElementById('main-app-content');

			// --- HELPER FUNCTIONS ---
			/** * Gets the day of the week with Saturday as the starting day (0).
			 * @param {Date} date - The date to check.
			 * @returns {number} - 0 for Saturday, 1 for Sunday, ..., 6 for Friday.
			 */
			const getDaySaturdayStart = (date) => {
				const day = date.getDay();
				return (day + 1) % 7; // Saturday = 0, Sunday = 1, ..., Friday = 6
			};

			const getAllRoles = () => {
				const roles = new Set(['Lead', 'Support', 'Trainee', 'Phlebotomist', 'Coordinator']);
				state.crc_events.forEach(event => {
					(event.roles || []).forEach(role => roles.add(role));
				});
				return Array.from(roles).sort();
			};

			// --- CALCULATION FUNCTIONS ---
			const calculateAllCrcStats = () => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();
				const daysInMonth = new Date(year, month + 1, 0).getDate();

				let totalWorkingDaysInMonth = 0;
				for (let day = 1; day <= daysInMonth; day++) {
					const dayOfWeek = new Date(year, month, day).getDay();
					if (dayOfWeek > 0 && dayOfWeek < 6) { // Monday to Friday
						totalWorkingDaysInMonth++;
					}
				}

				const stats = {};
				state.crcs.forEach(crc => {
					const eventsThisMonth = state.crc_events.filter(e => {
						const eventDate = new Date(e.date + 'T00:00:00');
						return e.crcId === crc.id && eventDate.getFullYear() === year && eventDate.getMonth() === month;
					});
					
					const productiveEventTypes = ['Site Assignment', 'Travel Day'];
					const nonWorkEventTypes = ['Paid Time Off', 'Unavailable'];

					// Use a Set to count unique days for productive and non-work events
					const productiveDays = new Set(
						eventsThisMonth
							.filter(e => productiveEventTypes.includes(e.type))
							.map(e => e.date)
					).size;
					
					const nonWorkDays = new Set(
						eventsThisMonth
							.filter(e => nonWorkEventTypes.includes(e.type))
							.map(e => e.date)
					).size;

					const crcAvailableWorkDays = totalWorkingDaysInMonth - nonWorkDays;
					
					const utilizationPercent = crcAvailableWorkDays > 0 ? Math.round((productiveDays / crcAvailableWorkDays) * 100) : 0;

					stats[crc.id] = {
						productiveDays,
						travelDays: eventsThisMonth.filter(e => e.type === 'Travel Day').length,
						ptoDays: eventsThisMonth.filter(e => e.type === 'Paid Time Off').length,
						unavailableDays: eventsThisMonth.filter(e => e.type === 'Unavailable').length,
						utilizationPercent
					};
				});
				return stats;
			};

			const calculateWeeklyUtilization = (dateInWeek) => {
				const dayOfWeek = getDaySaturdayStart(dateInWeek); // Saturday is 0
				const startOfWeek = new Date(dateInWeek);
				startOfWeek.setDate(dateInWeek.getDate() - dayOfWeek);
				startOfWeek.setHours(0, 0, 0, 0);

				const endOfWeek = new Date(startOfWeek);
				endOfWeek.setDate(startOfWeek.getDate() + 6);
				endOfWeek.setHours(23, 59, 59, 999);

				const stats = {};
				state.crcs.forEach(crc => {
					const eventsThisWeek = state.crc_events.filter(e => {
						const eventDate = new Date(e.date + 'T12:00:00');
						return e.crcId === crc.id && eventDate >= startOfWeek && eventDate <= endOfWeek;
					});
					const totalHours = eventsThisWeek.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
					stats[crc.id] = {
						totalHours,
						utilizationPercent: Math.round((totalHours / 40) * 100)
					};
				});
				return stats;
			};

			/// --- CORE FUNCTIONS ---
			const setState = (newState) => {
				const oldDate = state.crcCalendarDate.getTime();
				state = { ...state, ...newState };
				const newDate = state.crcCalendarDate.getTime();

				if (newState.crc_events || newState.crcs || oldDate !== newDate) {
					state.crcStats = calculateAllCrcStats();
				}

				if (state.authReady && state.initialLoadComplete) {
					window.requestAnimationFrame(() => {
						render();
						loadingOverlay.style.display = 'none';
					});
				}
			};

			const render = () => {
				renderNav();
				renderContent();
				lucide.createIcons();
			};

			const renderNav = () => {
				const container = document.getElementById('main-nav-tabs');
				if (!container) return;
				container.innerHTML = `
					<nav class="-mb-px flex space-x-6" aria-label="Tabs">
						<button data-action="set-main-tab" data-tab-id="scheduler" class="${state.activeTab === 'scheduler' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-500'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Scheduler</button>
						<button data-action="set-main-tab" data-tab-id="reporting" class="${state.activeTab === 'reporting' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-500'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Reporting</button>
					</nav>
				`;
			};

			const renderContent = () => {
				if (state.activeTab === 'scheduler') {
					mainAppContent.innerHTML = getSchedulerHTML();
					mainAppContent.className = 'flex flex-col lg:flex-row gap-8';
					renderSupervisorFilters();
					renderCRCCalendar();
					renderSidebarTabs();
					renderCRCLists();
					renderUtilization();
				} else if (state.activeTab === 'reporting') {
					mainAppContent.innerHTML = getReportingHTML();
					mainAppContent.className = '';
				}
			};

			// --- NOTIFICATION & MODAL HANDLING ---
			const showNotification = (message, type = 'info') => {
				const colors = {
					info: 'bg-blue-500',
					success: 'bg-green-500',
					error: 'bg-red-500',
				};
				const notification = document.createElement('div');
				notification.className = `fixed bottom-5 right-5 ${colors[type]} text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[101]`;
				notification.textContent = message;

				document.body.appendChild(notification);

				setTimeout(() => {
					notification.classList.remove('translate-y-20', 'opacity-0');
				}, 10);

				setTimeout(() => {
					notification.classList.add('translate-y-20', 'opacity-0');
					setTimeout(() => notification.remove(), 4000);
				}, 4000);
			};

			const openModal = (content, size = 'lg') => {
				const sizeClasses = {
					'lg': 'max-w-lg',
					'4xl': 'max-w-4xl',
					'7xl': 'max-w-7xl'
				};
				const maxWidthClass = sizeClasses[size] || sizeClasses['lg'];
				modalContainer.innerHTML = `
					<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full ${maxWidthClass} relative transform transition-all scale-95 opacity-0 animate-fade-in-up">
						<div class="modal-content overflow-y-auto max-h-[85vh] custom-scrollbar pr-4">
							${content}
						</div>
						<button data-action="close-modal" class="absolute top-3 right-3 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white rounded-full p-1 hover:bg-gray-200 dark:hover:bg-gray-700">
							<i data-lucide="x" class="w-5 h-5"></i>
						</button>
					</div>
					<style>
						@keyframes fade-in-up {
							from { transform: translateY(20px) scale(0.95); opacity: 0; }
							to { transform: translateY(0) scale(1); opacity: 1; }
						}
						.animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
					</style>
				`;
				modalContainer.classList.remove('hidden');
				lucide.createIcons();

				if (modalContainer.querySelector('#crc-event-form')) {
					const form = modalContainer.querySelector('#crc-event-form');
					const startDateInput = form.querySelector('input[name="startDate"]');
					const endDateInput = form.querySelector('input[name="endDate"]');
					const crcSelect = form.querySelector('select[name="crcId"]');
					const periodSelect = form.querySelector('select[name="period"]');
					const studySelect = form.querySelector('select[name="studyIds"]');
					
					updateCrcDropdownAvailability();
					if (form.dataset.eventId && crcSelect.value) {
						updateCrcHoursDisplay(crcSelect.value, startDateInput.value);
					}

					if(startDateInput) startDateInput.addEventListener('change', updateCrcDropdownAvailability);
					if(endDateInput) endDateInput.addEventListener('change', updateCrcDropdownAvailability);
					if(crcSelect) crcSelect.addEventListener('change', (e) => updateCrcHoursDisplay(e.target.value, startDateInput.value));
					if(periodSelect) periodSelect.addEventListener('change', updateCrcDropdownAvailability);
					if(studySelect) studySelect.addEventListener('change', updateSiteDropdownForStudies);
				}
				
				if (modalContainer.querySelector('#unavailability-calendar-container')) {
					renderUnavailabilityCalendar();
				}

				const printButton = modalContainer.querySelector('[data-action="print-report"]');
				if (printButton) {
					printButton.addEventListener('click', () => window.print());
				}
			};

			const closeModal = () => {
				modalContainer.classList.add('hidden');
				modalContainer.innerHTML = '';
			};

			// --- CSV HANDLING ---
			const parseCSV = (text) => {
				const lines = text.replace(/\r/g, '').split('\n').filter(Boolean);
				if (lines.length < 2) return { headers: [], data: [] };
				const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));
				const data = [];
				for (let i = 1; i < lines.length; i++) {
					const values = lines[i].split(',');
					const rowObject = {};
					headers.forEach((header, index) => {
						rowObject[header] = (values[index] || '').trim();
					});
					data.push(rowObject);
				}
				return { headers, data };
			};

			const handleCsvUpload = async (file, uploadType = 'shifts') => {
				if (!file) return;

				openModal(`
					<div class="text-center p-4">
						<h3 class="text-xl font-semibold mb-4 dark:text-white">Processing CSV...</h3>
						<div class="flex items-center justify-center space-x-2">
							<svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
								<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
								<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
							</svg>
							<p class="dark:text-gray-300">Reading file and preparing data. Please wait.</p>
						</div>
					</div>
				`);

				const reader = new FileReader();
				reader.onload = async (e) => {
					const text = e.target.result;
					const { headers, data } = parseCSV(text);

					if (uploadType === 'crcs') {
						await importCRCs(headers, data);
					} else {
						await importShifts(headers, data);
					}
				};
				reader.onerror = () => {
					openModal(`<h3 class="text-xl font-bold dark:text-white">Import Error</h3><p class="dark:text-gray-300">Could not read the selected file.</p>`);
				};
				reader.readAsText(file);
			};

			const importCRCs = async (headers, data) => {
				const requiredHeaders = ['CRCName', 'HomeLocation'];
				const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
				if (missingHeaders.length > 0) {
					openModal(`<h3 class="text-xl font-bold dark:text-white">Import Error</h3><p class="dark:text-gray-300">CRC CSV file is missing required headers. It must contain: ${missingHeaders.join(', ')}</p>`);
					return;
				}

				const batch = writeBatch(db);
				const crcsRef = collection(db, `artifacts/${appId}/public/data/crcs`);
				const errors = [];
				let successCount = 0;

				for (const [index, row] of data.entries()) {
					const rowNum = index + 2;
					const { CRCName, HomeLocation, Region } = row;

					if (!CRCName || !HomeLocation) {
						errors.push(`Row ${rowNum}: Missing required value for CRCName or HomeLocation.`);
						continue;
					}

					const crcData = {
						name: CRCName.trim(),
						homeLocation: HomeLocation.trim(),
						region: (Region || '').trim(),
						trainings: [],
						capabilities: [],
						trainingLevel: ''
					};
					
					const newCrcRef = doc(crcsRef);
					batch.set(newCrcRef, crcData);
					successCount++;
				}

				if (errors.length > 0) {
					const errorList = errors.map(err => `<li>${err}</li>`).join('');
					openModal(`
						<h3 class="text-xl font-bold text-red-500">Import Complete with Errors</h3>
						<p class="my-2 dark:text-gray-300">Successfully prepared <strong>${successCount}</strong> CRCs to be created.</p>
						<p class="my-2 dark:text-gray-300">The following ${errors.length} rows could not be imported:</p>
						<ul class="list-disc list-inside bg-red-100 dark:bg-red-900/50 p-4 rounded-md text-sm max-h-60 overflow-y-auto custom-scrollbar">
							${errorList}
						</ul>
						<div class="mt-6 text-right">
							<button data-action="close-modal" class="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Close</button>
						</div>
					`, 'lg');
				}
				
				if (successCount > 0) {
					await batch.commit();
					if (errors.length === 0) {
						closeModal();
						showNotification(`${successCount} CRCs imported successfully!`, 'success');
					}
				} else if (errors.length === 0) {
					closeModal();
					showNotification('No new CRCs found in the CSV file.', 'info');
				}
			};

			const importShifts = async (headers, data) => {
					const requiredHeaders = ['Date', 'EventType'];
					const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
					if (missingHeaders.length > 0) {
						openModal(`<h3 class="text-xl font-bold dark:text-white">Import Error</h3><p class="dark:text-gray-300">CSV file is missing required headers. It must contain: ${missingHeaders.join(', ')}</p>`);
						return;
					}

					const batch = writeBatch(db);
					const crcEventsRef = collection(db, `artifacts/${appId}/public/data/crc_events`);
					const sitesRef = collection(db, `artifacts/${appId}/public/data/crc_sites`);
					const studiesRef = collection(db, `artifacts/${appId}/public/data/studies`);
					const errors = [];
					let successCount = 0;

					// Create local maps for efficient lookup during the import process
					const crcMap = new Map(state.crcs.map(c => [c.name.toLowerCase(), c.id]));
					const siteMap = new Map(state.crc_sites.map(s => [s.name.toLowerCase(), s.id]));
					const studyMap = new Map(state.studies.map(s => [s.name.toLowerCase(), s.id]));

					for (const [index, row] of data.entries()) {
						const rowNum = index + 2;
						const { Date: date, EventType, CRCName, SiteName, StudyName, Roles, Notes, Hours, Period, VisitNumber, PrincipalInvestigator, Mileage } = row;

						if (!date || !EventType) {
							errors.push(`Row ${rowNum}: Missing required value for Date or EventType.`);
							continue;
						}
						if (isNaN(new Date(date).getTime())) {
							errors.push(`Row ${rowNum}: Invalid date format for "${date}". Please use YYYY-MM-DD.`);
							continue;
						}

						const eventData = {
							date: date.trim(),
							type: EventType.trim(),
							notes: (Notes || '').trim(),
							roles: Roles ? Roles.split(';').map(r => r.trim()) : [],
							hours: Hours ? parseFloat(Hours) : (state.settings[EventType.trim()] || 8),
							period: (Period || 'Full Day'),
							visitNumber: VisitNumber || null,
							principalInvestigator: PrincipalInvestigator || null,
							mileage: Mileage ? parseFloat(Mileage) : null,
							isOverridden: false,
							groupId: crypto.randomUUID(),
							crcId: null, siteId: null, studyIds: [],
						};
						
						let hasError = false;

						// CRC validation (CRCs must exist)
						if (EventType !== 'Open Shift' && !CRCName) {
							errors.push(`Row ${rowNum}: CRCName is required for EventType "${EventType}".`);
							hasError = true;
						}
						if (CRCName) {
							const crcId = crcMap.get(CRCName.toLowerCase());
							if (crcId) {
								eventData.crcId = crcId;
							} else {
								errors.push(`Row ${rowNum}: CRC "${CRCName}" not found.`);
								hasError = true;
							}
						}

						// Site handling (auto-create if not found)
						if (SiteName) {
							const siteNameTrimmed = SiteName.trim();
							const siteNameLower = siteNameTrimmed.toLowerCase();
							let siteId = siteMap.get(siteNameLower);
							if (!siteId) {
								const newSiteDoc = await addDoc(sitesRef, { name: siteNameTrimmed });
								siteId = newSiteDoc.id;
								siteMap.set(siteNameLower, siteId);
							}
							eventData.siteId = siteId;
						}
						
						// Study handling (auto-create if not found)
						if (StudyName) {
							const studyNames = StudyName.split(';').map(s => s.trim()).filter(Boolean);
							const studyIds = [];
							for (const sName of studyNames) {
								const sNameLower = sName.toLowerCase();
								let studyId = studyMap.get(sNameLower);
								if (!studyId) {
									const newStudyDoc = await addDoc(studiesRef, { name: sName });
									studyId = newStudyDoc.id;
									studyMap.set(sNameLower, studyId);
								}
								studyIds.push(studyId);
							}
							if (studyIds.length > 0) eventData.studyIds = studyIds;
						}


						if (!hasError) {
							const newEventRef = doc(crcEventsRef);
							batch.set(newEventRef, eventData);
							successCount++;
						}
					}

					if (errors.length > 0) {
						const errorList = errors.map(err => `<li>${err}</li>`).join('');
						openModal(`
							<h3 class="text-xl font-bold text-red-500">Import Complete with Errors</h3>
							<p class="my-2 dark:text-gray-300">Successfully prepared <strong>${successCount}</strong> shifts to be created.</p>
							<p class="my-2 dark:text-gray-300">The following ${errors.length} rows could not be imported:</p>
							<ul class="list-disc list-inside bg-red-100 dark:bg-red-900/50 p-4 rounded-md text-sm max-h-60 overflow-y-auto custom-scrollbar">
								${errorList}
							</ul>
							<div class="mt-6 text-right">
								<button data-action="close-modal" class="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Close</button>
							</div>
						`, 'lg');
					}
					
					if (successCount > 0) {
						await batch.commit();
						if (errors.length === 0) {
							closeModal();
							showNotification(`${successCount} shifts imported successfully!`, 'success');
						}
					} else if (errors.length === 0) {
						closeModal();
						showNotification('No new shifts found in the CSV file.', 'info');
					}
			};
			
			const exportCurrentMonthToCSV = () => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();

				const eventsThisMonth = state.crc_events.filter(e => {
					const eventDate = new Date(e.date + "T00:00:00");
					return eventDate.getFullYear() === year && eventDate.getMonth() === month;
				});

				if (eventsThisMonth.length === 0) {
					showNotification('No events in the current month to export.', 'info');
					return;
				}

				const headers = ['Date', 'EventType', 'CRCName', 'SiteName', 'StudyName', 'Roles', 'Hours', 'Period', 'Notes', 'VisitNumber', 'PrincipalInvestigator', 'Mileage'];
				const rows = eventsThisMonth.map(event => {
					const crc = state.crcs.find(c => c.id === event.crcId);
					const site = state.crc_sites.find(s => s.id === event.siteId);
					const studies = (event.studyIds || []).map(id => state.studies.find(s => s.id === id)?.name).filter(Boolean).join('; ');
					return [
						event.date,
						event.type,
						crc ? crc.name : '',
						site ? site.name : '',
						studies,
						(event.roles || []).join('; '),
						event.hours || '',
						event.period || 'Full Day',
						event.notes || '',
						event.visitNumber || '',
						event.principalInvestigator || '',
						event.mileage || ''
					].map(val => `"${(val || '').toString().replace(/"/g, '""')}"`).join(',');
				});

				const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\n');
				const encodedUri = encodeURI(csvContent);
				const link = document.createElement("a");
				link.setAttribute("href", encodedUri);
				const monthName = now.toLocaleString('default', { month: 'long' });
				link.setAttribute("download", `crc_schedule_${year}_${monthName}.csv`);
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			};

			// --- HTML GETTERS ---
			const getSchedulerHTML = () => `
				<aside class="w-full lg:w-1/3 xl:w-1/4 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex flex-col space-y-6">
					<div id="sidebar-tabs-container"></div>
					
					<div class="space-y-3">
						<h3 id="utilization-title" class="text-lg font-semibold text-gray-700 dark:text-gray-300">CRC Utilization</h3>
						<div id="crcUtilization" class="space-y-3 text-sm">
						</div>
					</div>

					<div class="flex-grow flex flex-col min-h-[300px]">
						<h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">CRC Home Locations</h3>
						<div class="flex-grow rounded-lg overflow-hidden border dark:border-gray-700">
							<iframe id="mapFrame" class="w-full h-full" style="border:0;" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade"
								src="">
							</iframe>
						</div>
						<p class="text-xs text-center text-gray-500 dark:text-gray-400 mt-2">Map requires a valid Google Maps Embed API Key.</p>
					</div>
				</aside>

				<div class="w-full lg:w-2/3 xl:w-3/4 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
					<div id="supervisor-filters-container" class="mb-6"></div>
					<div id="crc-calendar-container"></div>
				</div>
			`;

			const getReportingHTML = () => `
				<div class="w-full bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
					<h3 class="text-2xl font-bold mb-4">Reporting</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border dark:border-gray-700 mb-6">
						<div>
							<label for="report-crc-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by CRC</label>
							<select id="report-crc-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All CRCs</option>
								${state.crcs.map(crc => `<option value="${crc.id}">${crc.name}</option>`).join('')}
							</select>
						</div>
						<div>
							<label for="report-site-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Site</label>
							<select id="report-site-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All Sites</option>
								${state.crc_sites.map(site => `<option value="${site.id}">${site.name}</option>`).join('')}
							</select>
						</div>
						<div>
							<label for="report-study-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Study</label>
							<select id="report-study-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All Studies</option>
								${state.studies.map(study => `<option value="${study.id}">${study.name}</option>`).join('')}
							</select>
						</div>
						<div>
							<label for="report-region-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Region</label>
							<select id="report-region-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All Regions</option>
								${[...new Set(state.crcs.map(crc => crc.region).filter(Boolean))].map(region => `<option value="${region}">${region}</option>`).join('')}
							</select>
						</div>
						<div>
							<label for="report-event-type-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Shift (Event Type)</label>
							<select id="report-event-type-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All Shifts</option>
								${['Site Assignment', 'Travel Day', 'Paid Time Off', 'Unavailable', 'Open Shift'].map(type => `<option value="${type}">${type}</option>`).join('')}
							</select>
						</div>
					</div>
					<button data-action="generate-crc-report" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Generate Report</button>
					<div id="report-results-container" class="mt-6"></div>
				</div>
			`;

			// --- SUPERVISOR & CALENDAR RENDERING ---
			const renderSupervisorFilters = () => {
				const container = document.getElementById('supervisor-filters-container');
				if (!container) return;

				const crcOptions = state.crcs.map(crc => `<option value="${crc.id}">${crc.name}</option>`).join('');
				const siteOptions = state.crc_sites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
				const regions = [...new Set(state.crcs.map(crc => crc.region).filter(Boolean))];
				const regionOptions = regions.map(region => `<option value="${region}">${region}</option>`).join('');

				container.innerHTML = `
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border dark:border-gray-700">
						<div>
							<label for="crc-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by CRC</label>
							<select id="crc-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All CRCs</option>
								${crcOptions}
							</select>
						</div>
						<div>
							<label for="site-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Site</label>
							<select id="site-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All Sites</option>
								${siteOptions}
							</select>
						</div>
						<div>
							<label for="region-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter by Region</label>
							<select id="region-filter" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
								<option value="all">All Regions</option>
								${regionOptions}
							</select>
						</div>
					</div>
				`;
				document.getElementById('crc-filter').value = state.selectedCrcFilter;
				document.getElementById('site-filter').value = state.selectedSiteFilter;
				document.getElementById('region-filter').value = state.selectedRegionFilter;
			};
			
			const renderCRCCalendar = () => {
				const container = document.getElementById('crc-calendar-container');
				if (!container) return;

				if (state.calendarView === 'month') {
					if (state.calendarDisplayMode === 'study') {
						container.innerHTML = getStudyCalendarHTML();
					} else if (state.calendarDisplayMode === 'site') {
						container.innerHTML = getSiteCalendarHTML();
					} else {
						container.innerHTML = getMonthlyCalendarHTML();
					}
				} else if (state.calendarView === 'week') {
					container.innerHTML = getWeeklyCalendarHTML();
				} else if (state.calendarView === 'global') {
					if (state.calendarDisplayMode === 'at-a-glance') {
						container.innerHTML = getAtAGlanceViewHTML(state.atAGlanceGroupBy);
					} else {
						container.innerHTML = getGlobalViewDetailedHTML();
					}
				}
			};

			const getCalendarHeaderHTML = () => {
				const now = state.crcCalendarDate;
				const monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });
				const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - getDaySaturdayStart(now));
				const weekName = `Week of ${startOfWeek.toLocaleDateString('en-US', {month: 'long', day: 'numeric'})}`;
				
				let title;
				if (state.calendarView === 'week') title = weekName;
				else if (state.calendarView === 'global') title = `Global View - ${monthName}`;
				else title = monthName;
				
				const prevAction = state.calendarView === 'week' ? 'prev-crc-week' : 'prev-crc-month';
				const nextAction = state.calendarView === 'week' ? 'next-crc-week' : 'next-crc-month';

				// Conditional toggle for the "At-a-Glance" view
				let atAGlanceToggle = '';
				if (state.calendarView === 'global' && state.calendarDisplayMode === 'at-a-glance') {
					atAGlanceToggle = `
						<div class="flex items-center rounded-md border dark:border-gray-600 ml-4">
							<span class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300">Group By:</span>
							<button data-action="set-at-a-glance-group" data-group="study" class="px-3 py-1 text-sm ${state.atAGlanceGroupBy === 'study' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'}">Study</button>
							<button data-action="set-at-a-glance-group" data-group="site" class="px-3 py-1 text-sm ${state.atAGlanceGroupBy === 'site' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'}">Site</button>
						</div>
					`;
				}

				return `
					<div class="flex flex-wrap justify-between items-center mb-4 gap-2">
						<div class="flex items-center gap-4">
							<h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">${title}</h3>
							<div class="flex items-center rounded-md border dark:border-gray-600">
								<button data-action="set-display-mode" data-mode="employee" class="px-3 py-1 text-sm ${state.calendarDisplayMode === 'employee' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'} rounded-l-md">Employee</button>
								<button data-action="set-display-mode" data-mode="study" class="px-3 py-1 text-sm ${state.calendarDisplayMode === 'study' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'}">Study</button>
								<button data-action="set-display-mode" data-mode="site" class="px-3 py-1 text-sm ${state.calendarDisplayMode === 'site' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'}">Site</button>
								<button data-action="set-display-mode" data-mode="at-a-glance" class="px-3 py-1 text-sm ${state.calendarDisplayMode === 'at-a-glance' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'} rounded-r-md">At-a-Glance</button>
							</div>
							${atAGlanceToggle}
						</div>
						<div class="flex items-center space-x-2">
							<div class="flex items-center rounded-md border dark:border-gray-600">
								<button data-action="set-view" data-view="global" class="px-3 py-1 text-sm ${state.calendarView === 'global' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'} rounded-l-md">Global</button>
								<button data-action="set-view" data-view="month" class="px-3 py-1 text-sm ${state.calendarView === 'month' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'}">Month</button>
								<button data-action="set-view" data-view="week" class="px-3 py-1 text-sm ${state.calendarView === 'week' ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700'} rounded-r-md">Week</button>
							</div>
							<button data-action="${prevAction}" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
							<button data-action="${nextAction}" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
						</div>
					</div>
				`;
			};

			const getGenericCalendarHTML = (groupBy) => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();

				let collection, color, idField;
				if(groupBy === 'study') {
					collection = state.studies;
					idField = 'studyIds';
					color = 'bg-green-500';
				} else {
					collection = state.crc_sites;
					idField = 'siteId';
					color = 'bg-cyan-500';
				}

				const firstDayOfMonth = getDaySaturdayStart(new Date(year, month, 1));
				const daysInMonth = new Date(year, month + 1, 0).getDate();

				let dayGrid = '<div class="crc-calendar-grid bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">';
				const weekdays = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
				dayGrid += weekdays.map(day => `<div class="text-center font-medium text-sm py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400">${day}</div>`).join('');

				for (let i = 0; i < firstDayOfMonth; i++) {
					dayGrid += '<div class="bg-gray-50 dark:bg-gray-800/50"></div>';
				}

				for (let day = 1; day <= daysInMonth; day++) {
					const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
					const dayClass = isToday ? 'bg-blue-50 dark:bg-blue-900/30' : 'bg-white dark:bg-gray-800';
					
					const todaysEvents = state.crc_events.filter(e => e.date === dateStr);
					let uniqueIds;
					if (idField === 'studyIds') {
						uniqueIds = [...new Set(todaysEvents.flatMap(e => e.studyIds || []))];
					} else {
						uniqueIds = [...new Set(todaysEvents.map(e => e.siteId).filter(Boolean))];
					}

					let eventTags = uniqueIds.slice(0, 3).map(id => {
						const item = collection.find(s => s.id === id);
						return item ? `<div class="crc-event-tag ${color}">${item.name}</div>` : '';
					}).join('');

					if (uniqueIds.length > 3) {
						eventTags += `<div class="more-events-btn" data-action="view-day-events" data-date="${dateStr}">+${uniqueIds.length - 3} more</div>`;
					}

					dayGrid += `
						<div class="crc-calendar-day ${dayClass}" data-action="view-day-events" data-date="${dateStr}">
							<span class="day-number text-gray-500 dark:text-gray-400 ${isToday ? 'font-bold text-blue-600 dark:text-blue-400' : ''}">${day}</span>
							<button data-action="open-crc-event-modal" data-date="${dateStr}" class="add-event-btn p-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 rounded-full">
								<i data-lucide="plus-circle" class="w-4 h-4"></i>
							</button>
							<div class="mt-1 space-y-1">${eventTags}</div>
						</div>
					`;
				}
				dayGrid += '</div>';
				return getCalendarHeaderHTML() + dayGrid;
			};

			const getStudyCalendarHTML = () => getGenericCalendarHTML('study');
			const getSiteCalendarHTML = () => getGenericCalendarHTML('site');

			const getMonthlyCalendarHTML = () => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();

				let filteredEvents = state.crc_events;
				if (state.selectedCrcFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.crcId === state.selectedCrcFilter);
				}
				if (state.selectedSiteFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.siteId === state.selectedSiteFilter);
				}
				if (state.selectedRegionFilter !== 'all') {
					const crcsInRegion = state.crcs.filter(c => c.region === state.selectedRegionFilter).map(c => c.id);
					filteredEvents = filteredEvents.filter(e => crcsInRegion.includes(e.crcId));
				}
				
				const firstDayOfMonth = getDaySaturdayStart(new Date(year, month, 1));
				const daysInMonth = new Date(year, month + 1, 0).getDate();

				let dayGrid = '<div class="crc-calendar-grid bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">';
				const weekdays = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
				dayGrid += weekdays.map(day => `<div class="text-center font-medium text-sm py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400">${day}</div>`).join('');

				for (let i = 0; i < firstDayOfMonth; i++) {
					dayGrid += '<div class="bg-gray-50 dark:bg-gray-800/50"></div>';
				}

				for (let day = 1; day <= daysInMonth; day++) {
					const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
					const dayClass = isToday ? 'bg-blue-50 dark:bg-blue-900/30' : 'bg-white dark:bg-gray-800';
					
					const todaysEvents = filteredEvents.filter(e => e.date === dateStr);
					let eventTags = todaysEvents.slice(0, 2).map(event => {
						const crc = state.crcs.find(c => c.id === event.crcId);
						const eventColors = { 'Site Assignment': 'bg-blue-500', 'Travel Day': 'bg-orange-500', 'Paid Time Off': 'bg-purple-500', 'Unavailable': 'bg-gray-500', 'Open Shift': 'bg-red-500' };
						let title = crc ? `${crc.name.split(' ')[0]}: ${event.type}` : `Open: ${event.type}`;
						if(event.period && event.period !== 'Full Day') title += ` (${event.period})`;
						if(event.roles && event.roles.length > 0) title += ` (${event.roles.join(', ')})`;
						const overrideIcon = event.isOverridden ? `<i data-lucide="alert-triangle" class="inline-block w-3 h-3 text-yellow-300 ml-1"></i>` : '';
						return `<div data-action="view-crc-event" data-event-id="${event.id}" class="crc-event-tag ${eventColors[event.type] || 'bg-gray-500'}" title="${event.notes || title}">${title}${overrideIcon}</div>`;
					}).join('');

					if (todaysEvents.length > 2) {
						eventTags += `<div class="more-events-btn" data-action="view-day-events" data-date="${dateStr}">+${todaysEvents.length - 2} more</div>`;
					}

					dayGrid += `
						<div class="crc-calendar-day ${dayClass}" data-action="view-day-events" data-date="${dateStr}">
							<span class="day-number text-gray-500 dark:text-gray-400 ${isToday ? 'font-bold text-blue-600 dark:text-blue-400' : ''}">${day}</span>
							<button data-action="open-crc-event-modal" data-date="${dateStr}" class="add-event-btn p-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 rounded-full">
								<i data-lucide="plus-circle" class="w-4 h-4"></i>
							</button>
							<div class="mt-1 space-y-1">${eventTags}</div>
						</div>
					`;
				}
				dayGrid += '</div>';
				return getCalendarHeaderHTML() + dayGrid;
			};
			
			const getWeeklyCalendarHTML = () => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();
				const day = now.getDate();
				const dayOfWeek = getDaySaturdayStart(now);
				const startOfWeek = new Date(year, month, day - dayOfWeek);

				let filteredEvents = state.crc_events;
				if (state.selectedCrcFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.crcId === state.selectedCrcFilter);
				}
				if (state.selectedSiteFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.siteId === state.selectedSiteFilter);
				}
				if (state.selectedRegionFilter !== 'all') {
					const crcsInRegion = state.crcs.filter(c => c.region === state.selectedRegionFilter).map(c => c.id);
					filteredEvents = filteredEvents.filter(e => crcsInRegion.includes(e.crcId));
				}
				const weekdays = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];

				let dayGrid = '<div class="crc-calendar-grid bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">';
				
				let currentDayHeader = new Date(startOfWeek);
				for (let i = 0; i < 7; i++) {
					dayGrid += `<div class="text-center font-medium text-sm py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400">${weekdays[i]} ${currentDayHeader.getDate()}</div>`;
					currentDayHeader.setDate(currentDayHeader.getDate() + 1);
				}
				
				let currentDay = new Date(startOfWeek);
				for (let i = 0; i < 7; i++) {
					const dateStr = currentDay.toISOString().split('T')[0];
					const isToday = new Date().toDateString() === currentDay.toDateString();
					const dayClass = isToday ? 'bg-blue-50 dark:bg-blue-900/30' : 'bg-white dark:bg-gray-800';
					
					const todaysEvents = filteredEvents.filter(e => e.date === dateStr);
					const eventTags = todaysEvents.map(event => {
						const crc = state.crcs.find(c => c.id === event.crcId);
						const eventColors = {
							'Site Assignment': 'bg-blue-500', 'Travel Day': 'bg-orange-500', 'Paid Time Off': 'bg-purple-500', 'Unavailable': 'bg-gray-500', 'Open Shift': 'bg-red-500',
						};
						let title = crc ? `${crc.name.split(' ')[0]}: ${event.type}` : `Open: ${event.type}`;
						if(event.period && event.period !== 'Full Day') title += ` (${event.period})`;
						if(event.roles && event.roles.length > 0) title += ` (${event.roles.join(', ')})`;
						const overrideIcon = event.isOverridden ? `<i data-lucide="alert-triangle" class="inline-block w-3 h-3 text-yellow-300 ml-1"></i>` : '';

						return `<div data-action="view-crc-event" data-event-id="${event.id}" class="crc-event-tag ${eventColors[event.type] || 'bg-gray-500'}" title="${event.notes || title}">${title}${overrideIcon}</div>`;
					}).join('');

					dayGrid += `
						<div class="crc-calendar-day ${dayClass}" data-action="view-day-events" data-date="${dateStr}">
							<button data-action="open-crc-event-modal" data-date="${dateStr}" class="add-event-btn p-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 rounded-full">
								<i data-lucide="plus-circle" class="w-4 h-4"></i>
							</button>
							<div class="event-container custom-scrollbar">${eventTags}</div>
						</div>
					`;
					currentDay.setDate(currentDay.getDate() + 1);
				}
				dayGrid += '</div>';
				return getCalendarHeaderHTML() + dayGrid;
			};
			
			const getGlobalViewDetailedHTML = () => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();
				const daysInMonth = new Date(year, month + 1, 0).getDate();

				let filteredEvents = state.crc_events.filter(e => {
					const eventDate = new Date(e.date + 'T00:00:00');
					return eventDate.getFullYear() === year && eventDate.getMonth() === month;
				});

				// Apply top-level filters
				if (state.selectedCrcFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.crcId === state.selectedCrcFilter);
				}
				if (state.selectedSiteFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.siteId === state.selectedSiteFilter);
				}
				if (state.selectedRegionFilter !== 'all') {
					const crcsInRegion = state.crcs.filter(c => c.region === state.selectedRegionFilter).map(c => c.id);
					filteredEvents = filteredEvents.filter(e => crcsInRegion.includes(e.crcId));
				}

				// --- Calculate Daily Stats for the Macro View ---
				const dailyStats = {};
				for (let day = 1; day <= daysInMonth; day++) {
					const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					const dayEvents = filteredEvents.filter(e => e.date === dateStr);

					const uniqueCRCs = new Set(dayEvents.map(e => e.crcId).filter(Boolean));
					const openShifts = dayEvents.filter(e => e.type === 'Open Shift').length;
					const totalHours = dayEvents.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);

					dailyStats[day] = {
						totalStaff: uniqueCRCs.size,
						openShifts,
						totalHours
					};
				}

				// Group events by study, then by site for the Micro View
				const eventsByStudy = filteredEvents.reduce((acc, event) => {
					(event.studyIds && event.studyIds.length > 0 ? event.studyIds : ['unassigned']).forEach(studyId => {
						if (!acc[studyId]) acc[studyId] = [];
						acc[studyId].push(event);
					});
					return acc;
				}, {});

				let tableHtml = `<div class="overflow-auto custom-scrollbar border dark:border-gray-700 rounded-lg" style="max-height: 75vh;">
									<table class="min-w-full text-xs border-collapse">`;
				
				tableHtml += `<thead>`;
				// Day headers row
				tableHtml += `<tr class="bg-gray-100 dark:bg-gray-800" style="position: sticky; top: 0; z-index: 21;">
									<th class="global-view-header global-view-site-header sticky left-0 z-30 bg-gray-100 dark:bg-gray-800 p-2 font-bold">Site / Study</th>`;
				for (let day = 1; day <= daysInMonth; day++) {
					tableHtml += `<th class="global-view-header p-2 font-bold text-lg">${day}</th>`;
				}
				tableHtml += `</tr>`;

				// Macro Summary Row
				tableHtml += `<tr class="border-t-2 border-b dark:border-gray-600 bg-gray-50 dark:bg-gray-900/50" style="position: sticky; top: 2.7rem; z-index: 20;">
								<th class="global-view-header global-view-site-header sticky left-0 z-30 bg-gray-50 dark:bg-gray-900/50 font-semibold p-1">Daily Summary</th>`;
				for (let day = 1; day <= daysInMonth; day++) {
					const stats = dailyStats[day];
					const openShiftClass = stats.openShifts > 0 ? 'text-red-500 font-bold' : '';
					tableHtml += `<td class="p-1 text-center border-l dark:border-gray-700">
									<div class="flex items-center justify-center" title="Total Staff Assigned"><i data-lucide="users" class="w-3 h-3 mr-1 text-gray-500"></i>${stats.totalStaff}</div>
									<div class="flex items-center justify-center ${openShiftClass}" title="Open Shifts"><i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i>${stats.openShifts}</div>
									<div class="flex items-center justify-center" title="Total Hours Scheduled"><i data-lucide="clock" class="w-3 h-3 mr-1 text-gray-500"></i>${stats.totalHours}</div>
								</td>`;
				}
				tableHtml += `</tr></thead><tbody>`;

                const sortedStudies = [...state.studies, {id: 'unassigned', name: 'Unassigned Study'}]
                    .filter(study => eventsByStudy[study.id])
                    .sort((a,b) => a.name.localeCompare(b.name));

				sortedStudies.forEach(study => {
					const studyEvents = eventsByStudy[study.id];
					if (!studyEvents || studyEvents.length === 0) return;

					tableHtml += `<tr class="border-t-2 dark:border-gray-600">
									<td colspan="${daysInMonth + 1}" class="global-view-study-header p-2" style="position: sticky; top: 6.7rem; z-index: 19;">${study.name}</td>
								</tr>`;

					const eventsBySite = studyEvents.reduce((acc, event) => {
						const siteId = event.siteId || 'unassigned';
						if(!acc[siteId]) acc[siteId] = [];
						acc[siteId].push(event);
						return acc;
					}, {});
                    
                    const sortedSiteIds = Object.keys(eventsBySite).sort((a, b) => {
                        const siteA = state.crc_sites.find(s => s.id === a)?.name || 'zz';
                        const siteB = state.crc_sites.find(s => s.id === b)?.name || 'zz';
                        return siteA.localeCompare(siteB);
                    });

					sortedSiteIds.forEach(siteId => {
						const site = state.crc_sites.find(s => s.id === siteId);
						const siteName = site ? site.name : 'Unassigned Site';
						
						tableHtml += `<tr class="border-t dark:border-gray-700">
										<td class="global-view-header global-view-site-header sticky left-0 bg-white dark:bg-gray-900 pl-8 font-medium">${siteName}</td>`;

						for (let day = 1; day <= daysInMonth; day++) {
							const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
							const dayEvents = (eventsBySite[siteId] || []).filter(e => e.date === dateStr);
							
							tableHtml += `<td class="global-view-cell bg-white dark:bg-gray-900 align-top p-1 custom-scrollbar" data-action="open-crc-event-modal" data-date="${dateStr}">`;
							dayEvents.forEach(event => {
								const crc = state.crcs.find(c => c.id === event.crcId);
								const eventColor = event.type === 'Open Shift' ? 'bg-red-200 dark:bg-red-900/50 text-red-800 dark:text-red-200' : 'bg-blue-100 dark:bg-blue-900/50';
								const overrideIcon = event.isOverridden ? `<i data-lucide="alert-triangle" class="inline-block w-3 h-3 text-yellow-500 ml-1"></i>` : '';
								
								tableHtml += `<div class="global-view-event ${eventColor} cursor-pointer hover:ring-2 hover:ring-blue-500" data-action="view-crc-event" data-event-id="${event.id}">
													<strong>${crc ? crc.name : 'Open Shift'}</strong> ${overrideIcon}<br>
													<span class="text-gray-600 dark:text-gray-400">
														${event.visitNumber ? `Visit: ${event.visitNumber}<br>` : ''}
														${(event.roles || []).length > 0 ? `Role: ${(event.roles).join(', ')}` : ''}
														${event.period && event.period !== 'Full Day' ? `(${event.period})` : ''}
													</span>
												</div>`;
							});
							tableHtml += `</td>`;
						}
						tableHtml += `</tr>`;
					});
				});

				tableHtml += `</tbody></table></div>`;

				return getCalendarHeaderHTML() + tableHtml;
			};

			const getAtAGlanceViewHTML = (groupBy = 'study') => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();
				const daysInMonth = new Date(year, month + 1, 0).getDate();

				// 1. Filter events for the current month and apply global filters
				let filteredEvents = state.crc_events.filter(e => {
					const eventDate = new Date(e.date + 'T00:00:00');
					return eventDate.getFullYear() === year && eventDate.getMonth() === month;
				});
				if (state.selectedCrcFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.crcId === state.selectedCrcFilter);
				}
				if (state.selectedSiteFilter !== 'all') {
					filteredEvents = filteredEvents.filter(e => e.siteId === state.selectedSiteFilter);
				}
				if (state.selectedRegionFilter !== 'all') {
					const crcsInRegion = state.crcs.filter(c => c.region === state.selectedRegionFilter).map(c => c.id);
					filteredEvents = filteredEvents.filter(e => crcsInRegion.includes(e.crcId));
				}

				// 2. Aggregate data based on the groupBy parameter
				const staffCountByGroupAndDate = {};
				filteredEvents.forEach(event => {
					if (!event.crcId) return; // Only count assigned staff

					let groupIds = [];
					if (groupBy === 'study') {
						groupIds = (event.studyIds && event.studyIds.length > 0) ? event.studyIds : ['unassigned'];
					} else { // groupBy === 'site'
						groupIds = event.siteId ? [event.siteId] : ['unassigned'];
					}

					groupIds.forEach(groupId => {
						if (!staffCountByGroupAndDate[groupId]) {
							staffCountByGroupAndDate[groupId] = {};
						}
						if (!staffCountByGroupAndDate[groupId][event.date]) {
							staffCountByGroupAndDate[groupId][event.date] = new Set();
						}
						staffCountByGroupAndDate[groupId][event.date].add(event.crcId);
					});
				});

				// 3. Generate HTML for the table
				const collection = groupBy === 'study' ? state.studies : state.crc_sites;
				const unassignedGroup = { id: 'unassigned', name: `Unassigned ${groupBy.charAt(0).toUpperCase() + groupBy.slice(1)}` };

				let tableHtml = `<div class="overflow-auto custom-scrollbar border dark:border-gray-700 rounded-lg" style="max-height: 75vh;">
									<table class="min-w-full text-sm border-collapse">`;
				
				// Header row with day numbers
				tableHtml += `<thead class="sticky top-0 z-10">
								<tr class="bg-gray-100 dark:bg-gray-800">
									<th class="p-2 text-left sticky left-0 bg-gray-100 dark:bg-gray-800 font-semibold">${groupBy.charAt(0).toUpperCase() + groupBy.slice(1)}</th>`;
				for (let day = 1; day <= daysInMonth; day++) {
					tableHtml += `<th class="p-2 font-normal w-10">${day}</th>`;
				}
				tableHtml += `</tr></thead>`;

				// Table body with study/site rows
				let tbodyHtml = '<tbody>';
				const sortedGroups = [...collection, unassignedGroup]
					.filter(group => staffCountByGroupAndDate[group.id])
					.sort((a,b) => a.name.localeCompare(b.name));

				sortedGroups.forEach(group => {
					tbodyHtml += `<tr class="border-t dark:border-gray-700">
									<td class="p-2 text-left sticky left-0 bg-white dark:bg-gray-900 font-medium whitespace-nowrap">${group.name}</td>`;
					for (let day = 1; day <= daysInMonth; day++) {
						const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
						const staffSet = staffCountByGroupAndDate[group.id]?.[dateStr];
						const staffCount = staffSet ? staffSet.size : 0;
						
						let cellClass = 'text-center border-l dark:border-gray-700';
						let cellContent = staffCount > 0 ? staffCount : '-';

						if (staffCount === 1) cellClass += ' bg-blue-100 dark:bg-blue-900/50';
						if (staffCount === 2) cellClass += ' bg-green-100 dark:bg-green-900/50';
						if (staffCount >= 3) cellClass += ' bg-yellow-100 dark:bg-yellow-900/50 font-bold';
						
						tbodyHtml += `<td class="${cellClass}">${cellContent}</td>`;
					}
					tbodyHtml += `</tr>`;
				});
				tbodyHtml += '</tbody>';

				tableHtml += tbodyHtml + `</table></div>`;
				return getCalendarHeaderHTML() + tableHtml;
			};


			// --- UI & UTILIZATION RENDERING ---
			const renderSidebarTabs = () => {
				const container = document.getElementById('sidebar-tabs-container');
				if (!container) return;
				const tabIs = (id) => state.sidebarTab === id;

				container.innerHTML = `
					<div>
						<div class="border-b border-gray-200 dark:border-gray-700">
							<nav class="-mb-px flex space-x-6" aria-label="Tabs">
								<button data-action="set-sidebar-tab" data-tab-id="crcs" class="${tabIs('crcs') ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-500'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">CRCs</button>
								<button data-action="set-sidebar-tab" data-tab-id="sites" class="${tabIs('sites') ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-500'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Sites</button>
								<button data-action="set-sidebar-tab" data-tab-id="studies" class="${tabIs('studies') ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-500'} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Studies</button>
							</nav>
						</div>
						<div class="pt-6">
							${ tabIs('crcs') ? `
								<div class="space-y-4">
									<form id="add-crc-form" class="space-y-3">
										<h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Manage CRCs</h3>
										<input type="text" name="crcName" placeholder="CRC Name" required class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
										<input type="text" name="crcLocation" placeholder="Home Location (e.g., City, ST)" required class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
										<input type="text" name="crcRegion" placeholder="Region (e.g., East, West)" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
										<div class="flex gap-2">
											<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Add CRC</button>
											<button type="button" data-action="import-crcs-btn" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition-colors">Import CRCs</button>
										</div>
									</form>
									<div id="crcList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
								</div>
							` : '' }
							${ tabIs('sites') ? `
								<div class="space-y-4">
									<form id="add-crc-site-form" class="space-y-3">
										<h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Manage Sites</h3>
										<input type="text" name="crcSiteName" placeholder="Site Name" required class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
										<input type="text" name="crcSiteAddress" placeholder="Site Address" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
										<input type="text" name="crcSitePI" placeholder="Principal Investigator" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
										<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Add Site</button>
									</form>
									<div id="crcSiteList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
								</div>
							` : '' }
							${ tabIs('studies') ? `
								<div class="space-y-4">
									<h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Manage Studies</h3>
									<button data-action="open-add-study-modal" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">Add Study</button>
									<div id="studyList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
								</div>
							` : '' }
						</div>
					</div>
				`;
			};

			const renderCRCLists = () => {
				const crcList = document.getElementById('crcList');
				const siteList = document.getElementById('crcSiteList');
				const studyList = document.getElementById('studyList');
				
				if (crcList) {
					let filteredCrcs = state.crcs;
					if (state.selectedRegionFilter !== 'all') {
						filteredCrcs = state.crcs.filter(crc => crc.region === state.selectedRegionFilter);
					}
					crcList.innerHTML = filteredCrcs.map(crc => `
						<div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md">
							<button data-action="view-crc-profile" data-id="${crc.id}" class="text-sm font-medium text-gray-800 dark:text-gray-200 hover:underline">${crc.name}</button>
							<button data-action="delete-crc" data-id="${crc.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
						</div>
					`).join('') || '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No CRCs added yet.</p>';
				}

				if (siteList) {
					siteList.innerHTML = state.crc_sites.map(site => `
						<div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md">
							<button data-action="edit-crc-site" data-id="${site.id}" class="text-sm font-medium text-gray-800 dark:text-gray-200 hover:underline">${site.name}</button>
							<button data-action="delete-crc-site" data-id="${site.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
						</div>
					`).join('') || '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No sites added yet.</p>';
				}

				if (studyList) {
					studyList.innerHTML = state.studies.map(study => `
						<div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md">
							<button data-action="edit-study" data-id="${study.id}" class="text-sm font-medium text-gray-800 dark:text-gray-200 hover:underline">${study.name}</button>
							<button data-action="delete-study" data-id="${study.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
						</div>
					`).join('') || '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">No studies added yet.</p>';
				}
			};

			const renderUtilization = () => {
				const container = document.getElementById('crcUtilization');
				const titleEl = document.getElementById('utilization-title');
				if (!container || !titleEl) return;

				if (state.crcs.length === 0) {
					container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No CRCs to analyze.</p>';
					return;
				}

				let utilizationHTML = '';

				if (state.calendarView === 'week') {
					titleEl.textContent = 'CRC Utilization (Current Week)';
					const weeklyStats = calculateWeeklyUtilization(state.crcCalendarDate);
					
					utilizationHTML = state.crcs.map(crc => {
						const stats = weeklyStats[crc.id] || { totalHours: 0, utilizationPercent: 0 };
						const totalHours = stats.totalHours;
						
						let barColor = 'bg-green-500';
						if (totalHours > 35) barColor = 'bg-yellow-500';
						if (totalHours > 40) barColor = 'bg-red-500';

						return `
							<div>
								<div class="flex justify-between mb-1 font-medium">
									<span>${crc.name}</span>
									<span class="dark:text-gray-300">${totalHours} hrs</span>
								</div>
								<div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
									<div class="${barColor} h-2.5 rounded-full" style="width: ${Math.min(stats.utilizationPercent, 100)}%"></div>
								</div>
							</div>
						`;
					}).join('');

				} else { // Month or Global View
					titleEl.textContent = 'CRC Utilization (Current Month)';
					utilizationHTML = state.crcs.map(crc => {
						const stats = state.crcStats[crc.id] || { utilizationPercent: 0 };
						const utilizationPercent = stats.utilizationPercent;
						
						let barColor = 'bg-green-500';
						if (utilizationPercent > 85) barColor = 'bg-yellow-500';
						if (utilizationPercent >= 100) barColor = 'bg-red-500';

						return `
							<div>
								<div class="flex justify-between mb-1 font-medium">
									<span>${crc.name}</span>
									<span class="dark:text-gray-300">${utilizationPercent}%</span>
								</div>
								<div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
									<div class="${barColor} h-2.5 rounded-full" style="width: ${Math.min(utilizationPercent, 100)}%"></div>
								</div>
							</div>
						`;
					}).join('');
				}

				container.innerHTML = utilizationHTML;
			};
			
			const updateCRCMap = () => {
				const mapFrame = document.getElementById('mapFrame');
				if (!mapFrame || !window.google) return;

				const apiKey = "YOUR_GOOGLE_MAPS_API_KEY";
				if (apiKey === "YOUR_GOOGLE_MAPS_API_KEY") {
					mapFrame.src = "";
					return;
				}

				const locations = state.crcs.map(crc => `markers=color:blue%7Clabel:C%7C${encodeURIComponent(crc.homeLocation)}`).join('&');
				const mapUrl = `https://www.google.com/maps/embed/v1/view?key=${apiKey}&center=39.8283,-98.5795&zoom=4${locations ? '&' + locations : ''}`;
				
				if (mapFrame.src !== mapUrl) {
					mapFrame.src = mapUrl;
				}
			};

			const updateCrcDropdownAvailability = () => {
				const form = document.getElementById('crc-event-form');
				if (!form) return;

				const startDateInput = form.querySelector('input[name="startDate"]');
				const endDateInput = form.querySelector('input[name="endDate"]');
				const crcSelect = form.querySelector('select[name="crcId"]');
				const periodSelect = form.querySelector('select[name="period"]');
				const eventId = form.dataset.eventId;
				const originalEvent = eventId ? state.crc_events.find(e => e.id === eventId) : null;

				if (!startDateInput || !endDateInput || !crcSelect || !periodSelect) return;

				const startDate = new Date(startDateInput.value + 'T00:00:00');
				const endDate = new Date((endDateInput.value || startDateInput.value) + 'T00:00:00');
				const selectedPeriod = periodSelect.value;

				const scheduledPeriodsByCrc = {};
				const dateRange = [];
				let currentDate = new Date(startDate);
				while (currentDate <= endDate) {
					dateRange.push(currentDate.toISOString().split('T')[0]);
					currentDate.setDate(currentDate.getDate() + 1);
				}

				state.crc_events.forEach(event => {
					if (dateRange.includes(event.date) && event.crcId) {
						if (originalEvent && (originalEvent.id === event.id || (originalEvent.groupId && originalEvent.groupId === event.groupId))) {
							return;
						}
						if (!scheduledPeriodsByCrc[event.crcId]) {
							scheduledPeriodsByCrc[event.crcId] = [];
						}
						scheduledPeriodsByCrc[event.crcId].push(event.period || 'Full Day');
					}
				});

				for (const option of crcSelect.options) {
					if (option.value) {
						const crcId = option.value;
						const crc = state.crcs.find(c => c.id === crcId);
						option.textContent = crc ? crc.name : 'Unknown CRC'; // Reset text
						option.classList.remove('text-red-500', 'font-bold');
						
						const scheduledPeriods = scheduledPeriodsByCrc[crcId] || [];
						let isAvailable = true;
						let availabilityText = '';

						if (scheduledPeriods.includes('Full Day') || (scheduledPeriods.includes('AM') && scheduledPeriods.includes('PM'))) {
							isAvailable = false;
							availabilityText = '(Scheduled Full Day)';
						} else if (scheduledPeriods.includes('AM')) {
							if (selectedPeriod === 'AM' || selectedPeriod === 'Full Day') {
								isAvailable = false;
							}
							availabilityText = '(AM Scheduled)';
						} else if (scheduledPeriods.includes('PM')) {
							if (selectedPeriod === 'PM' || selectedPeriod === 'Full Day') {
								isAvailable = false;
							}
							availabilityText = '(PM Scheduled)';
						}
						
						const isMarkedUnavailable = scheduledPeriods.some(p => ['Unavailable', 'Paid Time Off'].includes(p.type));
						if(isMarkedUnavailable) {
							option.classList.add('text-red-500', 'font-bold');
							availabilityText += ' (Unavailable)';
						} else {
							option.disabled = !isAvailable;
							if (!isAvailable) {
								option.textContent += ` ${availabilityText}`;
							}
						}
					}
				}
			};
			
			const updateCrcHoursDisplay = (crcId, startDateStr) => {
				const infoDiv = document.getElementById('crc-hours-info');
				if (!infoDiv || !crcId || !startDateStr) {
					if(infoDiv) infoDiv.innerHTML = '';
					return;
				};

				const eventDate = new Date(startDateStr + 'T00:00:00');
				const year = eventDate.getFullYear();
				const month = eventDate.getMonth();
				const MONTHLY_FT_HOURS = 174;

				const productiveEventTypes = ['Site Assignment', 'Travel Day'];
				const eventsThisMonth = state.crc_events.filter(e => {
					const d = new Date(e.date + 'T00:00:00');
					return e.crcId === crcId &&
						d.getFullYear() === year &&
						d.getMonth() === month &&
						productiveEventTypes.includes(e.type);
				});

				const totalHours = eventsThisMonth.reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
				
				let hourText = `Scheduled this month: <strong>${totalHours}</strong> hours.`;
				if (totalHours > MONTHLY_FT_HOURS) {
					const overtime = totalHours - MONTHLY_FT_HOURS;
					hourText += ` <span class="text-yellow-500 font-semibold">(${overtime} OT hours)</span>`;
				}
				
				infoDiv.innerHTML = hourText;
			};


			const handleEventTypeChange = (selectElement) => {
				if (!selectElement) return;
				const eventType = selectElement.value;
				const form = selectElement.closest('form');
				if (!form) return;

				const crcGroup = form.querySelector('#crc-group');
				const siteGroup = form.querySelector('#site-group');
				const studyGroup = form.querySelector('#study-group');
				const roleGroup = form.querySelector('#role-group');
				const hoursInput = form.querySelector('input[name="hours"]');
				const periodGroup = form.querySelector('#period-group');
				const mileageGroup = form.querySelector('#mileage-group');
				const visitGroup = form.querySelector('#visit-group');

				if(hoursInput) {
					hoursInput.value = state.settings[eventType] || 8;
				}

				const allGroups = [crcGroup, siteGroup, studyGroup, roleGroup, periodGroup, mileageGroup, visitGroup];
				allGroups.forEach(el => {
					if (el) el.classList.add('hidden');
				});

				if (eventType === 'Site Assignment') {
					[crcGroup, siteGroup, studyGroup, roleGroup, visitGroup, periodGroup].forEach(el => {
						if (el) el.classList.remove('hidden');
					});
				} else if (eventType === 'Travel Day') {
					[crcGroup, siteGroup, studyGroup, mileageGroup, periodGroup].forEach(el => {
						if (el) el.classList.remove('hidden');
					});
				} else if (eventType === 'Paid Time Off' || eventType === 'Unavailable') {
					[crcGroup, periodGroup].forEach(el => {
						if (el) el.classList.remove('hidden');
					});
				} else if (eventType === 'Open Shift') {
					[siteGroup, studyGroup, roleGroup, visitGroup, periodGroup].forEach(el => {
						if (el) el.classList.remove('hidden');
					});
				}
				
				updateCrcDropdownAvailability();
			};

			// --- MODAL HTML GENERATORS ---
			const getAvailabilityModalHTML = () => {
				const now = state.crcCalendarDate;
				const year = now.getFullYear();
				const month = now.getMonth();
				const monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });
				const daysInMonth = new Date(year, month + 1, 0).getDate();

				const availabilityMap = new Map();
				state.crcs.forEach(crc => availabilityMap.set(crc.id, {}));

				state.crc_events.forEach(event => {
					const eventDate = new Date(event.date + 'T00:00:00');
					if (event.crcId && eventDate.getFullYear() === year && eventDate.getMonth() === month) {
						const day = eventDate.getDate();
						const crcData = availabilityMap.get(event.crcId);
						if (crcData) {
							if(!crcData[day]) crcData[day] = [];
							crcData[day].push(event);
						}
					}
				});

				let headerHtml = '<th class="sticky left-0 bg-gray-100 dark:bg-gray-800 p-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">CRC</th>';
				for (let day = 1; day <= daysInMonth; day++) {
					headerHtml += `<th class="p-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-8">${day}</th>`;
				}

				let bodyHtml = '';
				state.crcs.forEach(crc => {
					bodyHtml += '<tr>';
					bodyHtml += `<td class="sticky left-0 bg-white dark:bg-gray-900 p-2 whitespace-nowrap font-medium text-sm">${crc.name}</td>`;
					const crcData = availabilityMap.get(crc.id);
					for (let day = 1; day <= daysInMonth; day++) {
						const dayEvents = crcData[day];
						let cellColor = 'bg-green-200 dark:bg-green-800/60';
						let title = 'Available';
						if (dayEvents && dayEvents.length > 0) {
							const periods = dayEvents.map(e => e.period || 'Full Day');
							if (periods.includes('Full Day') || (periods.includes('AM') && periods.includes('PM'))) {
								cellColor = 'bg-red-300 dark:bg-red-800/60';
								title = 'Unavailable';
							} else if (periods.length > 0) {
								cellColor = 'bg-yellow-300 dark:bg-yellow-800/60';
								title = `${periods.join(', ')} taken`;
							}
						}
						bodyHtml += `<td class="${cellColor}" title="${title}"></td>`;
					}
					bodyHtml += '</tr>';
				});

				return `
					<h2 class="text-2xl font-bold dark:text-white mb-4">CRC Availability for ${monthName}</h2>
					<div class="overflow-auto custom-scrollbar border dark:border-gray-700 rounded-lg" style="max-height: 70vh;">
						<table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
							<thead class="bg-gray-100 dark:bg-gray-800 sticky top-0">
								<tr>${headerHtml}</tr>
							</thead>
							<tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
								${bodyHtml}
							</tbody>
						</table>
					</div>
				`;
			};

			const getCRCEventModalHTML = (date, event = null, seriesStartDate = null, seriesEndDate = null) => {
				// An event is being edited if it has an ID. Otherwise it's new or a template.
				const isEditing = event !== null && event.id;
				const eventType = event ? event.type : 'Site Assignment';
				const hours = event ? event.hours : (state.settings[eventType] || 8);
				const period = event ? (event.period || 'Full Day') : 'Full Day';
				const crcOptions = state.crcs.map(crc => `<option value="${crc.id}" ${event && event.crcId === crc.id ? 'selected' : ''}>${crc.name}</option>`).join('');
				const siteOptions = state.crc_sites.map(site => `<option value="${site.id}" ${event && event.siteId === site.id ? 'selected' : ''}>${site.name}</option>`).join('');
				
				const selectedStudyIds = new Set(event ? event.studyIds || [] : []);
				const studyOptions = state.studies.map(study => `<option value="${study.id}" ${selectedStudyIds.has(study.id) ? 'selected' : ''}>${study.name}</option>`).join('');

				const allRoles = getAllRoles();
				const selectedRoles = new Set(event ? event.roles || [] : []);
				const roleOptions = allRoles.map(r => `<option value="${r}" ${selectedRoles.has(r) ? 'selected' : ''}>${r}</option>`).join('');

				// Only show the "Split Shift" button if editing a full-day event.
				const isFullDayEvent = isEditing && (!event.period || event.period === 'Full Day');

				// Determine visibility for each section based on the event type.
				const show = {
					crc: !['Open Shift'].includes(eventType),
					site: ['Site Assignment', 'Travel Day', 'Open Shift'].includes(eventType),
					study: ['Site Assignment', 'Open Shift', 'Travel Day'].includes(eventType),
					role: ['Site Assignment', 'Open Shift'].includes(eventType),
					visit: ['Site Assignment', 'Open Shift'].includes(eventType),
					period: true, // Always shown
					mileage: ['Travel Day'].includes(eventType)
				};

				return `
					<h2 class="text-2xl font-bold dark:text-white mb-6">${isEditing ? 'Edit' : 'Add'} Shift</h2>
					<form id="crc-event-form" data-event-id="${isEditing ? event.id : ''}" data-group-id="${event?.groupId || ''}" class="space-y-4">
						
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium dark:text-gray-300 mb-1">Start Date</label>
								<input type="date" name="startDate" required class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${seriesStartDate || event?.date || date}">
							</div>
							<div>
								<label class="block text-sm font-medium dark:text-gray-300 mb-1">End Date</label>
								<input type="date" name="endDate" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${seriesEndDate || event?.date || date}">
							</div>
						</div>

						<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium dark:text-gray-300 mb-1">Event Type</label>
								<select id="crc-event-type" name="eventType" required class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
									<option ${eventType === 'Site Assignment' ? 'selected' : ''}>Site Assignment</option>
									<option ${eventType === 'Travel Day' ? 'selected' : ''}>Travel Day</option>
									<option ${eventType === 'Paid Time Off' ? 'selected' : ''}>Paid Time Off</option>
									<option ${eventType === 'Unavailable' ? 'selected' : ''}>Unavailable</option>
									<option ${eventType === 'Open Shift' ? 'selected' : ''}>Open Shift</option>
								</select>
							</div>
							<div>
								<label class="block text-sm font-medium dark:text-gray-300 mb-1">Hours</label>
								<input type="number" name="hours" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${hours}" step="0.5">
							</div>
						</div>
						
						<div id="period-group" class="${show.period ? '' : 'hidden'}">
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Time Period</label>
							<select name="period" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
								<option ${period === 'Full Day' ? 'selected' : ''}>Full Day</option>
								<option ${period === 'AM' ? 'selected' : ''}>AM</option>
								<option ${period === 'PM' ? 'selected' : ''}>PM</option>
							</select>
						</div>

						<div id="crc-group" class="${show.crc ? '' : 'hidden'}">
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">CRC(s) <span class="text-xs font-light">(Hold Ctrl/Cmd to select multiple)</span></label>
							<select name="crcId" ${!isEditing ? 'multiple' : ''} class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white h-32">
								${!isEditing ? crcOptions : `<option value="">Select CRC</option>${crcOptions}`}
							</select>
							<div id="crc-hours-info" class="text-sm mt-2 h-5 text-gray-600 dark:text-gray-400"></div>
						</div>

						<div id="study-group" class="${show.study ? '' : 'hidden'}">
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Study/Studies <span class="text-xs font-light">(Hold Ctrl/Cmd to select multiple)</span></label>
							<select name="studyIds" multiple class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white h-24"><option value="">Select Study</option>${studyOptions}</select>
						</div>
						
						<div id="site-group" class="${show.site ? '' : 'hidden'}">
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Site</label>
							<select name="siteId" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Site</option>${siteOptions}</select>
						</div>

						<div id="role-group" class="${show.role ? '' : 'hidden'}">
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Role(s) <span class="text-xs font-light">(Hold Ctrl/Cmd to select multiple)</span></label>
							<select name="roles" multiple class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white h-24">
								${roleOptions}
							</select>
						</div>
						
						<div id="visit-group" class="${show.visit ? '' : 'hidden'} grid grid-cols-1 sm:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium dark:text-gray-300 mb-1">Visit Number</label>
								<input type="text" name="visitNumber" value="${event ? event.visitNumber || '' : ''}" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
							</div>
							<div>
								<label class="block text-sm font-medium dark:text-gray-300 mb-1">Principal Investigator</label>
								<input type="text" name="principalInvestigator" value="${event ? event.principalInvestigator || '' : ''}" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="Defaults to site PI">
							</div>
						</div>

						<div id="mileage-group" class="${show.mileage ? '' : 'hidden'}">
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Mileage</label>
							<input type="number" name="mileage" value="${event ? event.mileage || '' : ''}" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" step="0.1">
						</div>

						<div>
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Notes</label>
							<textarea name="notes" rows="3" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${event ? event.notes || '' : ''}</textarea>
						</div>
						<div id="form-error-message" class="text-red-500 text-sm h-4"></div>
						<div class="flex justify-between items-center pt-4">
							<div class="flex items-center gap-4">
								${isEditing ? `<button type="button" data-action="delete-crc-event" data-event-id="${event.id}" data-group-id="${event.groupId || ''}" class="text-red-600 hover:underline">Delete Event</button>` : '<div></div>'}
								${isFullDayEvent ? `<button type="button" data-action="split-shift" data-event-id="${event.id}" class="text-blue-600 hover:underline">Split Shift</button>` : ''}
							</div>
							<button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">${isEditing ? 'Save Changes' : 'Add Event(s)'}</button>
						</div>
					</form>
				`;
			};

			const getDayViewModalHTML = (date, events) => {
				const dateObj = new Date(date + 'T00:00:00');
				const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

				let eventListHTML = events.map(event => {
					const crc = state.crcs.find(c => c.id === event.crcId);
					const site = state.crc_sites.find(s => s.id === event.siteId);
					const eventColors = { 'Site Assignment': 'bg-blue-500', 'Travel Day': 'bg-orange-500', 'Paid Time Off': 'bg-purple-500', 'Unavailable': 'bg-gray-500', 'Open Shift': 'bg-red-500' };
					
					return `
						<div class="p-3 border-b dark:border-gray-700 flex items-center gap-4">
							<div class="w-4 h-4 rounded-full ${eventColors[event.type] || 'bg-gray-500'}"></div>
							<div class="flex-grow">
								<p class="font-semibold">${event.type} (${event.hours || 'N/A'} hrs)</p>
								<p class="text-sm text-gray-600 dark:text-gray-300">
									${crc ? crc.name : ''} ${site ? `at ${site.name}` : ''} ${(event.roles || []).length > 0 ? `(${(event.roles).join(', ')})` : ''}
								</p>
								${event.notes ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${event.notes}</p>` : ''}
							</div>
							<button data-action="view-crc-event" data-event-id="${event.id}" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
								<i data-lucide="edit" class="w-4 h-4"></i>
							</button>
						</div>
					`;
				}).join('');

				if (events.length === 0) {
					eventListHTML = `<p class="p-4 text-center text-gray-500 dark:text-gray-400">No events scheduled for this day.</p>`;
				}

				return `
					<h2 class="text-2xl font-bold dark:text-white mb-4">${formattedDate}</h2>
					<div class="space-y-2">${eventListHTML}</div>
				`;
			};

			const getCRCProfileModalHTML = (crc) => {
				const thirtyDaysFromNow = new Date();
				thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
				const today = new Date();

				const weeklyHours = calculateWeeklyUtilization(new Date())[crc.id]?.totalHours || 0;

				let trainingsHTML = (crc.trainings && crc.trainings.length > 0) ? `
					<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 mt-4">
						<thead class="bg-gray-50 dark:bg-gray-800">
							<tr>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Training</th>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Training Date</th>
								<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Expiration Date</th>
							</tr>
						</thead>
						<tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
							${crc.trainings.map(t => {
								const expirationDate = new Date(t.expirationDate);
								let rowClass = '';
								if (expirationDate < today) {
									rowClass = 'bg-red-100 dark:bg-red-900/50';
								} else if (expirationDate < thirtyDaysFromNow) {
									rowClass = 'bg-yellow-100 dark:bg-yellow-900/50';
								}
								return `<tr class="${rowClass}">
									<td class="px-4 py-2 whitespace-nowrap text-sm">${t.name}</td>
									<td class="px-4 py-2 whitespace-nowrap text-sm">${t.completionDate}</td>
									<td class="px-4 py-2 whitespace-nowrap text-sm">${t.expirationDate}</td>
								</tr>`
							}).join('')}
						</tbody>
					</table></div>
				` : '<p class="text-sm text-gray-500 dark:text-gray-400 mt-4">No training records found.</p>';

				return `
					<h2 class="text-2xl font-bold dark:text-white mb-4">CRC Profile: ${crc.name}</h2>
					<div class="mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
						<span class="font-semibold">Current Week's Hours (Sat-Fri):</span>
						<span class="font-bold text-lg">${weeklyHours}</span>
					</div>
					<form id="edit-crc-form" data-id="${crc.id}" class="space-y-4">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium dark:text-gray-300">Name</label>
								<input type="text" name="name" value="${crc.name}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
							</div>
							<div>
								<label class="block text-sm font-medium dark:text-gray-300">Training Level / Sign-off</label>
								<input type="text" name="trainingLevel" value="${crc.trainingLevel || ''}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
							</div>
						</div>
						<div>
							<label class="block text-sm font-medium dark:text-gray-300">Capabilities / Tasks (comma-separated)</label>
							<input type="text" name="capabilities" value="${(crc.capabilities || []).join(', ')}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium dark:text-gray-300">Home Location (for Map)</label>
								<input type="text" name="homeLocation" value="${crc.homeLocation}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
							</div>
							<div>
								<label class="block text-sm font-medium dark:text-gray-300">Region</label>
								<input type="text" name="region" value="${crc.region || ''}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
							</div>
						</div>
						<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Save Changes</button>
					</form>

					<div class="mt-8 border-t dark:border-gray-700 pt-6">
						<h3 class="text-xl font-semibold dark:text-white mb-4">Training Records</h3>
						${trainingsHTML}
						<form id="add-training-form" data-id="${crc.id}" class="mt-6 space-y-3 border-t dark:border-gray-700 pt-4">
							<h4 class="font-semibold dark:text-gray-200">Add New Training</h4>
							<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
								<input type="text" name="trainingName" placeholder="Training Name" required class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
								<input type="date" name="completionDate" required class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
								<input type="date" name="expirationDate" required class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
							</div>
							<button type="submit" class="w-full bg-green-500 text-white py-2 rounded-md">Add Training</button>
						</form>
					</div>
				`;
			};

			const getImportCsvModalHTML = () => {
				return `
					<h2 class="text-2xl font-bold dark:text-white mb-4">Import Shifts from CSV</h2>
					<div class="space-y-4 text-gray-700 dark:text-gray-300">
						<p>Please ensure your CSV file is formatted correctly before uploading.</p>
						<div>
							<h4 class="font-semibold text-gray-800 dark:text-gray-200">Required Columns:</h4>
							<ul class="list-disc list-inside mt-2 text-sm">
								<li><strong>Date</strong>: The date of the shift (format: YYYY-MM-DD).</li>
								<li><strong>EventType</strong>: The type of shift (e.g., 'Site Assignment', 'Travel Day').</li>
							</ul>
						</div>
						<div>
							<h4 class="font-semibold text-gray-800 dark:text-gray-200">Optional Columns:</h4>
							<ul class="list-disc list-inside mt-2 text-sm">
								<li><strong>CRCName</strong>: The name of the CRC. Must match an existing CRC. (Required for most event types).</li>
								<li><strong>SiteName</strong>: The name of the Site. If the site doesn't exist, it will be created.</li>
								<li><strong>StudyName</strong>: Study names, separated by a semicolon (;). If a study doesn't exist, it will be created.</li>
								<li><strong>Roles</strong>: Roles for the assignment, separated by a semicolon (;).</li>
								<li><strong>Hours</strong>: Number of hours for the shift (defaults to 8).</li>
								<li><strong>Period</strong>: For Unavailable/PTO shifts ('Full Day', 'AM', 'PM').</li>
								<li><strong>Notes</strong>: Any additional notes for the shift.</li>
								<li><strong>VisitNumber</strong>: The visit number for the assignment.</li>
								<li><strong>PrincipalInvestigator</strong>: The PI for the visit.</li>
								<li><strong>Mileage</strong>: Mileage for travel days.</li>
							</ul>
						</div>
						<p class="text-sm text-gray-500 dark:text-gray-400">
							<strong>Tip:</strong> You can use the "Export Month" button to download a template with the correct format and existing data.
						</p>
					</div>
					<div class="mt-6 flex justify-end gap-4">
						<button data-action="close-modal" class="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
						<button data-action="trigger-csv-upload" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center">
							<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Choose File & Import
						</button>
					</div>
				`;
			};

			const getImportCRCsModalHTML = () => {
				return `
					<h2 class="text-2xl font-bold dark:text-white mb-4">Import CRCs from CSV</h2>
					<div class="space-y-4 text-gray-700 dark:text-gray-300">
						<p>Please ensure your CSV file has the correct headers before uploading.</p>
						<div>
							<h4 class="font-semibold text-gray-800 dark:text-gray-200">Required Columns:</h4>
							<ul class="list-disc list-inside mt-2 text-sm">
								<li><strong>CRCName</strong>: The full name of the CRC.</li>
								<li><strong>HomeLocation</strong>: The home city and state (e.g., "New York, NY") for mapping.</li>
							</ul>
						</div>
						<div>
							<h4 class="font-semibold text-gray-800 dark:text-gray-200">Optional Columns:</h4>
							<ul class="list-disc list-inside mt-2 text-sm">
								<li><strong>Region</strong>: The region the CRC belongs to (e.g., "East", "West").</li>
							</ul>
						</div>
					</div>
					<div class="mt-6 flex justify-end gap-4">
						<button data-action="close-modal" class="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
						<button data-action="trigger-crc-csv-upload" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 flex items-center">
							<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Choose File & Import
						</button>
					</div>
				`;
			};
			
			const getManageUnavailabilityModalHTML = () => {
				const crcOptions = state.crcs.map(crc => `<option value="${crc.id}" ${state.selectedCrcForUnavailability === crc.id ? 'selected' : ''}>${crc.name}</option>`).join('');
				return `
					<h2 class="text-2xl font-bold dark:text-white mb-4">Manage Staff Unavailability</h2>
					<div class="mb-4">
						<label for="unavailability-crc-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Staff Member</label>
						<select id="unavailability-crc-select" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
							<option value="">-- Please select a staff member --</option>
							${crcOptions}
						</select>
					</div>
					<div id="unavailability-calendar-container" class="mt-4">
					</div>
				`;
			};

			const getEditSiteModalHTML = (site) => {
				return `
					<h2 class="text-2xl font-bold dark:text-white mb-6">Edit Site</h2>
					<form id="edit-crc-site-form" data-id="${site.id}" class="space-y-4">
						<div>
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Site Name</label>
							<input type="text" name="crcSiteName" value="${site.name}" required class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
						</div>
						<div>
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Site Address</label>
							<input type="text" name="crcSiteAddress" value="${site.address || ''}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
						</div>
						<div>
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Principal Investigator</label>
							<input type="text" name="crcSitePI" value="${site.principalInvestigator || ''}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
						</div>
						<div class="flex justify-end pt-4">
							<button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Save Changes</button>
						</div>
					</form>
				`;
			};

			const getEditStudyModalHTML = (study) => {
				return `
					<h2 class="text-2xl font-bold dark:text-white mb-6">Edit Study</h2>
					<form id="edit-study-form" data-id="${study.id}" class="space-y-4">
						<div>
							<label class="block text-sm font-medium dark:text-gray-300 mb-1">Study Name</label>
							<input type="text" name="studyName" value="${study.name}" required class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white">
						</div>
						<div class="flex justify-end pt-4">
							<button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Save Changes</button>
						</div>
					</form>
				`;
			};

			const renderUnavailabilityCalendar = () => {
				const container = document.getElementById('unavailability-calendar-container');
				if (!container) return;
				
				if (!state.selectedCrcForUnavailability) {
					container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">Please select a staff member to view their unavailability calendar.</p>`;
					return;
				}

				const now = state.unavailabilityDate;
				const year = now.getFullYear();
				const month = now.getMonth();
				const monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });

				const unavailableEventsThisMonth = state.crc_events.filter(e =>
					e.crcId === state.selectedCrcForUnavailability &&
					e.type === 'Unavailable' &&
					new Date(e.date + 'T00:00:00').getFullYear() === year &&
					new Date(e.date + 'T00:00:00').getMonth() === month
				);

				const eventsMap = new Map(unavailableEventsThisMonth.map(e => [e.date, e]));

				const firstDayOfMonth = getDaySaturdayStart(new Date(year, month, 1));
				const daysInMonth = new Date(year, month + 1, 0).getDate();

				let dayGrid = `
					<div class="flex justify-between items-center mb-4">
						<h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">${monthName}</h3>
						<div class="flex items-center space-x-1">
							<button data-action="prev-unavailability-month" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
							<button data-action="next-unavailability-month" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
						</div>
					</div>
					<div class="crc-calendar-grid bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
				`;
				const weekdays = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
				dayGrid += weekdays.map(day => `<div class="text-center font-medium text-sm py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-400">${day}</div>`).join('');

				for (let i = 0; i < firstDayOfMonth; i++) {
					dayGrid += '<div class="bg-gray-50 dark:bg-gray-800/50"></div>';
				}

				for (let day = 1; day <= daysInMonth; day++) {
					const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					const event = eventsMap.get(dateStr);
					
					let dayClass = 'bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700';
					let statusHTML = '';

					if (event) {
						const period = event.period || 'Full Day';
						dayClass = 'bg-red-100 dark:bg-red-900/40 hover:bg-red-200 dark:hover:bg-red-900/60';
						statusHTML = `<div class="unavailability-status text-red-800 dark:text-red-200">${period}</div>`;
					} else {
						statusHTML = `<div class="unavailability-status text-green-800 dark:text-green-200">Available</div>`;
					}

					dayGrid += `
						<div class="unavailability-calendar-day ${dayClass} transition-colors" data-action="set-unavailability" data-date="${dateStr}" data-event-id="${event ? event.id : ''}">
							<span class="unavailability-day-number text-gray-600 dark:text-gray-400">${day}</span>
							${statusHTML}
						</div>
					`;
				}
				dayGrid += '</div></div>';
				container.innerHTML = dayGrid;
				lucide.createIcons();
			};

			// --- EVENT LISTENERS ---
			document.addEventListener('click', async (e) => {
				const actionButton = e.target.closest('[data-action]');
				if (!actionButton) return;
				
				// Prevent day view modal from opening when clicking on an event tag or add button
				if (actionButton.dataset.action !== 'view-day-events' && e.target.closest('.crc-event-tag, .add-event-btn, .global-view-event')) {
					e.stopPropagation();
				}

				const { action, id, date, eventId, groupId, view, tabId, mode, group } = actionButton.dataset;
				const getCollectionRef = (name) => collection(db, `artifacts/${appId}/public/data/${name}`);

				switch(action) {
					case 'view-availability': openModal(getAvailabilityModalHTML(), '7xl'); break;
					case 'manage-unavailability': openModal(getManageUnavailabilityModalHTML(), '4xl'); break;
					case 'auto-create-shift': {
						const todayStr = new Date().toISOString().split('T')[0];
						openModal(getCRCEventModalHTML(todayStr), '4xl');
						break;
					}
					case 'close-modal': closeModal(); break;
					case 'prev-crc-month': setState({ crcCalendarDate: new Date(state.crcCalendarDate.setMonth(state.crcCalendarDate.getMonth() - 1)) }); break;
					case 'next-crc-month': setState({ crcCalendarDate: new Date(state.crcCalendarDate.setMonth(state.crcCalendarDate.getMonth() + 1)) }); break;
					case 'prev-unavailability-month':
						setState({ unavailabilityDate: new Date(state.unavailabilityDate.setMonth(state.unavailabilityDate.getMonth() - 1)) });
						renderUnavailabilityCalendar();
						break;
					case 'next-unavailability-month':
						setState({ unavailabilityDate: new Date(state.unavailabilityDate.setMonth(state.unavailabilityDate.getMonth() + 1)) });
						renderUnavailabilityCalendar();
						break;
					case 'set-view': setState({ calendarView: view }); break;
					case 'set-display-mode': setState({ calendarDisplayMode: mode }); break;
					case 'set-at-a-glance-group': setState({ atAGlanceGroupBy: group }); break;
					case 'set-sidebar-tab': setState({ sidebarTab: tabId }); break;
					case 'set-main-tab': setState({ activeTab: tabId }); break;
					case 'import-csv-btn': openModal(getImportCsvModalHTML()); break;
					case 'trigger-csv-upload': 
						document.getElementById('csv-upload-input').dataset.uploadType = 'shifts';
						document.getElementById('csv-upload-input').click(); 
						break;
					case 'import-crcs-btn': openModal(getImportCRCsModalHTML()); break;
					case 'trigger-crc-csv-upload':
						document.getElementById('csv-upload-input').dataset.uploadType = 'crcs';
						document.getElementById('csv-upload-input').click();
						break;
					case 'export-csv-btn': exportCurrentMonthToCSV(); break;
					case 'open-crc-event-modal':
						openModal(getCRCEventModalHTML(date), '4xl');
						break;
					case 'view-day-events': {
						const todaysEvents = state.crc_events.filter(event => event.date === date);
						openModal(getDayViewModalHTML(date, todaysEvents), 'lg');
						break;
					}
					case 'view-crc-event': {
						const event = state.crc_events.find(e => e.id === eventId);
						if (event) {
							let seriesStartDate = event.date;
							let seriesEndDate = event.date;

							if (event.groupId) {
								const seriesEvents = state.crc_events.filter(e => e.groupId === event.groupId);
								if (seriesEvents.length > 0) {
									const dates = seriesEvents.map(e => new Date(e.date + 'T00:00:00'));
									seriesStartDate = new Date(Math.min.apply(null, dates)).toISOString().split('T')[0];
									seriesEndDate = new Date(Math.max.apply(null, dates)).toISOString().split('T')[0];
								}
							}
							openModal(getCRCEventModalHTML(event.date, event, seriesStartDate, seriesEndDate), '4xl');
						}
						break;
					}
					case 'split-shift': {
						const eventToSplit = state.crc_events.find(e => e.id === eventId);
						if (!eventToSplit) {
							showNotification('Error: Could not find the event to split.', 'error');
							return;
						}

						const originalHours = parseFloat(eventToSplit.hours) || 8;
						const splitHours = originalHours / 2;

						try {
							// 1. Update the original event to be the AM part
							await updateDoc(doc(getCollectionRef("crc_events"), eventId), {
								period: 'AM',
								hours: splitHours
							});

							// 2. Prepare a template for the new PM event.
							const pmEventTemplate = {
								...eventToSplit, // Copy all original data
								id: null, // Ensure it's treated as a new event
								groupId: null, // Don't link it to the old series
								period: 'PM',
								hours: splitHours
							};

							// 3. Re-open the modal to create the PM part
							closeModal();
							setTimeout(() => {
								openModal(getCRCEventModalHTML(pmEventTemplate.date, pmEventTemplate), '4xl');
								
								// Adjust modal for clarity since we are reusing the form
								setTimeout(() => {
									handleEventTypeChange(document.getElementById('crc-event-type'));
									const modalTitle = modalContainer.querySelector('h2');
									if (modalTitle) modalTitle.textContent = 'Create PM Half of Split Shift';
								}, 100);
							}, 150);
							
							showNotification('Shift split. Please confirm or edit details for the PM shift.', 'info');

						} catch (err) {
							console.error("Error splitting shift:", err);
							showNotification('Failed to split shift.', 'error');
						}
						break;
					}
					case 'set-unavailability': {
						const crcId = state.selectedCrcForUnavailability;
						if (!crcId) return;

						const existingEvent = eventId ? state.crc_events.find(e => e.id === eventId) : null;
						const currentPeriod = existingEvent ? (existingEvent.period || 'Full Day') : 'Available';

						let nextPeriod, nextHours;
						let operation = existingEvent ? 'update' : 'add';

						if (currentPeriod === 'Available') {
							nextPeriod = 'Full Day';
							nextHours = 8;
						} else if (currentPeriod === 'Full Day') {
							nextPeriod = 'AM';
							nextHours = 4;
						} else if (currentPeriod === 'AM') {
							nextPeriod = 'PM';
							nextHours = 4;
						} else {
							operation = 'delete';
						}
						
						try {
							if (operation === 'delete') {
								await deleteDoc(doc(getCollectionRef("crc_events"), eventId));
							} else {
								const eventData = {
									crcId: crcId,
									date: date,
									type: 'Unavailable',
									hours: nextHours,
									period: nextPeriod,
								};
								if (existingEvent) {
									await updateDoc(doc(getCollectionRef("crc_events"), eventId), eventData);
								} else {
									await addDoc(getCollectionRef("crc_events"), eventData);
								}
							}
							showNotification('Unavailability updated.', 'success');
						} catch(err) {
							console.error("Error updating unavailability:", err);
							showNotification('Failed to update unavailability.', 'error');
						}
						break;
					}
					case 'delete-crc': await deleteDoc(doc(getCollectionRef("crcs"), id)); break;
					case 'delete-crc-site': await deleteDoc(doc(getCollectionRef("crc_sites"), id)); break;
					case 'delete-study': await deleteDoc(doc(getCollectionRef("studies"), id)); break;
					case 'delete-crc-event': {
						if (groupId) {
							openModal(`
								<h3 class="text-xl font-bold dark:text-white mb-4">Delete Event Series</h3>
								<p class="dark:text-gray-300 mb-6">This event is part of a series. Do you want to delete only this single event or the entire series?</p>
								<div class="flex justify-end gap-4">
									<button data-action="close-modal" class="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
									<button data-action="delete-single-event" data-event-id="${eventId}" class="py-2 px-4 rounded-md bg-red-600 text-white hover:bg-red-700">Delete Just This One</button>
									<button data-action="delete-event-series" data-group-id="${groupId}" class="py-2 px-4 rounded-md bg-red-800 text-white hover:bg-red-900">Delete Entire Series</button>
								</div>
							`);
						} else {
							await deleteDoc(doc(getCollectionRef("crc_events"), eventId));
							closeModal();
						}
						break;
					}
					case 'delete-single-event': {
						await deleteDoc(doc(getCollectionRef("crc_events"), eventId));
						closeModal();
						break;
					}
					case 'delete-event-series': {
						const q = query(getCollectionRef("crc_events"), where("groupId", "==", groupId));
						const querySnapshot = await getDocs(q);
						const batch = writeBatch(db);
						querySnapshot.forEach((doc) => batch.delete(doc.ref));
						await batch.commit();
						closeModal();
						break;
					}
					case 'view-crc-profile': {
						const crc = state.crcs.find(c => c.id === id);
						if (crc) openModal(getCRCProfileModalHTML(crc), '4xl');
						break;
					}
					case 'edit-crc-site': {
						const site = state.crc_sites.find(s => s.id === id);
						if (site) openModal(getEditSiteModalHTML(site), 'lg');
						break;
					}
					case 'edit-study': {
						const study = state.studies.find(s => s.id === id);
						if (study) openModal(getEditStudyModalHTML(study), 'lg');
						break;
					}
					case 'update-single-event': {
						const eventData = {
							type: tempEventData.eventType,
							crcId: tempEventData.eventType === 'Open Shift' ? null : tempEventData.crcId,
							siteId: (tempEventData.eventType === 'Site Assignment' || tempEventData.eventType === 'Travel Day' || tempEventData.eventType === 'Open Shift') ? tempEventData.siteId : null,
							studyIds: tempEventData.studyIds || [],
							roles: tempEventData.roles || [],
							hours: parseFloat(tempEventData.hours) || state.settings[tempEventData.eventType] || 8,
							notes: tempEventData.notes || '',
							date: tempEventData.startDate,
							period: (tempEventData.eventType === 'Unavailable' || tempEventData.eventType === 'Paid Time Off') ? tempEventData.period : null,
							groupId: null, // Make it independent
							visitNumber: tempEventData.visitNumber || null,
							principalInvestigator: tempEventData.principalInvestigator || null,
							mileage: tempEventData.mileage ? parseFloat(tempEventData.mileage) : null,
							isOverridden: tempEventData.isOverridden || false,
						};
						await updateDoc(doc(getCollectionRef("crc_events"), eventId), eventData);
						closeModal();
						break;
					}
					case 'update-event-series': {
						const q = query(getCollectionRef("crc_events"), where("groupId", "==", groupId));
						const querySnapshot = await getDocs(q);
						const deleteBatch = writeBatch(db);
						querySnapshot.forEach((doc) => deleteBatch.delete(doc.ref));
						await deleteBatch.commit();

						const createBatch = writeBatch(db);
						const startDate = new Date(tempEventData.startDate + 'T00:00:00');
						const endDate = tempEventData.endDate ? new Date(tempEventData.endDate + 'T00:00:00') : new Date(startDate);
						let currentDate = new Date(startDate);
						const crcEventsRef = getCollectionRef("crc_events");

						const eventData = {
							type: tempEventData.eventType,
							crcId: tempEventData.eventType === 'Open Shift' ? null : tempEventData.crcId,
							siteId: (tempEventData.eventType === 'Site Assignment' || tempEventData.eventType === 'Travel Day' || tempEventData.eventType === 'Open Shift') ? tempEventData.siteId : null,
							studyIds: tempEventData.studyIds || [],
							roles: tempEventData.roles || [],
							hours: parseFloat(tempEventData.hours) || state.settings[tempEventData.eventType] || 8,
							notes: tempEventData.notes || '',
							period: (tempEventData.eventType === 'Unavailable' || tempEventData.eventType === 'Paid Time Off') ? tempEventData.period : null,
							visitNumber: tempEventData.visitNumber || null,
							principalInvestigator: tempEventData.principalInvestigator || null,
							mileage: tempEventData.mileage ? parseFloat(tempEventData.mileage) : null,
							isOverridden: tempEventData.isOverridden || false,
						};

						while (currentDate <= endDate) {
							const dateStr = currentDate.toISOString().split('T')[0];
							const newEventRef = doc(crcEventsRef);
							createBatch.set(newEventRef, {
								...eventData,
								groupId,
								date: dateStr,
							});
							currentDate.setDate(currentDate.getDate() + 1);
						}
						await createBatch.commit();
						closeModal();
						break;
					}
					case 'generate-crc-report': {
						const crcId = document.getElementById('report-crc-filter').value;
						const siteId = document.getElementById('report-site-filter').value;
						const studyId = document.getElementById('report-study-filter').value;
						const region = document.getElementById('report-region-filter').value;
						const eventType = document.getElementById('report-event-type-filter').value;

						let filteredEvents = state.crc_events;

						if (crcId !== 'all') {
							filteredEvents = filteredEvents.filter(event => event.crcId === crcId);
						}
						if (siteId !== 'all') {
							filteredEvents = filteredEvents.filter(event => event.siteId === siteId);
						}
						if (studyId !== 'all') {
							filteredEvents = filteredEvents.filter(event => (event.studyIds || []).includes(studyId));
						}
						if (region !== 'all') {
							const crcsInRegion = state.crcs.filter(c => c.region === region).map(c => c.id);
							filteredEvents = filteredEvents.filter(event => crcsInRegion.includes(event.crcId));
						}
						if (eventType !== 'all') {
							filteredEvents = filteredEvents.filter(event => event.type === eventType);
						}

						const resultsContainer = document.getElementById('report-results-container');
						if (filteredEvents.length > 0) {
							resultsContainer.innerHTML = `
								<table class="w-full text-left text-sm mt-4">
									<thead class="bg-gray-100 dark:bg-gray-700">
										<tr>
											<th class="py-2 px-4">Date</th>
											<th class="py-2 px-4">CRC</th>
											<th class="py-2 px-4">Region</th>
											<th class="py-2 px-4">Event Type (Shift)</th>
											<th class="py-2 px-4">Site</th>
											<th class="py-2 px-4">Study</th>
											<th class="py-2 px-4">Hours</th>
										</tr>
									</thead>
									<tbody>
										${filteredEvents.map(event => {
											const crc = state.crcs.find(c => c.id === event.crcId) || {};
											const site = state.crc_sites.find(s => s.id === event.siteId) || {};
											const studies = (event.studyIds || []).map(id => state.studies.find(s => s.id === id)?.name).join(', ');
											return `
												<tr class="border-b dark:border-gray-700">
													<td class="py-2 px-4">${event.date}</td>
													<td class="py-2 px-4">${crc.name || 'N/A'}</td>
													<td class="py-2 px-4">${crc.region || 'N/A'}</td>
													<td class="py-2 px-4">${event.type}</td>
													<td class="py-2 px-4">${site.name || 'N/A'}</td>
													<td class="py-2 px-4">${studies || 'N/A'}</td>
													<td class="py-2 px-4">${event.hours || 'N/A'}</td>
												</tr>
											`;
										}).join('')}
									</tbody>
								</table>
							`;
						} else {
							resultsContainer.innerHTML = '<p class="mt-4 text-gray-500 dark:text-gray-400">No events found for the selected criteria.</p>';
						}
						break;
					}
				}
			});
			
			document.addEventListener('submit', async (e) => {
				e.preventDefault();
				const form = e.target;
				const formData = new FormData(form);
				const data = Object.fromEntries(formData.entries());
				const getCollectionRef = (name) => collection(db, `artifacts/${appId}/public/data/${name}`);

				switch (form.id) {
					case 'add-crc-form': {
						try {
							await addDoc(getCollectionRef("crcs"), {
								name: data.crcName,
								homeLocation: data.crcLocation,
								region: data.crcRegion,
								trainings: [],
								capabilities: [],
								trainingLevel: ''
							});
							showNotification('CRC added successfully!', 'success');
							form.reset();
						} catch (error) {
							console.error("Error adding CRC:", error);
							showNotification('Failed to add CRC. See console for details.', 'error');
						}
						break;
					}
					case 'add-crc-site-form': {
						try {
							await addDoc(getCollectionRef("crc_sites"), { name: data.crcSiteName, address: data.crcSiteAddress, principalInvestigator: data.crcSitePI });
							showNotification('Site added successfully!', 'success');
							form.reset();
						} catch (error) {
							console.error("Error adding site:", error);
							showNotification('Failed to add site. See console for details.', 'error');
						}
						break;
					}
					case 'add-study-form': {
						try {
							await addDoc(getCollectionRef("studies"), { name: data.studyName });
							showNotification('Study added successfully!', 'success');
							form.reset();
						} catch (error) {
							console.error("Error adding study:", error);
							showNotification('Failed to add study. See console for details.', 'error');
						}
						break;
					}
					case 'crc-event-form': {
						const eventId = form.dataset.eventId;
						const isEditing = !!eventId;
						const errorMessageDiv = document.getElementById('form-error-message');
						if (errorMessageDiv) errorMessageDiv.textContent = '';

						const eventType = data.eventType;
						const crcIds = formData.getAll('crcId');
						const studyIds = formData.getAll('studyIds');
						const roles = formData.getAll('roles');

						// Validation
						if ((eventType === 'Site Assignment' || eventType === 'Travel Day' || eventType === 'Paid Time Off' || eventType === 'Unavailable') && crcIds.length === 0) {
							if (errorMessageDiv) errorMessageDiv.textContent = 'At least one CRC must be selected for this event type.';
							return;
						}
						// More validation...

						// Unavailability Override Check
						let isOverriding = false;
						for (const crcId of crcIds) {
							const crcOption = form.querySelector(`select[name="crcId"] option[value="${crcId}"]`);
							if (crcOption && crcOption.textContent.includes('(Unavailable)')) {
								isOverriding = true;
								break;
							}
						}

						const processSubmit = async (confirmedOverride = false) => {
							try {
								const eventData = {
									type: data.eventType,
									siteId: data.siteId || null,
									studyIds: studyIds,
									roles: roles,
									hours: parseFloat(data.hours) || state.settings[data.eventType] || 8,
									notes: data.notes || '',
									period: data.period || null,
									visitNumber: data.visitNumber || null,
									principalInvestigator: data.principalInvestigator || null,
									mileage: data.mileage ? parseFloat(data.mileage) : null,
									isOverridden: confirmedOverride,
								};

								if (isEditing) {
									// Handle editing logic (single vs series)
									// This part is complex and reuses logic from the click handler, simplified here
									await updateDoc(doc(getCollectionRef("crc_events"), eventId), { ...eventData, crcId: crcIds[0] });
								} else {
									// Handle creating new events
									const groupId = crypto.randomUUID();
									const batch = writeBatch(db);
									const crcEventsRef = getCollectionRef("crc_events");
									const startDate = new Date(data.startDate + 'T00:00:00');
									const endDate = data.endDate ? new Date(data.endDate + 'T00:00:00') : new Date(startDate);

									const targetCrcs = eventType === 'Open Shift' ? [null] : crcIds;

									for (const crcId of targetCrcs) {
										let currentDate = new Date(startDate);
										while (currentDate <= endDate) {
											const dateStr = currentDate.toISOString().split('T')[0];
											const newEventRef = doc(crcEventsRef);
											batch.set(newEventRef, {
												...eventData,
												crcId: crcId,
												date: dateStr,
												groupId,
											});
											currentDate.setDate(currentDate.getDate() + 1);
										}
									}
									await batch.commit();
								}
								closeModal();
								showNotification(isEditing ? 'Shift updated!' : 'Shift(s) created!', 'success');
							} catch (err) {
								console.error("Error submitting form:", err);
								showNotification('An error occurred.', 'error');
							}
						};

						if (isOverriding) {
							openModal(`
								<h3 class="text-xl font-bold text-yellow-500 mb-4">Unavailability Override</h3>
								<p class="dark:text-gray-300 mb-6">You are scheduling one or more CRCs on a day they marked as unavailable. Are you sure you want to proceed?</p>
								<div class="flex justify-end gap-4">
									<button data-action="close-modal" class="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Cancel</button>
									<button id="confirm-override-btn" class="py-2 px-4 rounded-md bg-yellow-600 text-white hover:bg-yellow-700">Confirm & Schedule</button>
								</div>
							`);
							document.getElementById('confirm-override-btn').onclick = () => processSubmit(true);
						} else {
							processSubmit(false);
						}
						break;
					}
					case 'edit-crc-form': {
						const crcId = form.dataset.id;
						const crc = state.crcs.find(c => c.id === crcId);
						if (crc) {
							await updateDoc(doc(getCollectionRef("crcs"), crcId), {
								...crc,
								name: data.name,
								homeLocation: data.homeLocation,
								region: data.region,
								trainingLevel: data.trainingLevel,
								capabilities: data.capabilities.split(',').map(s => s.trim()).filter(Boolean),
							});
						}
						closeModal();
						break;
					}
					case 'edit-crc-site-form': {
						const siteId = form.dataset.id;
						await updateDoc(doc(getCollectionRef("crc_sites"), siteId), {
							name: data.crcSiteName,
							address: data.crcSiteAddress,
							principalInvestigator: data.crcSitePI
						});
						closeModal();
						break;
					}
					case 'edit-study-form': {
						const studyId = form.dataset.id;
						await updateDoc(doc(getCollectionRef("studies"), studyId), { name: data.studyName });
						closeModal();
						break;
					}
					case 'add-training-form': {
						const crcId = form.dataset.id;
						const crc = state.crcs.find(c => c.id === crcId);
						const newTraining = {
							name: data.trainingName,
							completionDate: data.completionDate,
							expirationDate: data.expirationDate
						};
						const updatedTrainings = [...(crc.trainings || []), newTraining];
						await updateDoc(doc(getCollectionRef("crcs"), crcId), { trainings: updatedTrainings });
						
						const updatedCrc = {...crc, trainings: updatedTrainings};
						openModal(getCRCProfileModalHTML(updatedCrc), '4xl');
						break;
					}
				}
			});

			document.addEventListener('change', (e) => {
				const target = e.target;
				if (target.id === 'crc-event-type') {
					handleEventTypeChange(target);
				}
				if (target.id === 'crc-filter') {
					setState({ selectedCrcFilter: target.value });
				}
				if (target.id === 'site-filter') {
					setState({ selectedSiteFilter: target.value });
				}
				if (target.id === 'region-filter') {
					setState({ selectedRegionFilter: target.value });
				}
				if (target.id === 'unavailability-crc-select') {
					setState({ selectedCrcForUnavailability: target.value });
					renderUnavailabilityCalendar();
				}
			});
			
			// --- INITIALIZATION ---
			const setupRealtimeListeners = () => {
				const collectionsToWatch = ["crcs", "crc_sites", "studies", "crc_events"];
				collectionsToWatch.forEach(colName => {
					const collectionRef = collection(db, `artifacts/${appId}/public/data/${colName}`);
					onSnapshot(collectionRef, (snapshot) => {
						const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
						if (data.length > 0 && data[0].name) {
							data.sort((a, b) => a.name.localeCompare(b.name));
						}
						setState({ [colName]: data });
						
						if (colName === 'crc_events' && document.getElementById('unavailability-calendar-container')) {
							renderUnavailabilityCalendar();
						}

					}, (error) => {
						console.error(`Realtime listener error for ${colName}:`, error);
					});
				});
			};
			
			const performInitialLoad = async () => {
				loadingMessage.textContent = 'Loading data from database...';

				const collectionsToFetch = {
					crcs: collection(db, `artifacts/${appId}/public/data/crcs`),
					crc_sites: collection(db, `artifacts/${appId}/public/data/crc_sites`),
					studies: collection(db, `artifacts/${appId}/public/data/studies`),
					crc_events: collection(db, `artifacts/${appId}/public/data/crc_events`),
				};

				try {
					const [crcsSnapshot, sitesSnapshot, studiesSnapshot, eventsSnapshot] = await Promise.all([
						getDocs(collectionsToFetch.crcs),
						getDocs(collectionsToFetch.crc_sites),
						getDocs(collectionsToFetch.studies),
						getDocs(collectionsToFetch.crc_events),
					]);

					const crcs = crcsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
					const crc_sites = sitesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
					const studies = studiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
					const crc_events = eventsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
					
					if (crcs.length > 0 && crcs[0].name) crcs.sort((a, b) => a.name.localeCompare(b.name));
					if (crc_sites.length > 0 && crc_sites[0].name) crc_sites.sort((a, b) => a.name.localeCompare(b.name));
					if (studies.length > 0 && studies[0].name) studies.sort((a, b) => a.name.localeCompare(b.name));

					setState({
						crcs,
						crc_sites,
						studies,
						crc_events,
						initialLoadComplete: true
					});
					
					setupRealtimeListeners();

				} catch (error) {
					console.error("Error during initial data load:", error);
					loadingMessage.textContent = 'Data Load Error';
					loadingError.innerHTML = `<strong>Error:</strong> Could not fetch initial data from the database. This is often caused by Firestore Security Rules. Ensure that the path <code>/artifacts/${appId}/public/data/{document=**}</code> is readable.`;
				}
			};

			const setupThemeToggle = () => {
				const themeToggle = document.getElementById('theme-toggle');
				themeToggle.addEventListener('click', () => {
					if (document.documentElement.classList.contains('dark')) {
						document.documentElement.classList.remove('dark');
						localStorage.setItem('theme', 'light');
					} else {
						document.documentElement.classList.add('dark');
						localStorage.setItem('theme', 'dark');
					}
					lucide.createIcons();
				});
			};

			const init = async () => {
				lucide.createIcons();
				setupThemeToggle();
				
				document.getElementById('back-to-dashboard').addEventListener('click', (e) => {
					e.preventDefault();
					window.location.href = 'index.html';
				});
				
				const csvInput = document.getElementById('csv-upload-input');
				csvInput.addEventListener('change', (e) => {
					if (e.target.files[0]) {
						const uploadType = e.target.dataset.uploadType || 'shifts';
						closeModal();
						handleCsvUpload(e.target.files[0], uploadType);
						delete e.target.dataset.uploadType; // Reset after use
					}
					e.target.value = '';
				});


				onAuthStateChanged(auth, (user) => {
					if (user) {
						if (!state.authReady) {
							state.authReady = true;
							state.userId = user.uid;
							performInitialLoad();
						}
					} else {
						loadingMessage.textContent = 'Not Signed In';
						loadingError.textContent = 'Please sign in to use the scheduler.';
					}
				});

				try {
					loadingMessage.textContent = 'Authenticating...';
					const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
					if (token) {
						await signInWithCustomToken(auth, token);
					} else {
						await signInAnonymously(auth);
					}
				} catch (error) {
					console.error("Authentication failed:", error);
					loadingMessage.textContent = 'Authentication Error';
					loadingError.innerHTML = `<strong>Error:</strong> Could not authenticate with the database.<br><small>${error.message}</small>`;
				}
			};

			/// --- START THE APP ---
			init();

		})();
	</script>
</body>
</html>
