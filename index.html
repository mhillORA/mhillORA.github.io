<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.A.S.A. - Not Another Scheduling Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .calendar-day { min-height: 120px; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white p-4 border-r border-gray-200 h-screen sticky top-0 flex flex-col">
            <div class="flex items-center mb-8">
                <div id="logo-container" class="h-10 w-10"></div>
                <h1 class="text-xl font-bold ml-2 text-gray-800">N.A.S.A.</h1>
            </div>
            <nav id="nav-menu" class="space-y-2 flex-grow">
                <!-- Nav items will be injected by JS -->
            </nav>
            <div class="border-t pt-4">
                <p class="text-xs text-gray-500 px-4">Not Another Scheduling Application</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-8 bg-gray-50">
            <!-- Content will be injected by JS -->
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex justify-center items-center p-4"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- YOUR LIVE FIREBASE CONFIGURATION ---
        const firebaseConfig = {
           apiKey: "AIzaSyCJYn2wp6Vrlz-DVMwyZwsHrXSJJrXL3f0",
           authDomain: "nasa-27896.firebaseapp.com",
           projectId: "nasa-27896",
           storageBucket: "nasa-27896.appspot.com",
           messagingSenderId: "407765833759",
           appId: "1:407765833759:web:cef776a5e24a6fa92e5d2a",
           measurementId: "G-JXT99BHXMQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DATA STORE (Now fetched from Firebase) ---
        let state = {
            activeTab: 'dashboard',
            patientSearchTerm: '',
            schedulingView: 'creator',
            calendarDate: new Date(),
            studies: [],
            patients: [],
            sites: [],
            surveys: [],
            schedules: [],
        };
        
        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const navMenu = document.getElementById('nav-menu');
        const modalContainer = document.getElementById('modal-container');

        // --- RENDER & STATE MANAGEMENT ---
        const setState = (newState) => {
            state = { ...state, ...newState };
            render();
        };

        const render = () => {
            renderNav();
            renderContent();
            lucide.createIcons();
        };

        const renderNav = () => {
             const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'activity' },
                { id: 'studies', label: 'Studies', icon: 'file-text' },
                { id: 'patients', label: 'Patients', icon: 'users' },
                { id: 'sites', label: 'Sites', icon: 'building' },
                { id: 'surveys', label: 'Surveys', icon: 'clipboard-list' },
                { id: 'scheduling', label: 'Scheduling', icon: 'calendar' },
                { id: 'reporting', label: 'Reporting', icon: 'trending-up' },
            ];
            navMenu.innerHTML = navItems.map(item => `<button data-tab="${item.id}" class="nav-item w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors ${state.activeTab === item.id ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'}"><i data-lucide="${item.icon}" class="w-5 h-5"></i><span class="ml-3">${item.label}</span></button>`).join('');
        };

        const renderContent = () => {
            const contentMap = {
                dashboard: getDashboardHTML,
                studies: getStudiesHTML,
                patients: getPatientsHTML,
                sites: getSitesHTML,
                surveys: getSurveysHTML,
                scheduling: getSchedulingHTML,
                reporting: getReportingHTML,
            };
            mainContent.innerHTML = contentMap[state.activeTab]();
            if (state.activeTab === 'dashboard') renderDashboardChart();
            if (state.activeTab === 'surveys' && !document.getElementById('questions-container')?.children.length) addQuestionToSurveyForm();
            if (state.activeTab === 'scheduling' && state.schedulingView === 'calendar') renderCalendar();
        };

        // --- MODAL HANDLING ---
        const openModal = (content) => {
            modalContainer.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl relative max-h-full overflow-y-auto"><button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>${content}</div>`;
            modalContainer.classList.remove('hidden');
            lucide.createIcons();
        };

        const closeModal = () => {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        };

        // --- HTML GETTERS FOR EACH PAGE ---
        const getDashboardHTML = () => {
            const totalEnrolled = state.studies.reduce((sum, study) => sum + (study.enrolled || 0), 0);
            const recruitingStudies = state.studies.filter(s => s.status === 'Recruiting').length;
            const totalPatients = state.patients.length;
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-blue-500"><i data-lucide="users" class="text-white"></i></div><div><p class="text-sm text-gray-500">Total Patients Enrolled</p><p class="text-2xl font-bold">${totalEnrolled}</p></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-green-500"><i data-lucide="file-text" class="text-white"></i></div><div><p class="text-sm text-gray-500">Active Recruiting Studies</p><p class="text-2xl font-bold">${recruitingStudies}</p></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-indigo-500"><i data-lucide="users" class="text-white"></i></div><div><p class="text-sm text-gray-500">Potential Candidates</p><p class="text-2xl font-bold">${totalPatients}</p></div></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 mb-4">Recruitment Funnel</h3><div id="chart-container" style="width: 100%; height: 300px;"></div></div>`;
        };
        
        const getStudiesHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Clinical Studies</h2>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Enrollment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${state.studies.map(study => `<tr><td class="px-6 py-4">${study.title}</td><td class="px-6 py-4">${study.status}</td><td class="px-6 py-4">${study.enrolled} / ${study.target}</td><td class="px-6 py-4"><button data-action="edit-study" data-id="${study.id}" class="text-blue-600 hover:underline">Edit</button></td></tr>`).join('')}</tbody>
                </table>
            </div>`;

        const getPatientsHTML = () => {
            const filteredPatients = state.patients.filter(p => p.name.toLowerCase().includes(state.patientSearchTerm.toLowerCase()));
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Patients</h2>
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="patient-search" value="${state.patientSearchTerm}" class="p-2 border rounded-md md:col-span-2" placeholder="Search patients by name...">
                    <button data-action="quick-add-patient-modal" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Quick Add Patient</button>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Appointment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">${filteredPatients.map(p => `<tr><td class="px-6 py-4"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 hover:underline font-medium">${p.name}</button></td><td class="px-6 py-4">${state.sites.find(s => s.id === p.siteId)?.name}</td><td class="px-6 py-4">${state.studies.find(s => s.id === p.studyId)?.title}</td><td class="px-6 py-4">${p.appointment ? new Date(p.appointment.time).toLocaleString() : 'Not Scheduled'}</td><td class="px-6 py-4"><button data-action="schedule-patient" data-id="${p.id}" ${p.appointment ? 'disabled' : ''} class="text-blue-600 hover:underline disabled:text-gray-400 disabled:no-underline">Schedule</button></td></tr>`).join('')}</tbody>
                    </table>
                </div>`;
        };
        
        const getSitesHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Clinical Sites</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Add New Site</h3>
                <form id="add-site-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label for="siteName" class="block text-sm font-medium text-gray-700">Site Name</label><input type="text" id="siteName" name="siteName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="e.g., Andover"></div>
                    <div><label for="siteLocation" class="block text-sm font-medium text-gray-700">Location</label><input type="text" id="siteLocation" name="siteLocation" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="e.g., Andover, MA"></div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center justify-center h-10"><i data-lucide="plus-circle" class="mr-2"></i> Add Site</button>
                </form>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <h3 class="text-xl font-semibold text-gray-700 p-6">Current Sites</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${state.sites.map(site => `<tr><td class="px-6 py-4">${site.name}</td><td class="px-6 py-4">${site.location}</td></tr>`).join('')}</tbody>
                </table>
            </div>`;

        const getSurveysHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Surveys with Branching Logic</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Create New Survey</h3>
                <form id="survey-creator-form" class="space-y-6">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div><label class="block text-sm font-medium text-gray-700">Survey Title</label><input type="text" name="title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., Patient Intake Survey" required /></div>
                        <div><label class="block text-sm font-medium text-gray-700">Assign to Study</label><select name="studyId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white" required><option value="" disabled selected>Select a study</option>${state.studies.map(study => `<option value="${study.id}">${study.title}</option>`).join('')}</select></div>
                    </div>
                    <div id="questions-container" class="space-y-4"></div>
                    <button type="button" data-action="add-question" class="text-sm font-medium text-blue-600 p-2 hover:bg-blue-50 rounded-md">+ Add Question</button>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Create Survey</button>
                </form>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <h3 class="text-xl font-semibold text-gray-700 p-6">Existing Surveys</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                    <tbody>${state.surveys.map(s => `<tr><td class="px-6 py-4">${s.title}</td><td class="px-6 py-4">${state.studies.find(study => study.id == s.studyId)?.title}</td><td class="px-6 py-4"><button data-action="view-survey" data-id="${s.id}" class="text-blue-600 hover:underline">View Survey</button></td></tr>`).join('')}${state.surveys.length === 0 ? `<tr><td colspan="3" class="text-center text-gray-500 py-8">No surveys created yet.</td></tr>` : ''}</tbody>
                </table>
            </div>`;
        
        const getReportingHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Reporting</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Generate Report</h3>
                <form id="report-filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <select name="studyId" class="p-2 border rounded"><option value="all">All Studies</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select>
                    <select name="siteId" class="p-2 border rounded"><option value="all">All Sites</option>${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                    <input type="text" name="status" placeholder="Filter by Status (e.g., Enrolled)" class="p-2 border rounded"/>
                    <input type="date" name="startDate" class="p-2 border rounded"/>
                    <input type="date" name="endDate" class="p-2 border rounded"/>
                    <button type="submit" class="bg-blue-600 text-white rounded-md md:col-span-2 lg:col-span-1">Generate</button>
                </form>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <h3 class="text-xl font-semibold text-gray-700 p-6">Report Results</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Appointment Date</th></tr></thead>
                        <tbody id="report-results-body"><tr><td colspan="5" class="text-center text-gray-500 py-8">Generate a report to see results.</td></tr></tbody>
                    </table>
                </div>
            </div>`;
        
        const getSchedulingHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Scheduling</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Create Appointment Schedule</h3>
                <form id="schedule-creator-form" class="space-y-4">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Site</label><select name="siteId" required class="mt-1 block w-full p-2 border rounded border-gray-300"><option value="">Select a Site</option>${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Study</label><select name="studyId" required class="mt-1 block w-full p-2 border rounded border-gray-300"><option value="">Select a Study</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" name="startDate" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                        <div><label class="block text-sm font-medium text-gray-700">End Date</label><input type="date" name="endDate" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                    </div>
                    <div><label class="font-medium">Days of the Week</label><div class="flex gap-2 mt-1">${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `<button type="button" data-day="${i}" class="day-btn p-2 rounded border w-12 bg-gray-200">${day}</button>`).join('')}</div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                         <div><label class="block text-sm font-medium text-gray-700">Start Time</label><input type="time" name="startTime" value="09:00" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                         <div><label class="block text-sm font-medium text-gray-700">End Time</label><input type="time" name="endTime" value="17:00" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                         <div><label class="block text-sm font-medium text-gray-700">Duration (mins)</label><input type="number" name="duration" value="60" required placeholder="e.g., 60" class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                         <div><label class="block text-sm font-medium text-gray-700">Capacity</label><input type="number" name="capacity" value="1" required placeholder="e.g., 1" class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Generate Schedule</button>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Generated Schedules</h3>
                <div id="schedules-list" class="space-y-4">${state.schedules.length === 0 ? '<p class="text-center text-gray-500 py-8">No schedules created yet.</p>' : state.schedules.map(s => `<div class="p-4 border rounded-lg"><h4 class="font-bold">${state.studies.find(study => study.id == s.studyId)?.title} at ${state.sites.find(site => site.id == s.siteId)?.name}</h4><p>${s.slots.length} total slots available.</p></div>`).join('')}</div>
            </div>`;
        
        // --- EVENT HANDLERS ---
        document.addEventListener('click', (e) => {
            const navButton = e.target.closest('.nav-item');
            if (navButton) {
                setState({ activeTab: navButton.dataset.tab });
            }

            const dayButton = e.target.closest('.day-btn');
            if (dayButton) {
                dayButton.classList.toggle('bg-blue-500');
                dayButton.classList.toggle('text-white');
                dayButton.classList.toggle('bg-gray-200');
            }
            
            const actionButton = e.target.closest('button[data-action]');
            if (actionButton) {
                const { action, id } = actionButton.dataset;
                if (action === 'view-patient') {
                    // show patient profile modal
                } else if (action === 'schedule-patient') {
                    // show booking modal
                } else if (action === 'add-question') {
                    addQuestionToSurveyForm();
                } else if (action === 'add-option') {
                    addOptionToQuestion(actionButton.dataset.qId);
                } else if (action === 'remove-question') {
                    document.getElementById(actionButton.dataset.qId).remove();
                } else if (action === 'remove-option') {
                    actionButton.parentElement.remove();
                } else if (action === 'view-survey') {
                    // view survey modal
                } else if (action === 'close-modal') {
                    closeModal();
                }
            }
        });
        
        document.addEventListener('submit', async (e) => {
             e.preventDefault();
            if (e.target.id === 'schedule-creator-form') {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const days = {};
                e.target.querySelectorAll('.day-btn.bg-blue-500').forEach(btn => { days[btn.dataset.day] = true; });
                
                let slots = [];
                let currentDate = new Date(data.startDate + 'T00:00:00');
                const finalDate = new Date(data.endDate + 'T00:00:00');

                while (currentDate <= finalDate) {
                    const dayOfWeek = currentDate.getDay();
                    if (days[dayOfWeek]) {
                        const [startHour, startMinute] = data.startTime.split(':').map(Number);
                        const [endHour, endMinute] = data.endTime.split(':').map(Number);
                        let slotTime = new Date(currentDate);
                        slotTime.setHours(startHour, startMinute, 0, 0);
                        const endSlotTime = new Date(currentDate);
                        endSlotTime.setHours(endHour, endMinute, 0, 0);

                        while (slotTime < endSlotTime) {
                            slots.push({ id: `slot-${Date.now()}-${Math.random()}`, startTime: new Date(slotTime), booked: 0, capacity: parseInt(data.capacity) });
                            slotTime.setMinutes(slotTime.getMinutes() + parseInt(data.duration));
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                const newSchedule = { id: `sched-${Date.now()}`, siteId: parseInt(data.siteId), studyId: parseInt(data.studyId), slots: slots };
                await addDoc(collection(db, "schedules"), newSchedule);
                e.target.reset();
            }
        });

        // --- CHARTING ---
        const renderDashboardChart = () => {
            const container = document.getElementById('chart-container');
            if (!container || !window.Recharts || !window.React || !window.ReactDOM) return;
            
            const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;

            const element = React.createElement(ResponsiveContainer, { width: "100%", height: 300 },
                React.createElement(BarChart, { data: recruitmentData },
                    React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                    React.createElement(XAxis, { dataKey: "name" }),
                    React.createElement(YAxis),
                    React.createElement(Tooltip),
                    React.createElement(Legend),
                    React.createElement(Bar, { dataKey: "Screened", fill: "#8884d8" }),
                    React.createElement(Bar, { dataKey: "Enrolled", fill: "#82ca9d" })
                )
            );
            ReactDOM.render(element, container);
        };
        
        // --- SURVEY LOGIC ---
        const addQuestionToSurveyForm = () => {
            const container = document.getElementById('questions-container');
            if (!container) return;
            const qId = `q-${Date.now()}`;
            const questionHTML = `
                <div id="${qId}" class="p-4 border rounded-lg bg-gray-50 relative">
                    <button type="button" data-action="remove-question" data-q-id="${qId}" class="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
                    <label class="font-medium">Question ${container.children.length + 1}</label>
                    <input type="text" name="${qId}-text" class="w-full p-2 border rounded" placeholder="Question Text" required/>
                    <div class="mt-2 space-y-2 pl-4" data-options-for="${qId}">
                         <label class="text-sm font-medium text-gray-600">Options</label>
                         <!-- Options will be injected here -->
                    </div>
                    <button type="button" data-action="add-option" data-q-id="${qId}" class="text-sm text-blue-600 hover:underline mt-2">+ Add Option</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', questionHTML);
            addOptionToQuestion(qId); // Add one option by default
            lucide.createIcons();
        };

        const addOptionToQuestion = (qId) => {
            const optionsContainer = document.querySelector(`div[data-options-for="${qId}"]`);
            if (!optionsContainer) return;
            const optionHTML = `
                <div class="flex items-center gap-2">
                    <input type="text" name="${qId}-option-text" class="flex-grow p-2 border rounded" placeholder="Option Text" required/>
                    <input type="text" name="${qId}-option-next" class="w-48 p-2 border rounded" placeholder="Next Q# (e.g., 2) or 'submit'" required/>
                    <button type="button" data-action="remove-option" class="p-1 text-red-500 hover:bg-red-100 rounded-full"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                </div>
            `;
            optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
            lucide.createIcons();
        };
        
        // --- FIREBASE DATA INTERACTIONS ---
        const setupRealtimeListeners = () => {
            onSnapshot(collection(db, "studies"), (snapshot) => {
                state.studies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(collection(db, "patients"), (snapshot) => {
                state.patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(collection(db, "sites"), (snapshot) => {
                state.sites = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(collection(db, "schedules"), (snapshot) => {
                state.schedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
             onSnapshot(collection(db, "surveys"), (snapshot) => {
                state.surveys = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        };

        // --- INITIALIZATION ---
        const init = () => {
            document.getElementById('logo-container').innerHTML = `
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <circle cx="50" cy="50" r="48" fill="#3B82F6" />
                        <path d="M 5,60 C 40,85 60,85 95,60" stroke="#EF4444" strokeWidth="12" fill="none" strokeLinecap="round"/>
                        <circle cx="50" cy="50" r="22" fill="#1F2937" />
                        <circle cx="59" cy="41" r="7" fill="white" />
                    </g>
                </svg>
            `;
            setupRealtimeListeners();
        };

        window.onload = init;

    </script>
</body>
</html>
