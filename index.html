<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.A.S.A. - Not Another Scheduling Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // This configuration script MUST come BEFORE the main Tailwind CSS script.
        // It tells Tailwind to enable dark mode based on a 'dark' class in the HTML tag.
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .calendar-day {
            min-height: 120px;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: #f9fafb;
        }
        .dark .calendar-day:hover {
            background-color: #1f2937;
        }
        .appointment-slot {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .appointment-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* Custom scrollbar for modal content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
         .dark .modal-content::-webkit-scrollbar-track {
            background: #4b5563;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
    <script>
        // Apply theme as early as possible to prevent Flash of Unstyled Content (FOUC)
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div id="app-container" class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 p-4 border-r border-gray-200 dark:border-gray-700 h-screen sticky top-0 flex flex-col">
            <div class="flex items-center mb-8">
                <div id="logo-container" class="h-10 w-10"></div>
                <h1 class="text-xl font-bold ml-2 text-gray-800 dark:text-gray-200">N.A.S.A.</h1>
            </div>
            <nav id="nav-menu" class="space-y-2 flex-grow">
                <!-- Nav items will be injected by JS -->
            </nav>
            <div class="border-t dark:border-gray-700 pt-4 flex justify-between items-center">
                <p class="text-xs text-gray-500 dark:text-gray-400 px-4">Not Another Scheduling App</p>
                <button id="dark-mode-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <i id="dark-mode-icon" data-lucide="moon" class="w-5 h-5"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-8 bg-gray-50 dark:bg-gray-950">
            <!-- Content will be injected by JS -->
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex justify-center items-center p-4"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Use latest Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration (CORRECTED) ---
        // This now uses environment variables provided by the collaborative platform.
        // This is more secure and allows the app to work correctly.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // Fallback for local dev

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE & CONSTANTS ---
        let state = {
            authReady: false,
            userId: null,
            activeTab: 'dashboard',
            patientSearchTerm: '',
            schedulingView: 'calendar', // 'creator' or 'calendar'
            calendarDate: new Date(),
            studies: [],
            patients: [],
            sites: [],
            surveys: [],
            schedules: [],
            lastReportData: [], // To store data for CSV export
            currentSurveyState: null,
            currentPatientProfileTab: 'details', // 'details', 'contactLog', or 'surveyHistory'
            charts: {}, // To hold chart instances
        };

        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const navMenu = document.getElementById('nav-menu');
        const modalContainer = document.getElementById('modal-container');

        // --- THEME MANAGEMENT (Light/Dark Mode) ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            const iconElement = document.getElementById('dark-mode-icon');
            if (iconElement) {
                iconElement.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        };

        const toggleTheme = () => {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };

        // --- RENDER & STATE MANAGEMENT ---
        const setState = (newState) => {
            state = { ...state, ...newState };
            render();
        };

        const render = () => {
            if (!state.authReady) {
                 mainContent.innerHTML = `<div class="flex items-center justify-center h-full"><div class="text-gray-500 dark:text-gray-400">Authenticating...</div></div>`;
                return;
            }
            renderNav();
            renderContent();
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const renderNav = () => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'studies', label: 'Studies', icon: 'file-text' },
                { id: 'patients', label: 'Patients', icon: 'users' },
                { id: 'sites', label: 'Sites', icon: 'building' },
                { id: 'surveys', label: 'Surveys', icon: 'clipboard-list' },
                { id: 'scheduling', label: 'Scheduling', icon: 'calendar' },
                { id: 'reporting', label: 'Reporting', icon: 'trending-up' },
                { id: 'duplicates', label: 'Duplicates', icon: 'copy-x' },
            ];
            navMenu.innerHTML = navItems.map(item => `
                <button data-
