<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.A.S.A. - Not Another Scheduling Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .calendar-day { min-height: 120px; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white p-4 border-r border-gray-200 h-screen sticky top-0 flex flex-col">
            <div class="flex items-center mb-8">
                <div id="logo-container" class="h-10 w-10"></div>
                <h1 class="text-xl font-bold ml-2 text-gray-800">N.A.S.A.</h1>
            </div>
            <nav id="nav-menu" class="space-y-2 flex-grow">
                <!-- Nav items will be injected by JS -->
            </nav>
            <div class="border-t pt-4">
                <p class="text-xs text-gray-500 px-4">Not Another Scheduling Application</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-8 bg-gray-50">
            <!-- Content will be injected by JS -->
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex justify-center items-center p-4"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- YOUR LIVE FIREBASE CONFIGURATION ---
        const firebaseConfig = {
           apiKey: "AIzaSyCJYn2wp6Vrlz-DVMwyZwsHrXSJJrXL3f0",
           authDomain: "nasa-27896.firebaseapp.com",
           projectId: "nasa-27896",
           storageBucket: "nasa-27896.appspot.com",
           messagingSenderId: "407765833759",
           appId: "1:407765833759:web:cef776a5e24a6fa92e5d2a",
           measurementId: "G-JXT99BHXMQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DATA STORE (Now fetched from Firebase) ---
        let state = {
            activeTab: 'dashboard',
            patientSearchTerm: '',
            schedulingView: 'creator',
            calendarDate: new Date(),
            studies: [],
            patients: [],
            sites: [],
            surveys: [],
            schedules: [],
        };
        
        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const navMenu = document.getElementById('nav-menu');
        const modalContainer = document.getElementById('modal-container');

        // --- RENDER & STATE MANAGEMENT ---
        const setState = (newState) => {
            state = { ...state, ...newState };
            render();
        };

        const render = () => {
            renderNav();
            renderContent();
            lucide.createIcons();
        };

        const renderNav = () => {
             const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'activity' },
                { id: 'studies', label: 'Studies', icon: 'file-text' },
                { id: 'patients', label: 'Patients', icon: 'users' },
                { id: 'sites', label: 'Sites', icon: 'building' },
                { id: 'surveys', label: 'Surveys', icon: 'clipboard-list' },
                { id: 'scheduling', label: 'Scheduling', icon: 'calendar' },
                { id: 'reporting', label: 'Reporting', icon: 'trending-up' },
            ];
            navMenu.innerHTML = navItems.map(item => `<button data-tab="${item.id}" class="nav-item w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors ${state.activeTab === item.id ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'}"><i data-lucide="${item.icon}" class="w-5 h-5"></i><span class="ml-3">${item.label}</span></button>`).join('');
        };

        const renderContent = () => {
            const contentMap = {
                dashboard: getDashboardHTML,
                studies: getStudiesHTML,
                patients: getPatientsHTML,
                sites: getSitesHTML,
                surveys: getSurveysHTML,
                scheduling: getSchedulingHTML,
                reporting: getReportingHTML,
            };
            mainContent.innerHTML = contentMap[state.activeTab]();
            if (state.activeTab === 'surveys' && !document.getElementById('questions-container')?.children.length) addQuestionToSurveyForm();
            if (state.activeTab === 'scheduling' && state.schedulingView === 'calendar') renderCalendar();
        };

        // --- MODAL HANDLING ---
        const openModal = (content) => {
            modalContainer.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl relative max-h-full overflow-y-auto"><button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>${content}</div>`;
            modalContainer.classList.remove('hidden');
            lucide.createIcons();
        };

        const closeModal = () => {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        };

        // --- HTML GETTERS FOR EACH PAGE ---
        const getDashboardHTML = () => { /* ... (unchanged) ... */ return `Dashboard`; };
        const getStudiesHTML = () => { /* ... (unchanged) ... */ return `Studies`; };
        const getPatientsHTML = () => { /* ... (unchanged) ... */ return `Patients`; };
        const getSitesHTML = () => { /* ... (unchanged) ... */ return `Sites`; };
        const getSurveysHTML = () => { /* ... (unchanged) ... */ return `Surveys`; };
        const getSchedulingHTML = () => { /* ... (unchanged) ... */ return `Scheduling`; };
        const getReportingHTML = () => { /* ... (unchanged) ... */ return `Reporting`; };

        // --- EVENT HANDLERS ---
        document.addEventListener('click', async (e) => {
            const navButton = e.target.closest('.nav-item');
            if (navButton) {
                setState({ activeTab: navButton.dataset.tab });
            }

            const dayButton = e.target.closest('.day-btn');
            if (dayButton) {
                dayButton.classList.toggle('bg-blue-500');
                dayButton.classList.toggle('text-white');
                dayButton.classList.toggle('bg-gray-200');
            }
            
            const actionButton = e.target.closest('button[data-action]');
            if (actionButton) {
                const { action, id } = actionButton.dataset;
                if (action === 'view-patient') {
                    const patient = state.patients.find(p => p.id === id);
                    openModal(getPatientProfileHTML(patient));
                } else if (action === 'schedule-patient') {
                    const patient = state.patients.find(p => p.id === id);
                    openModal(getBookingModalHTML(patient));
                } else if (action === 'book-appointment') {
                    const { patientId, scheduleId, slotId } = actionButton.dataset;
                    const schedule = state.schedules.find(s => s.id === scheduleId);
                    const slot = schedule.slots.find(s => s.id === slotId);
                    slot.booked += 1;
                    
                    await updateDoc(doc(db, "schedules", scheduleId), { slots: schedule.slots });
                    await updateDoc(doc(db, "patients", patientId), { appointment: { scheduleId, slotId, time: slot.startTime } });
                    closeModal();
                } else if (action === 'quick-add-patient-modal') {
                    openModal(getQuickAddPatientHTML());
                } else if (action === 'add-question') {
                    addQuestionToSurveyForm();
                } else if (action === 'add-option') {
                    addOptionToQuestion(actionButton.dataset.qId);
                } else if (action === 'remove-question') {
                    document.getElementById(actionButton.dataset.qId).remove();
                } else if (action === 'remove-option') {
                    actionButton.parentElement.remove();
                } else if (action === 'view-survey') {
                    // view survey modal
                } else if (action === 'close-modal') {
                    closeModal();
                }
            }
        });
        
        document.addEventListener('submit', async (e) => {
             e.preventDefault();
            if (e.target.id === 'schedule-creator-form') {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const days = {};
                e.target.querySelectorAll('.day-btn.bg-blue-500').forEach(btn => { days[btn.dataset.day] = true; });
                
                let slots = [];
                let currentDate = new Date(data.startDate + 'T00:00:00');
                const finalDate = new Date(data.endDate + 'T00:00:00');

                while (currentDate <= finalDate) {
                    const dayOfWeek = currentDate.getDay();
                    if (days[dayOfWeek]) {
                        const [startHour, startMinute] = data.startTime.split(':').map(Number);
                        const [endHour, endMinute] = data.endTime.split(':').map(Number);
                        let slotTime = new Date(currentDate);
                        slotTime.setHours(startHour, startMinute, 0, 0);
                        const endSlotTime = new Date(currentDate);
                        endSlotTime.setHours(endHour, endMinute, 0, 0);

                        while (slotTime < endSlotTime) {
                            slots.push({ id: `slot-${Date.now()}-${Math.random()}`, startTime: slotTime.toISOString(), booked: 0, capacity: parseInt(data.capacity) });
                            slotTime.setMinutes(slotTime.getMinutes() + parseInt(data.duration));
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                const newSchedule = { siteId: parseInt(data.siteId), studyId: parseInt(data.studyId), slots: slots };
                await addDoc(collection(db, "schedules"), newSchedule);
                e.target.reset();
            } else if (e.target.id === 'add-site-form') {
                const formData = new FormData(e.target);
                const newSite = {
                    name: formData.get('siteName'),
                    location: formData.get('siteLocation'),
                };
                await addDoc(collection(db, "sites"), newSite);
                e.target.reset();
            } else if (e.target.id === 'quick-add-patient-form') {
                const formData = new FormData(e.target);
                const newPatient = {
                    name: formData.get('name'),
                    age: parseInt(formData.get('age')),
                    condition: formData.get('condition'),
                    status: formData.get('status'),
                    studyId: parseInt(formData.get('studyId')),
                    siteId: parseInt(formData.get('siteId')),
                    appointment: null,
                };
                await addDoc(collection(db, "patients"), newPatient);
                closeModal();
            }
        });

        // --- FIREBASE DATA INTERACTIONS ---
        const setupRealtimeListeners = () => {
            onSnapshot(collection(db, "studies"), (snapshot) => {
                state.studies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(collection(db, "patients"), (snapshot) => {
                state.patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(collection(db, "sites"), (snapshot) => {
                state.sites = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(collection(db, "schedules"), (snapshot) => {
                state.schedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
             onSnapshot(collection(db, "surveys"), (snapshot) => {
                state.surveys = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        };

        // --- INITIALIZATION ---
        const init = () => {
            document.getElementById('logo-container').innerHTML = `
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <circle cx="50" cy="50" r="48" fill="#3B82F6" />
                        <path d="M 5,60 C 40,85 60,85 95,60" stroke="#EF4444" strokeWidth="12" fill="none" strokeLinecap="round"/>
                        <circle cx="50" cy="50" r="22" fill="#1F2937" />
                        <circle cx="59" cy="41" r="7" fill="white" />
                    </g>
                </svg>
            `;
            setupRealtimeListeners();
        };

        window.onload = init;

    </script>
</body>
</html>
