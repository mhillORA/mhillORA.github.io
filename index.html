<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.A.S.A. - Not Another Scheduling Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // This configuration script MUST come BEFORE the main Tailwind CSS script.
        // It tells Tailwind to enable dark mode based on a 'dark' class in the HTML tag.
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Enhanced calendar styling */
        .calendar-day {
            min-height: 120px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.5rem;
            position: relative;
        }
        .calendar-day:hover {
            background-color: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .calendar-day:hover {
            background-color: #1f2937;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        /* Enhanced appointment slot styling */
        .appointment-slot {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.375rem;
            position: relative;
            overflow: hidden;
        }
        .appointment-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .appointment-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        /* Custom scrollbar for modal content */
        .modal-content::-webkit-scrollbar, .side-panel-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track, .side-panel-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dark .modal-content::-webkit-scrollbar-track, .dark .side-panel-content::-webkit-scrollbar-track {
            background: #4b5563;
        }
        .modal-content::-webkit-scrollbar-thumb, .side-panel-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover, .side-panel-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Styles for SVG Logo Inversion */
        .logo-bg { fill: #3B82F6; }
        .logo-swoosh { stroke: #EF4444; }
        .logo-inner-circle { fill: #1F2937; }
        .logo-dot { fill: white; }
        .dark .logo-bg { fill: #1E40AF; } /* Darker blue */
        .dark .logo-swoosh { stroke: #F87171; } /* Lighter red */
        .dark .logo-inner-circle { fill: #D1D5DB; } /* Light gray */
        .dark .logo-dot { fill: #1F2937; } /* Dark gray */
        /* Enhanced Notification Styling */
        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }
        .notification {
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            color: white;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-left: 4px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
        }
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .notification.bg-success { 
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        .notification.bg-error { 
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }
        .notification.bg-info { 
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        }
        .notification.bg-warning { 
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }
    </style>
    <script>
        // Apply theme as early as possible to prevent Flash of Unstyled Content (FOUC)
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
<div id="notification-container"></div>
<div class="flex flex-col md:flex-row">
    <!-- Mobile Header -->
    <header class="md:hidden bg-white dark:bg-gray-800 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <div class="flex items-center">
            <div id="mobile-logo-container" class="h-8 w-8"></div>
            <h1 class="text-lg font-bold ml-2 text-gray-800 dark:text-gray-200">N.A.S.A.</h1>
        </div>
        <button id="mobile-menu-button" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </header>
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 p-4 border-r border-gray-200 dark:border-gray-700 h-screen sticky top-0 flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out md:flex z-50">
        <div class="flex items-center mb-8">
            <div id="logo-container" class="h-10 w-10"></div>
            <h1 class="text-xl font-bold ml-2 text-gray-800 dark:text-gray-200">N.A.S.A.</h1>
        </div>
        <nav id="nav-menu" class="space-y-2 flex-grow">
            <!-- Nav items will be injected by JS -->
        </nav>
        <div class="border-t dark:border-gray-700 pt-4 flex justify-between items-center">
            <p class="text-xs text-gray-500 dark:text-gray-400 px-4">Not Another Scheduling App</p>
            <button id="dark-mode-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                <i id="dark-mode-icon" data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
    </aside>
    <!-- Main Content -->
    <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50 dark:bg-gray-950">
        <!-- Content will be injected by JS -->
    </main>
</div>
<!-- Overlay for mobile sidebar -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 opacity-0 transition-opacity duration-300 pointer-events-none"></div>
<!-- Side Panel Container -->
<div id="side-panel-container" class="fixed top-0 right-0 h-full w-full max-w-2xl bg-white dark:bg-gray-800 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <!-- Content will be injected here -->
</div>
<!-- Modal Container -->
<div id="modal-container" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex justify-center items-center p-4"></div>
<!-- Firebase SDK -->
<script type="module">
// Use latest Firebase SDKs
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, setDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, arrayRemove, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyBiXVUUzeLT3mae0N6sdjICdevmRicdk5g",
    authDomain: "nasa2-0.firebaseapp.com",
    projectId: "nasa2-0",
    storageBucket: "nasa2-0.appspot.com",
    messagingSenderId: "735088252433",
    appId: "1:735088252433:web:1b6733520226e27f5843b0",
    measurementId: "G-SNHQZXKCL4"
};
// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
// --- GLOBAL STATE & CONSTANTS ---
let state = {
    authReady: false,
    userId: null,
    activeTab: 'dashboard',
    patientSearchTerm: '',
    studySearchTerm: '',
    siteSearchTerm: '',
    schedulingView: 'calendar', // 'creator', 'calendar', 'day', 'booked'
    schedulingVisitFilter: 'all', // 'all', 'Visit 1', etc.
    schedulingSiteFilter: 'all',
    schedulingStudyFilter: 'all',
    calendarDate: new Date(),
    bookingCalendarDate: new Date(), // For the patient booking modal
    studies: [],
    patients: [],
    sites: [],
    surveys: [],
    schedules: [],
    lastReportData: [], // To store data for CSV export
    currentSurveyState: null,
    currentPatientProfileTab: 'details', // 'details' or 'contactLog' or 'surveyHistory' or 'visitDetails'
    selectedStudyId: null, // For the studies dropdown selector
    participantSearchTerm: '', // For searching participants within a study
    studiesExpanded: false, // For the collapsible studies list
};
let chartInstances = {}; // To hold chart objects for destruction
// --- DOM ELEMENTS ---
const mainContent = document.getElementById('main-content');
const navMenu = document.getElementById('nav-menu');
const modalContainer = document.getElementById('modal-container');
const sidePanelContainer = document.getElementById('side-panel-container');
const overlay = document.getElementById('overlay');
const sidebar = document.getElementById('sidebar');
const mobileMenuButton = document.getElementById('mobile-menu-button');
// --- NOTIFICATION UTILITY ---
/**
 * Show notification to user with enhanced styling and error handling
 * @param {string} message - Notification message
 * @param {string} type - Notification type ('success', 'error', 'info', 'warning')
 * @param {number} duration - Display duration in milliseconds (default: 3000)
 */
const showNotification = (message, type = 'info', duration = 3000) => {
    try {
        const container = document.getElementById('notification-container');
        if (!container) {
            console.warn('Notification container not found');
            return;
        }

        const notif = document.createElement('div');
        notif.className = `notification bg-${type}`;
        notif.textContent = message;
        notif.setAttribute('role', 'alert');
        notif.setAttribute('aria-live', 'polite');
        
        container.appendChild(notif);
        
        // Trigger the animation
        requestAnimationFrame(() => {
            notif.classList.add('show');
        });
        
        // Automatically remove after specified duration
        setTimeout(() => {
            notif.classList.remove('show');
            notif.addEventListener('transitionend', () => {
                if (notif.parentNode) {
                    notif.remove();
                }
            });
        }, duration);
    } catch (error) {
        console.error('Error showing notification:', error);
    }
};
// --- THEME MANAGEMENT (Light/Dark Mode) ---
/**
 * Apply theme to the application with enhanced error handling
 * @param {string} theme - Theme name ('light' or 'dark')
 */
const applyTheme = (theme) => {
    try {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        
        const iconElement = document.getElementById('dark-mode-icon');
        if (iconElement) {
            iconElement.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // Update chart colors if they exist
        updateChartColors(theme);
    } catch (error) {
        console.error('Error applying theme:', error);
    }
};

/**
 * Load theme from localStorage or system preference
 */
const loadTheme = () => {
    try {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme && (savedTheme === 'light' || savedTheme === 'dark')) {
            applyTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }
    } catch (error) {
        console.error('Error loading theme:', error);
        applyTheme('light'); // Fallback to light theme
    }
};

/**
 * Toggle between light and dark themes
 */
const toggleTheme = () => {
    try {
        const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    } catch (error) {
        console.error('Error toggling theme:', error);
    }
};

/**
 * Setup dependencies for schedule form (study-site filtering)
 */
const setupScheduleFormDependencies = () => {
    const studySelect = document.getElementById('schedule-study-select');
    const siteSelect = document.getElementById('schedule-site-select');
    
    if (!studySelect || !siteSelect) return;
    
    studySelect.addEventListener('change', (e) => {
        const selectedStudyId = e.target.value;
        
        if (!selectedStudyId) {
            siteSelect.innerHTML = '<option value="">Select a Study First</option>';
            siteSelect.disabled = true;
            return;
        }
        
        // Find the selected study
        const selectedStudy = state.studies.find(s => s.id === selectedStudyId);
        
        if (!selectedStudy) {
            siteSelect.innerHTML = '<option value="">No sites available</option>';
            siteSelect.disabled = true;
            return;
        }
        
        // Get sites assigned to this study in ARTEMIS
        const studySiteIds = selectedStudy.siteIds || [];
        const availableSites = state.sites.filter(site => 
            studySiteIds.includes(site.id) && site.status === 'Active'
        );
        
        if (availableSites.length === 0) {
            siteSelect.innerHTML = '<option value="">No sites assigned to this study</option>';
            siteSelect.disabled = true;
            return;
        }
        
        // Populate site dropdown with filtered sites
        siteSelect.innerHTML = '<option value="">Select a Site</option>' + 
            availableSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
        siteSelect.disabled = false;
    });
};

/**
 * Get washout status for a patient
 * @param {Object} patient - Patient object
 * @returns {Object|null} - Washout status object or null
 */
const getWashoutStatus = (patient) => {
    if (!patient.enrollments || patient.enrollments.length === 0) return false;
    
    // Find the most recent past enrollment
    const pastEnrollments = patient.enrollments.filter(e => e.status === 'past');
    if (pastEnrollments.length === 0) return null;
    
    const mostRecentPastEnrollment = pastEnrollments.reduce((latest, current) => {
        if (!latest.exitedDate || !current.exitedDate) return latest;
        return new Date(current.exitedDate) > new Date(latest.exitedDate) ? current : latest;
    });
    
    if (!mostRecentPastEnrollment.exitedDate) return null;
    
    // Get the study to find washout days
    const study = state.studies.find(s => s.id === mostRecentPastEnrollment.studyId);
    const washoutDays = study?.washoutDays || 30; // Default to 30 days
    const studyTitle = study?.title || 'Unknown Study';
    
    const exitedDate = new Date(mostRecentPastEnrollment.exitedDate);
    const washoutEndDate = new Date(exitedDate);
    washoutEndDate.setDate(exitedDate.getDate() + washoutDays);
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    washoutEndDate.setHours(0, 0, 0, 0);
    
    const diffMs = washoutEndDate.getTime() - today.getTime();
    const remainingDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
    
    // Only return washout status if still in washout period
    if (today < washoutEndDate && remainingDays > 0) {
        return {
            washoutDays,
            exitedDate,
            washoutEndDate,
            remainingDays,
            studyTitle,
            studyId: mostRecentPastEnrollment.studyId
        };
    }
    
    return null;
};

/**
 * Update chart colors based on theme
 * @param {string} theme - Current theme
 */
const updateChartColors = (theme) => {
    try {
        if (typeof Chart !== 'undefined') {
            const isDark = theme === 'dark';
            Chart.defaults.color = isDark ? 'rgba(255, 255, 255, 0.85)' : 'rgba(0, 0, 0, 0.85)';
            Chart.defaults.borderColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        }
    } catch (error) {
        console.error('Error updating chart colors:', error);
    }
};
// --- RENDER & STATE MANAGEMENT ---
/**
 * Update application state and trigger re-render
 * @param {Object} newState - New state properties to merge
 */
const setState = (newState) => {
    try {
        state = { ...state, ...newState };
        render();
    } catch (error) {
        console.error('Error updating state:', error);
    }
};

/**
 * Main render function with error handling
 */
const render = () => {
    try {
        if (!state.authReady) {
            mainContent.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <div class="text-gray-500 dark:text-gray-400">Authenticating...</div>
                    </div>
                </div>`;
            return;
        }
        
        renderNav();
        renderContent();
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Ensure search inputs are properly initialized after a short delay
        setTimeout(() => {
            setupSearchInputs();
            setupScheduleFormDependencies();
        }, 200);
    } catch (error) {
        console.error('Error in render function:', error);
        showErrorToUser('Failed to render content. Please refresh the page.');
    }
};

/**
 * Show error message to user
 * @param {string} message - Error message to display
 */
const showErrorToUser = (message) => {
    mainContent.innerHTML = `
        <div class="flex items-center justify-center h-full">
            <div class="text-center">
                <div class="text-red-500 mb-4">
                    <i data-lucide="alert-circle" class="w-12 h-12 mx-auto"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Error</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">${message}</p>
                <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Refresh Page
                </button>
            </div>
        </div>`;
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
};
const renderNav = () => {
    const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
        { id: 'studies', label: 'Studies', icon: 'file-text', hasDropdown: true },
        { id: 'patients', label: 'Patients', icon: 'users' },
        { id: 'sites', label: 'Sites', icon: 'building' },
        { id: 'ctms', label: 'CTMS', icon: 'database', href: `https://mhillORA.github.io/CTMS.html?userId=${state.userId}` },
        { id: 'crcs', label: 'CRCs', icon: 'map-pin', href: 'crc_scheduler.html' }, // Link to new page
        { id: 'surveys', label: 'Surveys', icon: 'clipboard-list' },
        { id: 'scheduling', label: 'Scheduling', icon: 'calendar' },
        { id: 'reporting', label: 'Reporting', icon: 'trending-up' },
        { id: 'duplicates', label: 'Duplicates', icon: 'copy-x' },
    ];
    navMenu.innerHTML = navItems.map(item => {
        if (item.href) {
            return `
                <a href="${item.href}" target="_blank" rel="noopener noreferrer" class="nav-item w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    <span class="ml-3">${item.label}</span>
                </a>`;
        }
        
        if (item.hasDropdown && item.id === 'studies') {
            const isExpanded = state.studiesExpanded || false;
            return `
                <div class="nav-item w-full">
                    <button data-action="toggle-studies" class="w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors ${state.activeTab === item.id ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'}">
                        <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                        <span class="ml-3">${item.label}</span>
                        <i data-lucide="chevron-${isExpanded ? 'up' : 'down'}" class="w-4 h-4 ml-auto transition-transform"></i>
                    </button>
                    <div class="studies-list ${isExpanded ? 'block' : 'hidden'} ml-8 mt-2 space-y-1">
                        <button data-action="select-study" data-study-id="" class="w-full text-left px-3 py-2 text-xs rounded-md transition-colors ${!state.selectedStudyId ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">
                            All Studies
                        </button>
                        ${state.studies.map(study => `
                            <button data-action="select-study" data-study-id="${study.id}" class="w-full text-left px-3 py-2 text-xs rounded-md transition-colors ${state.selectedStudyId === study.id ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">
                                ${study.title}
                            </button>
                        `).join('')}
                    </div>
                </div>`;
        }
        
        return `
                <button data-tab="${item.id}" class="nav-item w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors ${state.activeTab === item.id ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'}">
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    <span class="ml-3">${item.label}</span>
                </button>`;
    }).join('');
};
const renderContent = () => {
    const contentMap = {
        dashboard: getDashboardHTML,
        studies: getStudiesHTML,
        patients: getPatientsHTML,
        sites: getSitesHTML,
        surveys: getSurveysHTML,
        scheduling: getSchedulingHTML,
        reporting: getReportingHTML,
        duplicates: getDuplicatesHTML,
    };
    mainContent.innerHTML = contentMap[state.activeTab]();
    // Post-render actions for specific tabs
    if (state.activeTab === 'dashboard') {
        // Dashboard now shows real-time enrollment stats and today's appointments
        renderDashboardCharts();
    }
    if (state.activeTab === 'patients') {
        renderPatientTable();
        setTimeout(() => setupSearchInputs(), 100);
    }
    if (state.activeTab === 'studies') {
        if (state.selectedStudyId) {
            updateEnrollmentNumbers(state.selectedStudyId);
            renderStudyParticipants(state.selectedStudyId);
            // Setup search after participants are rendered
            setTimeout(() => {
                setupStudySelector();
            }, 100);
        } else {
            renderStudyTable();
            setTimeout(() => {
                setupSearchInputs();
                // Ensure the study search input has the correct value
                const studySearchInput = document.getElementById('study-search');
                if (studySearchInput && state.studySearchTerm) {
                    studySearchInput.value = state.studySearchTerm;
                    console.log('Set study search input value to:', state.studySearchTerm);
                }
            }, 100);
        }
    }
    if (state.activeTab === 'sites') {
        renderSiteTable();
        setTimeout(() => setupSearchInputs(), 100);
    }
    if (state.activeTab === 'surveys' && !document.getElementById('questions-container')?.children.length) {
        addQuestionToSurveyForm();
    }
    if (state.activeTab === 'scheduling') {
        if(state.schedulingView === 'calendar') renderCalendar();
        if(state.schedulingView === 'day') renderDayView();
        if(state.schedulingView === 'booked') renderBookedAppointmentsView();
    }
};
// --- MODAL & SIDE PANEL HANDLING ---
/**
 * Open modal with enhanced styling and error handling
 * @param {string} content - HTML content to display
 * @param {boolean} fullWidth - Whether to use full width
 */
const openModal = (content, fullWidth = false) => {
    try {
        const maxWidthClass = fullWidth ? 'max-w-4xl' : 'max-w-2xl';
        modalContainer.innerHTML = `
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl w-full ${maxWidthClass} relative max-h-[90vh] animate-in fade-in-0 zoom-in-95 duration-300">
                <div class="modal-content overflow-y-auto max-h-[calc(90vh-100px)] pr-4">
                    ${content}
                </div>
                <button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>`;
        modalContainer.classList.remove('hidden');
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error opening modal:', error);
        showNotification('Failed to open modal', 'error');
    }
};

/**
 * Close modal with cleanup
 */
const closeModal = () => {
    try {
        modalContainer.classList.add('hidden');
        modalContainer.innerHTML = '';
        state.currentSurveyState = null; // Clear survey state on modal close
    } catch (error) {
        console.error('Error closing modal:', error);
    }
};
/**
 * Handle outside clicks for side panel
 * @param {Event} e - Click event
 */
const handleOutsideClick = (e) => {
    try {
        if (!sidePanelContainer.contains(e.target) && !sidePanelContainer.classList.contains('translate-x-full')) {
            if (!e.target.closest('button[data-action="view-patient"]')) {
                closeSidePanel();
            }
        }
    } catch (error) {
        console.error('Error handling outside click:', error);
    }
};

/**
 * Open side panel with enhanced styling and error handling
 * @param {string} content - HTML content to display
 * @param {boolean} isPatientProfile - Whether this is a patient profile panel
 */
const openSidePanel = (content, isPatientProfile = false) => {
    try {
        sidePanelContainer.innerHTML = `
            <div class="side-panel-content h-full overflow-y-auto p-8 animate-in slide-in-from-right duration-300">
                ${content}
            </div>`;
        sidePanelContainer.classList.remove('translate-x-full');
        
        if (isPatientProfile) {
            setTimeout(() => { 
                document.addEventListener('click', handleOutsideClick, true);
            }, 100);
        } else {
            overlay.classList.remove('opacity-0', 'pointer-events-none');
        }
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    } catch (error) {
        console.error('Error opening side panel:', error);
        showNotification('Failed to open side panel', 'error');
    }
};

/**
 * Close side panel with cleanup
 */
const closeSidePanel = () => {
    try {
        sidePanelContainer.classList.add('translate-x-full');
        overlay.classList.add('opacity-0', 'pointer-events-none');
        sidePanelContainer.innerHTML = '';
        state.currentPatientProfileTab = 'details';
        document.removeEventListener('click', handleOutsideClick, true);
    } catch (error) {
        console.error('Error closing side panel:', error);
    }
};
// --- HTML GETTERS FOR EACH PAGE ---
const getDashboardHTML = () => {
    return `
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">Real-Time Enrollment Dashboard</h2>
        
        <!-- Today's Appointments Section -->
        <div class="mb-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Today's Appointments</h3>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                </div>
            </div>
            <div id="todays-appointments-container"></div>
        </div>
        
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">Enrollment Status</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
            ${state.studies
                .filter(study => {
                    // Only show active studies with valid start and end dates
                    const hasValidDates = study.startDate && study.endDate;
                    const isActive = study.status === 'Recruiting' || study.status === 'Enrolling' || study.status === 'Active';
                    return hasValidDates && isActive;
                })
                .map(study => {
                // Calculate real-time enrollment data for this study
                const studyPatients = state.patients.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment?.studyId === study.id;
                });
                
                const enrolledCount = studyPatients.filter(p => p.status === 'Enrolled').length;
                const target = study.target || 0;
                const percentage = target > 0 ? Math.round((enrolledCount / target) * 100) : 0;
                
                // Calculate schedule completion status
                const startDate = new Date(study.startDate);
                const endDate = new Date(study.endDate);
                const today = new Date();
                
                // Calculate time progress
                const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                const daysElapsed = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
                const timeProgress = Math.min(Math.max((daysElapsed / totalDays) * 100, 0), 100);
                
                // Determine if on track (enrollment progress >= time progress)
                const isOnTrack = percentage >= timeProgress;
                const isBehind = percentage < timeProgress - 10; // 10% tolerance
                
                // Color coding based on schedule status
                let statusColor, progressColor, cardBorder;
                if (isBehind) {
                    statusColor = 'text-red-600 dark:text-red-400';
                    progressColor = 'bg-red-500';
                    cardBorder = 'border-l-4 border-red-500';
                } else if (isOnTrack) {
                    statusColor = 'text-green-600 dark:text-green-400';
                    progressColor = 'bg-green-500';
                    cardBorder = 'border-l-4 border-green-500';
                } else {
                    statusColor = 'text-yellow-600 dark:text-yellow-400';
                    progressColor = 'bg-yellow-500';
                    cardBorder = 'border-l-4 border-yellow-500';
                }
                
                // Get site breakdown for this study
                const siteBreakdown = {};
                studyPatients.forEach(patient => {
                    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
                    if (currentEnrollment?.siteId) {
                        const site = state.sites.find(s => s.id === currentEnrollment.siteId);
                        const siteName = site?.name || 'Unknown Site';
                        if (!siteBreakdown[siteName]) {
                            siteBreakdown[siteName] = { enrolled: 0, total: 0 };
                        }
                        if (patient.status === 'Enrolled') {
                            siteBreakdown[siteName].enrolled++;
                        }
                        siteBreakdown[siteName].total++;
                    }
                });
                
                return `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md ${cardBorder}">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 truncate">${study.title}</h3>
                                <p class="text-xs text-gray-600 dark:text-gray-400">${study.status || 'Active'}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-500">
                                    ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}
                                </p>
                            </div>
                            <div class="text-right ml-2">
                                <div class="text-2xl font-bold ${statusColor}">${percentage}%</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Complete</div>
                                <div class="text-xs ${statusColor} font-medium">
                                    ${isBehind ? 'Behind Schedule' : isOnTrack ? 'On Track' : 'At Risk'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mb-3">
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="${progressColor} h-2 rounded-full transition-all duration-500" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mt-1">
                                <span>${enrolledCount} enrolled</span>
                                <span>Target: ${target}</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-500 mt-1">
                                <span>Time: ${Math.round(timeProgress)}%</span>
                                <span>Enrollment: ${percentage}%</span>
                            </div>
                        </div>
                        
                        <!-- Site Breakdown - Compact -->
                        <div class="space-y-2">
                            ${Object.entries(siteBreakdown).slice(0, 3).map(([siteName, data]) => {
                                const sitePercentage = data.total > 0 ? Math.round((data.enrolled / data.total) * 100) : 0;
                                return `
                                    <div class="flex items-center justify-between text-xs">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-gray-800 dark:text-gray-200 truncate">${siteName}</div>
                                            <div class="text-gray-500 dark:text-gray-400">${data.enrolled}/${data.total}</div>
                                        </div>
                                        <div class="flex items-center ml-2">
                                            <div class="w-8 bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mr-2">
                                                <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${sitePercentage}%"></div>
                                            </div>
                                            <span class="text-blue-600 dark:text-blue-400 font-semibold text-xs">${sitePercentage}%</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            
                            ${Object.keys(siteBreakdown).length > 3 ? `
                                <div class="text-xs text-gray-500 dark:text-gray-400 text-center pt-1">
                                    +${Object.keys(siteBreakdown).length - 3} more sites
                                </div>
                            ` : ''}
                            
                            ${Object.keys(siteBreakdown).length === 0 ? `
                                <div class="text-center py-2 text-gray-500 dark:text-gray-400 text-xs">
                                    <i data-lucide="building" class="w-4 h-4 mx-auto mb-1 opacity-50"></i>
                                    <p>No site data</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
            
            ${state.studies.filter(study => {
                const hasValidDates = study.startDate && study.endDate;
                const isActive = study.status === 'Recruiting' || study.status === 'Enrolling' || study.status === 'Active';
                return hasValidDates && isActive;
            }).length === 0 ? `
                <div class="col-span-full bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md text-center">
                    <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                    <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2">No Active Studies</h3>
                    <p class="text-gray-500 dark:text-gray-500 text-sm">No active studies with valid start/end dates found. Create studies in ARTEMIS to see enrollment statistics here.</p>
                </div>
            ` : ''}
        </div>`;
};
const renderDashboardCharts = () => {
    // Render Today's Appointments
    renderDashboardTodaysAppointments();
};

const renderDashboardTodaysAppointments = () => {
    const container = document.getElementById('todays-appointments-container');
    if (!container) return;
    
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    
    let todaysAppointments = state.patients.filter(p => {
        if (!p.appointment || !p.appointment.time) return false;
        const apptDate = new Date(p.appointment.time);
        apptDate.setHours(0, 0, 0, 0);
        return apptDate.getTime() === todayStart.getTime();
    });
    
    if (todaysAppointments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i data-lucide="calendar-check" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                <p>No appointments scheduled for today</p>
            </div>
        `;
        lucide.createIcons();
        return;
    }
    
    // Sort by time
    todaysAppointments.sort((a, b) => new Date(a.appointment.time) - new Date(b.appointment.time));
    
    // Group by study and site
    const grouped = {};
    todaysAppointments.forEach(patient => {
        const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
        const studyId = currentEnrollment?.studyId || 'unknown';
        const siteId = currentEnrollment?.siteId || 'unknown';
        const key = `${studyId}|||${siteId}`;
        
        if (!grouped[key]) {
            const study = state.studies.find(s => s.id === studyId);
            const site = state.sites.find(s => s.id === siteId);
            grouped[key] = {
                studyName: study?.title || 'Unknown Study',
                siteName: site?.name || 'Unknown Site',
                patients: []
            };
        }
        grouped[key].patients.push(patient);
    });
    
    let appointmentsHTML = '';
    Object.values(grouped).forEach(group => {
        appointmentsHTML += `
            <div class="mb-6 border dark:border-gray-700 rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 px-4 py-3">
                    <h4 class="font-bold text-white text-lg">${group.studyName}</h4>
                    <p class="text-blue-100 text-sm">${group.siteName}</p>
                </div>
                <div class="bg-white dark:bg-gray-800">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Time</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Patient</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Visit</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            ${group.patients.map(patient => {
                                const time = new Date(patient.appointment.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                const visit = patient.appointment.visit || 'General';
                                const checkInStatus = patient.appointment.checkInStatus || 'not-checked-in';
                                const checkInTime = patient.appointment.checkInTime;
                                
                                let statusBadge, actionButton;
                                if (checkInStatus === 'checked-in') {
                                    statusBadge = `
                                        <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                            <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>Checked In
                                        </div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${checkInTime ? new Date(checkInTime).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : ''}</div>
                                    `;
                                    actionButton = `
                                        <button data-action="undo-check-in" data-patient-id="${patient.id}" class="text-orange-600 dark:text-orange-400 hover:underline text-sm flex items-center">
                                            <i data-lucide="undo" class="w-4 h-4 mr-1"></i>Undo
                                        </button>
                                    `;
                                } else if (checkInStatus === 'no-show') {
                                    statusBadge = `
                                        <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                            <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i>No Show
                                        </div>
                                    `;
                                    actionButton = `
                                        <button data-action="undo-check-in" data-patient-id="${patient.id}" class="text-orange-600 dark:text-orange-400 hover:underline text-sm flex items-center">
                                            <i data-lucide="undo" class="w-4 h-4 mr-1"></i>Undo
                                        </button>
                                    `;
                                } else {
                                    statusBadge = `
                                        <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                                            <i data-lucide="clock" class="w-3 h-3 mr-1"></i>Waiting
                                        </div>
                                    `;
                                    actionButton = `
                                        <button data-action="open-check-in-modal" data-patient-id="${patient.id}" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 text-sm">
                                            Check In
                                        </button>
                                    `;
                                }
                                
                                return `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium dark:text-gray-200">${time}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                                            <button data-action="view-patient" data-id="${patient.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${patient.firstName} ${patient.lastName}</button>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-300">${visit}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm">${statusBadge}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm">${actionButton}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = appointmentsHTML;
    lucide.createIcons();
};
const renderTodaysAppointments = () => {
    const tableBody = document.getElementById('todays-appointments-body');
    if (!tableBody) return;
    const studyFilter = document.getElementById('study-filter')?.value;
    const siteFilter = document.getElementById('site-filter')?.value;
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    let todaysAppointments = state.patients
        .filter(p => {
            if (!p.appointment || !p.appointment.time) return false;
            const apptDate = new Date(p.appointment.time);
            apptDate.setHours(0, 0, 0, 0);
            return apptDate.getTime() === todayStart.getTime();
        });
    if (studyFilter && studyFilter !== 'all') {
        todaysAppointments = todaysAppointments.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.studyId === studyFilter;
        });
    }
    if (siteFilter && siteFilter !== 'all') {
        todaysAppointments = todaysAppointments.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.siteId === siteFilter;
        });
    }
    todaysAppointments.sort((a, b) => new Date(a.appointment.time) - new Date(b.appointment.time));
    if (todaysAppointments.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 dark:text-gray-400 py-8">No appointments scheduled for today with the selected filters.</td></tr>`;
        return;
    }
    tableBody.innerHTML = todaysAppointments.map(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        const site = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
        const study = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A';
        const visit = p.appointment.visit || 'General';
        const time = new Date(p.appointment.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const visitStatusOptions = ['Scheduled', 'Scheduled for next visit', 'Screenfailed', 'Study Complete', 'Discontinued', 'Visit Incomplete'];
        const currentStatus = p.appointment.visitStatus || 'Scheduled';
        const statusDropdownHTML = `
            <select data-action="update-visit-status" data-patient-id="${p.id}" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white text-sm w-full">
                ${visitStatusOptions.map(opt => `
                    <option value="${opt}" ${currentStatus === opt ? 'selected' : ''}>${opt}</option>
                `).join('')}
            </select>
        `;
        return `
            <tr class="dark:text-gray-300">
                <td class="px-6 py-4 whitespace-nowrap">${time}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${p.firstName} ${p.lastName}</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">${site}</td>
                <td class="px-6 py-4 whitespace-nowrap">${study}</td>
                <td class="px-6 py-4 whitespace-nowrap">${visit}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusDropdownHTML}</td>
            </tr>
        `;
    }).join('');
    lucide.createIcons();
};
const getStudiesHTML = () => {
    // If a study is selected, show participants view
    if (state.selectedStudyId) {
        const study = state.studies.find(s => s.id === state.selectedStudyId);
        return `
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">${study ? study.title : 'Study Participants'}</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Viewing participants for selected study</p>
                </div>
            </div>
            
            <!-- Enrollment Numbers Display -->
            <div class="mb-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Study Enrollment Summary</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total Enrolled</p>
                        <p id="total-enrolled" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Target Enrollment</p>
                        <p id="target-enrollment" class="text-2xl font-bold text-green-600 dark:text-green-400">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Screen Fails</p>
                        <p id="screen-fails" class="text-2xl font-bold text-red-600 dark:text-red-400">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Open Appointments</p>
                        <p id="open-appointments" class="text-2xl font-bold text-orange-600 dark:text-orange-400">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Enrollment Progress</p>
                        <p id="enrollment-progress" class="text-2xl font-bold text-purple-600 dark:text-purple-400">0%</p>
                    </div>
                </div>
            </div>
            
            <!-- Participants Table -->
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Study Participants</h3>
                    <div class="flex gap-2">
                        <input type="text" id="participant-search" placeholder="Search by name, phone, email, or global ID..." class="p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" autocomplete="off" spellcheck="false" oninput="handleParticipantSearchDirect(event)" onclick="console.log('Participant search input clicked')">
                        <button data-action="add-patient-to-study" data-study-id="${study.id}" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i> Add Patient
                        </button>
                        <button data-action="export-participants" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export
                        </button>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Global ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="participants-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Participants will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
        // Default view - show all studies
        return `
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Clinical Studies</h2>
            </div>
        <div class="mb-4">
            <input type="text" id="study-search" value="${state.studySearchTerm}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search for a study..." oninput="handleStudySearchDirect(event)">
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Protocol #</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Enrollment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Screen Fails</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th></tr></thead>
                <tbody id="study-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
        </div>`;
};
const renderStudyTable = () => {
    const tableBody = document.getElementById('study-table-body');
    if (!tableBody) return;
    const searchTerm = state.studySearchTerm || '';
    console.log('renderStudyTable called with searchTerm:', searchTerm); // Debug log
    console.log('Total studies:', state.studies.length); // Debug log
    const filteredStudies = state.studies.filter(s => s.title.toLowerCase().includes(searchTerm.toLowerCase()));
    console.log('Filtered studies:', filteredStudies.length); // Debug log
    tableBody.innerHTML = filteredStudies.map(study => {
        // The study.enrolled count is now updated directly from CTMS via postMessage
        const enrolledCount = study.enrolled || 0;
        return `<tr class="dark:text-gray-300">
                <td class="px-6 py-4"><button data-action="view-study-patients" data-id="${study.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${study.title}</button></td>
                <td class="px-6 py-4">${study.protocolNumber || 'N/A'}</td>
                <td class="px-6 py-4">${study.status}</td>
                <td class="px-6 py-4">${enrolledCount} / ${study.target}</td>
                <td class="px-6 py-4">${study.screenFails || 0}</td>
                <td class="px-6 py-4 flex items-center gap-4">
                    <span class="text-gray-400 dark:text-gray-500">View Only</span>
                </td>
            </tr>`
    }).join('');
    lucide.createIcons();
};

// --- SEARCH FUNCTIONALITY SETUP ---
const setupSearchInputs = () => {
    // Setup patient search
    const patientSearch = document.getElementById('patient-search');
    if (patientSearch) {
        patientSearch.removeEventListener('input', handlePatientSearch);
        patientSearch.removeEventListener('focus', handleSearchFocus);
        patientSearch.removeEventListener('click', handleSearchClick);
        patientSearch.addEventListener('input', handlePatientSearch);
        patientSearch.addEventListener('focus', handleSearchFocus);
        patientSearch.addEventListener('click', handleSearchClick);
        // Make sure the input is enabled and focusable
        patientSearch.disabled = false;
        patientSearch.readOnly = false;
        patientSearch.focus();
    }
    
    // Setup study search
    const studySearch = document.getElementById('study-search');
    if (studySearch) {
        console.log('Setting up study search input'); // Debug log
        // Remove any existing listeners to prevent duplicates
        studySearch.removeEventListener('input', handleStudySearch);
        studySearch.removeEventListener('focus', handleSearchFocus);
        studySearch.removeEventListener('click', handleSearchClick);
        
        // Add new listeners
        studySearch.addEventListener('input', handleStudySearch);
        studySearch.addEventListener('focus', handleSearchFocus);
        studySearch.addEventListener('click', handleSearchClick);
        
        // Ensure the input is properly configured
        studySearch.disabled = false;
        studySearch.readOnly = false;
        studySearch.style.pointerEvents = 'auto';
        studySearch.style.userSelect = 'text';
        
        // Set the current value
        if (state.studySearchTerm) {
            studySearch.value = state.studySearchTerm;
        }
        
        console.log('Study search input setup complete, value:', studySearch.value); // Debug log
    } else {
        console.log('Study search input not found'); // Debug log
    }
    
    // Setup site search
    const siteSearch = document.getElementById('site-search');
    if (siteSearch) {
        siteSearch.removeEventListener('input', handleSiteSearch);
        siteSearch.removeEventListener('focus', handleSearchFocus);
        siteSearch.removeEventListener('click', handleSearchClick);
        siteSearch.addEventListener('input', handleSiteSearch);
        siteSearch.addEventListener('focus', handleSearchFocus);
        siteSearch.addEventListener('click', handleSearchClick);
        siteSearch.disabled = false;
        siteSearch.readOnly = false;
    }
    
    // Setup participant search - but only if we're not in a study view
    // (study view is handled by setupStudySelector)
    const participantSearch = document.getElementById('participant-search');
    if (participantSearch && !state.selectedStudyId) {
        // Only add listeners if they don't already exist to prevent conflicts
        if (!participantSearch.hasAttribute('data-listeners-added')) {
            participantSearch.addEventListener('input', handleParticipantSearch);
            participantSearch.addEventListener('focus', handleSearchFocus);
            participantSearch.addEventListener('click', handleSearchClick);
            participantSearch.setAttribute('data-listeners-added', 'true');
        }
        participantSearch.disabled = false;
        participantSearch.readOnly = false;
        // Ensure the input is focusable and editable
        participantSearch.style.pointerEvents = 'auto';
        participantSearch.style.userSelect = 'text';
    }
    
    // Setup modal site patient search
    const modalSitePatientSearch = document.getElementById('modal-site-patient-search');
    if (modalSitePatientSearch) {
        if (!modalSitePatientSearch.hasAttribute('data-listeners-added')) {
            modalSitePatientSearch.addEventListener('focus', handleSearchFocus);
            modalSitePatientSearch.addEventListener('click', handleSearchClick);
            modalSitePatientSearch.setAttribute('data-listeners-added', 'true');
        }
        modalSitePatientSearch.disabled = false;
        modalSitePatientSearch.readOnly = false;
        modalSitePatientSearch.style.pointerEvents = 'auto';
        modalSitePatientSearch.style.userSelect = 'text';
    }
    
    // Setup modal study patient search
    const modalStudyPatientSearch = document.getElementById('modal-study-patient-search');
    if (modalStudyPatientSearch) {
        if (!modalStudyPatientSearch.hasAttribute('data-listeners-added')) {
            modalStudyPatientSearch.addEventListener('focus', handleSearchFocus);
            modalStudyPatientSearch.addEventListener('click', handleSearchClick);
            modalStudyPatientSearch.setAttribute('data-listeners-added', 'true');
        }
        modalStudyPatientSearch.disabled = false;
        modalStudyPatientSearch.readOnly = false;
        modalStudyPatientSearch.style.pointerEvents = 'auto';
        modalStudyPatientSearch.style.userSelect = 'text';
    }
};

// Handle search input focus and click events
const handleSearchFocus = (event) => {
    // Only select text if the input is empty or if it's a click-to-focus action
    if (!event.target.value || event.detail === 0) {
        event.target.select();
    }
};

const handleSearchClick = (event) => {
    event.target.focus();
    // Only select text if the input is empty
    if (!event.target.value) {
        event.target.select();
    }
};

// Individual search handlers
const handlePatientSearch = (event) => {
    state.patientSearchTerm = event.target.value;
    renderPatientTable();
};

const handleStudySearch = (event) => {
    console.log('Study search input changed:', event.target.value); // Debug log
    state.studySearchTerm = event.target.value;
    console.log('Updated state.studySearchTerm:', state.studySearchTerm); // Debug log
    renderStudyTable();
};

// Direct handler for inline event (fallback)
const handleStudySearchDirect = (event) => {
    console.log('Direct study search handler called with:', event.target.value); // Debug log
    state.studySearchTerm = event.target.value;
    console.log('Updated state.studySearchTerm (direct):', state.studySearchTerm); // Debug log
    renderStudyTable();
};

const handleSiteSearch = (event) => {
    state.siteSearchTerm = event.target.value;
    renderSiteTable();
};

// --- STUDY SELECTOR FUNCTIONALITY ---
const setupStudySelector = () => {
    const participantSearch = document.getElementById('participant-search');
    
    if (participantSearch) {
        console.log('Setting up participant search input'); // Debug log
        
        // Remove any existing listeners to prevent duplicates
        participantSearch.removeEventListener('input', handleParticipantSearch);
        participantSearch.removeEventListener('focus', handleSearchFocus);
        participantSearch.removeEventListener('click', handleSearchClick);
        
        // Add event listeners
        participantSearch.addEventListener('input', handleParticipantSearch);
        participantSearch.addEventListener('focus', handleSearchFocus);
        participantSearch.addEventListener('click', handleSearchClick);
        
        // Ensure the input is properly configured for typing
        participantSearch.disabled = false;
        participantSearch.readOnly = false;
        participantSearch.style.pointerEvents = 'auto';
        participantSearch.style.userSelect = 'text';
        
        // Set the current search term value
        if (state.participantSearchTerm) {
            participantSearch.value = state.participantSearchTerm;
        }
        
        console.log('Participant search input setup complete with event listeners'); // Debug log
    } else {
        console.log('Participant search input not found in setupStudySelector'); // Debug log
    }
};


const handleParticipantSearch = (event) => {
    const searchTerm = event.target.value;
    console.log('Search term:', searchTerm); // Debug log
    // Update state without triggering full re-render
    state.participantSearchTerm = searchTerm;
    
    if (state.selectedStudyId) {
        console.log('Calling renderStudyParticipants for study:', state.selectedStudyId); // Debug log
        renderStudyParticipants(state.selectedStudyId);
    }
};

// Direct handler for inline event
const handleParticipantSearchDirect = (event) => {
    const searchTerm = event.target.value;
    console.log('Direct participant search handler called with:', searchTerm);
    console.log('Current selectedStudyId:', state.selectedStudyId);
    
    // Update state
    state.participantSearchTerm = searchTerm;
    console.log('Updated state.participantSearchTerm to:', state.participantSearchTerm);
    
    // Immediately re-render the participants
    if (state.selectedStudyId) {
        console.log('Direct: Calling renderStudyParticipants for study:', state.selectedStudyId);
        renderStudyParticipants(state.selectedStudyId);
    } else {
        console.log('No selected study ID - cannot render participants');
    }
};


const updateEnrollmentNumbers = (studyId) => {
    const study = state.studies.find(s => s.id === studyId);
    if (!study) return;
    
    // Get participants for this study
    const studyParticipants = state.patients.filter(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        return currentEnrollment?.studyId === studyId;
    });
    
    const enrolledCount = studyParticipants.filter(p => p.status === 'Enrolled').length;
    const screenFailCount = studyParticipants.filter(p => p.status === 'Screen Fail').length;
    const targetEnrollment = study.target || 0;
    const enrollmentProgress = targetEnrollment > 0 ? Math.round((enrolledCount / targetEnrollment) * 100) : 0;
    
    // Calculate open appointment slots for this study
    const studySchedules = state.schedules.filter(s => s.studyId === studyId);
    let openAppointments = 0;
    studySchedules.forEach(schedule => {
        schedule.slots.forEach(slot => {
            const bookedCount = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id).length;
            const availableSlots = slot.capacity - bookedCount;
            if (availableSlots > 0) {
                openAppointments += availableSlots;
            }
        });
    });
    
    // Update the display
    const totalEnrolledEl = document.getElementById('total-enrolled');
    const targetEnrollmentEl = document.getElementById('target-enrollment');
    const screenFailsEl = document.getElementById('screen-fails');
    const openAppointmentsEl = document.getElementById('open-appointments');
    const enrollmentProgressEl = document.getElementById('enrollment-progress');
    
    if (totalEnrolledEl) totalEnrolledEl.textContent = enrolledCount;
    if (targetEnrollmentEl) targetEnrollmentEl.textContent = targetEnrollment;
    if (screenFailsEl) screenFailsEl.textContent = screenFailCount;
    if (openAppointmentsEl) openAppointmentsEl.textContent = openAppointments;
    if (enrollmentProgressEl) enrollmentProgressEl.textContent = `${enrollmentProgress}%`;
};

const renderStudyParticipants = (studyId) => {
    const tableBody = document.getElementById('participants-table-body');
    if (!tableBody) return;
    
    // Get participants for this study
    let studyParticipants = state.patients.filter(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        return currentEnrollment?.studyId === studyId;
    });
    
    console.log('Found', studyParticipants.length, 'participants for study', studyId); // Debug log
    
    // Apply search filter
    if (state.participantSearchTerm) {
        const searchTerm = state.participantSearchTerm.toLowerCase();
        console.log('Applying participant search filter:', searchTerm, 'to', studyParticipants.length, 'participants'); // Debug log
        console.log('Search term length:', searchTerm.length); // Debug log
        
        // Helper function to normalize phone numbers for searching
        const normalizePhoneForSearch = (phone) => {
            if (!phone) return '';
            return phone.replace(/\D/g, ''); // Remove all non-digits
        };
        
        studyParticipants = studyParticipants.filter(p => {
            const nameMatch = `${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm);
            const emailMatch = p.email && p.email.toLowerCase().includes(searchTerm);
            const globalIdMatch = p.globalId && p.globalId.toLowerCase().includes(searchTerm);
            
            // Phone number matching with format normalization
            let phoneMatch = false;
            if (p.phoneNumber) {
                const normalizedSearchTerm = searchTerm.replace(/\D/g, ''); // Remove non-digits from search term
                const normalizedPhone = normalizePhoneForSearch(p.phoneNumber);
                phoneMatch = normalizedPhone.includes(normalizedSearchTerm);
            }
            
            const matches = nameMatch || emailMatch || phoneMatch || globalIdMatch;
            
            // Debug logging for first few participants
            if (studyParticipants.indexOf(p) < 3) {
                console.log(`Patient ${p.firstName} ${p.lastName}:`, {
                    nameMatch, emailMatch, phoneMatch, globalIdMatch, matches,
                    searchTerm, phone: p.phoneNumber, globalId: p.globalId
                });
            }
            
            return matches;
        });
        console.log('Filtered to', studyParticipants.length, 'participants'); // Debug log
    }
    
    if (studyParticipants.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-gray-500 dark:text-gray-400 py-8">
                    ${state.participantSearchTerm ? 'No participants found matching your search.' : 'No participants enrolled in this study.'}
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = studyParticipants.map(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        const siteName = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
        const appointmentInfo = p.appointment ? 
            `${new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })} (${p.appointment.visit || 'General'})` 
            : 'Not Scheduled';
        
        // Check washout status
        const washoutStatus = getWashoutStatus(p);
        const washoutIndicator = washoutStatus ? `<div class="mt-1"><span class="inline-block px-2 py-1 text-xs bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded-full">Washout: ${washoutStatus.remainingDays}d</span></div>` : '';
        
        return `
            <tr class="dark:text-gray-300">
                <td class="px-6 py-4">
                    <div>
                        <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
                            ${p.firstName} ${p.lastName}
                        </button>
                        ${washoutIndicator}
                    </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                    ${p.globalId || 'N/A'}
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded-full ${
                        p.status === 'Enrolled' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                        p.status === 'Screen Fail' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                        p.status === 'Pre-Screening' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                        'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200'
                    }">
                        ${p.status || 'Candidate'}
                    </span>
                </td>
                <td class="px-6 py-4">${siteName}</td>
                <td class="px-6 py-4">${appointmentInfo}</td>
                <td class="px-6 py-4 flex items-center gap-2">
                    <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline text-sm">View</button>
                    <button data-action="survey-patient" data-id="${p.id}" class="text-green-600 dark:text-green-400 hover:underline text-sm">Survey</button>
                    <button data-action="schedule-patient" data-id="${p.id}" class="text-purple-600 dark:text-purple-400 hover:underline text-sm">Schedule</button>
                </td>
            </tr>
        `;
    }).join('');
    
    lucide.createIcons();
};

const exportParticipants = () => {
    if (!state.selectedStudyId) {
        showNotification("Please select a study first.", "info");
        return;
    }
    
    try {
        const studyParticipants = state.patients.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.studyId === state.selectedStudyId;
        });
        
        if (studyParticipants.length === 0) {
            showNotification("No participants found for the selected study.", "info");
            return;
        }
        
        const headers = ["Name", "Status", "Site", "Appointment", "Email", "Phone", "DOB"];
        const csvRows = [headers.join(',')];
        
        for (const p of studyParticipants) {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            const siteName = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
            const appointmentInfo = p.appointment ? 
                `${new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })} (${p.appointment.visit || 'General'})` 
                : 'Not Scheduled';
            
            const row = [
                `"${p.firstName} ${p.lastName}"`,
                `"${p.status || 'Candidate'}"`,
                `"${siteName}"`,
                `"${appointmentInfo}"`,
                `"${p.email || 'N/A'}"`,
                `"${p.phoneNumber || 'N/A'}"`,
                `"${p.dob || 'N/A'}"`
            ];
            csvRows.push(row.join(','));
        }
        
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        const study = state.studies.find(s => s.id === state.selectedStudyId);
        const studyTitle = study ? study.title.replace(/[^a-zA-Z0-9]/g, '_') : 'study';
        const date = new Date().toISOString().split('T')[0];
        link.setAttribute("download", `participants_${studyTitle}_${date}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification("Participants exported successfully!", "success");
    } catch (error) {
        console.error("Failed to export participants:", error);
        showNotification("Failed to export participants. See console for details.", "error");
    }
};

const getPatientsHTML = () => {
    return `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Patients</h2>
        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="text" id="patient-search" value="${state.patientSearchTerm}" class="p-2 border dark:border-gray-600 rounded-md md:col-span-2 bg-white dark:bg-gray-700 dark:text-white" placeholder="Search by Name, Email, Phone, or Global ID...">
            <div class="flex gap-2">
                <button data-action="import-patients-modal" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 flex items-center justify-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import</button>
                <button data-action="quick-add-patient-modal" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Quick Add</button>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th></tr></thead>
                <tbody id="patient-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
        </div>`;
};
const renderPatientTable = () => {
    const tableBody = document.getElementById('patient-table-body');
    if (!tableBody) return;
    const searchTerm = state.patientSearchTerm.toLowerCase();
    
    // Helper function to normalize phone numbers for searching
    const normalizePhoneForSearch = (phone) => {
        if (!phone) return '';
        return phone.replace(/\D/g, ''); // Remove all non-digits
    };
    
    const filteredPatients = state.patients.filter(p => {
        const nameMatch = `${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm);
        const emailMatch = p.email && p.email.toLowerCase().includes(searchTerm);
        const globalIdMatch = p.globalId && p.globalId.toLowerCase().includes(searchTerm);
        
        // Phone number matching with format normalization
        let phoneMatch = false;
        if (p.phoneNumber) {
            const normalizedSearchTerm = searchTerm.replace(/\D/g, ''); // Remove non-digits from search term
            const normalizedPhone = normalizePhoneForSearch(p.phoneNumber);
            phoneMatch = normalizedPhone.includes(normalizedSearchTerm);
        }
        
        return nameMatch || emailMatch || phoneMatch || globalIdMatch;
    });
    tableBody.innerHTML = filteredPatients.map(p => {
        const appointmentInfo = p.appointment ? 
            `${new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })} (${p.appointment.visit || 'General'})` 
            : 'Not Scheduled';
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        const siteName = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
        const studyName = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A';
        
        return `<tr class="dark:text-gray-300">
                <td class="px-6 py-4">
                    <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium text-left">${p.firstName} ${p.lastName}</button>
                </td>
                <td class="px-6 py-4">${siteName}</td>
                <td class="px-6 py-4">${studyName}</td>
                <td class="px-6 py-4">${appointmentInfo}</td>
                <td class="px-6 py-4 flex items-center gap-4">
                    <button data-action="survey-patient" data-id="${p.id}" class="text-green-600 dark:text-green-400 hover:underline">Survey</button>
                    <button data-action="schedule-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">Schedule</button>
                    <button data-action="edit-patient" data-id="${p.id}" class="text-gray-500 dark:text-gray-400 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                    <button data-action="delete-patient" data-id="${p.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            </tr>`;
    }).join('');
    lucide.createIcons();
};
const getSitesHTML = () => `
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Clinical Sites</h2>
        </div>
        <div class="mb-4">
            <input type="text" id="site-search" value="${state.siteSearchTerm}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search for a site...">
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">PI</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Location</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Indication</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">SF Rate</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="site-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
        </div>`;
const renderSiteTable = () => {
    const tableBody = document.getElementById('site-table-body');
    if (!tableBody) return;
    const filteredSites = state.sites.filter(s => s.name.toLowerCase().includes(state.siteSearchTerm.toLowerCase()));
    
    tableBody.innerHTML = filteredSites.map(site => {
        // Calculate screen fail rate for this site
        const sitePatients = state.patients.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.siteId === site.id;
        });
        const enrolled = sitePatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
        const screenFailed = sitePatients.filter(p => p.status && p.status.toLowerCase() === 'screen fail').length;
        const totalScreened = enrolled + screenFailed;
        const screenFailRate = totalScreened > 0 ? Math.round((screenFailed / totalScreened) * 100) : 0;
        
        // Format location
        const location = [site.city, site.state].filter(Boolean).join(', ') || site.location || 'N/A';
        
        // Format indication
        const indications = Array.isArray(site.indication) ? site.indication : (site.indication ? [site.indication] : []);
        const indicationTags = indications.map(ind => 
            `<span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-0.5 rounded-full">${ind}</span>`
        ).join(' ');
        
        return `
            <tr class="dark:text-gray-300">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${site.status || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">
                    <button data-action="view-site-patients" data-id="${site.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${site.name}</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${site.pi || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${location}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                    <div class="flex flex-wrap gap-1">
                        ${indicationTags || '<span class="text-gray-400">N/A</span>'}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${screenFailRate}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                    <span class="text-gray-400 dark:text-gray-500">View Only</span>
                </td>
            </tr>
        `;
    }).join('');
    lucide.createIcons();
};
const getSurveysHTML = () => `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Surveys with Branching Logic</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Create New Survey</h3>
            <form id="survey-creator-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Survey Title</label><input type="text" name="title" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Patient Intake Survey" required /></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Assign to Study</label><select name="studyId" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-white dark:bg-gray-700 dark:text-white" required><option value="" disabled selected>Select a study</option>${state.studies.map(study => `<option value="${study.id}">${study.title}</option>`).join('')}</select></div>
                </div>
                <div id="questions-container" class="space-y-4"></div>
                <button type="button" data-action="add-question" class="text-sm font-medium text-blue-600 dark:text-blue-400 p-2 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-md">+ Add Question</button>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Create Survey</button>
            </form>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 p-6">Existing Surveys</h3>
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th></tr></thead>
                <tbody class="dark:text-gray-300">${state.surveys.map(s => `<tr><td class="px-6 py-4">${s.title}</td><td class="px-6 py-4">${state.studies.find(study => study.id == s.studyId)?.title || 'N/A'}</td><td class="px-6 py-4"><button data-action="view-survey" data-id="${s.id}" class="text-blue-600 dark:text-blue-400 hover:underline">View Survey</button></td></tr>`).join('')}${state.surveys.length === 0 ? `<tr><td colspan="3" class="text-center text-gray-500 dark:text-gray-400 py-8">No surveys created yet.</td></tr>` : ''}</tbody>
            </table>
        </div>`;
const getReportingHTML = () => {
    const sources = ['Facebook', 'Instagram', 'Reddit', 'Site', 'Marketing', 'Email'];
    return `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Reporting & Analytics</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Report Filters</h3>
            <form id="report-filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
                <select name="studyId" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Studies</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select>
                <select name="siteId" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Sites</option>${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                <select name="status" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Statuses</option>${['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'].map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                <select name="source" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Sources</option>${sources.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                <select name="schedulingStatus" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Scheduling Statuses</option><option value="scheduled">Scheduled</option><option value="not-scheduled">Not Scheduled</option></select>
                <select name="surveyOutcome" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Survey Outcomes</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select>
                <div class="flex items-center gap-2">
                    <input type="number" name="minAge" placeholder="Min Age" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                    <span>-</span>
                    <input type="number" name="maxAge" placeholder="Max Age" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="surveyCompleted" id="surveyCompleted" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="surveyCompleted" class="text-sm text-gray-700 dark:text-gray-300">Survey Completed</label>
                </div>
                <input type="date" name="startDate" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                <input type="date" name="endDate" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                <button type="submit" class="bg-blue-600 text-white rounded-md h-10 col-span-full lg:col-span-2">Generate Report</button>
            </form>
        </div>
        <div id="report-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <div class="flex justify-between items-center p-6">
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Report Results</h3>
                <div class="flex gap-2">
                    <button id="export-csv-btn" data-action="export-csv" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center disabled:bg-gray-400" disabled>
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Report
                    </button>
                    <button id="export-surveys-btn" data-action="export-surveys-csv" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center disabled:bg-gray-400" disabled>
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Survey Results
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Age</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Survey Outcome</th>
                        </tr>
                    </thead>
                    <tbody id="report-results-body" class="dark:text-gray-300"><tr><td colspan="7" class="text-center text-gray-500 dark:text-gray-400 py-8">Generate a report to see results.</td></tr></tbody>
                </table>
            </div>
        </div>`;
    };
const getDuplicatesHTML = () => `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Find Duplicate Patients</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <p class="text-gray-600 dark:text-gray-400 mb-4">This tool scans for patients with matching <strong>Last Name</strong>, <strong>Date of Birth</strong>, and a partial <strong>First Name</strong> (e.g., Matt vs. Matthew). Review results carefully.</p>
            <button data-action="start-duplicate-scan" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 flex items-center">
                <i data-lucide="scan-line" class="w-5 h-5 mr-2"></i> Start Scan
            </button>
        </div>
        <div id="duplicate-results-container">
            <p class="text-center text-gray-500 dark:text-gray-400 py-8">Scan results will be displayed here.</p>
        </div>
        `;
const getSchedulingHTML = () => {
    // Filter studies to only show active ones
    const activeStudies = state.studies.filter(s => ['Recruiting', 'Enrolling', 'Active'].includes(s.status));
    
    const creatorView = `
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Create Appointment Schedule</h3>
            <form id="schedule-creator-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Study</label><select name="studyId" id="schedule-study-select" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"><option value="">Select a Study</option>${activeStudies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site</label><select name="siteId" id="schedule-site-select" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"><option value="">Select a Study First</option></select></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Visit</label>
                        <select name="visit" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white">
                            <option value="Visit 1">Visit 1</option>
                            <option value="Visit 2">Visit 2</option>
                            <option value="Visit 3">Visit 3</option>
                            <option value="Visit 4">Visit 4</option>
                            <option value="Visit 5">Visit 5</option>
                        </select>
                    </div>
                    <div></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label><input type="date" name="startDate" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date</label><input type="date" name="endDate" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                </div>
                <div>
                    <label class="font-medium dark:text-gray-300">Days of the Week</label>
                    <div class="flex items-center gap-4 my-2 dark:text-gray-300">
                        <label class="flex items-center"><input type="checkbox" data-day-group="weekdays" class="mr-2 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> Weekdays</label>
                        <label class="flex items-center"><input type="checkbox" data-day-group="weekends" class="mr-2 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> Weekends</label>
                        <label class="flex items-center"><input type="checkbox" data-day-group="everyday" class="mr-2 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> Everyday</label>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-1">${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `<button type="button" data-day="${i}" class="day-btn p-2 rounded border dark:border-gray-600 w-12 bg-gray-200 dark:bg-gray-600 dark:text-white">${day}</button>`).join('')}</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Time</label><input type="time" name="startTime" value="09:00" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Time</label><input type="time" name="endTime" value="17:00" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interval</label><input type="number" name="duration" value="60" required placeholder="e.g., 60" class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Capacity</label><input type="number" name="capacity" value="1" required placeholder="e.g., 1" class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Generate Schedule</button>
            </form>
        </div>
       <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Generated Schedules</h3>
            <div id="schedules-list" class="space-y-4">${state.schedules.length === 0 ? '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No schedules created yet.</p>' : state.schedules.map(s => {
                const totalCapacity = s.slots.reduce((sum, slot) => sum + slot.capacity, 0);
                const totalBooked = s.slots.reduce((sum, slot) => sum + (slot.booked || 0), 0);
                const availableSlots = totalCapacity - totalBooked;
                return `<div class="p-4 border dark:border-gray-700 rounded-lg dark:text-gray-300 flex justify-between items-center">
                    <div>
                        <h4 class="font-bold">${s.visit || 'General'} - ${state.studies.find(study => study.id == s.studyId)?.title || 'N/A'} at ${state.sites.find(site => site.id == s.siteId)?.name || 'N/A'}</h4>
                        <p>${availableSlots} of ${totalCapacity} total slots available.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-action="edit-schedule" data-id="${s.id}" class="text-blue-600 hover:underline">Edit</button>
                        <button data-action="delete-schedule" data-id="${s.id}" class="text-red-600 hover:underline">Delete</button>
                    </div>
                </div>`
            }).join('')}</div>
        </div>
        `;
    const calendarView = `<div id="calendar-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"></div>`;
    const dayView = `<div id="day-view-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"></div>`;
    const bookedView = `<div id="booked-view-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"></div>`;
    let currentViewHTML = '';
    switch(state.schedulingView) {
        case 'calendar': currentViewHTML = calendarView; break;
        case 'day': currentViewHTML = dayView; break;
        case 'booked': currentViewHTML = bookedView; break;
        case 'creator': default: currentViewHTML = creatorView; break;
    }
    const siteStudyFilterHTML = (state.schedulingView === 'calendar' || state.schedulingView === 'day' || state.schedulingView === 'booked')
        ? `<select id="scheduling-site-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
           <option value="all">All Sites</option>
           ${state.sites.map(s => `<option value="${s.id}" ${state.schedulingSiteFilter === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
       </select>
       <select id="scheduling-study-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
           <option value="all">All Studies</option>
           ${state.studies.map(s => `<option value="${s.id}" ${state.schedulingStudyFilter === s.id ? 'selected' : ''}>${s.title}</option>`).join('')}
       </select>`
        : '';
    const visitFilterHTML = (state.schedulingView === 'calendar' || state.schedulingView === 'day') 
        ? `<select id="scheduling-visit-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
           <option value="all">All Visits</option>
           ${[1,2,3,4,5].map(v => `<option value="Visit ${v}" ${state.schedulingVisitFilter === `Visit ${v}` ? 'selected' : ''}>Visit ${v}</option>`).join('')}
       </select>` 
        : '';
    return `
    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Scheduling</h2>
        <div class="flex items-center gap-2 flex-wrap ml-auto">
            ${siteStudyFilterHTML}
            ${visitFilterHTML}
            <div class="flex items-center gap-2">
                <button data-action="set-scheduling-view" data-view="creator" class="${state.schedulingView === 'creator' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Creator</button>
                <button data-action="set-scheduling-view" data-view="calendar" class="${state.schedulingView === 'calendar' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Month</button>
                <button data-action="set-scheduling-view" data-view="day" class="${state.schedulingView === 'day' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Day</button>
                <button data-action="set-scheduling-view" data-view="booked" class="${state.schedulingView === 'booked' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Booked</button>
            </div>
        </div>
    </div>
    ${currentViewHTML}
    `;
};
// --- MODAL HTML GETTERS ---
const getDayAppointmentsModalHTML = (dateString) => {
    const date = new Date(dateString + 'T00:00:00');
    const dayName = date.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });
    const slotsForDay = [];
    state.schedules.forEach(schedule => {
        schedule.slots.forEach(slot => {
            if (new Date(slot.startTime).toISOString().split('T')[0] === dateString) {
                slotsForDay.push({ schedule, slot });
            }
        });
    });
    slotsForDay.sort((a, b) => new Date(a.slot.startTime) - new Date(b.slot.startTime));
    let contentHTML = `<h2 class="text-2xl font-bold dark:text-white mb-4">Schedule for ${dayName}</h2>`;
    if (slotsForDay.length > 0) {
        contentHTML += `<div class="space-y-4">`;
        slotsForDay.forEach(({ schedule, slot }) => {
            const study = state.studies.find(s => s.id === schedule.studyId);
            const site = state.sites.find(s => s.id === schedule.siteId);
            const patientsInSlot = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id);
            const bookedCount = patientsInSlot.length;
            const isFull = bookedCount >= slot.capacity;
            contentHTML += `
                <div class="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/50 cursor-pointer appointment-slot" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg dark:text-white">${new Date(slot.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                            <p class="font-medium text-sm dark:text-gray-200">${schedule.visit || 'General'} - ${study?.title || 'N/A'}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${site?.name || 'N/A'}</p>
                        </div>
                        <div class="text-right text-sm">
                            <p class="font-semibold ${isFull ? 'text-red-500' : 'text-green-500'}">
                                ${bookedCount} / ${slot.capacity} Booked
                            </p>
                        </div>
                    </div>
                    <div class="mt-2 border-t dark:border-gray-600 pt-2 text-sm">
                        ${patientsInSlot.length > 0
                            ? patientsInSlot.map(p => `<p class="dark:text-gray-300"><i data-lucide="user" class="inline-block w-4 h-4 mr-1"></i><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">${p.firstName} ${p.lastName}</button></p>`).join('')
                            : '<p class="text-gray-500 dark:text-gray-400">No participants scheduled.</p>'
                        }
                    </div>
                </div>
            `;
        });
        contentHTML += `</div>`;
    } else {
        contentHTML += `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No appointment slots available for this day.</p>`;
    }
    return contentHTML;
};
const getPatientProfileHTML = (patient) => {
    if (!patient) return `<h2 class="text-2xl font-bold dark:text-white mb-4">Patient not found</h2>`;
    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
    const pastEnrollments = patient.enrollments?.filter(e => e.status === 'past') || [];
    const study = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId) : null;
    const site = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId) : null;
    // --- Survey Results ---
    let surveyResultsHTML = '<p class="text-gray-500 dark:text-gray-400">No survey results found.</p>';
    if (patient.surveyResults && patient.surveyResults.length > 0) {
        surveyResultsHTML = patient.surveyResults.map(result => {
            let outcomeHTML = '';
            if (result.outcome) {
                const colorClass = result.outcome === 'Pass'
                    ? 'text-green-500'
                    : (result.outcome === 'Fail' ? 'text-red-500' : 'text-gray-500');
                outcomeHTML = `<p class="text-sm font-bold ${colorClass} dark:${colorClass.replace('500', '400')}">Outcome: ${result.outcome}</p>`;
            }
            return `
                <div class="mt-4 p-3 border dark:border-gray-700 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold dark:text-gray-200">${result.surveyTitle}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Completed on: ${new Date(result.completedAt).toLocaleString()}</p>
                        </div>
                        ${outcomeHTML}
                    </div>
                    <ul class="list-disc pl-5 text-sm dark:text-gray-300 mt-2">
                        ${result.answers.map(ans => `<li><strong>${ans.question}</strong>: ${ans.answer}</li>`).join('')}
                    </ul>
                </div>
            `;
        }).join('');
    }
    // --- Contact Log ---
    let contactLogHTML = `
        <div class="flex justify-end mb-4">
            <button data-action="add-contact-log" data-patient-id="${patient.id}" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Add Log</button>
        </div>
    `;
    if (patient.contactLogs && patient.contactLogs.length > 0) {
        contactLogHTML += patient.contactLogs.map(log => `
            <div class="mt-4 p-3 border dark:border-gray-700 rounded-lg">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Logged on: ${new Date(log.date).toLocaleString()}</p>
                <p class="dark:text-gray-300"><strong>Outcome:</strong> ${log.outcome}</p>
                <p class="dark:text-gray-300 mt-1"><strong>Notes:</strong> ${log.notes}</p>
            </div>
        `).join('');
    } else {
        contactLogHTML += '<p class="text-gray-500 dark:text-gray-400">No contact logs found.</p>';
    }
    // --- Appointment ---
    let appointmentHTML = '<p><strong>Appointment:</strong> Not Scheduled</p>';
    if (patient.appointment) {
        const visitStatus = patient.appointment.visitStatus || 'Scheduled';
        appointmentHTML = `
            <p><strong>Appointment:</strong> ${new Date(patient.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })} (${patient.appointment.visit || 'General'})</p>
            <p><strong>Visit Status:</strong> ${visitStatus}</p>
            <div class="flex gap-2 mt-2">
                <button data-action="change-appointment" data-patient-id="${patient.id}" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Change</button>
                <button data-action="cancel-appointment" data-patient-id="${patient.id}" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Cancel</button>
            </div>
        `;
    }
    // --- Visit Logs ---
    let visitDetailsHTML = `
        <div class="flex justify-end mb-4">
            <button data-action="add-visit-log" data-patient-id="${patient.id}" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Add Visit Log</button>
        </div>
    `;
    if (patient.visitLogs && patient.visitLogs.length > 0) {
        const sortedLogs = [...patient.visitLogs].sort((a, b) => new Date(b.date) - new Date(a.date));
        visitDetailsHTML += sortedLogs.map(log => `
            <div class="mt-4 p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-lg dark:text-white">${log.visit} - <span class="font-medium">${log.outcome}</span></h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Logged on: ${new Date(log.date).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm dark:text-gray-300">Completed by: ${log.completedBy}</p>
                        <p class="text-sm dark:text-gray-300">Signed: ${log.signature}</p>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        visitDetailsHTML += '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No visit logs have been recorded.</p>';
    }
    return `
        <div class="flex justify-between items-start mb-6">
            <h2 class="text-2xl font-bold dark:text-white">${patient.firstName} ${patient.lastName}</h2>
            <button data-action="close-side-panel" class="text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="flex items-center gap-2 mb-6">
            <button data-action="survey-patient" data-id="${patient.id}" class="bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 flex items-center text-sm font-medium">
                <i data-lucide="clipboard-list" class="w-4 h-4 mr-2"></i> Survey
            </button>
            <button data-action="schedule-patient" data-id="${patient.id}" class="bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 flex items-center text-sm font-medium">
                <i data-lucide="calendar-plus" class="w-4 h-4 mr-2"></i> Schedule
            </button>
            <button data-action="edit-patient" data-id="${patient.id}" class="bg-gray-500 text-white px-3 py-1.5 rounded-md hover:bg-gray-600 flex items-center text-sm font-medium">
                <i data-lucide="edit" class="w-4 h-4 mr-2"></i> Edit
            </button>
        </div>
        <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="patient-profile-tabs" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'details' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                        id="details-tab" data-tab-name="details" data-patient-id="${patient.id}" type="button" role="tab">Details</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'contactLog' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                        id="contact-log-tab" data-tab-name="contactLog" data-patient-id="${patient.id}" type="button" role="tab">Contact Log</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'surveyHistory' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                        id="survey-history-tab" data-tab-name="surveyHistory" data-patient-id="${patient.id}" type="button" role="tab">Survey History</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'visitDetails' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                        id="visit-details-tab" data-tab-name="visitDetails" data-patient-id="${patient.id}" type="button" role="tab">Visit Details</button>
                </li>
            </ul>
        </div>
        <div id="patient-profile-tab-content-container">
            <div id="details-content" class="${state.currentPatientProfileTab === 'details' ? '' : 'hidden'}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 dark:text-gray-300">
                    <div class="space-y-2">
                        <p><strong>Global ID:</strong> ${patient.globalId || 'N/A'}</p>
                        <p><strong>Initials:</strong> ${patient.initials || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${patient.phoneNumber || 'N/A'}</p>
                        <p><strong>Email:</strong> ${patient.email || 'N/A'}</p>
                        <p><strong>DOB:</strong> ${patient.dob || 'N/A'}</p>
                        <p><strong>Address:</strong> ${patient.address || 'N/A'}</p>
                        <p><strong>City:</strong> ${patient.city || 'N/A'}</p>
                        <p><strong>State:</strong> ${patient.state || 'N/A'}</p>
                        <p><strong>Zip:</strong> ${patient.zipCode || 'N/A'}</p>
                    </div>
                    <div class="space-y-2">
                        <p><strong>Age:</strong> ${patient.age || 'N/A'}</p>
                        <p><strong>Status:</strong> ${patient.status || 'N/A'}</p>
                        <p><strong>Registry Status:</strong> ${patient.registryStatus || 'N/A'}</p>
                        <p><strong>Source:</strong> ${patient.source || 'N/A'}</p>
                        <p><strong>Therapeutic Area:</strong> ${patient.therapeuticArea || 'N/A'}</p>
                        <p><strong>Current Study:</strong> ${study?.title || 'N/A'}</p>
                        <p><strong>Site:</strong> ${site?.name || 'N/A'}</p>
                        ${appointmentHTML}
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="font-semibold text-lg dark:text-white mb-2 border-t dark:border-gray-700 pt-4">Enrollment History</h3>
                    ${pastEnrollments.length > 0 ? pastEnrollments.map((e, index) => `
                        <div class="p-2 border-l-2 dark:border-gray-600 pl-3 mb-2 flex justify-between items-center">
                            <div>
                                <p><strong>Study:</strong> ${state.studies.find(s => s.id === e.studyId)?.title || 'N/A'}</p>
                                <p><strong>Site:</strong> ${state.sites.find(s => s.id === e.siteId)?.name || 'N/A'}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    Enrolled: ${e.enrolledDate ? new Date(e.enrolledDate).toLocaleDateString() : 'N/A'} - Exited: ${e.exitedDate ? new Date(e.exitedDate).toLocaleDateString() : 'Present'}
                                </p>
                            </div>
                            <button data-action="edit-past-enrollment" data-patient-id="${patient.id}" data-enrollment-index="${patient.enrollments.findIndex(en => en === e)}" class="text-blue-600 hover:underline text-sm p-1">Edit</button>
                        </div>
                    `).join('') : '<p class="text-gray-500 dark:text-gray-400">No past enrollments.</p>'}
                </div>
            </div>
            <div id="contactLog-content" class="${state.currentPatientProfileTab === 'contactLog' ? '' : 'hidden'} dark:text-gray-300">
                ${contactLogHTML}
            </div>
            <div id="surveyHistory-content" class="${state.currentPatientProfileTab === 'surveyHistory' ? '' : 'hidden'} dark:text-gray-300">
                ${surveyResultsHTML}
            </div>
            <div id="visitDetails-content" class="${state.currentPatientProfileTab === 'visitDetails' ? '' : 'hidden'} dark:text-gray-300">
                ${visitDetailsHTML}
            </div>
        </div>
    `;
};
const getBookingModalHTML = (patient, visitFilter = 'all') => {
    if (!patient) return `<h2>Patient not found</h2>`;
    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
    if (!currentEnrollment) {
         return `
            <h2 class="text-2xl font-bold dark:text-white mb-4">Schedule for ${patient.firstName} ${patient.lastName}</h2>
            <p class="text-red-500">This patient is not currently enrolled in a study and cannot be scheduled.</p>
        `;
    }
    const completedVisits = patient.completedVisits || [];
    const availableSchedules = state.schedules.filter(s => 
        s.siteId === currentEnrollment.siteId && 
        s.studyId === currentEnrollment.studyId &&
        !completedVisits.includes(s.visit)
    );
    const uniqueVisits = [...new Set(availableSchedules.map(s => s.visit).filter(Boolean))].sort();
    if (availableSchedules.length === 0) {
        return `
            <h2 class="text-2xl font-bold dark:text-white mb-4">Schedule for ${patient.firstName} ${patient.lastName}</h2>
            <p class="text-red-500">No available schedules match the patient's assigned site, study, and visit history.</p>
        `;
    }
    // This function will now be responsible for rendering the calendar inside the modal
    const renderBookingCalendar = (date, patient, currentFilter) => {
        const month = date.getMonth();
        const year = date.getFullYear();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();
        const monthName = date.toLocaleString('default', { month: 'long' });
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const filteredSchedules = currentFilter === 'all' 
            ? availableSchedules 
            : availableSchedules.filter(s => s.visit === currentFilter);
        const availableSlotsByDay = {};
        filteredSchedules.forEach(schedule => {
            schedule.slots.forEach(slot => {
                if (slot.booked < slot.capacity) {
                    const slotDate = new Date(slot.startTime).toISOString().split('T')[0];
                    if (!availableSlotsByDay[slotDate]) {
                        availableSlotsByDay[slotDate] = [];
                    }
                    availableSlotsByDay[slotDate].push({scheduleId: schedule.id, scheduleType: schedule.visit, ...slot});
                }
            });
        });
        let calendarHTML = `
            <div class="flex justify-between items-center mb-4 dark:text-white">
                <button data-action="prev-booking-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
                <h3 class="text-xl font-semibold">${monthName} ${year}</h3>
                <button data-action="next-booking-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm">
                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<div class="font-semibold text-gray-500 dark:text-gray-400">${day}</div>`).join('')}
            `;
        for (let i = 0; i < startDayOfWeek; i++) { calendarHTML += `<div></div>`; }
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const dateString = currentDate.toISOString().split('T')[0];
            const hasSlots = availableSlotsByDay[dateString];
            const isPastDate = currentDate < today;
            const isToday = today.toDateString() === currentDate.toDateString();
            const isBookable = hasSlots && !isPastDate;
            calendarHTML += `
                <button 
                    data-action="select-booking-day" 
                    data-date="${dateString}" 
                    class="p-2 rounded-full ${isBookable ? 'bg-blue-500 text-white hover:bg-blue-600 cursor-pointer' : 'text-gray-400 dark:text-gray-500 cursor-not-allowed'} ${isToday ? 'ring-2 ring-blue-500' : ''}"
                    ${!isBookable ? 'disabled' : ''}
                >
                    ${day}
                </button>
            `;
        }
        calendarHTML += `</div>`;
        return calendarHTML;
    };
    return `
        <div class="flex justify-between items-center mb-4">
             <h2 class="text-2xl font-bold dark:text-white">Schedule for ${patient.firstName} ${patient.lastName}</h2>
             <select id="booking-visit-filter" data-patient-id="${patient.id}" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                 <option value="all">Filter by Visit (All)</option>
                 ${uniqueVisits.map(v => `<option value="${v}" ${visitFilter === v ? 'selected' : ''}>${v}</option>`).join('')}
             </select>
        </div>
        <p class="dark:text-gray-300"><strong>Study:</strong> ${state.studies.find(s => s.id === currentEnrollment.studyId)?.title}</p>
        <p class="dark:text-gray-300 mb-4"><strong>Site:</strong> ${state.sites.find(s => s.id === currentEnrollment.siteId)?.name}</p>
        <div id="booking-calendar-container" data-patient-id="${patient.id}">
            ${renderBookingCalendar(state.bookingCalendarDate, patient, visitFilter)}
        </div>
        <div id="booking-slots-container" class="mt-4 max-h-48 overflow-y-auto"></div>
    `;
};
const getQuickAddPatientHTML = () => {
    const registryStatuses = ['Active', 'Inactive', 'Do Not Call'];
    const therapeuticAreas = ['Dry Eye', 'Allergy', 'Glaucoma', 'Cataract', 'Retina', 'Uveitis'];
    const sources = ['Facebook', 'Instagram', 'Reddit', 'Site', 'Marketing', 'Email'];
    // Fields to be mapped automatically
    const mappedFields = ['firstName', 'lastName', 'phoneNumber', 'email', 'dob', 'address', 'city', 'state', 'zipCode'];
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Quick Add Patient</h2>
        <form id="quick-add-patient-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${mappedFields.map(key => {
                    const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><input type="${key === 'dob' ? 'date' : 'text'}" name="${key}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"></div>`;
                }).join('')}
                <!-- Manually added and special fields -->
                <div><label class="block text-sm font-medium dark:text-gray-300">Initials</label><input type="text" name="initials" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-gray-200 dark:bg-gray-800 dark:text-white cursor-not-allowed" readonly></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Age</label><input type="text" name="age" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-gray-200 dark:bg-gray-800 dark:text-white cursor-not-allowed" readonly></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Status</label><select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'].map(s => `<option>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Registry Status</label><select name="registryStatus" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${registryStatuses.map(s => `<option>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Therapeutic Area</label><select name="therapeuticArea" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Area</option>${therapeuticAreas.map(s => `<option>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Source</label><select name="source" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Source</option>${sources.map(s => `<option>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Assign to Study</label><select name="studyId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">None</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Assign to Site</label><select name="siteId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">None</option>${state.sites.filter(s => s.status === 'Active').map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Add Patient</button>
        </form>
    `;
};
const getEditPatientModalHTML = (patient) => {
    if (!patient) return `<h2 class="text-2xl font-bold dark:text-white mb-4">Patient not found</h2>`;
    
    const registryStatuses = ['Active', 'Inactive', 'Do Not Call'];
    const therapeuticAreas = ['Dry Eye', 'Allergy', 'Glaucoma', 'Cataract', 'Retina', 'Uveitis'];
    const sources = ['Facebook', 'Instagram', 'Reddit', 'Site', 'Marketing', 'Email'];
    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
    
    // Check if patient has a scheduled appointment
    const hasAppointment = patient.appointment && patient.appointment.time;
    const appointmentWarning = hasAppointment ? `
        <div class="mb-4 p-3 bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300">
            <p class="font-semibold">⚠️ Appointment Scheduled</p>
            <p>This patient has a scheduled appointment on ${new Date(patient.appointment.time).toLocaleString()}. 
            Study assignment cannot be changed while an appointment is scheduled.</p>
        </div>
    ` : '';
    
    // Check washout status
    const washoutStatus = getWashoutStatus(patient);
    const washoutWarning = washoutStatus ? `
        <div class="mb-4 p-3 bg-orange-100 dark:bg-orange-900 border-l-4 border-orange-500 text-orange-700 dark:text-orange-300">
            <p class="font-semibold">⏳ Washout Period Active</p>
            <p>Patient exited ${washoutStatus.studyTitle} on ${new Date(washoutStatus.exitedDate).toLocaleDateString()}. 
            Cannot be enrolled in a new study until ${washoutStatus.remainingDays} days remaining (${new Date(washoutStatus.washoutEndDate).toLocaleDateString()}).</p>
        </div>
    ` : '';
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Patient: ${patient.firstName} ${patient.lastName}</h2>
        ${appointmentWarning}
        ${washoutWarning}
        <form id="edit-patient-form" data-id="${patient.id}" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium dark:text-gray-300">First Name</label><input type="text" name="firstName" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.firstName || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Last Name</label><input type="text" name="lastName" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.lastName || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Phone Number</label><input type="text" name="phoneNumber" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.phoneNumber || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Email</label><input type="email" name="email" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.email || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Date of Birth</label><input type="date" name="dob" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.dob || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Age</label><input type="text" name="age" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-gray-200 dark:bg-gray-800 dark:text-white cursor-not-allowed" readonly value="${patient.age || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Address</label><input type="text" name="address" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.address || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">City</label><input type="text" name="city" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.city || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">State</label><input type="text" name="state" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.state || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Zip Code</label><input type="text" name="zipCode" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${patient.zipCode || ''}"></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Status</label><select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'].map(s => `<option ${patient.status === s ? 'selected' : ''} ${(washoutStatus && s === 'Pre-Screening') ? 'disabled' : ''}>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Registry Status</label><select name="registryStatus" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${registryStatuses.map(s => `<option ${patient.registryStatus === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Therapeutic Area</label><select name="therapeuticArea" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Area</option>${therapeuticAreas.map(s => `<option ${patient.therapeuticArea === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Source</label><select name="source" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Source</option>${sources.map(s => `<option ${patient.source === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Assign to Study</label><select name="studyId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" ${hasAppointment || washoutStatus ? 'disabled' : ''}><option value="">None</option>${state.studies.map(s => `<option ${currentEnrollment?.studyId === s.id ? 'selected' : ''} value="${s.id}">${s.title}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium dark:text-gray-300">Assign to Site</label><select name="siteId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" ${hasAppointment || washoutStatus ? 'disabled' : ''}><option value="">None</option>${state.sites.filter(s => s.status === 'Active').map(s => `<option ${currentEnrollment?.siteId === s.id ? 'selected' : ''} value="${s.id}">${s.name}</option>`).join('')}</select></div>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    `;
};

const getEditStudyModalHTML = (study) => {
    const studySiteIds = study.siteIds || [];
    const assignedSites = state.sites.filter(site => studySiteIds.includes(site.id));
    const unassignedSites = state.sites.filter(site => !studySiteIds.includes(site.id) && site.status === 'Active');
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Clinical Study</h2>
        <form id="edit-study-form" data-id="${study.id}" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Study Title</label>
                    <input type="text" name="title" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${study.title}">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Protocol Number</label>
                    <input type="text" name="protocolNumber" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${study.protocolNumber || ''}">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Status</label>
                    <select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                        ${['Recruiting', 'Enrolling', 'Active', 'Closed'].map(s => `<option ${study.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Enrollment Target</label>
                    <input type="number" name="target" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${study.target}">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Washout Days</label>
                    <input type="number" name="washoutDays" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${typeof study.washoutDays === 'number' ? study.washoutDays : 30}" min="0">
                </div>
            </div>
            
            <div class="border-t dark:border-gray-600 pt-4 mt-4">
                <h3 class="text-lg font-semibold dark:text-gray-200 mb-3">Site Assignments</h3>
                
                ${assignedSites.length > 0 ? `
                    <div class="mb-4">
                        <label class="block text-sm font-medium dark:text-gray-300 mb-2">Currently Assigned Sites (${assignedSites.length})</label>
                        <div class="bg-blue-50 dark:bg-blue-900/20 border dark:border-blue-500 rounded-lg p-3 max-h-48 overflow-y-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                ${assignedSites.map(site => `
                                    <label class="flex items-center p-2 bg-white dark:bg-gray-800 rounded border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                        <input type="checkbox" name="siteIds" value="${site.id}" checked class="h-4 w-4 rounded border-gray-300 text-blue-600">
                                        <span class="ml-2 text-sm dark:text-gray-200">${site.name}</span>
                                        <span class="ml-auto text-xs text-green-600 dark:text-green-400">✓ Assigned</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Uncheck to remove site from study</p>
                    </div>
                ` : ''}
                
                ${unassignedSites.length > 0 ? `
                    <div>
                        <label class="block text-sm font-medium dark:text-gray-300 mb-2">Available Sites (${unassignedSites.length})</label>
                        <div class="bg-gray-50 dark:bg-gray-800 border dark:border-gray-600 rounded-lg p-3 max-h-48 overflow-y-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                ${unassignedSites.map(site => `
                                    <label class="flex items-center p-2 bg-white dark:bg-gray-700 rounded border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
                                        <input type="checkbox" name="siteIds" value="${site.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600">
                                        <span class="ml-2 text-sm dark:text-gray-200">${site.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Check to add site to study</p>
                    </div>
                ` : '<p class="text-sm text-gray-500 dark:text-gray-400">All active sites are already assigned to this study.</p>'}
            </div>
            
            <div class="flex justify-end gap-4 pt-4 border-t dark:border-gray-600">
                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    `;
};

const getEditScheduleModalHTML = (schedule) => {
    if (!schedule) return `<h2 class="text-2xl font-bold dark:text-white mb-4">Schedule not found</h2>`;
    
    const study = state.studies.find(s => s.id === schedule.studyId);
    const site = state.sites.find(s => s.id === schedule.siteId);
    const totalCapacity = schedule.slots.reduce((sum, slot) => sum + slot.capacity, 0);
    const totalBooked = schedule.slots.reduce((sum, slot) => sum + (slot.booked || 0), 0);
    const availableSlots = totalCapacity - totalBooked;
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Schedule</h2>
        <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <h3 class="font-semibold text-lg dark:text-white mb-2">Schedule Details</h3>
            <p class="dark:text-gray-300"><strong>Visit:</strong> ${schedule.visit || 'General'}</p>
            <p class="dark:text-gray-300"><strong>Study:</strong> ${study?.title || 'N/A'}</p>
            <p class="dark:text-gray-300"><strong>Site:</strong> ${site?.name || 'N/A'}</p>
            <p class="dark:text-gray-300"><strong>Total Slots:</strong> ${schedule.slots.length}</p>
            <p class="dark:text-gray-300"><strong>Total Capacity:</strong> ${totalCapacity}</p>
            <p class="dark:text-gray-300"><strong>Booked:</strong> ${totalBooked}</p>
            <p class="dark:text-gray-300"><strong>Available:</strong> ${availableSlots}</p>
        </div>
        
        <div class="space-y-4">
            <h3 class="font-semibold text-lg dark:text-white">Schedule Actions</h3>
            <div class="flex gap-4">
                <button data-action="delete-schedule" data-id="${schedule.id}" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 flex items-center">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    Delete Schedule
                </button>
                <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i>
                    This will cancel all appointments and cannot be undone
                </p>
            </div>
        </div>
        
        <div class="mt-8">
            <h3 class="font-semibold text-lg dark:text-white mb-4">Individual Slots</h3>
            <div class="max-h-96 overflow-y-auto space-y-2">
                ${schedule.slots.map((slot, index) => {
                    const slotDate = new Date(slot.startTime);
                    const isBooked = (slot.booked || 0) > 0;
                    return `
                        <div class="p-3 border dark:border-gray-600 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-medium dark:text-white">${slotDate.toLocaleDateString()} at ${slotDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${slot.booked || 0}/${slot.capacity} booked</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${isBooked ? 
                                    `<span class="text-sm text-gray-500 dark:text-gray-400">Cannot delete - has bookings</span>` :
                                    `<button data-action="delete-slot" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="text-red-600 hover:underline text-sm">Delete Slot</button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <div class="mt-6 flex justify-end gap-4">
            <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Close</button>
        </div>
    `;
};
const getAppointmentDetailsModalHTML = (schedule, slot) => {
    const scheduledPatients = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id);
    const study = state.studies.find(s => s.id === schedule.studyId);
    const site = state.sites.find(s => s.id === schedule.siteId);
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-2">Appointment Details</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">${new Date(slot.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' })}</p>
        <p class="dark:text-gray-300"><strong>Site:</strong> ${site?.name || 'N/A'}</p>
        <p class="dark:text-gray-300"><strong>Study:</strong> ${study?.title || 'N/A'}</p>
        <p class="dark:text-gray-300"><strong>Visit Type:</strong> ${schedule.visit || 'General'}</p>
        <form id="update-capacity-form" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="my-4 flex items-end gap-2">
            <div>
                <label for="capacity" class="block text-sm font-medium dark:text-gray-300">Edit Slot Capacity</label>
                <input type="number" name="capacity" class="w-24 p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${slot.capacity}">
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm">Update</button>
        </form>
        <h3 class="font-semibold dark:text-white mt-6 mb-2">Scheduled Participants (${scheduledPatients.length}/${slot.capacity})</h3>
        ${scheduledPatients.length > 0 ? `
            <ul class="list-disc pl-5 dark:text-gray-300">
                ${scheduledPatients.map(p => `<li><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">${p.firstName} ${p.lastName}</button></li>`).join('')}
            </ul>
        ` : '<p class="text-gray-500 dark:text-gray-400">No participants scheduled for this slot.</p>'}
        <div class="mt-6 border-t dark:border-gray-700 pt-4">
            <button data-action="delete-slot" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="text-sm text-red-600 hover:underline" ${slot.booked > 0 ? 'disabled' : ''}>Delete Slot</button>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" ${slot.booked > 0 ? '' : 'hidden'}>Cannot delete a slot that is booked.</p>
        </div>
    `;
};
const getViewSurveyModalHTML = (survey) => {
    if (!survey) return `<h2>Survey not found</h2>`;
    const study = state.studies.find(s => s.id === survey.studyId);
    let questionsHTML = survey.questions.map((q, index) => {
        let optionsHTML = q.options.map(opt => {
            let nextText = `Question ${opt.next}`;
            if (opt.next === 'pass') nextText = 'End - Pass';
            if (opt.next === 'fail') nextText = 'End - Fail';
            if (opt.next === 'submit') nextText = 'End - Completed';
            return `
                <li class="ml-4 list-disc break-words">
                    <span class="break-words whitespace-normal">${opt.text}</span> &rarr; (Next: ${nextText})
                </li>
            `}).join('');
        // Display question notes if available
        let notesHTML = q.note ? `<div class="mt-2 p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm italic">${q.note}</div>` : '';
        // Display question table if available
        let tableHTML = '';
        if (q.table && q.table.headers && q.table.rows) {
            tableHTML = `
                <div class="mt-2 overflow-x-auto">
                    <table class="min-w-full border dark:border-gray-600 text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                ${q.table.headers.map(h => `<th class="px-2 py-1 border dark:border-gray-600">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${q.table.rows.map(row => `
                                <tr>
                                    ${row.map(cell => `<td class="px-2 py-1 border dark:border-gray-600">${cell}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        return `
            <div class="mt-4 p-2 border-t dark:border-gray-700" data-question-id="${q.id || index}" draggable="true">
                <p class="font-semibold break-words whitespace-normal">${q.text}</p>
                ${notesHTML}
                ${tableHTML}
                <ul class="mt-1">
                    ${optionsHTML}
                </ul>
            </div>
        `;
    }).join('');
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-2 break-words">${survey.title}</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">For Study: ${study?.title || 'N/A'}</p>
        <div class="dark:text-gray-300">${questionsHTML}</div>
        <div class="mt-4 flex gap-2">
            <button data-action="edit-survey" data-id="${survey.id}" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Edit Survey</button>
        </div>
    `;
};

const getEditSurveyModalHTML = (survey) => {
    if (!survey) return `<h2>Survey not found</h2>`;
    const study = state.studies.find(s => s.id === survey.studyId);
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Survey: ${survey.title}</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">For Study: ${study?.title || 'N/A'}</p>
        <form id="edit-survey-form" data-id="${survey.id}" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Survey Title</label><input type="text" name="title" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-white dark:bg-gray-700 dark:text-white" value="${survey.title}" required /></div>
                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Assign to Study</label><select name="studyId" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-white dark:bg-gray-700 dark:text-white" required><option value="">Select a study</option>${state.studies.map(s => `<option value="${s.id}" ${s.id === survey.studyId ? 'selected' : ''}>${s.title}</option>`).join('')}</select></div>
            </div>
            <div id="edit-questions-container" class="space-y-4">
                ${survey.questions.map((q, index) => `
                    <div id="edit-q-${index}" class="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700 relative question-block">
                        <button type="button" data-action="remove-question" data-q-id="edit-q-${index}" class="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <label class="font-medium dark:text-white" id="edit-q-${index}-label">${q.text.length > 50 ? q.text.substring(0, 50) + '...' : q.text}</label>
                        <input type="text" name="edit-q-${index}-text" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white mb-2" value="${q.text}" required oninput="updateQuestionLabel('edit-q-${index}')"/>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Question Type</label>
                            <select name="edit-q-${index}-type" class="mt-1 block w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                <option value="single-select" ${q.type === 'single-select' ? 'selected' : ''}>Single Select (with branching)</option>
                                <option value="multi-select" ${q.type === 'multi-select' ? 'selected' : ''}>Multi-Select</option>
                                <option value="dropdown" ${q.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                                <option value="open-text" ${q.type === 'open-text' ? 'selected' : ''}>Open Text</option>
                            </select>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Question Note (Optional)</label>
                            <textarea name="edit-q-${index}-note" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white" rows="2" placeholder="Add a note for this question...">${q.note || ''}</textarea>
                        </div>
                        <div class="mt-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Table Data (Optional)</label>
                            <textarea name="edit-q-${index}-table" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white font-mono text-xs" rows="3" placeholder="Paste CSV data here">${q.table ? q.table.headers.join(',') + '\n' + q.table.rows.map(row => row.join(',')).join('\n') : ''}</textarea>
                        </div>
                        <div class="mt-2 space-y-2 pl-4" data-options-for="edit-q-${index}">
                            <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Options</label>
                            ${q.options.map((opt, optIndex) => `
                                <div class="flex items-center gap-2">
                                    <input type="text" name="edit-q-${index}-option-text" class="flex-grow p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white" value="${opt.text}" required/>
                                    ${q.type === 'single-select' ? `<select name="edit-q-${index}-option-next" class="w-48 p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white"></select>` : ''}
                                    <button type="button" data-action="remove-option" class="p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" data-action="add-option" data-q-id="edit-q-${index}" data-type="${q.type}" class="text-sm text-blue-600 dark:text-blue-400 hover:underline mt-2">+ Add Option</button>
                    </div>
                `).join('')}
            </div>
            <button type="button" data-action="add-question" class="text-sm font-medium text-blue-600 dark:text-blue-400 p-2 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-md">+ Add Question</button>
            <div class="flex gap-4">
                <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Save Changes</button>
                <button type="button" data-action="close-modal" class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">Cancel</button>
            </div>
        </form>
    `;
};

const getSelectSurveyModalHTML = (patient) => {
    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
    if (!currentEnrollment) {
        return `<h2 class="text-2xl font-bold dark:text-white mb-4">Survey ${patient.firstName} ${patient.lastName}</h2><p class="dark:text-gray-300">Patient is not currently in a study.</p>`;
    }
    const availableSurveys = state.surveys.filter(s => s.studyId === currentEnrollment.studyId);
    if (availableSurveys.length === 0) {
        return `<h2 class="text-2xl font-bold dark:text-white mb-4">Survey ${patient.firstName} ${patient.lastName}</h2><p class="dark:text-gray-300">No surveys available for the patient's assigned study.</p>`;
    }
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Select Survey for ${patient.firstName} ${patient.lastName}</h2>
        <div class="space-y-2">
            ${availableSurveys.map(s => `<button data-action="start-survey" data-patient-id="${patient.id}" data-survey-id="${s.id}" class="w-full text-left p-3 border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white">${s.title}</button>`).join('')}
        </div>
    `;
};
const getTakeSurveyModalHTML = () => {
    const { survey, patient, currentQuestionIndex, answers } = state.currentSurveyState;
    const question = survey.questions[currentQuestionIndex];
    // Display question notes if available
    let notesHTML = question.note ? `<div class="mt-2 p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm italic break-words">${question.note}</div>` : '';
    // Display question table if available
    let tableHTML = '';
    if (question.table && question.table.headers && question.table.rows) {
        tableHTML = `
            <div class="mt-2 mb-4 overflow-x-auto">
                <table class="min-w-full border dark:border-gray-600 text-sm">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            ${question.table.headers.map(h => `<th class="px-2 py-1 border dark:border-gray-600">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${question.table.rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td class="px-2 py-1 border dark:border-gray-600">${cell}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-2 break-words">${survey.title}</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Question ${currentQuestionIndex + 1} of ${survey.questions.length}</p>
        <form id="take-survey-form">
            <p class="text-lg font-semibold dark:text-white mb-4 break-words whitespace-normal">${question.text}</p>
            ${notesHTML}
            ${tableHTML}
            <div class="space-y-3 dark:text-gray-300">
                ${question.options.map((opt, index) => `
                    <div>
                        <input type="radio" id="option-${index}" name="answer" value="${opt.text}" data-next="${opt.next}" required class="mr-2">
                        <label for="option-${index}" class="break-words whitespace-normal">${opt.text}</label>
                    </div>
                `).join('')}
            </div>
            <button type="submit" class="mt-8 w-full bg-blue-600 text-white py-2 rounded-md">Next</button>
        </form>
    `;
};
const getAddVisitLogModalHTML = (patientId) => {
    const visitOutcomes = ['Enrolled', 'Screen Fail', 'No Show', 'Did not consent', 'Cancelled', 'Withdrew Consent'];
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Add Visit Log</h2>
        <form id="add-visit-log-form" data-patient-id="${patientId}" class="space-y-4">
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Visit</label>
                <input type="text" name="visit" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., V1, Screening">
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Outcome</label>
                <select name="outcome" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                    ${visitOutcomes.map(o => `<option>${o}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Completed By</label>
                <input type="text" name="completedBy" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="Your Name">
            </div>
             <div>
                <label class="block text-sm font-medium dark:text-gray-300">Signature</label>
                <input type="text" name="signature" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="Type your name to sign">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Visit Log</button>
        </form>
    `;
};

const getCheckInModalHTML = (patientId) => {
    const patient = state.patients.find(p => p.id === patientId);
    if (!patient) return `<h2>Patient not found</h2>`;
    
    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
    const study = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId) : null;
    const site = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId) : null;
    const appointmentTime = new Date(patient.appointment.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const visit = patient.appointment.visit || 'General';
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Check In Patient</h2>
        <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 rounded">
            <p class="text-lg font-semibold dark:text-white mb-2">${patient.firstName} ${patient.lastName}</p>
            <div class="grid grid-cols-2 gap-4 text-sm dark:text-gray-300">
                <div>
                    <p><strong>Study:</strong> ${study?.title || 'N/A'}</p>
                    <p><strong>Site:</strong> ${site?.name || 'N/A'}</p>
                </div>
                <div>
                    <p><strong>Visit:</strong> ${visit}</p>
                    <p><strong>Scheduled:</strong> ${appointmentTime}</p>
                </div>
            </div>
        </div>
        <form id="check-in-form" data-patient-id="${patientId}" class="space-y-4">
            <div>
                <label class="block text-sm font-medium dark:text-gray-300 mb-2">Check-In Status</label>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <input type="radio" name="checkInStatus" value="checked-in" required class="h-4 w-4 text-blue-600">
                        <div class="ml-3">
                            <span class="font-medium dark:text-white">Checked In</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Patient arrived and checked in</p>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <input type="radio" name="checkInStatus" value="no-show" required class="h-4 w-4 text-red-600">
                        <div class="ml-3">
                            <span class="font-medium dark:text-white">No Show</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Patient did not arrive</p>
                        </div>
                    </label>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300 mb-2">Notes (Optional)</label>
                <textarea name="checkInNotes" rows="3" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="Add any additional notes..."></textarea>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Submit</button>
            </div>
        </form>
    `;
};
const getViewStudyPatientsModalHTML = (study) => {
    if (!study) return `<h2>Study not found</h2>`;
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Patients in: ${study.title}</h2>
        <div class="mb-4">
            <input type="text" id="modal-study-patient-search" data-study-id="${study.id}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search patients in this study...">
        </div>
        <div id="modal-patient-list-container">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="modal-patient-list-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                </tbody>
            </table>
        </div>
    `;
};
const getViewSiteStudiesModalHTML = (site) => {
    if (!site) return `<h2>Site not found</h2>`;
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Studies at: ${site.name}</h2>
        <div class="mb-4">
            <input type="text" id="modal-site-study-search" data-site-id="${site.id}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search studies at this site...">
        </div>
        <div id="modal-study-list-container">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Enrollment</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="modal-study-list-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                </tbody>
            </table>
        </div>
    `;
};
const renderModalStudyList = (studies, type, siteId = null) => {
    const modalBody = document.getElementById('modal-study-list-body');
    if (!modalBody) return;
    if (studies.length === 0) {
        modalBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500 dark:text-gray-400">No studies found at this site.</td></tr>`;
        return;
    }
    
    // Get site ID from the search input if not provided
    if (!siteId) {
        const searchInput = document.getElementById('modal-site-study-search');
        siteId = searchInput?.dataset.siteId;
    }
    
    const tableRowsHTML = studies.map(study => {
        // Count patients enrolled in this study at this site
        const sitePatients = state.patients.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.studyId === study.id && currentEnrollment?.siteId === siteId;
        });
        const enrolledCount = sitePatients.filter(p => p.status === 'Enrolled').length;
        
        return `
            <tr class="dark:text-gray-300">
                <td class="px-6 py-4">
                    <button data-action="view-study-patients" data-id="${study.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${study.title}</button>
                </td>
                <td class="px-6 py-4">${study.status || 'N/A'}</td>
                <td class="px-6 py-4">${enrolledCount} / ${study.target || 0}</td>
                <td class="px-6 py-4">
                    <button data-action="view-study-patients" data-id="${study.id}" class="text-blue-600 dark:text-blue-400 hover:underline">View Patients</button>
                </td>
            </tr>
        `;
    }).join('');
    
    modalBody.innerHTML = tableRowsHTML;
    lucide.createIcons();
};

const renderModalPatientList = (patients, type) => {
    const modalBody = document.getElementById('modal-patient-list-body');
    if (!modalBody) return;
    if (patients.length === 0) {
        modalBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500 dark:text-gray-400">No matching patients found.</td></tr>`;
        return;
    }
    let tableRowsHTML = '';
    if (type === 'study') {
        tableRowsHTML = patients.map(p => `
            <tr class="dark:text-gray-300">
                <td class="px-6 py-4"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${p.firstName} ${p.lastName}</button></td>
                <td class="px-6 py-4">${p.status || 'N/A'}</td>
                <td class="px-6 py-4">${p.appointment ? new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'Not Scheduled'}</td>
                <td class="px-6 py-4"><button data-action="survey-patient" data-id="${p.id}" class="text-green-600 dark:text-green-400 hover:underline">Survey</button></td>
            </tr>
        `).join('');
    } else if (type === 'site') {
        tableRowsHTML = patients.map(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            const washoutStatus = getWashoutStatus(p);
            const washoutIndicator = washoutStatus ? `<div class="mt-1"><span class="inline-block px-2 py-1 text-xs bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded-full">Washout: ${washoutStatus.remainingDays}d</span></div>` : '';
            return `
                <tr class="dark:text-gray-300">
                    <td class="px-6 py-4">
                        <div>
                            <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${p.firstName} ${p.lastName}</button>
                            ${washoutIndicator}
                        </div>
                    </td>
                    <td class="px-6 py-4">${currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A'}</td>
                    <td class="px-6 py-4">${p.status || 'N/A'}</td>
                </tr>
            `;
        }).join('');
    }
    modalBody.innerHTML = tableRowsHTML;
    lucide.createIcons();
};
const getImportPatientsModalHTML = () => {
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Import Patients from CSV</h2>
        
        <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 mb-4">
            <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-2">📋 CSV Format Requirements</h3>
            <p class="text-sm text-blue-700 dark:text-blue-200">Upload a CSV file with comma-separated values. Headers are <strong>case-sensitive</strong>.</p>
        </div>

        <div class="max-h-96 overflow-y-auto border dark:border-gray-700 rounded-lg p-4 mb-4 bg-gray-50 dark:bg-gray-800">
            <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-3">Required Fields <span class="text-red-500">*</span></h3>
            <div class="space-y-3 text-sm">
                <div class="bg-white dark:bg-gray-700 p-3 rounded border-l-4 border-red-500">
                    <p class="font-semibold dark:text-white">firstName <span class="text-red-500">*</span></p>
                    <p class="text-gray-600 dark:text-gray-400">Format: Text</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: John</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-3 rounded border-l-4 border-red-500">
                    <p class="font-semibold dark:text-white">lastName <span class="text-red-500">*</span></p>
                    <p class="text-gray-600 dark:text-gray-400">Format: Text</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: Doe</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-3 rounded border-l-4 border-red-500">
                    <p class="font-semibold dark:text-white">dob <span class="text-red-500">*</span></p>
                    <p class="text-gray-600 dark:text-gray-400">Format: YYYY-MM-DD</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: 1985-03-15</p>
                </div>
            </div>

            <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-3 mt-6">Optional Fields</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">initials</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: JD</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">phoneNumber</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: (555) 123-4567</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">email</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: john@email.com</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">address</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: 123 Main St</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">city</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: Boston</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">state</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: MA</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">zipCode</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: 02101</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">age</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Example: 38 (auto-calculated from DOB)</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">status</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Candidate, Enrolled, Pre-Screening, Screen Fail</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">registryStatus</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Active, Inactive, Archived</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">source</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Referral, Walk-in, Website, etc.</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">therapeuticArea</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Oncology, Cardiology, etc.</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">studyId</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Study ID (auto-enrolls patient)</p>
                </div>
                <div class="bg-white dark:bg-gray-700 p-2 rounded">
                    <p class="font-semibold dark:text-white">siteId</p>
                    <p class="text-xs text-gray-500 dark:text-gray-500">Site ID (required if studyId provided)</p>
                </div>
            </div>

            <div class="mt-6 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-3">
                <h4 class="font-bold text-yellow-800 dark:text-yellow-300 mb-2">📝 Example CSV Format:</h4>
                <code class="text-xs bg-white dark:bg-gray-800 p-2 rounded block overflow-x-auto whitespace-pre">firstName,lastName,dob,email,phoneNumber,status,studyId,siteId
John,Doe,1985-03-15,john@email.com,(555) 123-4567,Candidate,study123,site456
Jane,Smith,1990-07-22,jane@email.com,(555) 987-6543,Pre-Screening,study123,site456</code>
            </div>
        </div>

        <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 mb-4">
            <h3 class="font-bold text-green-800 dark:text-green-300 mb-2">✅ Important Notes</h3>
            <ul class="text-sm text-green-700 dark:text-green-200 space-y-1 list-disc list-inside">
                <li>Only <strong>new</strong> patients will be imported (duplicates are skipped based on firstName, lastName, and DOB)</li>
                <li><strong>Global ID</strong> is auto-generated for each patient</li>
                <li><strong>Age</strong> is auto-calculated from DOB if not provided</li>
                <li>If <strong>studyId</strong> is provided, <strong>siteId</strong> must also be provided</li>
                <li>Empty optional fields will be left blank</li>
            </ul>
        </div>

        <form id="import-patients-form" class="mt-6">
            <input type="file" id="csv-file-input" accept=".csv" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" required>
            <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                Import Patients
            </button>
        </form>
        <div id="import-status" class="mt-4 text-sm"></div>
    `;
};
const getAddContactLogModalHTML = (patientId) => {
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Add Contact Log</h2>
        <form id="add-contact-log-form" data-patient-id="${patientId}" class="space-y-4">
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Outcome</label>
                <input type="text" name="outcome" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Notes</label>
                <textarea name="notes" rows="4" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"></textarea>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Log</button>
        </form>
    `;
};

const getAddPatientToStudyModalHTML = (studyId) => {
    const study = state.studies.find(s => s.id === studyId);
    if (!study) return `<h2>Study not found</h2>`;
    
    // Get patients that are NOT currently enrolled in this study
    const availablePatients = state.patients.filter(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        // Include patients with no current enrollment OR enrolled in a different study
        return !currentEnrollment || currentEnrollment.studyId !== studyId;
    });
    
    // Get sites available for this study
    const studySiteIds = study.siteIds || [];
    const availableSites = state.sites.filter(site => 
        studySiteIds.includes(site.id) && site.status === 'Active'
    );
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Add Patient to ${study.title}</h2>
        <div class="mb-4">
            <input type="text" id="add-patient-search" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search patients by name, email, phone, or Global ID..." autocomplete="off">
        </div>
        <div class="mb-4 max-h-96 overflow-y-auto border dark:border-gray-700 rounded-lg">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Global ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Current Study</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Action</th>
                    </tr>
                </thead>
                <tbody id="add-patient-search-results" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    ${availablePatients.length === 0 ? `
                        <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">All patients are already enrolled in this study.</td></tr>
                    ` : availablePatients.map(p => {
                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                        const currentStudy = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId) : null;
                        const washoutStatus = getWashoutStatus(p);
                        const canEnroll = !currentEnrollment && !washoutStatus;
                        
                        return `
                            <tr class="dark:text-gray-300 patient-row" data-patient-name="${p.firstName} ${p.lastName}" data-patient-email="${p.email || ''}" data-patient-phone="${p.phoneNumber || ''}" data-patient-id="${p.globalId || ''}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${p.firstName} ${p.lastName}
                                    ${washoutStatus ? `<div class="mt-1"><span class="inline-block px-2 py-1 text-xs bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded-full">Washout: ${washoutStatus.remainingDays}d</span></div>` : ''}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">${p.globalId || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${p.status || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${currentStudy ? currentStudy.title : 'None'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${canEnroll ? `
                                        <button data-action="select-patient-for-enrollment" data-patient-id="${p.id}" data-study-id="${studyId}" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 text-sm">Select</button>
                                    ` : currentEnrollment ? `
                                        <button data-action="transfer-patient-to-study" data-patient-id="${p.id}" data-study-id="${studyId}" class="bg-yellow-600 text-white px-3 py-1 rounded-md hover:bg-yellow-700 text-sm">Transfer</button>
                                    ` : `
                                        <span class="text-xs text-gray-500 dark:text-gray-400">In washout</span>
                                    `}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <div class="flex justify-end gap-4 mt-4">
            <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
        </div>
    `;
};

const getEnrollPatientFormModalHTML = (patientId, studyId) => {
    const patient = state.patients.find(p => p.id === patientId);
    const study = state.studies.find(s => s.id === studyId);
    if (!patient || !study) return `<h2>Patient or Study not found</h2>`;
    
    // Get sites available for this study
    const studySiteIds = study.siteIds || [];
    const availableSites = state.sites.filter(site => 
        studySiteIds.includes(site.id) && site.status === 'Active'
    );
    
    if (availableSites.length === 0) {
        return `
            <h2 class="text-2xl font-bold dark:text-white mb-4">No Sites Available</h2>
            <p class="dark:text-gray-300">This study has no active sites assigned. Please configure sites in ARTEMIS first.</p>
            <div class="flex justify-end gap-4 mt-4">
                <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Close</button>
            </div>
        `;
    }
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Enroll ${patient.firstName} ${patient.lastName} in ${study.title}</h2>
        <form id="enroll-patient-form" data-patient-id="${patientId}" data-study-id="${studyId}" class="space-y-4">
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Select Site</label>
                <select name="siteId" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                    <option value="">Select a Site</option>
                    ${availableSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('')}
                </select>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Enroll Patient</button>
            </div>
        </form>
    `;
};

const getCreateStudyModalHTML = () => {
    const activeSites = state.sites.filter(site => site.status === 'Active');
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Create New Study</h2>
        <form id="create-study-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Study Title</label>
                    <input type="text" name="title" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Phase 3 Study">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Protocol Number</label>
                    <input type="text" name="protocolNumber" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., P3-001">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Status</label>
                    <select name="status" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white">
                        <option value="Recruiting">Recruiting</option>
                        <option value="Enrolling">Enrolling</option>
                        <option value="Active">Active</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Target Enrollment</label>
                    <input type="number" name="target" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., 100">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Washout Days</label>
                    <input type="number" name="washoutDays" value="30" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., 30">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Start Date</label>
                    <input type="date" name="startDate" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">End Date</label>
                    <input type="date" name="endDate" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white">
                </div>
            </div>
            
            ${activeSites.length > 0 ? `
                <div class="border-t dark:border-gray-600 pt-4">
                    <h3 class="text-lg font-semibold dark:text-gray-200 mb-3">Assign Sites</h3>
                    <div class="bg-gray-50 dark:bg-gray-800 border dark:border-gray-600 rounded-lg p-3 max-h-64 overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${activeSites.map(site => `
                                <label class="flex items-center p-2 bg-white dark:bg-gray-700 rounded border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
                                    <input type="checkbox" name="siteIds" value="${site.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600">
                                    <span class="ml-2 text-sm dark:text-gray-200">${site.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Select the sites where this study will be conducted</p>
                </div>
            ` : '<p class="text-sm text-gray-500 dark:text-gray-400 mt-4">No active sites available. Create sites first.</p>'}
            
            <div class="flex justify-end gap-4 pt-4 border-t dark:border-gray-600">
                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Create Study</button>
            </div>
        </form>
    `;
};

const getCreateSiteModalHTML = () => {
    const indicationOptions = ['Dry Eye', 'Glaucoma', 'Cataract', 'Macular Degeneration', 'Diabetic Retinopathy', 'Other'];
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Add New Site</h2>
        <form id="create-site-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Name</label>
                    <input type="text" name="name" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., City Eye Center">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Name Abbreviation</label>
                    <input type="text" name="siteNameAbbreviation" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., CEC">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Status</label>
                <select name="status" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white">
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Address Line 1</label>
                <input type="text" name="address1" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., 123 Main St">
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Address Line 2</label>
                <input type="text" name="address2" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Suite 100">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">City</label>
                    <input type="text" name="city" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Boston">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">State</label>
                    <input type="text" name="state" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., MA">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Zip Code</label>
                    <input type="text" name="zipCode" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., 02101">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Country</label>
                <input type="text" name="country" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., USA">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Principal Investigator (PI)</label>
                    <input type="text" name="pi" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Dr. Smith">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">PI Email</label>
                    <input type="email" name="piEmail" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., dr.smith@email.com">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Coordinator</label>
                    <input type="text" name="siteCoordinator" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., John Doe">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Coordinator Email</label>
                    <input type="email" name="siteCoordinatorEmail" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., j.doe@email.com">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Indication</label>
                <div class="mt-2 max-h-40 overflow-y-auto border dark:border-gray-600 rounded-md p-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                    ${indicationOptions.map(ind => `
                        <label class="flex items-center">
                            <input type="checkbox" name="indication" value="${ind}" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">${ind}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Create Site</button>
            </div>
        </form>
    `;
};

const getEditSiteModalHTML = (site) => {
    if (!site) return `<h2 class="text-2xl font-bold dark:text-white mb-4">Site not found</h2>`;
    
    const indicationOptions = ['Dry Eye', 'Glaucoma', 'Cataract', 'Macular Degeneration', 'Diabetic Retinopathy', 'Other'];
    const siteIndications = Array.isArray(site.indication) ? site.indication : (site.indication ? [site.indication] : []);
    
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Site: ${site.name}</h2>
        <form id="edit-site-form" data-id="${site.id}" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Name</label>
                    <input type="text" name="name" value="${site.name || ''}" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., City Eye Center">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Name Abbreviation</label>
                    <input type="text" name="siteNameAbbreviation" value="${site.siteNameAbbreviation || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., CEC">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Status</label>
                <select name="status" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white">
                    <option value="Active" ${site.status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Inactive" ${site.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Address Line 1</label>
                <input type="text" name="address1" value="${site.address1 || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., 123 Main St">
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Address Line 2</label>
                <input type="text" name="address2" value="${site.address2 || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Suite 100">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">City</label>
                    <input type="text" name="city" value="${site.city || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Boston">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">State</label>
                    <input type="text" name="state" value="${site.state || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., MA">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Zip Code</label>
                    <input type="text" name="zipCode" value="${site.zipCode || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., 02101">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Country</label>
                <input type="text" name="country" value="${site.country || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., USA">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Principal Investigator (PI)</label>
                    <input type="text" name="pi" value="${site.pi || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Dr. Smith">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">PI Email</label>
                    <input type="email" name="piEmail" value="${site.piEmail || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., dr.smith@email.com">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Coordinator</label>
                    <input type="text" name="siteCoordinator" value="${site.siteCoordinator || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., John Doe">
                </div>
                <div>
                    <label class="block text-sm font-medium dark:text-gray-300">Site Coordinator Email</label>
                    <input type="email" name="siteCoordinatorEmail" value="${site.siteCoordinatorEmail || ''}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., j.doe@email.com">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Indication</label>
                <div class="mt-2 max-h-40 overflow-y-auto border dark:border-gray-600 rounded-md p-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                    ${indicationOptions.map(ind => `
                        <label class="flex items-center">
                            <input type="checkbox" name="indication" value="${ind}" ${siteIndications.includes(ind) ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">${ind}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Changes</button>
            </div>
        </form>
    `;
};
// --- APPOINTMENT UTILITIES ---
const cancelAppointment = async (patientId) => {
    const patient = state.patients.find(p => p.id === patientId);
    if (!patient || !patient.appointment) return;
    const { scheduleId, slotId, visit } = patient.appointment;
    const schedule = state.schedules.find(s => s.id === scheduleId);
    if (!schedule) return;
    const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
    if (slotIndex > -1 && schedule.slots[slotIndex].booked > 0) {
        schedule.slots[slotIndex].booked -= 1;
        const scheduleRef = doc(db, "schedules", scheduleId);
        await updateDoc(scheduleRef, { slots: schedule.slots });
    }
    // NOTE: We no longer decrement the study enrollment here,
    // as the CTMS is now the source of truth for enrollment numbers.
    // This prevents a double-decrement if the CTMS sends an update.
    const patientRef = doc(db, "patients", patientId);
    const updates = { appointment: null };
    if (visit) {
        updates.completedVisits = arrayRemove(visit);
    }
    await updateDoc(patientRef, updates);
};
const deletePatient = async (patientId) => {
    const patient = state.patients.find(p => p.id === patientId);
    if (!patient) return;
    // If patient had an appointment, free up the slot.
    // Enrollment count is handled by CTMS, so we don't adjust it here.
    if (patient.appointment) {
        const { scheduleId, slotId } = patient.appointment;
        const schedule = state.schedules.find(s => s.id === scheduleId);
        if (schedule) {
            const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
            if (slotIndex > -1 && schedule.slots[slotIndex].booked > 0) {
                schedule.slots[slotIndex].booked -= 1;
                const scheduleRef = doc(db, "schedules", scheduleId);
                await updateDoc(scheduleRef, { slots: schedule.slots });
            }
        }
    }
    // Delete the patient document
    await deleteDoc(doc(db, "patients", patientId));
    closeModal();
};
// --- DATA STRUCTURES & UTILITIES ---
const calculateAge = (dobString) => {
    if (!dobString) return '';
    const dob = new Date(dobString);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    return age >= 0 ? age : '';
};

// --- WASHOUT PERIOD UTILITIES ---
const calculateWashoutEndDate = (exitedDate, washoutDays) => {
    if (!exitedDate || !washoutDays) return null;
    const exitDate = new Date(exitedDate);
    const washoutEndDate = new Date(exitDate);
    washoutEndDate.setDate(exitDate.getDate() + washoutDays);
    return washoutEndDate;
};

const isWashoutPeriodActive = (patient) => {
    if (!patient.enrollments || patient.enrollments.length === 0) return false;
    
    // Find the most recent past enrollment
    const pastEnrollments = patient.enrollments.filter(e => e.status === 'past');
    if (pastEnrollments.length === 0) return false;
    
    const mostRecentPastEnrollment = pastEnrollments.reduce((latest, current) => {
        if (!latest.exitedDate || !current.exitedDate) return latest;
        return new Date(current.exitedDate) > new Date(latest.exitedDate) ? current : latest;
    });
    
    if (!mostRecentPastEnrollment.exitedDate) return false;
    
    // Get the study to find washout days
    const study = state.studies.find(s => s.id === mostRecentPastEnrollment.studyId);
    const washoutDays = study?.washoutDays || 30; // Default to 30 days
    
    const washoutEndDate = calculateWashoutEndDate(mostRecentPastEnrollment.exitedDate, washoutDays);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    return washoutEndDate && today < washoutEndDate;
};

// getWashoutStatus function moved to line 350 for better organization

const canBePrescreened = (patient) => {
    // Check if patient is in washout period
    if (isWashoutPeriodActive(patient)) {
        return false;
    }
    
    // Check if patient is already enrolled in a study
    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
    if (currentEnrollment) {
        return false;
    }
    
    return true;
};
const generateShortId = () => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
};
const patientTemplate = () => ({
    firstName: '', lastName: '', initials: '', globalId: '', phoneNumber: '', email: '', dob: '', address: '', city: '', state: '', zipCode: '',
    age: null, status: 'Candidate', registryStatus: 'Active', source: '', therapeuticArea: '',
    enrollments: [], appointment: null, surveyResults: [], contactLogs: [], completedVisits: [], visitLogs: []
});
// --- EVENT HANDLERS ---
document.addEventListener('click', async (e) => {
    const navButton = e.target.closest('.nav-item[data-tab]');
    if (navButton) {
        setState({ activeTab: navButton.dataset.tab });
        if (window.innerWidth < 768) { // Close sidebar on mobile after navigation
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('opacity-0', 'pointer-events-none');
        }
    }
    const dayButton = e.target.closest('.day-btn');
    if (dayButton) {
        dayButton.classList.toggle('bg-blue-500');
        dayButton.classList.toggle('text-white');
        dayButton.classList.toggle('bg-gray-200');
        dayButton.classList.toggle('dark:bg-gray-600'); // For dark mode
    }
    const calendarDay = e.target.closest('.calendar-day[data-date]');
    if (calendarDay) {
        const date = calendarDay.dataset.date;
        openModal(getDayAppointmentsModalHTML(date), true);
    }
    const appointmentSlot = e.target.closest('.appointment-slot');
    if (appointmentSlot) {
        const { scheduleId, slotId } = appointmentSlot.dataset;
        const schedule = state.schedules.find(s => s.id === scheduleId);
        const slot = schedule.slots.find(s => s.id === slotId);
        openModal(getAppointmentDetailsModalHTML(schedule, slot));
    }
    // Delegated listener for patient profile tabs within the modal
    const tabButton = e.target.closest('#patient-profile-tabs button[data-tab-name]');
    if (tabButton && sidePanelContainer.classList.contains('translate-x-full') === false) { // Only if side panel is open
        const patientId = tabButton.dataset.patientId;
        const patient = state.patients.find(p => p.id === patientId);
        if (patient) {
            state.currentPatientProfileTab = tabButton.dataset.tabName;
            const tabContents = sidePanelContainer.querySelectorAll('#patient-profile-tab-content-container > div');
            tabContents.forEach(contentDiv => {
                if (contentDiv.id === `${state.currentPatientProfileTab}-content`) {
                    contentDiv.classList.remove('hidden');
                } else {
                    contentDiv.classList.add('hidden');
                }
            });
            const tabButtons = sidePanelContainer.querySelectorAll('#patient-profile-tabs button');
            tabButtons.forEach(btn => {
                if (btn.dataset.tabName === state.currentPatientProfileTab) {
                    btn.classList.add('border-blue-600', 'text-blue-600', 'dark:border-blue-400', 'dark:text-blue-400');
                    btn.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600', 'text-gray-500', 'dark:text-gray-400');
                } else {
                    btn.classList.remove('border-blue-600', 'text-blue-600', 'dark:border-blue-400', 'dark:text-blue-400');
                    btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600', 'text-gray-500', 'dark:text-gray-400');
                }
            });
            lucide.createIcons();
        }
        return; // Important: Stop further processing for this click
    }
    const actionButton = e.target.closest('button[data-action]');
    if (actionButton) {
        const { action, id, view, patientId, surveyId, qId, scheduleId, slotId, date, eventId, enrollmentIndex } = actionButton.dataset;
        switch (action) {
            case 'close-modal': closeModal(); break;
            case 'close-side-panel': closeSidePanel(); break;
            case 'create-study-modal': openModal(getCreateStudyModalHTML(), true); break;
            case 'create-site-modal': openModal(getCreateSiteModalHTML()); break;
            case 'set-scheduling-view': setState({ schedulingView: view }); break;
            case 'prev-month': state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); render(); break;
            case 'next-month': state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); render(); break;
            case 'prev-day': state.calendarDate.setDate(state.calendarDate.getDate() - 1); render(); break;
            case 'next-day': state.calendarDate.setDate(state.calendarDate.getDate() + 1); render(); break;
            case 'view-patient': 
                closeModal(); // Close any open modal first
                openSidePanel(getPatientProfileHTML(state.patients.find(p => p.id === id)), true); 
                break;
            case 'view-study-patients': {
                const study = state.studies.find(s => s.id === id);
                openModal(getViewStudyPatientsModalHTML(study), true);
                const studyPatients = state.patients.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment?.studyId === study.id;
                });
                renderModalPatientList(studyPatients, 'study');
                // Setup search inputs for the modal
                setTimeout(() => {
                    setupSearchInputs();
                }, 100);
                break;
            }
            case 'view-site-patients': {
                const site = state.sites.find(s => s.id === id);
                openModal(getViewSiteStudiesModalHTML(site), true);
                const siteStudies = state.studies.filter(study => {
                    // Check if any patients are enrolled in this study at this site
                    return state.patients.some(p => {
                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                        return currentEnrollment?.studyId === study.id && currentEnrollment?.siteId === site.id;
                    });
                });
                renderModalStudyList(siteStudies, 'site', site.id);
                // Add search functionality
                setTimeout(() => {
                    const searchInput = document.getElementById('modal-site-study-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            const filteredStudies = siteStudies.filter(study => 
                                study.title.toLowerCase().includes(searchTerm)
                            );
                            renderModalStudyList(filteredStudies, 'site', site.id);
                        });
                    }
                    // Setup search inputs for the modal
                    setupSearchInputs();
                }, 100);
                break;
            }
            case 'edit-patient': openModal(getEditPatientModalHTML(state.patients.find(p => p.id === id)), true); break;
            case 'edit-study': openModal(getEditStudyModalHTML(state.studies.find(s => s.id === id)), true); break;
            case 'edit-site': openModal(getEditSiteModalHTML(state.sites.find(s => s.id === id))); break;
            case 'schedule-patient': 
                state.bookingCalendarDate = new Date();
                openModal(getBookingModalHTML(state.patients.find(p => p.id === id))); 
                break;
            case 'survey-patient': openModal(getSelectSurveyModalHTML(state.patients.find(p => p.id === id))); break;
            case 'import-patients-modal': openModal(getImportPatientsModalHTML()); break;
            case 'add-contact-log': openModal(getAddContactLogModalHTML(patientId)); break;
            case 'add-visit-log': openModal(getAddVisitLogModalHTML(patientId)); break;
            case 'open-check-in-modal': openModal(getCheckInModalHTML(patientId)); break;
            case 'undo-check-in': {
                try {
                    const patient = state.patients.find(p => p.id === patientId);
                    if (patient && patient.appointment) {
                        const patientRef = doc(db, "patients", patientId);
                        await updateDoc(patientRef, {
                            'appointment.checkInStatus': 'not-checked-in',
                            'appointment.checkInTime': null,
                            'appointment.checkInNotes': null
                        });
                        showNotification("Check-in status reset.", "success");
                    }
                } catch (error) {
                    console.error("Error undoing check-in:", error);
                    showNotification("Failed to undo check-in.", "error");
                }
                break;
            }
            case 'add-patient-to-study': {
                const studyId = actionButton.dataset.studyId;
                openModal(getAddPatientToStudyModalHTML(studyId), true);
                // Setup search for the modal
                setTimeout(() => {
                    const searchInput = document.getElementById('add-patient-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase();
                            const rows = document.querySelectorAll('.patient-row');
                            rows.forEach(row => {
                                const name = row.dataset.patientName?.toLowerCase() || '';
                                const email = row.dataset.patientEmail?.toLowerCase() || '';
                                const phone = row.dataset.patientPhone?.toLowerCase() || '';
                                const globalId = row.dataset.patientId?.toLowerCase() || '';
                                const matches = name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm) || globalId.includes(searchTerm);
                                row.style.display = matches ? '' : 'none';
                            });
                        });
                    }
                }, 100);
                break;
            }
            case 'select-patient-for-enrollment': {
                const patientId = actionButton.dataset.patientId;
                const studyId = actionButton.dataset.studyId;
                openModal(getEnrollPatientFormModalHTML(patientId, studyId));
                break;
            }
            case 'transfer-patient-to-study': {
                const patientId = actionButton.dataset.patientId;
                const studyId = actionButton.dataset.studyId;
                const patient = state.patients.find(p => p.id === patientId);
                const study = state.studies.find(s => s.id === studyId);
                
                if (patient.appointment) {
                    showNotification("Cannot transfer patient with scheduled appointment. Cancel appointment first.", "error");
                    return;
                }
                
                openModal(`
                    <h2 class="text-2xl font-bold text-yellow-600 dark:text-yellow-400 mb-4">Confirm Transfer</h2>
                    <p class="dark:text-gray-300">Are you sure you want to transfer <strong>${patient.firstName} ${patient.lastName}</strong> to <strong>${study.title}</strong>?</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This will mark their current enrollment as past and create a new enrollment.</p>
                    <div class="flex justify-end gap-4 mt-8">
                        <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                        <button data-action="confirm-transfer-patient" data-patient-id="${patientId}" data-study-id="${studyId}" class="px-4 py-2 rounded-md bg-yellow-600 text-white hover:bg-yellow-700">Confirm Transfer</button>
                    </div>
                `);
                break;
            }
            case 'confirm-transfer-patient': {
                const patientId = actionButton.dataset.patientId;
                const studyId = actionButton.dataset.studyId;
                openModal(getEnrollPatientFormModalHTML(patientId, studyId));
                break;
            }
            case 'cancel-appointment': 
                await cancelAppointment(patientId);
                closeModal();
                break;
            case 'change-appointment':
                await cancelAppointment(patientId);
                state.bookingCalendarDate = new Date();
                openModal(getBookingModalHTML(state.patients.find(p => p.id === patientId)));
                break;
            case 'start-survey': {
                state.currentSurveyState = {
                    patient: state.patients.find(p => p.id === patientId),
                    survey: state.surveys.find(s => s.id === surveyId),
                    currentQuestionIndex: 0,
                    answers: []
                };
                openModal(getTakeSurveyModalHTML());
                break;
            }
            case 'book-appointment': {
                const patient = state.patients.find(p => p.id === patientId);
                const schedule = state.schedules.find(s => s.id === scheduleId);
                const slot = schedule.slots.find(s => s.id === slotId);
                // Use the reliable patient list to count, not the 'booked' property which might be stale
                const currentBookings = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id).length;
                if (currentBookings >= slot.capacity) {
                    showNotification("This slot is already full.", "error");
                    return;
                }
                const scheduleRef = doc(db, "schedules", scheduleId);
                // Find the specific slot in the array and increment its 'booked' count
                const updatedSlots = schedule.slots.map(s => {
                    if (s.id === slotId) {
                        return { ...s, booked: (s.booked || 0) + 1 };
                    }
                    return s;
                });
                await updateDoc(scheduleRef, { slots: updatedSlots });
                const patientRef = doc(db, "patients", patientId);
                const updates = {
                    appointment: {
                        scheduleId,
                        slotId,
                        time: slot.startTime,
                        visit: schedule.visit || null
                    }
                };
                if (schedule.visit) {
                    updates.completedVisits = arrayUnion(schedule.visit);
                }
                await updateDoc(patientRef, updates);
                // NOTE: We no longer increment study enrollment here.
                // This action is now handled by the CTMS, which is the source of truth.
                // This prevents the number from being incremented twice.
                closeModal();
                break;
            }
            case 'quick-add-patient-modal': openModal(getQuickAddPatientHTML(), true); break;
            case 'add-question': addQuestionToSurveyForm(); break;
            case 'add-option': addOptionToQuestion(actionButton.dataset.qId, actionButton.dataset.type); break; // Pass type
            case 'remove-question': 
                document.getElementById(qId).remove();
                updateBranchingLogicDropdowns();
                break;
            case 'remove-option': 
                actionButton.parentElement.remove();
                break;
            case 'view-survey': openModal(getViewSurveyModalHTML(state.surveys.find(s => s.id === id))); break;
            case 'edit-survey': openModal(getEditSurveyModalHTML(state.surveys.find(s => s.id === id))); break;
            case 'export-csv': exportToCSV(); break;
            case 'export-surveys-csv': exportSurveysToCSV(); break;
            case 'export-participants': exportParticipants(); break;
            case 'toggle-studies': {
                setState({ studiesExpanded: !state.studiesExpanded });
                break;
            }
            case 'select-study': {
                const studyId = actionButton.dataset.studyId;
                setState({ selectedStudyId: studyId || null });
                // If we're not on the studies tab, switch to it
                if (state.activeTab !== 'studies') {
                    setState({ activeTab: 'studies' });
                } else {
                    // If we're already on studies tab, just re-render
                    render();
                }
                break;
            }
            case 'start-duplicate-scan': {
                const duplicateGroups = findDuplicates();
                renderDuplicateResults(duplicateGroups);
                break;
            }
            case 'delete-patient': {
                const patient = state.patients.find(p => p.id === id);
                openModal(`
                    <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Confirm Deletion</h2>
                    <p class="dark:text-gray-300">Are you sure you want to permanently delete the record for <strong>${patient.firstName} ${patient.lastName}</strong>?</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
                    <div class="flex justify-end gap-4 mt-8">
                        <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                        <button data-action="confirm-delete-patient" data-id="${id}" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirm Delete</button>
                    </div>
                `);
                break;
            }
            case 'confirm-delete-patient': {
                await deletePatient(id);
                break;
            }
            case 'delete-site': {
                const site = state.sites.find(s => s.id === id);
                openModal(`
                    <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Confirm Site Deletion</h2>
                    <p class="dark:text-gray-300">Are you sure you want to permanently delete the site <strong>${site.name}</strong>?</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone and will remove the site from all studies.</p>
                    <div class="flex justify-end gap-4 mt-8">
                        <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                        <button data-action="confirm-delete-site" data-id="${id}" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirm Delete</button>
                    </div>
                `);
                break;
            }
            case 'confirm-delete-site': {
                await deleteDoc(doc(db, "sites", id));
                closeModal();
                break;
            }
            case 'delete-slot': {
                const schedule = state.schedules.find(s => s.id === scheduleId);
                const updatedSlots = schedule.slots.filter(s => s.id !== slotId);
                await updateDoc(doc(db, "schedules", scheduleId), { slots: updatedSlots });
                closeModal();
                break;
            }
            case 'prev-booking-month': {
                state.bookingCalendarDate.setMonth(state.bookingCalendarDate.getMonth() - 1);
                const patient = state.patients.find(p => p.id === document.getElementById('booking-calendar-container').dataset.patientId);
                openModal(getBookingModalHTML(patient));
                break;
            }
            case 'next-booking-month': {
                state.bookingCalendarDate.setMonth(state.bookingCalendarDate.getMonth() + 1);
                const patient = state.patients.find(p => p.id === document.getElementById('booking-calendar-container').dataset.patientId);
                openModal(getBookingModalHTML(patient));
                break;
            }
            case 'select-booking-day': {
                const patient = state.patients.find(p => p.id === document.getElementById('booking-calendar-container').dataset.patientId);
                const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
                const completedVisits = patient.completedVisits || [];
                const availableSchedules = state.schedules.filter(s => 
                    s.siteId === currentEnrollment.siteId && 
                    s.studyId === currentEnrollment.studyId &&
                    !completedVisits.includes(s.visit)
                );
                const slotsForDay = [];
                availableSchedules.forEach(schedule => {
                    schedule.slots.forEach(slot => {
                        if (slot.booked < slot.capacity && new Date(slot.startTime).toISOString().split('T')[0] === date) {
                            slotsForDay.push({scheduleId: schedule.id, scheduleType: schedule.visit, ...slot});
                        }
                    });
                });
                const slotsContainer = document.getElementById('booking-slots-container');
                slotsContainer.innerHTML = slotsForDay.length > 0 ? slotsForDay.map(slot => `
                    <button data-action="book-appointment" data-patient-id="${patient.id}" data-schedule-id="${slot.scheduleId}" data-slot-id="${slot.id}" class="w-full text-left p-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white mb-2">
                        ${new Date(slot.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${slot.scheduleType || 'General'}
                    </button>
                `).join('') : '<p class="text-gray-500 dark:text-gray-400">No available slots for this day.</p>';
                break;
            }
            case 'edit-past-enrollment': {
                const patient = state.patients.find(p => p.id === patientId);
                openModal(getEditPastEnrollmentModalHTML(patient, enrollmentIndex));
                break;
            }
            case 'edit-schedule': {
                const schedule = state.schedules.find(s => s.id === id);
                openModal(getEditScheduleModalHTML(schedule));
                break;
            }
            case 'delete-schedule': {
                const schedule = state.schedules.find(s => s.id === id);
                const study = state.studies.find(s => s.id === schedule.studyId);
                const site = state.sites.find(s => s.id === schedule.siteId);
                openModal(`
                    <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Confirm Schedule Deletion</h2>
                    <p class="dark:text-gray-300">Are you sure you want to permanently delete the schedule for:</p>
                    <p class="font-bold dark:text-white mt-2">${schedule.visit || 'General'} - ${study?.title || 'N/A'} at ${site?.name || 'N/A'}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This will delete all ${schedule.slots.length} appointment slots and cannot be undone.</p>
                    <div class="flex justify-end gap-4 mt-8">
                        <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                        <button data-action="confirm-delete-schedule" data-id="${id}" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirm Delete</button>
                    </div>
                `);
                break;
            }
            case 'confirm-delete-schedule': {
                // Remove all patient appointments for this schedule first
                const schedule = state.schedules.find(s => s.id === id);
                const patientsWithAppointments = state.patients.filter(p => p.appointment && p.appointment.scheduleId === id);
                
                for (const patient of patientsWithAppointments) {
                    const patientRef = doc(db, "patients", patient.id);
                    await updateDoc(patientRef, { appointment: null });
                }
                
                // Delete the schedule
                await deleteDoc(doc(db, "schedules", id));
                closeModal();
                showNotification("Schedule deleted successfully.", "success");
                break;
            }
        }
    }
});
document.addEventListener('change', async (e) => {
    if ((e.target.id === 'study-filter' || e.target.id === 'site-filter') && state.activeTab === 'dashboard') {
        renderDashboardCharts();
        renderTodaysAppointments();
    }
    if (e.target.id === 'scheduling-visit-filter') {
        setState({ schedulingVisitFilter: e.target.value });
    }
    if (e.target.id === 'scheduling-site-filter') {
        setState({ schedulingSiteFilter: e.target.value });
    }
    if (e.target.id === 'scheduling-study-filter') {
        setState({ schedulingStudyFilter: e.target.value });
    }
     if (e.target.id === 'booking-visit-filter') {
         const patientId = e.target.dataset.patientId;
         const patient = state.patients.find(p => p.id === patientId);
         const visitFilter = e.target.value;
         if (patient) {
             openModal(getBookingModalHTML(patient, visitFilter));
         }
     }
    if (e.target.name === 'dob') {
        const age = calculateAge(e.target.value);
        const form = e.target.closest('form');
        if (form) {
            const ageInput = form.querySelector('input[name="age"]');
            if (ageInput) {
                ageInput.value = age;
            }
        }
    }
    // Handle visit status updates from the dashboard
    if (e.target.dataset.action === 'update-visit-status') {
        const patientId = e.target.dataset.patientId;
        const newStatus = e.target.value;
        const patient = state.patients.find(p => p.id === patientId);
        if (patient && patient.appointment) {
            const patientRef = doc(db, "patients", patientId);
            const updatedAppointment = { ...patient.appointment, visitStatus: newStatus };
            try {
                await updateDoc(patientRef, { appointment: updatedAppointment });
                showNotification(`Status for ${patient.firstName} updated to "${newStatus}".`, 'success');
            } catch (error) {
                console.error("Error updating visit status:", error);
                showNotification("Failed to update status.", "error");
            }
        }
    }
    // Handle scheduling day group checkboxes
    if (e.target.dataset.dayGroup) {
        const group = e.target.dataset.dayGroup;
        const isChecked = e.target.checked;
        const form = e.target.closest('form');
        if (!form) return;
        const dayButtons = form.querySelectorAll('.day-btn');
        const groups = {
            weekdays: [1, 2, 3, 4, 5],
            weekends: [0, 6],
            everyday: [0, 1, 2, 3, 4, 5, 6]
        };
        const daysToToggle = groups[group] || [];
        dayButtons.forEach(btn => {
            const dayIndex = parseInt(btn.dataset.day);
            if (daysToToggle.includes(dayIndex)) {
                 if (isChecked) {
                    btn.classList.add('bg-blue-500', 'text-white');
                    btn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                } else {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-gray-600');
                }
            }
        });
    }
});
document.addEventListener('input', (e) => {
    if (e.target.id === 'patient-search') {
        state.patientSearchTerm = e.target.value;
        renderPatientTable();
    }
    if (e.target.id === 'study-search') {
        state.studySearchTerm = e.target.value;
        renderStudyTable();
    }
    if (e.target.id === 'site-search') {
        state.siteSearchTerm = e.target.value;
        renderSiteTable();
    }
    if (e.target.id === 'modal-study-patient-search') {
        const studyId = e.target.dataset.studyId;
        const searchTerm = e.target.value.toLowerCase();
        const studyPatients = state.patients.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.studyId === studyId;
        });
        
        // Helper function to normalize phone numbers for searching
        const normalizePhoneForSearch = (phone) => {
            if (!phone) return '';
            return phone.replace(/\D/g, ''); // Remove all non-digits
        };
        
        const filteredPatients = studyPatients.filter(p => {
            const nameMatch = `${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm);
            const emailMatch = p.email && p.email.toLowerCase().includes(searchTerm);
            
            // Phone number matching with format normalization
            let phoneMatch = false;
            if (p.phoneNumber) {
                const normalizedSearchTerm = searchTerm.replace(/\D/g, ''); // Remove non-digits from search term
                const normalizedPhone = normalizePhoneForSearch(p.phoneNumber);
                phoneMatch = normalizedPhone.includes(normalizedSearchTerm);
            }
            
            return nameMatch || emailMatch || phoneMatch;
        });
        renderModalPatientList(filteredPatients, 'study');
    }
    if (e.target.id === 'modal-site-patient-search') {
        const siteId = e.target.dataset.siteId;
        const searchTerm = e.target.value.toLowerCase();
        const sitePatients = state.patients.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.siteId === siteId;
        });
        
        // Helper function to normalize phone numbers for searching
        const normalizePhoneForSearch = (phone) => {
            if (!phone) return '';
            return phone.replace(/\D/g, ''); // Remove all non-digits
        };
        
        const filteredPatients = sitePatients.filter(p => {
            const nameMatch = `${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm);
            const emailMatch = p.email && p.email.toLowerCase().includes(searchTerm);
            
            // Phone number matching with format normalization
            let phoneMatch = false;
            if (p.phoneNumber) {
                const normalizedSearchTerm = searchTerm.replace(/\D/g, ''); // Remove non-digits from search term
                const normalizedPhone = normalizePhoneForSearch(p.phoneNumber);
                phoneMatch = normalizedPhone.includes(normalizedSearchTerm);
            }
            
            return nameMatch || emailMatch || phoneMatch;
        });
        renderModalPatientList(filteredPatients, 'site');
    }
    if (e.target.matches('[name$="-type"]')) {
        const questionBlock = e.target.closest('.question-block');
        const qId = questionBlock.id;
        const selectedType = e.target.value;
        const optionsContainer = questionBlock.querySelector(`div[data-options-for="${qId}"]`);
        const addOptionBtn = questionBlock.querySelector(`button[data-action="add-option"]`);
        optionsContainer.innerHTML = `<label class="text-sm font-medium text-gray-600 dark:text-gray-400">Options</label>`;
        if (selectedType === 'open-text') {
            if (addOptionBtn) addOptionBtn.classList.add('hidden');
        } else {
            if (addOptionBtn) addOptionBtn.classList.remove('hidden');
            addOptionToQuestion(qId, selectedType); 
        }
        updateBranchingLogicDropdowns(); 
    }
    if (e.target.name === 'phoneNumber') {
        const input = e.target.value.replace(/\D/g, '').substring(0, 10);
        const areaCode = input.substring(0, 3);
        const middle = input.substring(3, 6);
        const last = input.substring(6, 10);
        if (input.length > 6) {
            e.target.value = `(${areaCode}) ${middle}-${last}`;
        } else if (input.length > 3) {
            e.target.value = `(${areaCode}) ${middle}`;
        } else if (input.length > 0) {
            e.target.value = `(${areaCode}`;
        } else {
            e.target.value = '';
        }
    }
    // Auto-generate initials in patient forms
    const form = e.target.closest('form');
    if (form && (form.id === 'quick-add-patient-form' || form.id === 'edit-patient-form')) {
        if (e.target.name === 'firstName' || e.target.name === 'lastName') {
            const firstName = form.querySelector('input[name="firstName"]').value;
            const lastName = form.querySelector('input[name="lastName"]').value;
            const initialsInput = form.querySelector('input[name="initials"]');
            if (initialsInput) {
                const firstInitial = firstName ? firstName.charAt(0).toUpperCase() : '';
                const lastInitial = lastName ? lastName.charAt(0).toUpperCase() : '';
                initialsInput.value = `${firstInitial}${lastInitial}`;
            }
        }
    }
});
document.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const getCollectionRef = (name) => collection(db, name);
    switch (form.id) {
        case 'add-contact-log-form': {
            const patientId = form.dataset.patientId;
            const newLog = {
                date: new Date().toISOString(),
                outcome: data.outcome,
                notes: data.notes,
            };
            const patientRef = doc(db, "patients", patientId);
            await updateDoc(patientRef, {
                contactLogs: arrayUnion(newLog)
            });
            closeModal();
            openModal(getPatientProfileHTML(state.patients.find(p => p.id === patientId)), true);
            break;
        }
        case 'add-visit-log-form': {
            const patientId = form.dataset.patientId;
            const newLog = {
                date: new Date().toISOString(),
                visit: data.visit,
                outcome: data.outcome,
                completedBy: data.completedBy,
                signature: data.signature,
            };
            const patientRef = doc(db, "patients", patientId);
            await updateDoc(patientRef, {
                visitLogs: arrayUnion(newLog)
            });
            closeModal();
            state.currentPatientProfileTab = 'visitDetails';
            openModal(getPatientProfileHTML(state.patients.find(p => p.id === patientId)), true);
            break;
        }
        case 'check-in-form': {
            try {
                const patientId = form.dataset.patientId;
                const checkInStatus = data.checkInStatus;
                const checkInNotes = data.checkInNotes || '';
                
                if (!checkInStatus) {
                    showNotification("Please select a check-in status.", "error");
                    return;
                }
                
                const patient = state.patients.find(p => p.id === patientId);
                if (!patient || !patient.appointment) {
                    showNotification("Patient or appointment not found.", "error");
                    return;
                }
                
                const patientRef = doc(db, "patients", patientId);
                const updates = {
                    'appointment.checkInStatus': checkInStatus,
                    'appointment.checkInTime': new Date().toISOString(),
                    'appointment.checkInNotes': checkInNotes
                };
                
                await updateDoc(patientRef, updates);
                
                const statusMessage = checkInStatus === 'checked-in' ? 'Patient checked in successfully!' : 'No show recorded.';
                const messageType = checkInStatus === 'checked-in' ? 'success' : 'info';
                
                closeModal();
                showNotification(statusMessage, messageType);
            } catch (error) {
                console.error("Error checking in patient:", error);
                showNotification(`Failed to check in patient: ${error.message}`, "error");
            }
            break;
        }
        case 'enroll-patient-form': {
            try {
                const patientId = form.dataset.patientId;
                const studyId = form.dataset.studyId;
                const siteId = data.siteId;
                
                if (!siteId) {
                    showNotification("Please select a site.", "error");
                    return;
                }
                
                const patient = state.patients.find(p => p.id === patientId);
                if (!patient) {
                    showNotification("Patient not found.", "error");
                    return;
                }
                
                // Check if patient is in washout period
                if (isWashoutPeriodActive(patient) && !data.overrideWashout) {
                    const washoutStatus = getWashoutStatus(patient);
                    const targetStudy = state.studies.find(s => s.id === studyId);
                    closeModal();
                    openModal(`
                        <h2 class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-4">⚠️ Washout Period Warning</h2>
                        <div class="space-y-4 dark:text-gray-300">
                            <p><strong>${patient.firstName} ${patient.lastName}</strong> is currently in a washout period.</p>
                            <div class="bg-orange-50 dark:bg-orange-900/20 border-l-4 border-orange-500 p-4">
                                <p><strong>Previous Study:</strong> ${washoutStatus.studyTitle}</p>
                                <p><strong>Exited:</strong> ${new Date(washoutStatus.exitedDate).toLocaleDateString()}</p>
                                <p><strong>Washout Period:</strong> ${washoutStatus.washoutDays} days</p>
                                <p><strong>Remaining:</strong> ${washoutStatus.remainingDays} days</p>
                                <p><strong>Can Re-enroll After:</strong> ${new Date(washoutStatus.washoutEndDate).toLocaleDateString()}</p>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">You are attempting to enroll this patient in <strong>${targetStudy?.title || 'a new study'}</strong> before the washout period has completed.</p>
                            <p class="text-sm font-semibold text-red-600 dark:text-red-400">⚠️ This may violate protocol requirements. Ensure you have proper authorization before proceeding.</p>
                        </div>
                        <form id="override-enroll-washout-form" data-patient-id="${patientId}" data-study-id="${studyId}" data-site-id="${siteId}" class="mt-6">
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-500 rounded p-4 mb-4">
                                <label class="flex items-start">
                                    <input type="checkbox" name="confirmOverride" required class="mt-1 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">I confirm that I have the authority to override the washout period and understand the protocol implications.</span>
                                </label>
                            </div>
                            <div class="flex justify-end gap-4">
                                <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                                <button type="submit" class="px-4 py-2 rounded-md bg-orange-600 text-white hover:bg-orange-700">Override & Enroll</button>
                            </div>
                        </form>
                    `);
                    return;
                }
                
                // Prepare the enrollment data
                const newEnrollments = patient.enrollments ? [...patient.enrollments] : [];
                const oldEnrollmentIndex = newEnrollments.findIndex(e => e.status === 'current');
                
                // Mark old enrollment as past if it exists
                if (oldEnrollmentIndex > -1) {
                    newEnrollments[oldEnrollmentIndex].status = 'past';
                    newEnrollments[oldEnrollmentIndex].exitedDate = new Date().toISOString();
                }
                
                // Add new enrollment
                newEnrollments.push({
                    studyId: studyId,
                    siteId: siteId,
                    status: 'current',
                    enrolledDate: new Date().toISOString(),
                    exitedDate: null
                });
                
                // Update the patient
                const patientRef = doc(db, "patients", patientId);
                await updateDoc(patientRef, { enrollments: newEnrollments });
                
                closeModal();
                const overrideMsg = data.overrideWashout ? " (washout override applied)" : "";
                showNotification(`Patient successfully enrolled!${overrideMsg}`, "success");
            } catch (error) {
                console.error("Error enrolling patient:", error);
                showNotification(`Failed to enroll patient: ${error.message}`, "error");
            }
            break;
        }
        case 'override-enroll-washout-form': {
            try {
                const patientId = form.dataset.patientId;
                const studyId = form.dataset.studyId;
                const siteId = form.dataset.siteId;
                
                const patient = state.patients.find(p => p.id === patientId);
                if (!patient) {
                    showNotification("Patient not found.", "error");
                    return;
                }
                
                // Prepare the enrollment data
                const newEnrollments = patient.enrollments ? [...patient.enrollments] : [];
                const oldEnrollmentIndex = newEnrollments.findIndex(e => e.status === 'current');
                
                // Mark old enrollment as past if it exists
                if (oldEnrollmentIndex > -1) {
                    newEnrollments[oldEnrollmentIndex].status = 'past';
                    newEnrollments[oldEnrollmentIndex].exitedDate = new Date().toISOString();
                }
                
                // Add new enrollment
                newEnrollments.push({
                    studyId: studyId,
                    siteId: siteId,
                    status: 'current',
                    enrolledDate: new Date().toISOString(),
                    exitedDate: null
                });
                
                // Update the patient
                const patientRef = doc(db, "patients", patientId);
                await updateDoc(patientRef, { enrollments: newEnrollments });
                
                closeModal();
                showNotification("Patient successfully enrolled (washout override applied).", "success");
            } catch (error) {
                console.error("Error enrolling patient with override:", error);
                showNotification(`Failed to enroll patient: ${error.message}`, "error");
            }
            break;
        }
        case 'import-patients-form': {
            const fileInput = document.getElementById('csv-file-input');
            const statusEl = document.getElementById('import-status');
            if (!fileInput.files || fileInput.files.length === 0) {
                statusEl.textContent = "Please select a file.";
                statusEl.className = "text-red-500";
                return;
            }
            const file = fileInput.files[0];
            statusEl.textContent = "Processing...";
            statusEl.className = "text-blue-500";
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const patientsToImport = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i]) continue;
                        const values = lines[i].split(',');
                        const patientData = {};
                        headers.forEach((header, index) => {
                            if (header) { // Ensure header is not empty
                                patientData[header] = values[index]?.trim() || '';
                            }
                        });
                        const existingPatient = state.patients.find(p =>
                            p.firstName.toLowerCase() === patientData.firstName.toLowerCase() &&
                            p.lastName.toLowerCase() === patientData.lastName.toLowerCase() &&
                            p.dob === patientData.dob
                        );
                        if (existingPatient) {
                            console.log(`Skipping existing patient: ${patientData.firstName} ${patientData.lastName}`);
                            continue;
                        }
                        const finalPatient = patientTemplate();
                        Object.keys(finalPatient).forEach(key => {
                            if (patientData[key] !== undefined) {
                                finalPatient[key] = patientData[key];
                            }
                        });
                        finalPatient.globalId = generateShortId();
                        finalPatient.age = calculateAge(finalPatient.dob);
                        if (patientData.studyId && patientData.siteId) {
                            finalPatient.enrollments.push({
                                studyId: patientData.studyId,
                                siteId: patientData.siteId,
                                status: 'current',
                                enrolledDate: new Date().toISOString()
                            });
                        }
                        patientsToImport.push(finalPatient);
                    }
                    const batch = writeBatch(db);
                    patientsToImport.forEach(patient => {
                        const newPatientRef = doc(collection(db, "patients"));
                        batch.set(newPatientRef, patient);
                    });
                    await batch.commit();
                    statusEl.textContent = `Successfully imported ${patientsToImport.length} new patients.`;
                    statusEl.className = "text-green-500";
                    setTimeout(closeModal, 2000);
                } catch (error) {
                    console.error("CSV Import Error:", error);
                    statusEl.textContent = "Error importing file. Check console for details.";
                    statusEl.className = "text-red-500";
                }
            };
            reader.readAsText(file);
            break;
        }
        case 'take-survey-form': {
            const { survey, patient, currentQuestionIndex, answers } = state.currentSurveyState;
            const question = survey.questions[currentQuestionIndex];
            const selectedOption = form.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                console.error('Please select an option.');
                return;
            }
            const answer = selectedOption.value;
            answers.push({ question: question.text, answer });
            const nextQuestionTarget = selectedOption.dataset.next;
            const endSurvey = async (outcome) => {
                const surveyResult = {
                    surveyId: survey.id,
                    surveyTitle: survey.title,
                    completedAt: new Date().toISOString(),
                    answers: answers,
                    outcome: outcome
                };
                const patientRef = doc(db, "patients", patient.id);
                const updates = { surveyResults: arrayUnion(surveyResult) };
                if (outcome === 'Pass') {
                    updates.status = 'Pre-Screening';
                } else if (outcome === 'Fail') {
                    updates.status = 'Screen Fail';
                }
                await updateDoc(patientRef, updates);
                closeModal();
            };
            if (nextQuestionTarget === 'pass') {
                await endSurvey('Pass');
            } else if (nextQuestionTarget === 'fail') {
                await endSurvey('Fail');
            } else if (nextQuestionTarget === 'submit') {
                await endSurvey('Completed');
            } else if (nextQuestionTarget && !isNaN(nextQuestionTarget)) {
                const nextIndex = parseInt(nextQuestionTarget) - 1;
                if (nextIndex >= 0 && nextIndex < survey.questions.length) {
                    state.currentSurveyState.currentQuestionIndex = nextIndex;
                    openModal(getTakeSurveyModalHTML());
                } else {
                    await endSurvey('Completed'); // Fallback for invalid index
                }
            } else if (currentQuestionIndex < survey.questions.length - 1) {
                state.currentSurveyState.currentQuestionIndex++;
                openModal(getTakeSurveyModalHTML());
            } else {
                await endSurvey('Completed');
            }
            break;
        }
        case 'update-capacity-form': {
            const { scheduleId, slotId } = form.dataset;
            const newCapacity = parseInt(data.capacity);
            const schedule = state.schedules.find(s => s.id === scheduleId);
            const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
            if (slotIndex > -1) {
                schedule.slots[slotIndex].capacity = newCapacity;
                await updateDoc(doc(db, "schedules", scheduleId), { slots: schedule.slots });
            }
            closeModal();
            break;
        }
        case 'edit-patient-form': {
            try {
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...</span>';
                
                const patientId = form.dataset.id;
                const patient = state.patients.find(p => p.id === patientId);
                
                if (!patient) {
                    throw new Error("Patient not found");
                }
                
                // Check if patient has a scheduled appointment
                const hasAppointment = patient.appointment && patient.appointment.time;
                
                const updatedPatient = { ...patient }; // Start with existing data
                Object.keys(patientTemplate()).forEach(key => {
                    if (data[key] !== undefined && key !== 'enrollments') {
                        updatedPatient[key] = data[key] || null;
                    }
                });
                updatedPatient.age = data.age ? parseInt(data.age) : null;
                
                // Check if trying to set status to Pre-Screening while in washout
                if (data.status === 'Pre-Screening' && isWashoutPeriodActive(patient)) {
                    const washoutStatus = getWashoutStatus(patient);
                    showNotification(`Cannot set status to Pre-Screening while patient is in washout period from ${washoutStatus.studyTitle}. ${washoutStatus.remainingDays} days remaining.`, "error");
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }
                
                const currentEnrollment = updatedPatient.enrollments?.find(e => e.status === 'current');
                
                // If study or site has changed, check for appointment and washout
                if (data.studyId && (currentEnrollment?.studyId !== data.studyId || currentEnrollment?.siteId !== data.siteId)) {
                    if (hasAppointment) {
                        showNotification("Cannot change study assignment while patient has a scheduled appointment. Please cancel the appointment first.", "error");
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return;
                    }
                    
                    // Check if patient is in washout period
                    if (isWashoutPeriodActive(patient) && !data.overrideWashout) {
                        const washoutStatus = getWashoutStatus(patient);
                        const targetStudy = state.studies.find(s => s.id === data.studyId);
                        closeModal();
                        openModal(`
                            <h2 class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-4">⚠️ Washout Period Warning</h2>
                            <div class="space-y-4 dark:text-gray-300">
                                <p><strong>${patient.firstName} ${patient.lastName}</strong> is currently in a washout period.</p>
                                <div class="bg-orange-50 dark:bg-orange-900/20 border-l-4 border-orange-500 p-4">
                                    <p><strong>Previous Study:</strong> ${washoutStatus.studyTitle}</p>
                                    <p><strong>Exited:</strong> ${new Date(washoutStatus.exitedDate).toLocaleDateString()}</p>
                                    <p><strong>Washout Period:</strong> ${washoutStatus.washoutDays} days</p>
                                    <p><strong>Remaining:</strong> ${washoutStatus.remainingDays} days</p>
                                    <p><strong>Can Re-enroll After:</strong> ${new Date(washoutStatus.washoutEndDate).toLocaleDateString()}</p>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">You are attempting to enroll this patient in <strong>${targetStudy?.title || 'a new study'}</strong> before the washout period has completed.</p>
                                <p class="text-sm font-semibold text-red-600 dark:text-red-400">⚠️ This may violate protocol requirements. Ensure you have proper authorization before proceeding.</p>
                            </div>
                            <form id="override-washout-form" data-patient-id="${patientId}" data-study-id="${data.studyId}" data-site-id="${data.siteId}" class="mt-6">
                                <input type="hidden" name="allFormData" value='${JSON.stringify(data)}' />
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-500 rounded p-4 mb-4">
                                    <label class="flex items-start">
                                        <input type="checkbox" name="confirmOverride" required class="mt-1 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">I confirm that I have the authority to override the washout period and understand the protocol implications.</span>
                                    </label>
                                </div>
                                <div class="flex justify-end gap-4">
                                    <button type="button" data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                                    <button type="submit" class="px-4 py-2 rounded-md bg-orange-600 text-white hover:bg-orange-700">Override & Continue</button>
                                </div>
                            </form>
                        `);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return;
                    }
                    
                    const newEnrollments = updatedPatient.enrollments ? [...updatedPatient.enrollments] : [];
                    const oldEnrollmentIndex = newEnrollments.findIndex(e => e.status === 'current');
                    // Mark old one as past
                    if (oldEnrollmentIndex > -1) {
                        newEnrollments[oldEnrollmentIndex].status = 'past';
                        newEnrollments[oldEnrollmentIndex].exitedDate = new Date().toISOString();
                    }
                    // Add new one as current
                    newEnrollments.push({
                        studyId: data.studyId,
                        siteId: data.siteId,
                        status: 'current',
                        enrolledDate: new Date().toISOString(),
                        exitedDate: null
                    });
                    updatedPatient.enrollments = newEnrollments;
                }
                
                await updateDoc(doc(db, "patients", patientId), updatedPatient);
                closeModal();
                showNotification("Patient updated successfully.", "success");
            } catch (error) {
                console.error("Error updating patient:", error);
                showNotification(`Failed to update patient: ${error.message}`, "error");
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Save Changes';
                }
            }
            break;
        }
        case 'override-washout-form': {
            try {
                const patientId = form.dataset.patientId;
                const studyId = form.dataset.studyId;
                const siteId = form.dataset.siteId;
                const allFormDataJson = form.querySelector('input[name="allFormData"]').value;
                const originalData = JSON.parse(allFormDataJson);
                
                // Add override flag
                originalData.overrideWashout = true;
                
                const patient = state.patients.find(p => p.id === patientId);
                if (!patient) {
                    showNotification("Patient not found.", "error");
                    return;
                }
                
                // Prepare the updated patient data
                const updatedPatient = { ...patient };
                Object.keys(patientTemplate()).forEach(key => {
                    if (originalData[key] !== undefined && key !== 'enrollments') {
                        updatedPatient[key] = originalData[key] || null;
                    }
                });
                updatedPatient.age = originalData.age ? parseInt(originalData.age) : null;
                
                // Update enrollments
                const newEnrollments = updatedPatient.enrollments ? [...updatedPatient.enrollments] : [];
                const oldEnrollmentIndex = newEnrollments.findIndex(e => e.status === 'current');
                
                // Mark old enrollment as past
                if (oldEnrollmentIndex > -1) {
                    newEnrollments[oldEnrollmentIndex].status = 'past';
                    newEnrollments[oldEnrollmentIndex].exitedDate = new Date().toISOString();
                }
                
                // Add new enrollment
                newEnrollments.push({
                    studyId: studyId,
                    siteId: siteId,
                    status: 'current',
                    enrolledDate: new Date().toISOString(),
                    exitedDate: null
                });
                updatedPatient.enrollments = newEnrollments;
                
                // Save to database
                await updateDoc(doc(db, "patients", patientId), updatedPatient);
                closeModal();
                showNotification("Patient updated successfully (washout override applied).", "success");
            } catch (error) {
                console.error("Error overriding washout:", error);
                showNotification(`Failed to update patient: ${error.message}`, "error");
            }
            break;
        }
        case 'edit-study-form': {
            const studyId = form.dataset.id;
            const formData = new FormData(form);
            const selectedSiteIds = formData.getAll('siteIds');
            
            const updatedStudy = {
                title: data.title,
                protocolNumber: data.protocolNumber,
                status: data.status,
                target: parseInt(data.target),
                washoutDays: data.washoutDays ? parseInt(data.washoutDays) : 30,
                siteIds: selectedSiteIds
            };
            await updateDoc(doc(db, "studies", studyId), updatedStudy);
            closeModal();
            showNotification("Study updated successfully!", "success");
            break;
        }
        case 'edit-site-form': {
            const siteId = form.dataset.id;
            const updatedSite = { name: data.name, location: data.location, status: data.status };
            await updateDoc(doc(db, "sites", siteId), updatedSite);
            closeModal();
            break;
        }
        case 'create-study-form': {
            const formData = new FormData(form);
            const selectedSiteIds = formData.getAll('siteIds');
            
            const newStudy = { 
                title: data.title,
                protocolNumber: data.protocolNumber,
                status: data.status,
                target: parseInt(data.target),
                startDate: data.startDate || '',
                endDate: data.endDate || '',
                washoutDays: data.washoutDays ? parseInt(data.washoutDays) : 30,
                enrolled: 0,
                screenFails: 0,
                siteIds: selectedSiteIds
            };
            await addDoc(collection(db, "studies"), newStudy);
            closeModal();
            showNotification("Study created successfully!", "success");
            break;
        }
        case 'schedule-creator-form': {
            const days = {};
            form.querySelectorAll('.day-btn.bg-blue-500').forEach(btn => { days[btn.dataset.day] = true; });
            let slots = [];
            let currentDate = new Date(data.startDate + 'T00:00:00');
            const finalDate = new Date(data.endDate + 'T00:00:00');
            while (currentDate <= finalDate) {
                if (days[currentDate.getDay()]) {
                    const [startHour, startMinute] = data.startTime.split(':').map(Number);
                    const [endHour, endMinute] = data.endTime.split(':').map(Number);
                    let slotTime = new Date(currentDate);
                    slotTime.setHours(startHour, startMinute, 0, 0);
                    const endSlotTime = new Date(currentDate);
                    endSlotTime.setHours(endHour, endMinute, 0, 0);
                    while (slotTime < endSlotTime) {
                        slots.push({ id: `slot-${Date.now()}-${Math.random()}`, startTime: slotTime.toISOString(), booked: 0, capacity: parseInt(data.capacity) });
                        slotTime.setMinutes(slotTime.getMinutes() + parseInt(data.duration));
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            const newSchedule = { 
                siteId: data.siteId, 
                studyId: data.studyId, 
                visit: data.visit,
                slots: slots 
            };
            await addDoc(getCollectionRef("schedules"), newSchedule);
            form.reset();
            break;
        }
        case 'edit-schedule-form': {
            const scheduleId = form.dataset.id;
            const schedule = state.schedules.find(s => s.id === scheduleId);
            
            // Check if any patients are currently booked in this schedule
            const patientsWithAppointments = state.patients.filter(p => p.appointment && p.appointment.scheduleId === scheduleId);
            
            if (patientsWithAppointments.length > 0) {
                showNotification("Cannot edit schedule with existing appointments. Please cancel all appointments first.", "error");
                return;
            }
            
            // Generate new slots based on updated parameters
            const days = {};
            form.querySelectorAll('.day-btn.bg-blue-500').forEach(btn => { days[btn.dataset.day] = true; });
            let slots = [];
            let currentDate = new Date(data.startDate + 'T00:00:00');
            const finalDate = new Date(data.endDate + 'T00:00:00');
            while (currentDate <= finalDate) {
                if (days[currentDate.getDay()]) {
                    const [startHour, startMinute] = data.startTime.split(':').map(Number);
                    const [endHour, endMinute] = data.endTime.split(':').map(Number);
                    let slotTime = new Date(currentDate);
                    slotTime.setHours(startHour, startMinute, 0, 0);
                    const endSlotTime = new Date(currentDate);
                    endSlotTime.setHours(endHour, endMinute, 0, 0);
                    while (slotTime < endSlotTime) {
                        slots.push({ id: `slot-${Date.now()}-${Math.random()}`, startTime: slotTime.toISOString(), booked: 0, capacity: parseInt(data.capacity) });
                        slotTime.setMinutes(slotTime.getMinutes() + parseInt(data.duration));
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Update the schedule
            const scheduleRef = doc(db, "schedules", scheduleId);
            await updateDoc(scheduleRef, {
                siteId: data.siteId,
                studyId: data.studyId,
                visit: data.visit,
                slots: slots
            });
            
            closeModal();
            showNotification("Schedule updated successfully.", "success");
            break;
        }
        case 'add-site-form': {
            const newSite = { name: data.siteName, location: data.location, status: 'Active' };
            await addDoc(getCollectionRef("sites"), newSite);
            form.reset();
            break;
        }
        case 'quick-add-patient-form': {
            const isDuplicate = state.patients.some(p => 
                p.firstName.toLowerCase() === data.firstName.toLowerCase() &&
                p.lastName.toLowerCase() === data.lastName.toLowerCase() &&
                p.dob === data.dob
            );
            if (isDuplicate) {
                openModal(`
                    <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Duplicate Patient</h2>
                    <p class="dark:text-gray-300">A patient with the same first name, last name, and date of birth already exists.</p>
                    <div class="flex justify-end mt-8">
                        <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">OK</button>
                    </div>
                `);
                return;
            }
            const newPatient = patientTemplate();
            Object.keys(newPatient).forEach(key => {
                if (data[key] !== undefined) {
                    newPatient[key] = data[key] || null;
                }
            });
            newPatient.globalId = generateShortId();
            newPatient.age = data.age ? parseInt(data.age) : null;
            if (data.studyId && data.siteId) {
                // Check if patient is in washout period (for existing patients being reassigned)
                const existingPatient = state.patients.find(existingP => 
                    existingP.firstName.toLowerCase() === data.firstName.toLowerCase() &&
                    existingP.lastName.toLowerCase() === data.lastName.toLowerCase() &&
                    existingP.dob === data.dob
                );
                
                if (existingPatient && isWashoutPeriodActive(existingPatient)) {
                    const washoutStatus = getWashoutStatus(existingPatient);
                    showNotification(`Cannot enroll patient in new study while in washout period from ${washoutStatus.studyTitle}. ${washoutStatus.remainingDays} days remaining.`, "error");
                    return;
                }
                
                newPatient.enrollments.push({
                    studyId: data.studyId,
                    siteId: data.siteId,
                    status: 'current',
                    enrolledDate: new Date().toISOString(),
                    exitedDate: null
                });
            }
            await addDoc(getCollectionRef("patients"), newPatient);
            closeModal();
            break;
        }
        case 'survey-creator-form': {
            const questions = [];
            const questionElements = form.querySelectorAll('#questions-container > div');
            questionElements.forEach((qEl, index) => {
                const qId = qEl.id;
                const text = form.querySelector(`input[name="${qId}-text"]`).value;
                const type = form.querySelector(`select[name="${qId}-type"]`).value;
                const note = form.querySelector(`textarea[name="${qId}-note"]`)?.value || '';
                const tableData = form.querySelector(`textarea[name="${qId}-table"]`)?.value || '';
                
                // Parse table data from CSV format
                let table = null;
                if (tableData.trim()) {
                    const lines = tableData.trim().split('\n').filter(line => line.trim());
                    if (lines.length > 0) {
                        const headers = lines[0].split(',').map(h => h.trim());
                        const rows = lines.slice(1).map(line => line.split(',').map(cell => cell.trim()));
                        table = { headers, rows };
                    }
                }
                
                const options = [];
                qEl.querySelectorAll(`div[data-options-for="${qId}"] > div`).forEach(optEl => {
                    options.push({
                        text: optEl.querySelector(`input[name*="-option-text"]`).value,
                        next: optEl.querySelector(`select[name*="-option-next"]`)?.value || 'submit',
                    });
                });
                const question = { id: index + 1, text, type, options };
                if (note) question.note = note;
                if (table) question.table = table;
                questions.push(question);
            });
            const newSurvey = { title: data.title, studyId: data.studyId, questions };
            await addDoc(getCollectionRef("surveys"), newSurvey);
            form.reset();
            document.getElementById('questions-container').innerHTML = '';
            addQuestionToSurveyForm(); 
            break;
        }
        case 'edit-survey-form': {
            const surveyId = form.dataset.id;
            const questions = [];
            const questionElements = form.querySelectorAll('#edit-questions-container > div');
            questionElements.forEach((qEl, index) => {
                const qId = qEl.id;
                const text = form.querySelector(`input[name="${qId}-text"]`).value;
                const type = form.querySelector(`select[name="${qId}-type"]`).value;
                const note = form.querySelector(`textarea[name="${qId}-note"]`)?.value || '';
                const tableData = form.querySelector(`textarea[name="${qId}-table"]`)?.value || '';
                
                // Parse table data from CSV format
                let table = null;
                if (tableData.trim()) {
                    const lines = tableData.trim().split('\n').filter(line => line.trim());
                    if (lines.length > 0) {
                        const headers = lines[0].split(',').map(h => h.trim());
                        const rows = lines.slice(1).map(line => line.split(',').map(cell => cell.trim()));
                        table = { headers, rows };
                    }
                }
                
                const options = [];
                qEl.querySelectorAll(`div[data-options-for="${qId}"] > div`).forEach(optEl => {
                    options.push({
                        text: optEl.querySelector(`input[name*="-option-text"]`).value,
                        next: optEl.querySelector(`select[name*="-option-next"]`)?.value || 'submit',
                    });
                });
                const question = { id: index + 1, text, type, options };
                if (note) question.note = note;
                if (table) question.table = table;
                questions.push(question);
            });
            const updatedSurvey = { title: data.title, studyId: data.studyId, questions };
            await updateDoc(doc(db, "surveys", surveyId), updatedSurvey);
            closeModal();
            break;
        }
        case 'report-filter-form': {
            let filteredPatients = [...state.patients];
            // Apply filters
            if (data.studyId !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.enrollments?.some(e => e.studyId === data.studyId));
            }
            if (data.siteId !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.enrollments?.some(e => e.siteId === data.siteId));
            }
            if (data.status !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.status === data.status);
            }
            if (data.source !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.source === data.source);
            }
            if (data.minAge) {
                filteredPatients = filteredPatients.filter(p => p.age >= parseInt(data.minAge));
            }
            if (data.maxAge) {
                filteredPatients = filteredPatients.filter(p => p.age <= parseInt(data.maxAge));
            }
            if (data.schedulingStatus === 'scheduled') {
                filteredPatients = filteredPatients.filter(p => p.appointment);
            }
            if (data.schedulingStatus === 'not-scheduled') {
                filteredPatients = filteredPatients.filter(p => !p.appointment);
            }
            if (form.querySelector('[name="surveyCompleted"]').checked) {
                filteredPatients = filteredPatients.filter(p => p.surveyResults && p.surveyResults.length > 0);
            }
            if (data.surveyOutcome !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.surveyResults?.some(sr => sr.outcome === data.surveyOutcome));
            }
            if (data.startDate) {
                filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) >= new Date(data.startDate));
            }
            if (data.endDate) {
                filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) <= new Date(data.endDate));
            }
            state.lastReportData = filteredPatients;
            const exportBtn = document.getElementById('export-csv-btn');
            const exportSurveysBtn = document.getElementById('export-surveys-btn');
            const resultsBody = document.getElementById('report-results-body');
            if(filteredPatients.length > 0) {
                resultsBody.innerHTML = filteredPatients.map(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    const lastSurvey = p.surveyResults && p.surveyResults.length > 0 ? p.surveyResults[p.surveyResults.length - 1] : null;
                    const outcome = lastSurvey ? lastSurvey.outcome : 'N/A';
                    const outcomeColor = outcome === 'Pass' ? 'text-green-500' : outcome === 'Fail' ? 'text-red-500' : '';
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${p.firstName} ${p.lastName}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${p.age || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${p.status || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${p.appointment ? new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'Not Scheduled'}</td>
                            <td class="px-6 py-4 whitespace-nowrap font-semibold ${outcomeColor}">${outcome}</td>
                        </tr>
                    `;
                }).join('');
                if (exportBtn) exportBtn.disabled = false;
                if (exportSurveysBtn) exportSurveysBtn.disabled = false;
            } else {
                resultsBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 dark:text-gray-400 py-8">No patients match the selected criteria.</td></tr>`;
                if (exportBtn) exportBtn.disabled = true;
                if (exportSurveysBtn) exportSurveysBtn.disabled = true;
            }
            // Calculate and display metrics
            const metricsContainer = document.getElementById('report-metrics');
            const total = filteredPatients.length;
            const avgAge = total > 0 ? (filteredPatients.reduce((sum, p) => sum + (p.age || 0), 0) / filteredPatients.filter(p => p.age).length).toFixed(1) : 'N/A';
            const scheduled = filteredPatients.filter(p => p.appointment).length;
            metricsContainer.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Total Patients</p><p class="text-2xl font-bold dark:text-white">${total}</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Average Age</p><p class="text-2xl font-bold dark:text-white">${avgAge}</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Scheduled</p><p class="text-2xl font-bold dark:text-white">${scheduled}</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Not Scheduled</p><p class="text-2xl font-bold dark:text-white">${total - scheduled}</p></div>
            `;
            lucide.createIcons();
            break;
        }
        case 'edit-past-enrollment-form': {
            const { patientId, enrollmentIndex } = form.dataset;
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && patient.enrollments[enrollmentIndex]) {
                const updatedEnrollments = [...patient.enrollments];
                updatedEnrollments[enrollmentIndex] = {
                    ...updatedEnrollments[enrollmentIndex],
                    studyId: data.studyId,
                    siteId: data.siteId,
                    enrolledDate: data.enrolledDate ? new Date(data.enrolledDate).toISOString() : null,
                    exitedDate: data.exitedDate ? new Date(data.exitedDate).toISOString() : null,
                };
                await updateDoc(doc(db, "patients", patientId), { enrollments: updatedEnrollments });
                closeModal();
            }
            break;
        }
        case 'create-study-form': {
            const studyData = {
                title: data.title,
                protocolNumber: data.protocolNumber || '',
                status: data.status || 'Recruiting',
                target: parseInt(data.target, 10) || 0,
                startDate: data.startDate || '',
                endDate: data.endDate || '',
                washoutDays: parseInt(data.washoutDays, 10) || 30,
                enrolled: 0,
                screenFails: 0,
                siteIds: []
            };
            await addDoc(collection(db, "studies"), studyData);
            closeModal();
            break;
        }
        case 'create-site-form': {
            const selectedIndications = Array.from(form.querySelectorAll('input[name="indication"]:checked')).map(cb => cb.value);
            const siteData = {
                name: data.name,
                siteNameAbbreviation: data.siteNameAbbreviation || '',
                status: data.status || 'Active',
                address1: data.address1 || '',
                address2: data.address2 || '',
                city: data.city || '',
                state: data.state || '',
                zipCode: data.zipCode || '',
                country: data.country || '',
                pi: data.pi || '',
                piEmail: data.piEmail || '',
                siteCoordinator: data.siteCoordinator || '',
                siteCoordinatorEmail: data.siteCoordinatorEmail || '',
                indication: selectedIndications
            };
            await addDoc(collection(db, "sites"), siteData);
            closeModal();
            break;
        }
        case 'edit-site-form': {
            const { id } = form.dataset;
            const selectedIndications = Array.from(form.querySelectorAll('input[name="indication"]:checked')).map(cb => cb.value);
            const siteData = {
                name: data.name,
                siteNameAbbreviation: data.siteNameAbbreviation || '',
                status: data.status || 'Active',
                address1: data.address1 || '',
                address2: data.address2 || '',
                city: data.city || '',
                state: data.state || '',
                zipCode: data.zipCode || '',
                country: data.country || '',
                pi: data.pi || '',
                piEmail: data.piEmail || '',
                siteCoordinator: data.siteCoordinator || '',
                siteCoordinatorEmail: data.siteCoordinatorEmail || '',
                indication: selectedIndications
            };
            await updateDoc(doc(db, "sites", id), siteData);
            closeModal();
            break;
        }
    }
});
// --- SURVEY LOGIC ---
const updateBranchingLogicDropdowns = () => {
    const questionsContainer = document.getElementById('questions-container');
    if (!questionsContainer) return;
    const questionElements = questionsContainer.querySelectorAll('.question-block');
    const questionOptions = Array.from(questionElements).map((el, index) => {
        return { value: index + 1, text: `Question ${index + 1}` };
    });
    const allDropdowns = questionsContainer.querySelectorAll('select[name$="-option-next"]');
    allDropdowns.forEach(dropdown => {
        const currentValue = dropdown.value;
        dropdown.innerHTML = `
            <option value="submit">End - Completed</option>
            <option value="pass">End - Pass</option>
            <option value="fail">End - Fail</option>
        `;
        questionOptions.forEach(opt => {
            dropdown.innerHTML += `<option value="${opt.value}">${opt.text}</option>`;
        });
        dropdown.value = currentValue;
    });
};
const addQuestionToSurveyForm = () => {
    const container = document.getElementById('questions-container');
    if (!container) return;
    const qId = `q-${Date.now()}`;
    const questionIndex = container.children.length + 1;
    const questionHTML = `
        <div id="${qId}" class="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700 relative question-block">
            <button type="button" data-action="remove-question" data-q-id="${qId}" class="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            <label class="font-medium dark:text-white" id="${qId}-label">Question ${questionIndex}</label>
            <input type="text" name="${qId}-text" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white mb-2" placeholder="Question Text" required oninput="updateQuestionLabel('${qId}')"/>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Question Type</label>
                <select name="${qId}-type" class="mt-1 block w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                    <option value="single-select">Single Select (with branching)</option>
                    <option value="multi-select">Multi-Select</option>
                    <option value="dropdown">Dropdown</option>
                    <option value="open-text">Open Text</option>
                </select>
            </div>
            <div class="mt-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Question Note (Optional)</label>
                <textarea name="${qId}-note" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white" rows="2" placeholder="Add a note for this question..."></textarea>
            </div>
            <div class="mt-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Table Data (Optional)</label>
                <textarea name="${qId}-table" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white font-mono text-xs" rows="3" placeholder="Paste CSV data here (headers in first row, e.g.: Column1,Column2&#10;Value1,Value2)"></textarea>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use CSV format: headers in first row, then data rows separated by line breaks</p>
            </div>
            <div class="mt-2 space-y-2 pl-4" data-options-for="${qId}">
                <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Options</label>
            </div>
            <button type="button" data-action="add-option" data-q-id="${qId}" data-type="single-select" class="text-sm text-blue-600 dark:text-blue-400 hover:underline mt-2">+ Add Option</button>
        </div>`;
    container.insertAdjacentHTML('beforeend', questionHTML);
    addOptionToQuestion(qId, 'single-select'); // Add an initial option, default to single-select type logic
    updateBranchingLogicDropdowns();
    setupDragAndDrop();
    lucide.createIcons();
};

// Function to update question labels with actual question text
const updateQuestionLabel = (qId) => {
    const input = document.querySelector(`input[name="${qId}-text"]`);
    const label = document.getElementById(`${qId}-label`);
    if (input && label) {
        const text = input.value.trim();
        if (text) {
            // Truncate long text for display
            const displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
            label.textContent = displayText;
        } else {
            // Reset to question number if empty
            const container = document.getElementById('questions-container');
            const questionIndex = Array.from(container.children).indexOf(document.getElementById(qId)) + 1;
            label.textContent = `Question ${questionIndex}`;
        }
    }
};

// Drag and drop functionality for question reordering
const setupDragAndDrop = () => {
    const container = document.getElementById('questions-container');
    if (!container) return;
    
    const questions = container.querySelectorAll('.question-block');
    questions.forEach(question => {
        question.draggable = true;
        question.addEventListener('dragstart', handleDragStart);
        question.addEventListener('dragover', handleDragOver);
        question.addEventListener('drop', handleDrop);
        question.addEventListener('dragend', handleDragEnd);
    });
};

let draggedElement = null;

const handleDragStart = (e) => {
    draggedElement = e.target;
    e.target.style.opacity = '0.5';
};

const handleDragOver = (e) => {
    e.preventDefault();
};

const handleDrop = (e) => {
    e.preventDefault();
    if (draggedElement && e.target !== draggedElement) {
        const container = document.getElementById('questions-container');
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
            container.appendChild(draggedElement);
        } else {
            container.insertBefore(draggedElement, afterElement);
        }
        updateBranchingLogicDropdowns();
    }
};

const handleDragEnd = (e) => {
    e.target.style.opacity = '';
    draggedElement = null;
};

const getDragAfterElement = (container, y) => {
    const draggableElements = [...container.querySelectorAll('.question-block:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
};

const addOptionToQuestion = (qId, type) => {
    const optionsContainer = document.querySelector(`div[data-options-for="${qId}"]`);
    if (!optionsContainer) return;
    let optionHTML = `
        <div class="flex items-center gap-2">
            <input type="text" name="${qId}-option-text" class="flex-grow p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white" placeholder="Option Text" required/>
        `;
    // Only show the next question dropdown for single-select type
    if (type === 'single-select') {
        optionHTML += `<select name="${qId}-option-next" class="w-48 p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white"></select>`;
    }
    // Multi-select and Dropdown don't need 'next' branching in the creator UI for simplicity, as they proceed linearly
    optionHTML += `
            <button type="button" data-action="remove-option" class="p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
        </div>`;
    optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
    updateBranchingLogicDropdowns();
    lucide.createIcons();
};
// --- CALENDAR LOGIC ---
const renderCalendar = () => {
    const container = document.getElementById('calendar-container');
    if (!container) return;
    const date = state.calendarDate;
    const month = date.getMonth();
    const year = date.getFullYear();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay();
    const monthName = date.toLocaleString('default', { month: 'long' });
    // Apply site and study filters
    let filteredSchedules = state.schedules;
    if (state.schedulingSiteFilter !== 'all') {
        filteredSchedules = filteredSchedules.filter(s => s.siteId === state.schedulingSiteFilter);
    }
    if (state.schedulingStudyFilter !== 'all') {
        filteredSchedules = filteredSchedules.filter(s => s.studyId === state.schedulingStudyFilter);
    }
    let calendarHTML = `
        <div class="flex justify-between items-center mb-4 dark:text-white">
            <button data-action="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
            <h3 class="text-xl font-semibold">${monthName} ${year}</h3>
            <button data-action="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
        </div>
        <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
            ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<div class="text-center font-semibold text-sm py-2 bg-gray-50 dark:bg-gray-700 dark:text-gray-300">${day}</div>`).join('')}
        `;
    for (let i = 0; i < startDayOfWeek; i++) {
        calendarHTML += `<div class="bg-gray-50 dark:bg-gray-700/50"></div>`;
    }
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const dateString = currentDate.toISOString().split('T')[0];
        let appointmentsHTML = '';
        filteredSchedules.forEach(schedule => {
            schedule.slots.forEach(slot => {
                const slotDate = new Date(slot.startTime);
                if (slotDate.toISOString().split('T')[0] === dateString) {
                    const study = state.studies.find(s => s.id === schedule.studyId);
                    const bookedCount = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id).length;
                    const isFull = bookedCount >= slot.capacity;
                    appointmentsHTML += `
                        <div data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="appointment-slot p-1.5 mb-1 rounded-md text-xs cursor-pointer ${isFull ? 'bg-red-200 dark:bg-red-800 text-red-900 dark:text-red-100' : 'bg-blue-100 dark:bg-blue-800 hover:bg-blue-200 dark:hover:bg-blue-700 text-blue-900 dark:text-blue-100'}">
                            <p class="font-semibold truncate dark:text-white">${schedule.visit || 'General'}: ${study?.title || 'No Title'}</p>
                            <p class="dark:text-gray-300">${slotDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${bookedCount}/${slot.capacity})</p>
                        </div>
                    `;
                }
            });
        });
        calendarHTML += `
            <div class="calendar-day p-2 bg-white dark:bg-gray-800 relative cursor-pointer" data-date="${dateString}">
                <span class="font-medium text-gray-800 dark:text-gray-200">${day}</span>
                <div class="mt-2 overflow-y-auto max-h-24">${appointmentsHTML}</div>
            </div>
        `;
    }
    calendarHTML += `</div>`;
    container.innerHTML = calendarHTML;
    lucide.createIcons();
};
const renderDayView = () => {
    const container = document.getElementById('day-view-container');
    if (!container) return;
    const date = state.calendarDate;
    const dateString = date.toISOString().split('T')[0];
    const dayName = date.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });
    let filteredSchedules = state.schedules;
    if (state.schedulingSiteFilter !== 'all') {
        filteredSchedules = filteredSchedules.filter(s => s.siteId === state.schedulingSiteFilter);
    }
    if (state.schedulingStudyFilter !== 'all') {
        filteredSchedules = filteredSchedules.filter(s => s.studyId === state.schedulingStudyFilter);
    }
    const slotsForDay = [];
    filteredSchedules.forEach(schedule => {
        schedule.slots.forEach(slot => {
            if (new Date(slot.startTime).toISOString().split('T')[0] === dateString) {
                slotsForDay.push({schedule, slot});
            }
        });
    });
    slotsForDay.sort((a,b) => new Date(a.slot.startTime) - new Date(b.slot.startTime));
    let dayHTML = `
        <div class="flex justify-between items-center mb-4 dark:text-white">
            <button data-action="prev-day" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
            <h3 class="text-xl font-semibold">${dayName}</h3>
            <button data-action="next-day" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
        </div>
        <div class="space-y-4">
        `;
    if (slotsForDay.length > 0) {
        slotsForDay.forEach(({schedule, slot}) => {
            const study = state.studies.find(s => s.id === schedule.studyId);
            const patientsInSlot = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id);
            dayHTML += `
                <div class="p-4 border dark:border-gray-700 rounded-lg">
                    <p class="font-bold dark:text-white">${new Date(slot.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${schedule.visit || 'General'}: ${study?.title || 'N/A'}</p>
                    <div class="mt-2 text-sm">
                        ${patientsInSlot.length > 0 ? patientsInSlot.map(p => `<p class="dark:text-gray-300">${p.firstName} ${p.lastName}</p>`).join('') : '<p class="text-gray-500 dark:text-gray-500">Open Slot</p>'}
                    </div>
                </div>
            `;
        });
    } else {
        dayHTML += `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No appointments scheduled for this day.</p>`;
    }
    dayHTML += `</div>`;
    container.innerHTML = dayHTML;
    lucide.createIcons();
};
const renderBookedAppointmentsView = () => {
    const container = document.getElementById('booked-view-container');
    if(!container) return;
    let bookedAppointments = [];
    state.patients.forEach(p => {
        if(p.appointment) {
            const schedule = state.schedules.find(s => s.id === p.appointment.scheduleId);
            if (schedule) {
                const slot = schedule.slots.find(s => s.id === p.appointment.slotId);
                if(slot) {
                    bookedAppointments.push({patient: p, schedule, slot});
                }
            }
        }
    });
    if (state.schedulingSiteFilter !== 'all') {
        bookedAppointments = bookedAppointments.filter(({ patient }) => {
            const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.siteId === state.schedulingSiteFilter;
        });
    }
    if (state.schedulingStudyFilter !== 'all') {
        bookedAppointments = bookedAppointments.filter(({ patient }) => {
            const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.studyId === state.schedulingStudyFilter;
        });
    }
    bookedAppointments.sort((a,b) => new Date(a.slot.startTime) - new Date(b.slot.startTime));
    let bookedHTML = `<h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">All Booked Appointments</h3>`;
    if (bookedAppointments.length > 0) {
        bookedHTML += `
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Date & Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Patient</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Visit Type</th>
                </tr></thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                ${bookedAppointments.map(({patient, schedule, slot}) => `
                    <tr class="dark:text-gray-300">
                        <td class="px-6 py-4">${new Date(slot.startTime).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })}</td>
                        <td class="px-6 py-4"><button data-action="view-patient" data-id="${patient.id}" class="text-blue-600 dark:text-blue-400 hover:underline">${patient.firstName} ${patient.lastName}</button></td>
                        <td class="px-6 py-4">${state.studies.find(s => s.id === schedule.studyId)?.title || 'N/A'}</td>
                        <td class="px-6 py-4">${schedule.visit || 'General'}</td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
        `;
    } else {
        bookedHTML += `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No appointments have been booked with the current filters.</p>`;
    }
    container.innerHTML = bookedHTML;
    lucide.createIcons();
};
// --- REPORTING & DUPLICATE UTILITIES ---
const findDuplicates = () => {
    const potentialDuplicates = new Map();
    state.patients.forEach(patient => {
        if (!patient.lastName || !patient.dob || !patient.firstName) {
            return;
        }
        // Normalize first name to its first 3 letters for fuzzy matching
        const firstNameKey = patient.firstName.toLowerCase().substring(0, 3);
        const key = `${patient.lastName.toLowerCase()}|${patient.dob}|${firstNameKey}`;
        if (!potentialDuplicates.has(key)) {
            potentialDuplicates.set(key, []);
        }
        potentialDuplicates.get(key).push(patient);
    });
    const actualDuplicates = [];
    // A second pass to catch variations like Matt/Matthew
    for (const group of potentialDuplicates.values()) {
        if (group.length > 1) {
            actualDuplicates.push(group);
        }
    }
    return actualDuplicates;
};
const renderDuplicateResults = (duplicateGroups) => {
    const container = document.getElementById('duplicate-results-container');
    if (!container) return;
    if (duplicateGroups.length === 0) {
        container.innerHTML = `<div class="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 text-green-700 dark:text-green-300 p-4" role="alert"><p class="font-bold">Scan Complete</p><p>No potential duplicates found.</p></div>`;
        return;
    }
    container.innerHTML = duplicateGroups.map((group, index) => `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
            <div class="p-4 bg-red-100 dark:bg-red-900 border-l-4 border-red-500 flex justify-between items-center">
                <h3 class="font-bold text-lg text-red-800 dark:text-red-200">Potential Duplicate Group ${index + 1}</h3>
                <button data-action="combine-duplicates" data-group-ids='${JSON.stringify(group.map(p => p.id))}' class="bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600">Combine</button>
            </div>
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">DOB</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                </tr></thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    ${group.map(p => `
                        <tr class="dark:text-gray-300">
                            <td class="px-6 py-4">${p.firstName} ${p.lastName}</td>
                            <td class="px-6 py-4">${p.dob}</td>
                            <td class="px-6 py-4">${p.email || 'N/A'}</td>
                            <td class="px-6 py-4 flex items-center gap-2">
                                <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">View</button>
                                <button data-action="delete-patient" data-id="${p.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>
    `).join('');
    lucide.createIcons();
};
const exportToCSV = () => {
    try {
        const patients = state.lastReportData;
        if (!patients || patients.length === 0) {
            showNotification("Please generate a report before exporting.", "info");
            return;
        }
        const headers = Object.keys(patientTemplate());
        headers.splice(headers.indexOf('surveyResults'), 1); // remove complex object
        headers.splice(headers.indexOf('appointment'), 1);
        headers.splice(headers.indexOf('enrollments'), 1);
        headers.push("appointmentDate", "currentStudy", "currentSite");
        const csvRows = [headers.join(',')];
        for (const p of patients) {
            const row = headers.map(header => {
                let value;
                const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                if (header === 'appointmentDate') {
                    value = p.appointment ? new Date(p.appointment.time).toISOString() : '';
                } else if (header === 'currentStudy') {
                    value = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A';
                } else if (header === 'currentSite') {
                    value = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
                } else {
                    value = p[header];
                }
                return `"${(value || '').toString().replace(/"/g, '""')}"`;
            });
            csvRows.push(row.join(','));
        }
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        const date = new Date().toISOString().split('T')[0];
        link.setAttribute("download", `report_${date}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification("Report exported successfully!", "success");
    } catch (error) {
        console.error("Failed to export report CSV:", error);
        showNotification("Failed to export report. See console for details.", "error");
    }
};
const exportSurveysToCSV = () => {
    try {
        const patients = state.lastReportData;
        if (!patients || patients.length === 0) {
            showNotification("Please generate a report before exporting survey results.", "info");
            return;
        }
        const headers = ["PatientID", "PatientName", "SurveyTitle", "CompletionDate", "Outcome", "Question", "Answer"];
        const csvRows = [headers.join(',')];
        for (const p of patients) {
            if (p.surveyResults && p.surveyResults.length > 0) {
                for (const result of p.surveyResults) {
                    if (result.answers && result.answers.length > 0) {
                        for (const answer of result.answers) {
                            csvRows.push([
                                `"${p.id}"`,
                                `"${p.firstName} ${p.lastName}"`,
                                `"${(result.surveyTitle || '').replace(/"/g, '""')}"`,
                                `"${new Date(result.completedAt).toISOString()}"`,
                                `"${(result.outcome || 'N/A').replace(/"/g, '""')}"`,
                                `"${(answer.question || '').replace(/"/g, '""')}"`,
                                `"${(answer.answer || '').replace(/"/g, '""')}"`
                            ].join(','));
                        }
                    } else {
                        csvRows.push([
                            `"${p.id}"`,
                            `"${p.firstName} ${p.lastName}"`,
                            `"${(result.surveyTitle || '').replace(/"/g, '""')}"`,
                            `"${new Date(result.completedAt).toISOString()}"`,
                            `"${(result.outcome || 'N/A').replace(/"/g, '""')}"`,
                            `"N/A"`,
                            `"N/A"`
                        ].join(','));
                    }
                }
            }
        }
        if (csvRows.length <= 1) {
            showNotification("No survey results found for the patients in the current report.", "info");
            return;
        }
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        const date = new Date().toISOString().split('T')[0];
        const filename = `survey_results_${date}.csv`;
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        try {
            link.click();
            showNotification(`CSV generated. Download '${filename}' should begin.`, "success");
        } catch (clickError) {
            console.error("Error triggering download link click:", clickError);
            showNotification("Could not trigger download. Please check browser console.", "error");
        }
        document.body.removeChild(link);
        URL.revokeObjectURL(url); 
    } catch (error) {
        console.error("Failed to export survey CSV:", error);
        showNotification("Failed to export surveys. See console for details.", "error");
    }
};
/// --- FIREBASE DATA INTERACTIONS ---
const setupRealtimeListeners = (userId) => {
    const collectionsToFetch = {
        "studies": query(collection(db, "studies"), where("status", "in", ["Recruiting", "Enrolling", "Active"])),
        "sites": collection(db, "sites"),
        "patients": collection(db, "patients"),
        "schedules": collection(db, "schedules"),
        "surveys": collection(db, "surveys")
    };
    Object.entries(collectionsToFetch).forEach(([colName, queryOrRef]) => {
        onSnapshot(queryOrRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (data.length > 0 && (data[0].firstName || data[0].lastName)) {
                data.sort((a, b) => `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`));
            } else if (data.length > 0 && (data[0].title || data[0].name)) {
                data.sort((a, b) => (a.title || a.name).localeCompare(b.title || b.name));
            }
            state[colName] = data;
            render(); 
        }, (error) => {
            console.error(`Error listening to ${colName}:`, error);
            if (error.code === 'failed-precondition') {
                 showNotification(`Query for ${colName} requires a Firestore index. Please create it in your Firebase console.`, 'error');
            }
        });
    });
};
// --- CTMS INTEGRATION ---
/**
 * Handles incoming messages from the CTMS window to update study data.
 * @param {MessageEvent} event The message event from the other window.
 */
const handleCtmsMessage = async (event) => {
    // In a real application, you would check event.origin for security.
    // For example: if (event.origin !== 'https://mhillora.github.io') return;
    const { type, payload } = event.data;
    if (type === 'CTMS_DATA_UPDATE' && payload) {
        const { studyId, enrolled, screenFails } = payload;
        if (!studyId || typeof enrolled === 'undefined' || typeof screenFails === 'undefined') {
            console.warn("Received invalid CTMS data payload:", payload);
            return;
        }
        const studyRef = doc(db, "studies", studyId);
        try {
            await updateDoc(studyRef, {
                enrolled: parseInt(enrolled, 10),
                screenFails: parseInt(screenFails, 10)
            });
            const studyTitle = state.studies.find(s => s.id === studyId)?.title || 'a study';
            showNotification(`Data for ${studyTitle} updated from CTMS.`, 'success');
        } catch (error) {
            console.error("Error updating study data from CTMS:", error);
            showNotification("Failed to update study data from CTMS.", "error");
        }
    }
};
// --- INITIALIZATION ---
const init = async () => {
    document.getElementById('logo-container').innerHTML = `
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <g>
                <circle class="logo-bg" cx="50" cy="50" r="48" />
                <path class="logo-swoosh" d="M 5,60 C 40,85 60,85 95,60" stroke-width="12" fill="none" stroke-linecap="round"/>
                <circle class="logo-inner-circle" cx="50" cy="50" r="22" />
                <circle class="logo-dot" cx="59" cy="41" r="7" />
            </g>
        </svg>`;
    document.getElementById('mobile-logo-container').innerHTML = document.getElementById('logo-container').innerHTML;
    document.getElementById('dark-mode-toggle').addEventListener('click', toggleTheme);
    overlay.addEventListener('click', () => {
        closeSidePanel();
        if (sidebar.classList.contains('-translate-x-full') === false) {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('opacity-0', 'pointer-events-none');
        }
    });
    mobileMenuButton.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('opacity-0');
        overlay.classList.toggle('pointer-events-none');
        overlay.classList.add('bg-opacity-60'); // Ensure mobile overlay is visible
    });
    loadTheme(); // Apply theme on load
    // Listen for messages from other windows (i.e., the CTMS)
    window.addEventListener('message', handleCtmsMessage, false);
    onAuthStateChanged(auth, (user) => {
        if (user) {
            if (!state.authReady) {
                state.userId = user.uid;
                state.authReady = true;
                setupRealtimeListeners(user.uid);
            }
        } else {
            state.authReady = false;
            state.userId = null;
            setState({ patients: [], sites: [], studies: [], schedules: [], surveys: []});
        }
    });
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    } catch (error) {
        console.error("Authentication failed:", error);
        let errorMessage = "Error: Could not authenticate with the server. Please refresh the page.";
        if (error.code === 'auth/operation-not-allowed') {
            errorMessage = `<div class='text-center'><h3 class='font-bold text-lg'>Authentication Error</h3><p class='mt-2'>Anonymous sign-in is not enabled for this project.</p><p class='mt-4 text-sm text-gray-600'><strong>Action Required:</strong> Go to your Firebase project's Authentication settings, select the "Sign-in method" tab, and enable the "Anonymous" provider.</p></div>`;
        }
        mainContent.innerHTML = `<div class="p-4 bg-red-100 rounded-md text-red-700">${errorMessage}</div>`;
    }
};
window.onload = init;
</script>
</body>
</html> 
