<!DOCTYPE html>
<html lang="en" class="">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>N.A.S.A. - Not Another Scheduling Application</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
// This configuration script MUST come BEFORE the main Tailwind CSS script.
// It tells Tailwind to enable dark mode based on a 'dark' class in the HTML tag.
tailwind.config = {
darkMode: 'class',
}
</script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }
.calendar-day {
min-height: 120px;
transition: background-color: 0.2s;
}
.calendar-day:hover {
background-color: #f9fafb;
}
.dark .calendar-day:hover {
background-color: #1f2937;
}
.appointment-slot {
transition: transform 0.2s, box-shadow 0.2s;
}
.appointment-slot:hover {
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
/* Custom scrollbar for modal content */
.modal-content::-webkit-scrollbar, .side-panel-content::-webkit-scrollbar {
width: 8px;
}
.modal-content::-webkit-scrollbar-track, .side-panel-content::-webkit-scrollbar-track {
background: #f1f1f1;
border-radius: 10px;
}
.dark .modal-content::-webkit-scrollbar-track, .dark .side-panel-content::-webkit-scrollbar-track {
background: #4b5563;
}
.modal-content::-webkit-scrollbar-thumb, .side-panel-content::-webkit-scrollbar-thumb {
background: #888;
border-radius: 10px;
}
.modal-content::-webkit-scrollbar-thumb:hover, .side-panel-content::-webkit-scrollbar-thumb:hover {
background: #555;
}
/* Styles for SVG Logo Inversion */
.logo-bg { fill: #3B82F6; }
.logo-swoosh { stroke: #EF4444; }
.logo-inner-circle { fill: #1F2937; }
.logo-dot { fill: white; }

.dark .logo-bg { fill: #1E40AF; } /* Darker blue */
.dark .logo-swoosh { stroke: #F87171; } /* Lighter red */
.dark .logo-inner-circle { fill: #D1D5DB; } /* Light gray */
.dark .logo-dot { fill: #1F2937; } /* Dark gray */

/* Notification Styling */
#notification-container {
position: fixed;
bottom: 20px;
right: 20px;
z-index: 1000;
display: flex;
flex-direction: column;
gap: 10px;
}
.notification {
padding: 1rem;
border-radius: 0.5rem;
color: white;
opacity: 0;
transform: translateX(100%);
transition: all 0.5s ease-in-out;
}
.notification.show {
opacity: 1;
transform: translateX(0);
}
.notification.bg-success { background-color: #10B981; }
.notification.bg-error { background-color: #EF4444; }
.notification.bg-info { background-color: #3B82F6; }
</style>
<script>
// Apply theme as early as possible to prevent Flash of Unstyled Content (FOUC)
(function() {
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
document.documentElement.classList.add('dark');
} else {
document.documentElement.classList.remove('dark');
}
})();
</script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

<div id="notification-container"></div>

<div class="flex flex-col md:flex-row">
<!-- Mobile Header -->
<header class="md:hidden bg-white dark:bg-gray-800 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
    <div class="flex items-center">
        <div id="mobile-logo-container" class="h-8 w-8"></div>
        <h1 class="text-lg font-bold ml-2 text-gray-800 dark:text-gray-200">N.A.S.A.</h1>
    </div>
    <button id="mobile-menu-button" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>
</header>

<!-- Sidebar -->
<aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 p-4 border-r border-gray-200 dark:border-gray-700 h-screen sticky top-0 flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out md:flex z-50">
    <div class="flex items-center mb-8">
        <div id="logo-container" class="h-10 w-10"></div>
        <h1 class="text-xl font-bold ml-2 text-gray-800 dark:text-gray-200">N.A.S.A.</h1>
    </div>
    <nav id="nav-menu" class="space-y-2 flex-grow">
        <!-- Nav items will be injected by JS -->
    </nav>
    <div class="border-t dark:border-gray-700 pt-4 flex justify-between items-center">
        <p class="text-xs text-gray-500 dark:text-gray-400 px-4">Not Another Scheduling App</p>
        <button id="dark-mode-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
            <i id="dark-mode-icon" data-lucide="moon" class="w-5 h-5"></i>
        </button>
    </div>
</aside>

<!-- Main Content -->
<main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50 dark:bg-gray-950">
    <!-- Content will be injected by JS -->
</main>
</div>

<!-- Overlay for mobile sidebar -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 opacity-0 transition-opacity duration-300 pointer-events-none"></div>

<!-- Side Panel Container -->
<div id="side-panel-container" class="fixed top-0 right-0 h-full w-full max-w-2xl bg-white dark:bg-gray-800 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
    <!-- Content will be injected here -->
</div>

<!-- Modal Container -->
<div id="modal-container" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex justify-center items-center p-4"></div>

<!-- Firebase SDK -->
<script type="module">
// Use latest Firebase SDKs
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, setDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, arrayRemove, increment, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Firebase Configuration ---
const firebaseConfig = {
apiKey: "AIzaSyBiXVUUzeLT3mae0N6sdjICdevmRicdk5g",
authDomain: "nasa2-0.firebaseapp.com",
projectId: "nasa2-0",
storageBucket: "nasa2-0.appspot.com",
messagingSenderId: "735088252433",
appId: "1:735088252433:web:1b6733520226e27f5843b0",
measurementId: "G-SNHQZXKCL4"
};


// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- GLOBAL STATE & CONSTANTS ---
let state = {
authReady: false,
userId: null,
activeTab: 'dashboard',
patientSearchTerm: '',
studySearchTerm: '',
siteSearchTerm: '',
schedulingView: 'calendar', // 'creator', 'calendar', 'day', 'booked'
schedulingVisitFilter: 'all', // 'all', 'Visit 1', etc.
schedulingSiteFilter: 'all',
schedulingStudyFilter: 'all',
calendarDate: new Date(),
bookingCalendarDate: new Date(), // For the patient booking modal
studies: [],
patients: [],
sites: [],
surveys: [],
schedules: [],
lastReportData: [], // To store data for CSV export
currentSurveyState: null,
currentPatientProfileTab: 'details', // 'details' or 'contactLog' or 'surveyHistory' or 'visitDetails'
};
let chartInstances = {}; // To hold chart objects for destruction

// --- DOM ELEMENTS ---
const mainContent = document.getElementById('main-content');
const navMenu = document.getElementById('nav-menu');
const modalContainer = document.getElementById('modal-container');
const sidePanelContainer = document.getElementById('side-panel-container');
const overlay = document.getElementById('overlay');
const sidebar = document.getElementById('sidebar');
const mobileMenuButton = document.getElementById('mobile-menu-button');


// --- NOTIFICATION UTILITY ---
const showNotification = (message, type = 'info') => {
const container = document.getElementById('notification-container');
const notif = document.createElement('div');
notif.className = `notification bg-${type}`;
notif.textContent = message;
container.appendChild(notif);

// Trigger the animation
setTimeout(() => {
notif.classList.add('show');
}, 10);

// Automatically remove after 3 seconds
setTimeout(() => {
notif.classList.remove('show');
notif.addEventListener('transitionend', () => notif.remove());
}, 3000);
};

// --- THEME MANAGEMENT (Light/Dark Mode) ---
const applyTheme = (theme) => {
if (theme === 'dark') {
document.documentElement.classList.add('dark');
} else {
document.documentElement.classList.remove('dark');
}
const iconElement = document.getElementById('dark-mode-icon');
if (iconElement) {
iconElement.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
if (typeof lucide !== 'undefined') {
lucide.createIcons();
}
}
};

const loadTheme = () => {
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
applyTheme(savedTheme);
} else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
applyTheme('dark');
} else {
applyTheme('light');
}
};

const toggleTheme = () => {
const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
localStorage.setItem('theme', newTheme);
applyTheme(newTheme);
};

// --- RENDER & STATE MANAGEMENT ---
const setState = (newState) => {
state = { ...state, ...newState };
render();
};

const render = () => {
if (!state.authReady) {
mainContent.innerHTML = `<div class="flex items-center justify-center h-full"><div class="text-gray-500 dark:text-gray-400">Authenticating...</div></div>`;
return;
}
renderNav();
renderContent();
lucide.createIcons();
};

const renderNav = () => {
const navItems = [
{ id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
{ id: 'studies', label: 'Studies', icon: 'file-text' },
{ id: 'patients', label: 'Patients', icon: 'users' },
{ id: 'sites', label: 'Sites', icon: 'building' },
{ id: 'ctms', label: 'CTMS', icon: 'database', href: `https://mhillORA.github.io/CTMS.html?userId=${state.userId}` },
{ id: 'crcs', label: 'CRCs', icon: 'map-pin', href: 'crc_scheduler.html' }, // Link to new page
{ id: 'surveys', label: 'Surveys', icon: 'clipboard-list' },
{ id: 'scheduling', label: 'Scheduling', icon: 'calendar' },
{ id: 'reporting', label: 'Reporting', icon: 'trending-up' },
{ id: 'duplicates', label: 'Duplicates', icon: 'copy-x' },
];
navMenu.innerHTML = navItems.map(item => {
if (item.href) {
return `
                                <a href="${item.href}" target="_blank" rel="noopener noreferrer" class="nav-item w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                                    <span class="ml-3">${item.label}</span>
                                </a>`;
}
return `
                                <button data-tab="${item.id}" class="nav-item w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors ${state.activeTab === item.id ? 'bg-blue-600 text-white' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'}">
                                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                                    <span class="ml-3">${item.label}</span>
                                </button>`;
}).join('');
};

const renderContent = () => {
const contentMap = {
dashboard: getDashboardHTML,
studies: getStudiesHTML,
patients: getPatientsHTML,
sites: getSitesHTML,
surveys: getSurveysHTML,
scheduling: getSchedulingHTML,
reporting: getReportingHTML,
duplicates: getDuplicatesHTML,
};
mainContent.innerHTML = contentMap[state.activeTab]();
// Post-render actions for specific tabs
if (state.activeTab === 'dashboard') {
renderDashboardCharts();
renderTodaysAppointments();
}
if (state.activeTab === 'patients') {
renderPatientTable();
}
if (state.activeTab === 'studies') {
renderStudyTable();
}
if (state.activeTab === 'sites') {
renderSiteTable();
}
if (state.activeTab === 'surveys' && !document.getElementById('questions-container')?.children.length) {
addQuestionToSurveyForm();
}
if (state.activeTab === 'scheduling') {
if(state.schedulingView === 'calendar') renderCalendar();
if(state.schedulingView === 'day') renderDayView();
if(state.schedulingView === 'booked') renderBookedAppointmentsView();
}
};

// --- MODAL & SIDE PANEL HANDLING ---
const openModal = (content, fullWidth = false) => {
const maxWidthClass = fullWidth ? 'max-w-4xl' : 'max-w-2xl';
modalContainer.innerHTML = `
                                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl w-full ${maxWidthClass} relative max-h-[90vh]">
                                    <div class="modal-content overflow-y-auto max-h-[calc(90vh-100px)] pr-4">
                                        ${content}
                                    </div>
                                     <button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                                         <i data-lucide="x"></i>
                                     </button>
                                </div>`;
modalContainer.classList.remove('hidden');
lucide.createIcons();
};

const closeModal = () => {
modalContainer.classList.add('hidden');
modalContainer.innerHTML = '';
state.currentSurveyState = null; // Clear survey state on modal close
};

const handleOutsideClick = (e) => {
    if (!sidePanelContainer.contains(e.target) && !sidePanelContainer.classList.contains('translate-x-full')) {
        if (!e.target.closest('button[data-action="view-patient"]')) {
            closeSidePanel();
        }
    }
};

const openSidePanel = (content, isPatientProfile = false) => {
    sidePanelContainer.innerHTML = `<div class="side-panel-content h-full overflow-y-auto p-8">${content}</div>`;
    sidePanelContainer.classList.remove('translate-x-full');
    
    if (isPatientProfile) {
        setTimeout(() => { 
            document.addEventListener('click', handleOutsideClick, true);
        }, 100);
    } else {
        overlay.classList.remove('opacity-0', 'pointer-events-none');
    }
    lucide.createIcons();
};

const closeSidePanel = () => {
    sidePanelContainer.classList.add('translate-x-full');
    overlay.classList.add('opacity-0', 'pointer-events-none');
    sidePanelContainer.innerHTML = '';
    state.currentPatientProfileTab = 'details';
    document.removeEventListener('click', handleOutsideClick, true);
};


// --- HTML GETTERS FOR EACH PAGE ---

const getDashboardHTML = () => {
const totalEnrolled = state.studies.reduce((sum, study) => sum + (study.enrolled || 0), 0);
const recruitingStudies = state.studies.filter(s => s.status === 'Recruiting').length;
const totalPatients = state.patients.length;
const totalScreenFails = state.studies.reduce((sum, study) => sum + (study.screenFails || 0), 0);
return `
                                <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Dashboard</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-blue-500"><i data-lucide="users" class="text-white"></i></div><div><p class="text-sm text-gray-500 dark:text-gray-400">Total Patients Enrolled</p><p class="text-2xl font-bold dark:text-white">${totalEnrolled}</p></div></div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-green-500"><i data-lucide="file-text" class="text-white"></i></div><div><p class="text-sm text-gray-500 dark:text-gray-400">Active Recruiting Studies</p><p class="text-2xl font-bold dark:text-white">${recruitingStudies}</p></div></div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-red-500"><i data-lucide="user-x" class="text-white"></i></div><div><p class="text-sm text-gray-500 dark:text-gray-400">Total Screen Fails</p><p class="text-2xl font-bold dark:text-white">${totalScreenFails}</p></div></div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-indigo-500"><i data-lucide="users" class="text-white"></i></div><div><p class="text-sm text-gray-500 dark:text-gray-400">Potential Candidates</p><p class="text-2xl font-bold dark:text-white">${totalPatients}</p></div></div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Recruitment Funnel</h3>
                                        <div class="flex gap-4">
                                            <select id="study-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                                <option value="all">All Studies</option>
                                                ${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}
                                            </select>
                                            <select id="site-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                                <option value="all">All Sites</option>
                                                ${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                                        <div>
                                            <h4 class="text-center text-gray-600 dark:text-gray-400 mb-2">Patient Status</h4>
                                            <div class="relative h-64">
                                               <canvas id="status-chart"></canvas>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 class="text-center text-gray-600 dark:text-gray-400 mb-2">Patient Age Distribution</h4>
                                            <div class="relative h-64">
                                               <canvas id="age-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Today's Appointments</h3>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                            <thead class="bg-gray-50 dark:bg-gray-700">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Time</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Patient Name</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Visit</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Visit Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="todays-appointments-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                <!-- Appointments will be injected here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>`;
};

const renderDashboardCharts = () => {
const studyFilter = document.getElementById('study-filter')?.value;
const siteFilter = document.getElementById('site-filter')?.value;

let filteredPatients = state.patients;
if (studyFilter && studyFilter !== 'all') {
    filteredPatients = filteredPatients.filter(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        return currentEnrollment?.studyId === studyFilter;
    });
}
if (siteFilter && siteFilter !== 'all') {
    filteredPatients = filteredPatients.filter(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        return currentEnrollment?.siteId === siteFilter;
    });
}


// --- Status Chart Data ---
const statusCounts = { 'Candidate': 0, 'Enrolled': 0, 'Pre-Screening': 0, 'Screen Fail': 0 };
filteredPatients.forEach(p => {
if (p.status in statusCounts) {
statusCounts[p.status]++;
}
});

const statusCtx = document.getElementById('status-chart')?.getContext('2d');
if (statusCtx) {
if (chartInstances.statusChart) {
chartInstances.statusChart.destroy();
}
chartInstances.statusChart = new Chart(statusCtx, {
type: 'doughnut',
data: {
labels: Object.keys(statusCounts),
datasets: [{
data: Object.values(statusCounts),
backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444'],
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'top',
}
}
}
});
}

// --- Age Chart Data ---
const ageBrackets = { '<18': 0, '18-30': 0, '31-45': 0, '46-60': 0, '61+': 0 };
filteredPatients.forEach(p => {
const age = p.age; // Assuming age is a field in the patient data
if (age) {
if (age < 18) ageBrackets['<18']++;
else if (age <= 30) ageBrackets['18-30']++;
else if (age <= 45) ageBrackets['31-45']++;
else if (age <= 60) ageBrackets['46-60']++;
else ageBrackets['61+']++;
}
});

const ageCtx = document.getElementById('age-chart')?.getContext('2d');
if (ageCtx) {
if (chartInstances.ageChart) {
chartInstances.ageChart.destroy();
}
chartInstances.ageChart = new Chart(ageCtx, {
type: 'bar',
data: {
labels: Object.keys(ageBrackets),
datasets: [{
label: 'Number of Patients',
data: Object.values(ageBrackets),
backgroundColor: '#6366F1',
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
display: false,
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
stepSize: 1
}
}
}
}
});
}
};

const renderTodaysAppointments = () => {
    const tableBody = document.getElementById('todays-appointments-body');
    if (!tableBody) return;

    const studyFilter = document.getElementById('study-filter')?.value;
    const siteFilter = document.getElementById('site-filter')?.value;

    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);

    let todaysAppointments = state.patients
        .filter(p => {
            if (!p.appointment || !p.appointment.time) return false;
            const apptDate = new Date(p.appointment.time);
            apptDate.setHours(0, 0, 0, 0);
            return apptDate.getTime() === todayStart.getTime();
        });

    if (studyFilter && studyFilter !== 'all') {
        todaysAppointments = todaysAppointments.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.studyId === studyFilter;
        });
    }
    if (siteFilter && siteFilter !== 'all') {
        todaysAppointments = todaysAppointments.filter(p => {
            const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
            return currentEnrollment?.siteId === siteFilter;
        });
    }

    todaysAppointments.sort((a, b) => new Date(a.appointment.time) - new Date(b.appointment.time));

    if (todaysAppointments.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 dark:text-gray-400 py-8">No appointments scheduled for today with the selected filters.</td></tr>`;
        return;
    }

    tableBody.innerHTML = todaysAppointments.map(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        const site = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
        const study = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A';
        const visit = p.appointment.visit || 'General';
        const time = new Date(p.appointment.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const visitStatusOptions = ['Scheduled', 'Scheduled for next visit', 'Screenfailed', 'Study Complete', 'Discontinued', 'Visit Incomplete'];
        const currentStatus = p.appointment.visitStatus || 'Scheduled';

        const statusDropdownHTML = `
            <select data-action="update-visit-status" data-patient-id="${p.id}" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white text-sm w-full">
                ${visitStatusOptions.map(opt => `
                    <option value="${opt}" ${currentStatus === opt ? 'selected' : ''}>${opt}</option>
                `).join('')}
            </select>
        `;

        return `
            <tr class="dark:text-gray-300">
                <td class="px-6 py-4 whitespace-nowrap">${time}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${p.firstName} ${p.lastName}</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">${site}</td>
                <td class="px-6 py-4 whitespace-nowrap">${study}</td>
                <td class="px-6 py-4 whitespace-nowrap">${visit}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusDropdownHTML}</td>
            </tr>
        `;
    }).join('');
    lucide.createIcons();
};

const getStudiesHTML = () => `
        <div class="flex justify-between items-center mb-6">
             <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Clinical Studies</h2>
             <button data-action="create-study-modal" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                 <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Create New Study
             </button>
        </div>
        <div class="mb-4">
            <input type="text" id="study-search" value="${state.studySearchTerm}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search for a study...">
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Protocol #</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Enrollment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Screen Fails</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th></tr></thead>
                <tbody id="study-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
        </div>`;

const renderStudyTable = () => {
const tableBody = document.getElementById('study-table-body');
if (!tableBody) return;
const filteredStudies = state.studies.filter(s => s.title.toLowerCase().includes(state.studySearchTerm.toLowerCase()));
tableBody.innerHTML = filteredStudies.map(study => {
// The study.enrolled count is now updated directly from CTMS via postMessage
const enrolledCount = study.enrolled || 0;
return `<tr class="dark:text-gray-300">
                <td class="px-6 py-4"><button data-action="view-study-patients" data-id="${study.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${study.title}</button></td>
                <td class="px-6 py-4">${study.protocolNumber || 'N/A'}</td>
                <td class="px-6 py-4">${study.status}</td>
                <td class="px-6 py-4">${enrolledCount} / ${study.target}</td>
                <td class="px-6 py-4">${study.screenFails || 0}</td>
                <td class="px-6 py-4 flex items-center gap-4">
                    <button data-action="edit-study" data-id="${study.id}" class="text-blue-600 hover:underline">Edit</button>
                </td>
            </tr>`
}).join('');
lucide.createIcons();
};

const getPatientsHTML = () => {
return `
                                <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Patients</h2>
                                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="text" id="patient-search" value="${state.patientSearchTerm}" class="p-2 border dark:border-gray-600 rounded-md md:col-span-2 bg-white dark:bg-gray-700 dark:text-white" placeholder="Search by Name, Email, Phone, or Global ID...">
                                    <div class="flex gap-2">
                                        <button data-action="import-patients-modal" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 flex items-center justify-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import</button>
                                        <button data-action="quick-add-patient-modal" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Quick Add</button>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th></tr></thead>
                                        <tbody id="patient-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                                    </table>
                                </div>`;
};

const renderPatientTable = () => {
const tableBody = document.getElementById('patient-table-body');
if (!tableBody) return;
const searchTerm = state.patientSearchTerm.toLowerCase();
const filteredPatients = state.patients.filter(p => 
`${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm) ||
(p.email && p.email.toLowerCase().includes(searchTerm)) ||
(p.phoneNumber && p.phoneNumber.includes(searchTerm)) ||
(p.globalId && p.globalId.toLowerCase().includes(searchTerm))
);
tableBody.innerHTML = filteredPatients.map(p => {
const appointmentInfo = p.appointment ? 
`${new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })} (${p.appointment.visit || 'General'})` 
: 'Not Scheduled';
const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
const siteName = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
const studyName = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A';

return `<tr class="dark:text-gray-300">
                <td class="px-6 py-4"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${p.firstName} ${p.lastName}</button></td>
                <td class="px-6 py-4">${siteName}</td>
                <td class="px-6 py-4">${studyName}</td>
                <td class="px-6 py-4">${appointmentInfo}</td>
                <td class="px-6 py-4 flex items-center gap-4">
                    <button data-action="survey-patient" data-id="${p.id}" class="text-green-600 dark:text-green-400 hover:underline">Survey</button>
                    <button data-action="schedule-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">Schedule</button>
                    <button data-action="edit-patient" data-id="${p.id}" class="text-gray-500 dark:text-gray-400 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                    <button data-action="delete-patient" data-id="${p.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            </tr>`;
}).join('');
lucide.createIcons();
};

const getSitesHTML = () => `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Clinical Sites</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Add New Site</h3>
            <form id="add-site-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div><label for="siteName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site Name</label><input type="text" id="siteName" name="siteName" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Andover"></div>
                <div><label for="siteLocation" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Location</label><input type="text" id="siteLocation" name="siteLocation" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Andover, MA"></div>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center justify-center h-10"><i data-lucide="plus-circle" class="mr-2"></i> Add Site</button>
            </form>
        </div>
        <div class="mb-4">
            <input type="text" id="site-search" value="${state.siteSearchTerm}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search for a site...">
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 p-6">Current Sites</h3>
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Location</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th></tr></thead>
                <tbody id="site-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
        </div>`;

const renderSiteTable = () => {
const tableBody = document.getElementById('site-table-body');
if (!tableBody) return;
const filteredSites = state.sites.filter(s => s.name.toLowerCase().includes(state.siteSearchTerm.toLowerCase()));
tableBody.innerHTML = filteredSites.map(site => `<tr class="dark:text-gray-300"><td class="px-6 py-4"><button data-action="view-site-patients" data-id="${site.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${site.name}</button></td><td class="px-6 py-4">${site.location}</td><td class="px-6 py-4">${site.status || 'N/A'}</td><td class="px-6 py-4"><button data-action="edit-site" data-id="${site.id}" class="text-blue-600 dark:text-blue-400 hover:underline">Edit</button></td></tr>`).join('');
lucide.createIcons();
};

const getSurveysHTML = () => `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Surveys with Branching Logic</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Create New Survey</h3>
            <form id="survey-creator-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Survey Title</label><input type="text" name="title" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Patient Intake Survey" required /></div>
                    <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Assign to Study</label><select name="studyId" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-white dark:bg-gray-700 dark:text-white" required><option value="" disabled selected>Select a study</option>${state.studies.map(study => `<option value="${study.id}">${study.title}</option>`).join('')}</select></div>
                </div>
                <div id="questions-container" class="space-y-4"></div>
                <button type="button" data-action="add-question" class="text-sm font-medium text-blue-600 dark:text-blue-400 p-2 hover:bg-blue-50 dark:hover:bg-gray-700 rounded-md">+ Add Question</button>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Create Survey</button>
            </form>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 p-6">Existing Surveys</h3>
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th></tr></thead>
                <tbody class="dark:text-gray-300">${state.surveys.map(s => `<tr><td class="px-6 py-4">${s.title}</td><td class="px-6 py-4">${state.studies.find(study => study.id == s.studyId)?.title || 'N/A'}</td><td class="px-6 py-4"><button data-action="view-survey" data-id="${s.id}" class="text-blue-600 dark:text-blue-400 hover:underline">View Survey</button></td></tr>`).join('')}${state.surveys.length === 0 ? `<tr><td colspan="3" class="text-center text-gray-500 dark:text-gray-400 py-8">No surveys created yet.</td></tr>` : ''}</tbody>
            </table>
        </div>`;

const getReportingHTML = () => {
    const sources = ['Facebook', 'Instagram', 'Reddit', 'Site', 'Marketing', 'Email'];
    return `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Reporting & Analytics</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Report Filters</h3>
            <form id="report-filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
                <select name="studyId" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Studies</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select>
                <select name="siteId" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Sites</option>${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                <select name="status" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Statuses</option>${['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'].map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                <select name="source" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Sources</option>${sources.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                <select name="schedulingStatus" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Scheduling Statuses</option><option value="scheduled">Scheduled</option><option value="not-scheduled">Not Scheduled</option></select>
                <select name="surveyOutcome" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="all">All Survey Outcomes</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select>
                <div class="flex items-center gap-2">
                    <input type="number" name="minAge" placeholder="Min Age" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                    <span>-</span>
                    <input type="number" name="maxAge" placeholder="Max Age" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="surveyCompleted" id="surveyCompleted" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="surveyCompleted" class="text-sm text-gray-700 dark:text-gray-300">Survey Completed</label>
                </div>
                <input type="date" name="startDate" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                <input type="date" name="endDate" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                <button type="submit" class="bg-blue-600 text-white rounded-md h-10 col-span-full lg:col-span-2">Generate Report</button>
            </form>
        </div>
        <div id="report-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
            <div class="flex justify-between items-center p-6">
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Report Results</h3>
                <div class="flex gap-2">
                    <button id="export-csv-btn" data-action="export-csv" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center disabled:bg-gray-400" disabled>
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Report
                    </button>
                    <button id="export-surveys-btn" data-action="export-surveys-csv" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center disabled:bg-gray-400" disabled>
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Survey Results
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Age</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Survey Outcome</th>
                        </tr>
                    </thead>
                    <tbody id="report-results-body" class="dark:text-gray-300"><tr><td colspan="7" class="text-center text-gray-500 dark:text-gray-400 py-8">Generate a report to see results.</td></tr></tbody>
                </table>
            </div>
        </div>`;
    };

const getDuplicatesHTML = () => `
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">Find Duplicate Patients</h2>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <p class="text-gray-600 dark:text-gray-400 mb-4">This tool scans for patients with matching <strong>Last Name</strong>, <strong>Date of Birth</strong>, and a partial <strong>First Name</strong> (e.g., Matt vs. Matthew). Review results carefully.</p>
            <button data-action="start-duplicate-scan" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 flex items-center">
                <i data-lucide="scan-line" class="w-5 h-5 mr-2"></i> Start Scan
            </button>
        </div>
        <div id="duplicate-results-container">
            <p class="text-center text-gray-500 dark:text-gray-400 py-8">Scan results will be displayed here.</p>
        </div>
        `;

const getSchedulingHTML = () => {
const creatorView = `
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Create Appointment Schedule</h3>
                                    <form id="schedule-creator-form" class="space-y-4">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site</label><select name="siteId" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"><option value="">Select a Site</option>${state.sites.filter(s => s.status === 'Active').map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Study</label><select name="studyId" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"><option value="">Select a Study</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select></div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Visit</label>
                                                <select name="visit" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white">
                                                    <option value="Visit 1">Visit 1</option>
                                                    <option value="Visit 2">Visit 2</option>
                                                    <option value="Visit 3">Visit 3</option>
                                                    <option value="Visit 4">Visit 4</option>
                                                    <option value="Visit 5">Visit 5</option>
                                                </select>
                                            </div>
                                            <div></div>
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label><input type="date" name="startDate" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date</label><input type="date" name="endDate" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                                        </div>
                                        <div><label class="font-medium dark:text-gray-300">Days of the Week</label><div class="flex flex-wrap gap-2 mt-1">${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `<button type="button" data-day="${i}" class="day-btn p-2 rounded border dark:border-gray-600 w-12 bg-gray-200 dark:bg-gray-600 dark:text-white">${day}</button>`).join('')}</div></div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Time</label><input type="time" name="startTime" value="09:00" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Time</label><input type="time" name="endTime" value="17:00" required class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Interval</label><input type="number" name="duration" value="60" required placeholder="e.g., 60" class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Capacity</label><input type="number" name="capacity" value="1" required placeholder="e.g., 1" class="mt-1 block w-full p-2 border rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white"/></div>
                                        </div>
                                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Generate Schedule</button>
                                    </form>
                                </div>
                               <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Generated Schedules</h3>
                                    <div id="schedules-list" class="space-y-4">${state.schedules.length === 0 ? '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No schedules created yet.</p>' : state.schedules.map(s => {
                                        const totalCapacity = s.slots.reduce((sum, slot) => sum + slot.capacity, 0);
                                        const totalBooked = s.slots.reduce((sum, slot) => sum + (slot.booked || 0), 0);
                                        const availableSlots = totalCapacity - totalBooked;
                                        return `<div class="p-4 border dark:border-gray-700 rounded-lg dark:text-gray-300 flex justify-between items-center">
                                                <div>
                                                    <h4 class="font-bold">${s.visit || 'General'} - ${state.studies.find(study => study.id == s.studyId)?.title || 'N/A'} at ${state.sites.find(site => site.id == s.siteId)?.name || 'N/A'}</h4>
                                                    <p>${availableSlots} of ${totalCapacity} total slots available.</p>
                                                </div>
                                                <button data-action="edit-schedule" data-id="${s.id}" class="text-blue-600 hover:underline">Edit</button>
                                            </div>`
                                    }).join('')}</div>
                                </div>
                                `;
const calendarView = `<div id="calendar-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"></div>`;
const dayView = `<div id="day-view-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"></div>`;
const bookedView = `<div id="booked-view-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"></div>`;

let currentViewHTML = '';
switch(state.schedulingView) {
case 'calendar': currentViewHTML = calendarView; break;
case 'day': currentViewHTML = dayView; break;
case 'booked': currentViewHTML = bookedView; break;
case 'creator': default: currentViewHTML = creatorView; break;
}

const siteStudyFilterHTML = (state.schedulingView === 'calendar' || state.schedulingView === 'day' || state.schedulingView === 'booked')
    ? `<select id="scheduling-site-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
           <option value="all">All Sites</option>
           ${state.sites.map(s => `<option value="${s.id}" ${state.schedulingSiteFilter === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
       </select>
       <select id="scheduling-study-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
           <option value="all">All Studies</option>
           ${state.studies.map(s => `<option value="${s.id}" ${state.schedulingStudyFilter === s.id ? 'selected' : ''}>${s.title}</option>`).join('')}
       </select>`
    : '';

const visitFilterHTML = (state.schedulingView === 'calendar' || state.schedulingView === 'day') 
    ? `<select id="scheduling-visit-filter" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
           <option value="all">All Visits</option>
           ${[1,2,3,4,5].map(v => `<option value="Visit ${v}" ${state.schedulingVisitFilter === `Visit ${v}` ? 'selected' : ''}>Visit ${v}</option>`).join('')}
       </select>` 
    : '';

return `
    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Scheduling</h2>
        <div class="flex items-center gap-2 flex-wrap ml-auto">
            ${siteStudyFilterHTML}
            ${visitFilterHTML}
            <div class="flex items-center gap-2">
                <button data-action="set-scheduling-view" data-view="creator" class="${state.schedulingView === 'creator' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Creator</button>
                <button data-action="set-scheduling-view" data-view="calendar" class="${state.schedulingView === 'calendar' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Month</button>
                <button data-action="set-scheduling-view" data-view="day" class="${state.schedulingView === 'day' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Day</button>
                <button data-action="set-scheduling-view" data-view="booked" class="${state.schedulingView === 'booked' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-300'} px-4 py-2 rounded-md text-sm font-medium">Booked</button>
            </div>
        </div>
    </div>
    ${currentViewHTML}
`;
};

// --- MODAL HTML GETTERS ---
const getDayAppointmentsModalHTML = (dateString) => {
    const date = new Date(dateString + 'T00:00:00');
    const dayName = date.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });

    const slotsForDay = [];
    state.schedules.forEach(schedule => {
        schedule.slots.forEach(slot => {
            if (new Date(slot.startTime).toISOString().split('T')[0] === dateString) {
                slotsForDay.push({ schedule, slot });
            }
        });
    });
    slotsForDay.sort((a, b) => new Date(a.slot.startTime) - new Date(b.slot.startTime));

    let contentHTML = `<h2 class="text-2xl font-bold dark:text-white mb-4">Schedule for ${dayName}</h2>`;

    if (slotsForDay.length > 0) {
        contentHTML += `<div class="space-y-4">`;
        slotsForDay.forEach(({ schedule, slot }) => {
            const study = state.studies.find(s => s.id === schedule.studyId);
            const site = state.sites.find(s => s.id === schedule.siteId);
            const patientsInSlot = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id);
            const bookedCount = patientsInSlot.length;
            const isFull = bookedCount >= slot.capacity;

            contentHTML += `
                <div class="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/50 cursor-pointer appointment-slot" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg dark:text-white">${new Date(slot.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                            <p class="font-medium text-sm dark:text-gray-200">${schedule.visit || 'General'} - ${study?.title || 'N/A'}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${site?.name || 'N/A'}</p>
                        </div>
                        <div class="text-right text-sm">
                            <p class="font-semibold ${isFull ? 'text-red-500' : 'text-green-500'}">
                                ${bookedCount} / ${slot.capacity} Booked
                            </p>
                        </div>
                    </div>
                    <div class="mt-2 border-t dark:border-gray-600 pt-2 text-sm">
                        ${patientsInSlot.length > 0
                            ? patientsInSlot.map(p => `<p class="dark:text-gray-300"><i data-lucide="user" class="inline-block w-4 h-4 mr-1"></i><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">${p.firstName} ${p.lastName}</button></p>`).join('')
                            : '<p class="text-gray-500 dark:text-gray-400">No participants scheduled.</p>'
                        }
                    </div>
                </div>
            `;
        });
        contentHTML += `</div>`;
    } else {
        contentHTML += `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No appointment slots available for this day.</p>`;
    }

    return contentHTML;
};


const getPatientProfileHTML = (patient) => {
if (!patient) return `<h2 class="text-2xl font-bold dark:text-white mb-4">Patient not found</h2>`;

const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
const pastEnrollments = patient.enrollments?.filter(e => e.status === 'past') || [];

const study = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId) : null;
const site = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId) : null;


let surveyResultsHTML = '<p class="text-gray-500 dark:text-gray-400">No survey results found.</p>';
if (patient.surveyResults && patient.surveyResults.length > 0) {
surveyResultsHTML = patient.surveyResults.map(result => {
let outcomeHTML = '';
if (result.outcome) {
const colorClass = result.outcome === 'Pass' ? 'text-green-500' : (result.outcome === 'Fail' ? 'text-red-500' : 'text-gray-500');
outcomeHTML = `<p class="text-sm font-bold ${colorClass} dark:${colorClass.replace('500', '400')}">Outcome: ${result.outcome}</p>`;
}
return `
                <div class="mt-4 p-3 border dark:border-gray-700 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold dark:text-gray-200">${result.surveyTitle}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Completed on: ${new Date(result.completedAt).toLocaleString()}</p>
                        </div>
                        ${outcomeHTML}
                    </div>
                    <ul class="list-disc pl-5 text-sm dark:text-gray-300 mt-2">
                        ${result.answers.map(ans => `<li><strong>${ans.question}</strong>: ${ans.answer}</li>`).join('')}
                    </ul>
                </div>
                `}).join('');
}

let contactLogHTML = `
                <div class="flex justify-end mb-4">
                    <button data-action="add-contact-log" data-patient-id="${patient.id}" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Add Log</button>
                </div>
                `;
if (patient.contactLogs && patient.contactLogs.length > 0) {
contactLogHTML += patient.contactLogs.map(log => `
                <div class="mt-4 p-3 border dark:border-gray-700 rounded-lg">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Logged on: ${new Date(log.date).toLocaleString()}</p>
                    <p class="dark:text-gray-300"><strong>Outcome:</strong> ${log.outcome}</p>
                    <p class="dark:text-gray-300 mt-1"><strong>Notes:</strong> ${log.notes}</p>
                </div>
            `).join('');
} else {
contactLogHTML += '<p class="text-gray-500 dark:text-gray-400">No contact logs found.</p>';
}

let appointmentHTML = '<p><strong>Appointment:</strong> Not Scheduled</p>';
if (patient.appointment) {
    const visitStatus = patient.appointment.visitStatus || 'Scheduled';
    appointmentHTML = `
        <p><strong>Appointment:</strong> ${new Date(patient.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })} (${patient.appointment.visit || 'General'})</p>
        <p><strong>Visit Status:</strong> ${visitStatus}</p>
        <div class="flex gap-2 mt-2">
            <button data-action="change-appointment" data-patient-id="${patient.id}" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Change</button>
            <button data-action="cancel-appointment" data-patient-id="${patient.id}" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Cancel</button>
        </div>
    `;
}

let visitDetailsHTML = `
    <div class="flex justify-end mb-4">
        <button data-action="add-visit-log" data-patient-id="${patient.id}" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Add Visit Log</button>
    </div>
`;
if (patient.visitLogs && patient.visitLogs.length > 0) {
    const sortedLogs = [...patient.visitLogs].sort((a, b) => new Date(b.date) - new Date(a.date));
    visitDetailsHTML += sortedLogs.map(log => `
        <div class="mt-4 p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700/50">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-lg dark:text-white">${log.visit} - <span class="font-medium">${log.outcome}</span></h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Logged on: ${new Date(log.date).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })}</p>
                </div>
                <div class="text-right">
                        <p class="text-sm dark:text-gray-300">Completed by: ${log.completedBy}</p>
                        <p class="text-sm dark:text-gray-300">Signed: ${log.signature}</p>
                </div>
            </div>
        </div>
    `).join('');
} else {
    visitDetailsHTML += '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No visit logs have been recorded.</p>';
}

return `
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold dark:text-white">${patient.firstName} ${patient.lastName}</h2>
                    <button data-action="close-side-panel" class="text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                         <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 mb-6">
                        <button data-action="survey-patient" data-id="${patient.id}" class="bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 flex items-center text-sm font-medium">
                            <i data-lucide="clipboard-list" class="w-4 h-4 mr-2"></i> Survey
                        </button>
                        <button data-action="schedule-patient" data-id="${patient.id}" class="bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 flex items-center text-sm font-medium">
                            <i data-lucide="calendar-plus" class="w-4 h-4 mr-2"></i> Schedule
                        </button>
                    <button data-action="edit-patient" data-id="${patient.id}" class="bg-gray-500 text-white px-3 py-1.5 rounded-md hover:bg-gray-600 flex items-center text-sm font-medium">
                         <i data-lucide="edit" class="w-4 h-4 mr-2"></i> Edit
                    </button>
                </div>
                
                <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="patient-profile-tabs" role="tablist">
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'details' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                                id="details-tab" data-tab-name="details" data-patient-id="${patient.id}" type="button" role="tab" aria-controls="details" aria-selected="${state.currentPatientProfileTab === 'details'}">Details</button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'contactLog' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                                id="contact-log-tab" data-tab-name="contactLog" data-patient-id="${patient.id}" type="button" role="tab" aria-controls="contact-log" aria-selected="${state.currentPatientProfileTab === 'contactLog'}">Contact Log</button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'surveyHistory' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                                id="survey-history-tab" data-tab-name="surveyHistory" data-patient-id="${patient.id}" type="button" role="tab" aria-controls="survey-history" aria-selected="${state.currentPatientProfileTab === 'surveyHistory'}">Survey History</button>
                        </li>
                        <li class="mr-2" role="presentation">
                            <button class="inline-block p-4 border-b-2 rounded-t-lg ${state.currentPatientProfileTab === 'visitDetails' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-600 text-gray-500 dark:text-gray-400'}"
                                id="visit-details-tab" data-tab-name="visitDetails" data-patient-id="${patient.id}" type="button" role="tab" aria-controls="visit-details" aria-selected="${state.currentPatientProfileTab === 'visitDetails'}">Visit Details</button>
                        </li>
                    </ul>
                </div>

                <div id="patient-profile-tab-content-container">
                    <div id="details-content" class="${state.currentPatientProfileTab === 'details' ? '' : 'hidden'}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 dark:text-gray-300">
                            <div class="space-y-2">
                                <p><strong>Global ID:</strong> ${patient.globalId || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${patient.phoneNumber || 'N/A'}</p>
                                <p><strong>Email:</strong> ${patient.email || 'N/A'}</p>
                                <p><strong>DOB:</strong> ${patient.dob || 'N/A'}</p>
                                <p><strong>Address:</strong> ${patient.address || 'N/A'}</p>
                                <p><strong>City:</strong> ${patient.city || 'N/A'}</p>
                                <p><strong>State:</strong> ${patient.state || 'N/A'}</p>
                                <p><strong>Zip:</strong> ${patient.zipCode || 'N/A'}</p>
                            </div>
                            <div class="space-y-2">
                                <p><strong>Age:</strong> ${patient.age || 'N/A'}</p>
                                <p><strong>Status:</strong> ${patient.status || 'N/A'}</p>
                                <p><strong>Registry Status:</strong> ${patient.registryStatus || 'N/A'}</p>
                                <p><strong>Source:</strong> ${patient.source || 'N/A'}</p>
                                <p><strong>Therapeutic Area:</strong> ${patient.therapeuticArea || 'N/A'}</p>
                                <p><strong>Current Study:</strong> ${study?.title || 'N/A'}</p>
                                <p><strong>Site:</strong> ${site?.name || 'N/A'}</p>
                                ${appointmentHTML}
                            </div>
                        </div>
                        <div class="mt-6">
                             <h3 class="font-semibold text-lg dark:text-white mb-2 border-t dark:border-gray-700 pt-4">Enrollment History</h3>
                             ${pastEnrollments.length > 0 ? pastEnrollments.map((e, index) => `
                                <div class="p-2 border-l-2 dark:border-gray-600 pl-3 mb-2 flex justify-between items-center">
                                    <div>
                                        <p><strong>Study:</strong> ${state.studies.find(s => s.id === e.studyId)?.title || 'N/A'}</p>
                                        <p><strong>Site:</strong> ${state.sites.find(s => s.id === e.siteId)?.name || 'N/A'}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                            Enrolled: ${e.enrolledDate ? new Date(e.enrolledDate).toLocaleDateString() : 'N/A'} - Exited: ${e.exitedDate ? new Date(e.exitedDate).toLocaleDateString() : 'Present'}
                                        </p>
                                    </div>
                                    <button data-action="edit-past-enrollment" data-patient-id="${patient.id}" data-enrollment-index="${patient.enrollments.findIndex(en => en === e)}" class="text-blue-600 hover:underline text-sm p-1">Edit</button>
                                </div>
                            `).join('') : '<p class="text-gray-500 dark:text-gray-400">No past enrollments.</p>'}
                        </div>
                    </div>

                    <div id="contactLog-content" class="${state.currentPatientProfileTab === 'contactLog' ? '' : 'hidden'} dark:text-gray-300">
                        ${contactLogHTML}
                    </div>

                    <div id="surveyHistory-content" class="${state.currentPatientProfileTab === 'surveyHistory' ? '' : 'hidden'} dark:text-gray-300">
                        ${surveyResultsHTML}
                    </div>
                    
                    <div id="visitDetails-content" class="${state.currentPatientProfileTab === 'visitDetails' ? '' : 'hidden'} dark:text-gray-300">
                        ${visitDetailsHTML}
                    </div>
                </div>
            `;
};

const getBookingModalHTML = (patient, visitFilter = 'all') => {
    if (!patient) return `<h2>Patient not found</h2>`;
    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
    if (!currentEnrollment) {
         return `
            <h2 class="text-2xl font-bold dark:text-white mb-4">Schedule for ${patient.firstName} ${patient.lastName}</h2>
            <p class="text-red-500">This patient is not currently enrolled in a study and cannot be scheduled.</p>
        `;
    }

    const completedVisits = patient.completedVisits || [];
    const availableSchedules = state.schedules.filter(s => 
        s.siteId === currentEnrollment.siteId && 
        s.studyId === currentEnrollment.studyId &&
        !completedVisits.includes(s.visit)
    );

    const uniqueVisits = [...new Set(availableSchedules.map(s => s.visit).filter(Boolean))].sort();

    if (availableSchedules.length === 0) {
        return `
            <h2 class="text-2xl font-bold dark:text-white mb-4">Schedule for ${patient.firstName} ${patient.lastName}</h2>
            <p class="text-red-500">No available schedules match the patient's assigned site, study, and visit history.</p>
        `;
    }

    // This function will now be responsible for rendering the calendar inside the modal
    const renderBookingCalendar = (date, patient, currentFilter) => {
        const month = date.getMonth();
        const year = date.getFullYear();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();
        const monthName = date.toLocaleString('default', { month: 'long' });
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const filteredSchedules = currentFilter === 'all' 
            ? availableSchedules 
            : availableSchedules.filter(s => s.visit === currentFilter);

        const availableSlotsByDay = {};
        filteredSchedules.forEach(schedule => {
            schedule.slots.forEach(slot => {
                if (slot.booked < slot.capacity) {
                    const slotDate = new Date(slot.startTime).toISOString().split('T')[0];
                    if (!availableSlotsByDay[slotDate]) {
                        availableSlotsByDay[slotDate] = [];
                    }
                    availableSlotsByDay[slotDate].push({scheduleId: schedule.id, scheduleType: schedule.visit, ...slot});
                }
            });
        });

        let calendarHTML = `
            <div class="flex justify-between items-center mb-4 dark:text-white">
                <button data-action="prev-booking-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
                <h3 class="text-xl font-semibold">${monthName} ${year}</h3>
                <button data-action="next-booking-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm">
                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<div class="font-semibold text-gray-500 dark:text-gray-400">${day}</div>`).join('')}
            `;

        for (let i = 0; i < startDayOfWeek; i++) { calendarHTML += `<div></div>`; }

        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const dateString = currentDate.toISOString().split('T')[0];
            const hasSlots = availableSlotsByDay[dateString];
            const isPastDate = currentDate < today;
            const isToday = today.toDateString() === currentDate.toDateString();
            const isBookable = hasSlots && !isPastDate;

            calendarHTML += `
                <button 
                    data-action="select-booking-day" 
                    data-date="${dateString}" 
                    class="p-2 rounded-full ${isBookable ? 'bg-blue-500 text-white hover:bg-blue-600 cursor-pointer' : 'text-gray-400 dark:text-gray-500 cursor-not-allowed'} ${isToday ? 'ring-2 ring-blue-500' : ''}"
                    ${!isBookable ? 'disabled' : ''}
                >
                    ${day}
                </button>
            `;
        }
        calendarHTML += `</div>`;
        return calendarHTML;
    };

    return `
        <div class="flex justify-between items-center mb-4">
             <h2 class="text-2xl font-bold dark:text-white">Schedule for ${patient.firstName} ${patient.lastName}</h2>
             <select id="booking-visit-filter" data-patient-id="${patient.id}" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                 <option value="all">Filter by Visit (All)</option>
                 ${uniqueVisits.map(v => `<option value="${v}" ${visitFilter === v ? 'selected' : ''}>${v}</option>`).join('')}
             </select>
        </div>
        <p class="dark:text-gray-300"><strong>Study:</strong> ${state.studies.find(s => s.id === currentEnrollment.studyId)?.title}</p>
        <p class="dark:text-gray-300 mb-4"><strong>Site:</strong> ${state.sites.find(s => s.id === currentEnrollment.siteId)?.name}</p>
        <div id="booking-calendar-container" data-patient-id="${patient.id}">
            ${renderBookingCalendar(state.bookingCalendarDate, patient, visitFilter)}
        </div>
        <div id="booking-slots-container" class="mt-4 max-h-48 overflow-y-auto"></div>
    `;
};

const getQuickAddPatientHTML = () => {
const registryStatuses = ['Active', 'Inactive', 'Do Not Call'];
const therapeuticAreas = ['Dry Eye', 'Allergy', 'Glaucoma', 'Cataract', 'Retina', 'Uveitis'];
const sources = ['Facebook', 'Instagram', 'Reddit', 'Site', 'Marketing', 'Email'];
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Quick Add Patient</h2>
                                        <form id="quick-add-patient-form" class="space-y-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${Object.keys(patientTemplate()).map(key => {
                                                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                                if (key === 'status') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'].map(s => `<option>${s}</option>`).join('')}</select></div>`;
                                                }
                                                if (key === 'registryStatus') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="registryStatus" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${registryStatuses.map(s => `<option>${s}</option>`).join('')}</select></div>`;
                                                }
                                                if (key === 'therapeuticArea') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="therapeuticArea" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Area</option>${therapeuticAreas.map(s => `<option>${s}</option>`).join('')}</select></div>`;
                                                }
                                                if (key === 'source') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="source" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Source</option>${sources.map(s => `<option>${s}</option>`).join('')}</select></div>`;
                                                }
                                                // These fields will be handled separately below
                                                if (['globalId', 'enrollments', 'appointment', 'surveyResults', 'contactLogs', 'completedVisits', 'visitLogs'].includes(key)) return '';
                                                return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><input type="${key === 'dob' ? 'date' : 'text'}" name="${key}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"></div>`;
                                            }).join('')}
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Assign to Study</label><select name="studyId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">None</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Assign to Site</label><select name="siteId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">None</option>${state.sites.filter(s => s.status === 'Active').map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                                            </div>
                                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Add Patient</button>
                                        </form>
                                    `;
};

const getCreateStudyModalHTML = () => {
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Create New Clinical Study</h2>
                                        <form id="create-study-form" class="space-y-4">
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Study Title</label><input type="text" name="title" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., Phase 3 Aspirin Trial"></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Protocol Number</label><input type="text" name="protocolNumber" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., XYZ-123"></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Status</label><select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option>Recruiting</option><option>Enrolling</option><option>Active</option><option>Closed</option></select></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Enrollment Target</label><input type="number" name="target" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., 100"></div>
                                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Create Study</button>
                                        </form>
                                    `;
};

const getEditStudyModalHTML = (study) => {
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Clinical Study</h2>
                                        <form id="edit-study-form" data-id="${study.id}" class="space-y-4">
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Study Title</label><input type="text" name="title" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${study.title}"></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Protocol Number</label><input type="text" name="protocolNumber" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${study.protocolNumber || ''}"></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Status</label><select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${['Recruiting', 'Enrolling', 'Active', 'Closed'].map(s => `<option ${study.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Enrollment Target</label><input type="number" name="target" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${study.target}"></div>
                                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                                        </form>
                                    `;
};

const getEditSiteModalHTML = (site) => {
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Site</h2>
                                        <form id="edit-site-form" data-id="${site.id}" class="space-y-4">
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Site Name</label><input type="text" name="name" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${site.name}"></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Location</label><input type="text" name="location" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${site.location}"></div>
                                            <div>
                                                <label class="block text-sm font-medium dark:text-gray-300">Status</label>
                                                <select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                                    <option ${site.status === 'Active' ? 'selected' : ''}>Active</option>
                                                    <option ${site.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                                        </form>
                                    `;
};

const getEditPatientModalHTML = (patient) => {
const statuses = ['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'];
const registryStatuses = ['Active', 'Inactive', 'Do Not Call'];
const therapeuticAreas = ['Dry Eye', 'Allergy', 'Glaucoma', 'Cataract', 'Retina', 'Uveitis'];
const sources = ['Facebook', 'Instagram', 'Reddit', 'Site', 'Marketing', 'Email'];
const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');

return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Edit Patient</h2>
                                        <form id="edit-patient-form" data-id="${patient.id}" class="space-y-4">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${Object.keys(patientTemplate()).map(key => {
                                                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                                const value = patient[key] || '';
                                                if (key === 'status') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="status" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${statuses.map(s => `<option ${value === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`;
                                                }
                                                if (key === 'registryStatus') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="registryStatus" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">${registryStatuses.map(s => `<option ${value === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`;
                                                }
                                                if (key === 'therapeuticArea') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="therapeuticArea" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Area</option>${therapeuticAreas.map(s => `<option ${value === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`;
                                                }
                                                if (key === 'source') {
                                                    return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><select name="source" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">Select Source</option>${sources.map(s => `<option ${value === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`;
                                                }
                                                if (['enrollments', 'appointment', 'surveyResults', 'contactLogs', 'completedVisits', 'visitLogs'].includes(key)) return '';
                                                return `<div><label class="block text-sm font-medium dark:text-gray-300">${label}</label><input type="${key === 'dob' ? 'date' : 'text'}" name="${key}" value="${value}" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" ${key === 'globalId' ? 'readonly' : ''}></div>`;
                                            }).join('')}
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Current Study</label><select name="studyId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">None</option>${state.studies.map(s => `<option value="${s.id}" ${currentEnrollment?.studyId === s.id ? 'selected' : ''}>${s.title}</option>`).join('')}</select></div>
                                            <div><label class="block text-sm font-medium dark:text-gray-300">Site</label><select name="siteId" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"><option value="">None</option>${state.sites.filter(s => s.status === 'Active').map(s => `<option value="${s.id}" ${currentEnrollment?.siteId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}</select></div>
                                            </div>
                                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                                        </form>
                                    `;
};

const getAppointmentDetailsModalHTML = (schedule, slot) => {
const scheduledPatients = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id);
const study = state.studies.find(s => s.id === schedule.studyId);
const site = state.sites.find(s => s.id === schedule.siteId);

return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-2">Appointment Details</h2>
                                        <p class="text-gray-600 dark:text-gray-400 mb-4">${new Date(slot.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' })}</p>
                                        <p class="dark:text-gray-300"><strong>Site:</strong> ${site?.name || 'N/A'}</p>
                                        <p class="dark:text-gray-300"><strong>Study:</strong> ${study?.title || 'N/A'}</p>
                                        <p class="dark:text-gray-300"><strong>Visit Type:</strong> ${schedule.visit || 'General'}</p>
                                        
                                        <form id="update-capacity-form" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="my-4 flex items-end gap-2">
                                            <div>
                                                <label for="capacity" class="block text-sm font-medium dark:text-gray-300">Edit Slot Capacity</label>
                                                <input type="number" name="capacity" class="w-24 p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" value="${slot.capacity}">
                                            </div>
                                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm">Update</button>
                                        </form>

                                        <h3 class="font-semibold dark:text-white mt-6 mb-2">Scheduled Participants (${scheduledPatients.length}/${slot.capacity})</h3>
                                        ${scheduledPatients.length > 0 ? `
                                            <ul class="list-disc pl-5 dark:text-gray-300">
                                                ${scheduledPatients.map(p => `<li><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">${p.firstName} ${p.lastName}</button></li>`).join('')}
                                            </ul>
                                        ` : '<p class="text-gray-500 dark:text-gray-400">No participants scheduled for this slot.</p>'}
                                        
                                        <div class="mt-6 border-t dark:border-gray-700 pt-4">
                                            <button data-action="delete-slot" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="text-sm text-red-600 hover:underline" ${slot.booked > 0 ? 'disabled' : ''}>Delete Slot</button>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" ${slot.booked > 0 ? '' : 'hidden'}>Cannot delete a slot that is booked.</p>
                                        </div>
                                    `;
};

const getViewSurveyModalHTML = (survey) => {
if (!survey) return `<h2>Survey not found</h2>`;
const study = state.studies.find(s => s.id === survey.studyId);
let questionsHTML = survey.questions.map((q, index) => {
let optionsHTML = q.options.map(opt => {
let nextText = `Question ${opt.next}`;
if (opt.next === 'pass') nextText = 'End - Pass';
if (opt.next === 'fail') nextText = 'End - Fail';
if (opt.next === 'submit') nextText = 'End - Completed';
return `
                                                <li class="ml-4 list-disc">
                                                    ${opt.text} &rarr; (Next: ${nextText})
                                                </li>
                                            `}).join('');
return `
                                        <div class="mt-4 p-2 border-t dark:border-gray-700">
                                            <p class="font-semibold">Q${index + 1}: ${q.text}</p>
                                            <ul class="mt-1">
                                                ${optionsHTML}
                                            </ul>
                                        </div>
                                    `;
}).join('');

return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-2">${survey.title}</h2>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">For Study: ${study?.title || 'N/A'}</p>
                                        <div class="dark:text-gray-300">${questionsHTML}</div>
                                    `;
};

const getSelectSurveyModalHTML = (patient) => {
const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
if (!currentEnrollment) {
    return `<h2 class="text-2xl font-bold dark:text-white mb-4">Survey ${patient.firstName} ${patient.lastName}</h2><p class="dark:text-gray-300">Patient is not currently in a study.</p>`;
}
const availableSurveys = state.surveys.filter(s => s.studyId === currentEnrollment.studyId);
if (availableSurveys.length === 0) {
return `<h2 class="text-2xl font-bold dark:text-white mb-4">Survey ${patient.firstName} ${patient.lastName}</h2><p class="dark:text-gray-300">No surveys available for the patient's assigned study.</p>`;
}
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Select Survey for ${patient.firstName} ${patient.lastName}</h2>
                                        <div class="space-y-2">
                                            ${availableSurveys.map(s => `<button data-action="start-survey" data-patient-id="${patient.id}" data-survey-id="${s.id}" class="w-full text-left p-3 border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white">${s.title}</button>`).join('')}
                                        </div>
                                    `;
};

const getTakeSurveyModalHTML = () => {
const { survey, patient, currentQuestionIndex, answers } = state.currentSurveyState;
const question = survey.questions[currentQuestionIndex];

return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-2">${survey.title}</h2>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Question ${currentQuestionIndex + 1} of ${survey.questions.length}</p>
                                        <form id="take-survey-form">
                                            <p class="text-lg font-semibold dark:text-white mb-4">${question.text}</p>
                                            <div class="space-y-3 dark:text-gray-300">
                                                ${question.options.map((opt, index) => `
                                                    <div>
                                                        <input type="radio" id="option-${index}" name="answer" value="${opt.text}" data-next="${opt.next}" required class="mr-2">
                                                        <label for="option-${index}">${opt.text}</label>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <button type="submit" class="mt-8 w-full bg-blue-600 text-white py-2 rounded-md">Next</button>
                                        </form>
                                    `;
};

const getAddVisitLogModalHTML = (patientId) => {
    const visitOutcomes = ['Enrolled', 'Screen Fail', 'No Show', 'Did not consent', 'Cancelled', 'Withdrew Consent'];
    return `
        <h2 class="text-2xl font-bold dark:text-white mb-4">Add Visit Log</h2>
        <form id="add-visit-log-form" data-patient-id="${patientId}" class="space-y-4">
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Visit</label>
                <input type="text" name="visit" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="e.g., V1, Screening">
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Outcome</label>
                <select name="outcome" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                    ${visitOutcomes.map(o => `<option>${o}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium dark:text-gray-300">Completed By</label>
                <input type="text" name="completedBy" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="Your Name">
            </div>
             <div>
                <label class="block text-sm font-medium dark:text-gray-300">Signature</label>
                <input type="text" name="signature" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" placeholder="Type your name to sign">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Visit Log</button>
        </form>
    `;
};

const getViewStudyPatientsModalHTML = (study) => {
if (!study) return `<h2>Study not found</h2>`;
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Patients in: ${study.title}</h2>
                                        <div class="mb-4">
                                            <input type="text" id="modal-study-patient-search" data-study-id="${study.id}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search patients in this study...">
                                        </div>
                                        <div id="modal-patient-list-container">
                                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                                <thead class="bg-gray-50 dark:bg-gray-700">
                                                    <tr>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="modal-patient-list-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                </tbody>
                                            </table>
                                        </div>
                                    `;
};

const getViewSitePatientsModalHTML = (site) => {
if (!site) return `<h2>Site not found</h2>`;
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Patients at: ${site.name}</h2>
                                        <div class="mb-4">
                                            <input type="text" id="modal-site-patient-search" data-site-id="${site.id}" class="w-full p-2 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white" placeholder="Search patients at this site...">
                                        </div>
                                        <div id="modal-patient-list-container">
                                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                                <thead class="bg-gray-50 dark:bg-gray-700">
                                                    <tr>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="modal-patient-list-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                </tbody>
                                            </table>
                                        </div>
                                    `;
};

const renderModalPatientList = (patients, type) => {
const modalBody = document.getElementById('modal-patient-list-body');
if (!modalBody) return;

if (patients.length === 0) {
modalBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500 dark:text-gray-400">No matching patients found.</td></tr>`;
return;
}

let tableRowsHTML = '';
if (type === 'study') {
tableRowsHTML = patients.map(p => `
                                        <tr class="dark:text-gray-300">
                                            <td class="px-6 py-4"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${p.firstName} ${p.lastName}</button></td>
                                            <td class="px-6 py-4">${p.status || 'N/A'}</td>
                                            <td class="px-6 py-4">${p.appointment ? new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'Not Scheduled'}</td>
                                            <td class="px-6 py-4"><button data-action="survey-patient" data-id="${p.id}" class="text-green-600 dark:text-green-400 hover:underline">Survey</button></td>
                                        </tr>
                                    `).join('');
} else if (type === 'site') {
tableRowsHTML = patients.map(p => {
    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
    return `
        <tr class="dark:text-gray-300">
            <td class="px-6 py-4"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">${p.firstName} ${p.lastName}</button></td>
            <td class="px-6 py-4">${currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A'}</td>
            <td class="px-6 py-4">${p.status || 'N/A'}</td>
        </tr>
    `;
}).join('');
}
modalBody.innerHTML = tableRowsHTML;
lucide.createIcons();
};

const getImportPatientsModalHTML = () => {
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Import Patients from CSV</h2>
                                        <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                                            <p>Upload a CSV file with the following headers (case-sensitive):</p>
                                            <code class="text-xs bg-gray-100 dark:bg-gray-700 p-2 rounded-md block whitespace-pre-wrap">${Object.keys(patientTemplate()).filter(k => !['enrollments'].includes(k)).join(', ')},studyId,siteId</code>
                                            <p><strong>Note:</strong> The import will only add <strong>new</strong> patients (based on First Name, Last Name, and DOB) and will auto-generate a Global ID.</p>
                                        </div>
                                        <form id="import-patients-form" class="mt-6">
                                            <input type="file" id="csv-file-input" accept=".csv" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white" required>
                                            <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Import Patients</button>
                                        </form>
                                        <div id="import-status" class="mt-4 text-sm"></div>
                                    `;
};

const getAddContactLogModalHTML = (patientId) => {
return `
                                        <h2 class="text-2xl font-bold dark:text-white mb-4">Add Contact Log</h2>
                                        <form id="add-contact-log-form" data-patient-id="${patientId}" class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium dark:text-gray-300">Outcome</label>
                                                <input type="text" name="outcome" required class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium dark:text-gray-300">Notes</label>
                                                <textarea name="notes" rows="4" class="mt-1 w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"></textarea>
                                            </div>
                                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Log</button>
                                        </form>
                                    `;
};

// --- APPOINTMENT UTILITIES ---
const cancelAppointment = async (patientId) => {
const patient = state.patients.find(p => p.id === patientId);
if (!patient || !patient.appointment) return;

const { scheduleId, slotId, visit } = patient.appointment;
const schedule = state.schedules.find(s => s.id === scheduleId);
if (!schedule) return;

const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
if (slotIndex > -1 && schedule.slots[slotIndex].booked > 0) {
schedule.slots[slotIndex].booked -= 1;
const scheduleRef = doc(db, "schedules", scheduleId);
await updateDoc(scheduleRef, { slots: schedule.slots });
}

// NOTE: We no longer decrement the study enrollment here,
// as the CTMS is now the source of truth for enrollment numbers.
// This prevents a double-decrement if the CTMS sends an update.

const patientRef = doc(db, "patients", patientId);
                                        const updates = { appointment: null };
                                        if (visit) {
                                            updates.completedVisits = arrayRemove(visit);
                                        }
                                        await updateDoc(patientRef, updates);
};

const deletePatient = async (patientId) => {
const patient = state.patients.find(p => p.id === patientId);
if (!patient) return;

// If patient had an appointment, free up the slot.
// Enrollment count is handled by CTMS, so we don't adjust it here.
if (patient.appointment) {
    const { scheduleId, slotId } = patient.appointment;
    const schedule = state.schedules.find(s => s.id === scheduleId);
    if (schedule) {
        const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
        if (slotIndex > -1 && schedule.slots[slotIndex].booked > 0) {
            schedule.slots[slotIndex].booked -= 1;
            const scheduleRef = doc(db, "schedules", scheduleId);
            await updateDoc(scheduleRef, { slots: schedule.slots });
        }
    }
}

// Delete the patient document
await deleteDoc(doc(db, "patients", patientId));
closeModal();
};

// --- DATA STRUCTURES & UTILITIES ---
const calculateAge = (dobString) => {
if (!dobString) return '';
const dob = new Date(dobString);
const today = new Date();
let age = today.getFullYear() - dob.getFullYear();
const m = today.getMonth() - dob.getMonth();
if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
age--;
}
return age >= 0 ? age : '';
};

const generateShortId = () => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
};


const patientTemplate = () => ({
firstName: '', lastName: '', globalId: '', phoneNumber: '', email: '', dob: '', address: '', city: '', state: '', zipCode: '',
age: null, status: 'Candidate', registryStatus: 'Active', source: '', therapeuticArea: '',
enrollments: [], appointment: null, surveyResults: [], contactLogs: [], completedVisits: [], visitLogs: []
});


// --- EVENT HANDLERS ---
document.addEventListener('click', async (e) => {
const navButton = e.target.closest('.nav-item[data-tab]');
if (navButton) {
    setState({ activeTab: navButton.dataset.tab });
    if (window.innerWidth < 768) { // Close sidebar on mobile after navigation
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('opacity-0', 'pointer-events-none');
    }
}

const dayButton = e.target.closest('.day-btn');
if (dayButton) {
dayButton.classList.toggle('bg-blue-500');
dayButton.classList.toggle('text-white');
dayButton.classList.toggle('bg-gray-200');
dayButton.classList.toggle('dark:bg-gray-600'); // For dark mode
}

const calendarDay = e.target.closest('.calendar-day[data-date]');
if (calendarDay) {
    const date = calendarDay.dataset.date;
    openModal(getDayAppointmentsModalHTML(date), true);
}

const appointmentSlot = e.target.closest('.appointment-slot');
if (appointmentSlot) {
const { scheduleId, slotId } = appointmentSlot.dataset;
const schedule = state.schedules.find(s => s.id === scheduleId);
const slot = schedule.slots.find(s => s.id === slotId);
openModal(getAppointmentDetailsModalHTML(schedule, slot));
}

// Delegated listener for patient profile tabs within the modal
const tabButton = e.target.closest('#patient-profile-tabs button[data-tab-name]');
if (tabButton && sidePanelContainer.classList.contains('translate-x-full') === false) { // Only if side panel is open
const patientId = tabButton.dataset.patientId;
const patient = state.patients.find(p => p.id === patientId);
if (patient) {
state.currentPatientProfileTab = tabButton.dataset.tabName;

const tabContents = sidePanelContainer.querySelectorAll('#patient-profile-tab-content-container > div');
tabContents.forEach(contentDiv => {
if (contentDiv.id === `${state.currentPatientProfileTab}-content`) {
contentDiv.classList.remove('hidden');
} else {
contentDiv.classList.add('hidden');
}
});

const tabButtons = sidePanelContainer.querySelectorAll('#patient-profile-tabs button');
tabButtons.forEach(btn => {
if (btn.dataset.tabName === state.currentPatientProfileTab) {
btn.classList.add('border-blue-600', 'text-blue-600', 'dark:border-blue-400', 'dark:text-blue-400');
btn.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600', 'text-gray-500', 'dark:text-gray-400');
} else {
btn.classList.remove('border-blue-600', 'text-blue-600', 'dark:border-blue-400', 'dark:text-blue-400');
btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300', 'dark:hover:text-gray-300', 'dark:hover:border-gray-600', 'text-gray-500', 'dark:text-gray-400');
}
});
lucide.createIcons();
}
return; // Important: Stop further processing for this click
}

const actionButton = e.target.closest('button[data-action]');
if (actionButton) {
const { action, id, view, patientId, surveyId, qId, scheduleId, slotId, date, eventId, enrollmentIndex } = actionButton.dataset;
switch (action) {
case 'close-modal': closeModal(); break;
case 'close-side-panel': closeSidePanel(); break;
case 'create-study-modal': openModal(getCreateStudyModalHTML()); break;
case 'set-scheduling-view': setState({ schedulingView: view }); break;
case 'prev-month': state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); render(); break;
case 'next-month': state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); render(); break;
case 'prev-day': state.calendarDate.setDate(state.calendarDate.getDate() - 1); render(); break;
case 'next-day': state.calendarDate.setDate(state.calendarDate.getDate() + 1); render(); break;
case 'view-patient': 
    closeModal(); // Close any open modal first
    openSidePanel(getPatientProfileHTML(state.patients.find(p => p.id === id)), true); 
    break;
case 'view-study-patients': {
const study = state.studies.find(s => s.id === id);
openModal(getViewStudyPatientsModalHTML(study), true);
const studyPatients = state.patients.filter(p => {
    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
    return currentEnrollment?.studyId === study.id;
});
renderModalPatientList(studyPatients, 'study');
break;
}
case 'view-site-patients': {
const site = state.sites.find(s => s.id === id);
openModal(getViewSitePatientsModalHTML(site), true);
const sitePatients = state.patients.filter(p => {
    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
    return currentEnrollment?.siteId === site.id;
});
renderModalPatientList(sitePatients, 'site');
break;
}
case 'edit-patient': openModal(getEditPatientModalHTML(state.patients.find(p => p.id === id)), true); break;
case 'edit-study': openModal(getEditStudyModalHTML(state.studies.find(s => s.id === id))); break;
case 'edit-site': openModal(getEditSiteModalHTML(state.sites.find(s => s.id === id))); break;
case 'schedule-patient': 
state.bookingCalendarDate = new Date();
openModal(getBookingModalHTML(state.patients.find(p => p.id === id))); 
break;
case 'survey-patient': openModal(getSelectSurveyModalHTML(state.patients.find(p => p.id === id))); break;
case 'import-patients-modal': openModal(getImportPatientsModalHTML()); break;
case 'add-contact-log': openModal(getAddContactLogModalHTML(patientId)); break;
case 'add-visit-log': openModal(getAddVisitLogModalHTML(patientId)); break;
case 'cancel-appointment': 
await cancelAppointment(patientId);
closeModal();
break;
case 'change-appointment':
await cancelAppointment(patientId);
state.bookingCalendarDate = new Date();
openModal(getBookingModalHTML(state.patients.find(p => p.id === patientId)));
break;
case 'start-survey': {
state.currentSurveyState = {
patient: state.patients.find(p => p.id === patientId),
survey: state.surveys.find(s => s.id === surveyId),
currentQuestionIndex: 0,
answers: []
};
openModal(getTakeSurveyModalHTML());
break;
}
case 'book-appointment': {
    const patient = state.patients.find(p => p.id === patientId);
    const schedule = state.schedules.find(s => s.id === scheduleId);
    const slot = schedule.slots.find(s => s.id === slotId);
    
    // Use the reliable patient list to count, not the 'booked' property which might be stale
    const currentBookings = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id).length;

    if (currentBookings >= slot.capacity) {
        showNotification("This slot is already full.", "error");
        return;
    }

    const scheduleRef = doc(db, "schedules", scheduleId);
    // Find the specific slot in the array and increment its 'booked' count
    const updatedSlots = schedule.slots.map(s => {
        if (s.id === slotId) {
            return { ...s, booked: (s.booked || 0) + 1 };
        }
        return s;
    });
    await updateDoc(scheduleRef, { slots: updatedSlots });

    const patientRef = doc(db, "patients", patientId);
    const updates = {
        appointment: {
            scheduleId,
            slotId,
            time: slot.startTime,
            visit: schedule.visit || null
        }
    };

    if (schedule.visit) {
        updates.completedVisits = arrayUnion(schedule.visit);
    }
    await updateDoc(patientRef, updates);

    // NOTE: We no longer increment study enrollment here.
    // This action is now handled by the CTMS, which is the source of truth.
    // This prevents the number from being incremented twice.

    closeModal();
    break;
}
case 'quick-add-patient-modal': openModal(getQuickAddPatientHTML(), true); break;
case 'add-question': addQuestionToSurveyForm(); break;
case 'add-option': addOptionToQuestion(actionButton.dataset.qId, actionButton.dataset.type); break; // Pass type
case 'remove-question': 
document.getElementById(qId).remove();
updateBranchingLogicDropdowns();
break;
case 'remove-option': 
actionButton.parentElement.remove();
break;
case 'view-survey': openModal(getViewSurveyModalHTML(state.surveys.find(s => s.id === id))); break;
case 'export-csv': exportToCSV(); break;
case 'export-surveys-csv': exportSurveysToCSV(); break;
case 'start-duplicate-scan': {
const duplicateGroups = findDuplicates();
renderDuplicateResults(duplicateGroups);
break;
}
case 'delete-patient': {
const patient = state.patients.find(p => p.id === id);
openModal(`
                                        <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Confirm Deletion</h2>
                                        <p class="dark:text-gray-300">Are you sure you want to permanently delete the record for <strong>${patient.firstName} ${patient.lastName}</strong>?</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
                                        <div class="flex justify-end gap-4 mt-8">
                                            <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                                            <button data-action="confirm-delete-patient" data-id="${id}" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">Confirm Delete</button>
                                        </div>
                                    `);
break;
}
case 'confirm-delete-patient': {
await deletePatient(id);
break;
}
case 'delete-slot': {
const schedule = state.schedules.find(s => s.id === scheduleId);
const updatedSlots = schedule.slots.filter(s => s.id !== slotId);
await updateDoc(doc(db, "schedules", scheduleId), { slots: updatedSlots });
closeModal();
break;
}
case 'prev-booking-month': {
state.bookingCalendarDate.setMonth(state.bookingCalendarDate.getMonth() - 1);
const patient = state.patients.find(p => p.id === document.getElementById('booking-calendar-container').dataset.patientId);
openModal(getBookingModalHTML(patient));
break;
}
case 'next-booking-month': {
state.bookingCalendarDate.setMonth(state.bookingCalendarDate.getMonth() + 1);
const patient = state.patients.find(p => p.id === document.getElementById('booking-calendar-container').dataset.patientId);
openModal(getBookingModalHTML(patient));
break;
}
case 'select-booking-day': {
const patient = state.patients.find(p => p.id === document.getElementById('booking-calendar-container').dataset.patientId);
const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
const completedVisits = patient.completedVisits || [];
const availableSchedules = state.schedules.filter(s => 
s.siteId === currentEnrollment.siteId && 
s.studyId === currentEnrollment.studyId &&
!completedVisits.includes(s.visit)
);
const slotsForDay = [];
availableSchedules.forEach(schedule => {
schedule.slots.forEach(slot => {
if (slot.booked < slot.capacity && new Date(slot.startTime).toISOString().split('T')[0] === date) {
slotsForDay.push({scheduleId: schedule.id, scheduleType: schedule.visit, ...slot});
}
});
});
const slotsContainer = document.getElementById('booking-slots-container');
slotsContainer.innerHTML = slotsForDay.length > 0 ? slotsForDay.map(slot => `
                                                    <button data-action="book-appointment" data-patient-id="${patient.id}" data-schedule-id="${slot.scheduleId}" data-slot-id="${slot.id}" class="w-full text-left p-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white mb-2">
                                                        ${new Date(slot.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${slot.scheduleType || 'General'}
                                                    </button>
                                                `).join('') : '<p class="text-gray-500 dark:text-gray-400">No available slots for this day.</p>';
break;
}
case 'edit-past-enrollment': {
    const patient = state.patients.find(p => p.id === patientId);
    openModal(getEditPastEnrollmentModalHTML(patient, enrollmentIndex));
    break;
}
}
}
});

document.addEventListener('change', async (e) => {
    if ((e.target.id === 'study-filter' || e.target.id === 'site-filter') && state.activeTab === 'dashboard') {
        renderDashboardCharts();
        renderTodaysAppointments();
    }
    if (e.target.id === 'scheduling-visit-filter') {
        setState({ schedulingVisitFilter: e.target.value });
    }
    if (e.target.id === 'scheduling-site-filter') {
        setState({ schedulingSiteFilter: e.target.value });
    }
    if (e.target.id === 'scheduling-study-filter') {
        setState({ schedulingStudyFilter: e.target.value });
    }
     if (e.target.id === 'booking-visit-filter') {
          const patientId = e.target.dataset.patientId;
          const patient = state.patients.find(p => p.id === patientId);
          const visitFilter = e.target.value;
          if (patient) {
              openModal(getBookingModalHTML(patient, visitFilter));
          }
      }
    if (e.target.name === 'dob') {
        const age = calculateAge(e.target.value);
        const form = e.target.closest('form');
        if (form) {
            const ageInput = form.querySelector('input[name="age"]');
            if (ageInput) {
                ageInput.value = age;
            }
        }
    }
    // Handle visit status updates from the dashboard
    if (e.target.dataset.action === 'update-visit-status') {
        const patientId = e.target.dataset.patientId;
        const newStatus = e.target.value;
        const patient = state.patients.find(p => p.id === patientId);

        if (patient && patient.appointment) {
            const patientRef = doc(db, "patients", patientId);
            const updatedAppointment = { ...patient.appointment, visitStatus: newStatus };
            try {
                await updateDoc(patientRef, { appointment: updatedAppointment });
                showNotification(`Status for ${patient.firstName} updated to "${newStatus}".`, 'success');
            } catch (error) {
                console.error("Error updating visit status:", error);
                showNotification("Failed to update status.", "error");
            }
        }
    }
});

document.addEventListener('input', (e) => {
if (e.target.id === 'patient-search') {
state.patientSearchTerm = e.target.value;
renderPatientTable();
}
if (e.target.id === 'study-search') {
state.studySearchTerm = e.target.value;
renderStudyTable();
}
if (e.target.id === 'site-search') {
state.siteSearchTerm = e.target.value;
renderSiteTable();
}
if (e.target.id === 'modal-study-patient-search') {
const studyId = e.target.dataset.studyId;
const searchTerm = e.target.value.toLowerCase();
const studyPatients = state.patients.filter(p => {
    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
    return currentEnrollment?.studyId === studyId;
});
const filteredPatients = studyPatients.filter(p => `${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm));
renderModalPatientList(filteredPatients, 'study');
}
if (e.target.id === 'modal-site-patient-search') {
const siteId = e.target.dataset.siteId;
const searchTerm = e.target.value.toLowerCase();
const sitePatients = state.patients.filter(p => {
    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
    return currentEnrollment?.siteId === siteId;
});
const filteredPatients = sitePatients.filter(p => `${p.firstName} ${p.lastName}`.toLowerCase().includes(searchTerm));
renderModalPatientList(filteredPatients, 'site');
}
if (e.target.matches('[name$="-type"]')) {
const questionBlock = e.target.closest('.question-block');
const qId = questionBlock.id;
const selectedType = e.target.value;
const optionsContainer = questionBlock.querySelector(`div[data-options-for="${qId}"]`);
const addOptionBtn = questionBlock.querySelector(`button[data-action="add-option"]`);

optionsContainer.innerHTML = `<label class="text-sm font-medium text-gray-600 dark:text-gray-400">Options</label>`;

if (selectedType === 'open-text') {
if (addOptionBtn) addOptionBtn.classList.add('hidden');
} else {
if (addOptionBtn) addOptionBtn.classList.remove('hidden');
addOptionToQuestion(qId, selectedType); 
}
updateBranchingLogicDropdowns(); 
}
if (e.target.name === 'phoneNumber') {
const input = e.target.value.replace(/\D/g, '').substring(0, 10);
const areaCode = input.substring(0, 3);
const middle = input.substring(3, 6);
const last = input.substring(6, 10);

if (input.length > 6) {
e.target.value = `(${areaCode}) ${middle}-${last}`;
} else if (input.length > 3) {
e.target.value = `(${areaCode}) ${middle}`;
} else if (input.length > 0) {
e.target.value = `(${areaCode}`;
} else {
e.target.value = '';
}
}
});

document.addEventListener('submit', async (e) => {
e.preventDefault();
const form = e.target;
const formData = new FormData(form);
const data = Object.fromEntries(formData.entries());
const getCollectionRef = (name) => collection(db, name);

switch (form.id) {
case 'add-contact-log-form': {
const patientId = form.dataset.patientId;
const newLog = {
date: new Date().toISOString(),
outcome: data.outcome,
notes: data.notes,
};
const patientRef = doc(db, "patients", patientId);
await updateDoc(patientRef, {
contactLogs: arrayUnion(newLog)
});
closeModal();
openModal(getPatientProfileHTML(state.patients.find(p => p.id === patientId)), true);
break;
}
case 'add-visit-log-form': {
    const patientId = form.dataset.patientId;
    const newLog = {
        date: new Date().toISOString(),
        visit: data.visit,
        outcome: data.outcome,
        completedBy: data.completedBy,
        signature: data.signature,
    };
    const patientRef = doc(db, "patients", patientId);
    await updateDoc(patientRef, {
        visitLogs: arrayUnion(newLog)
    });
    closeModal();
    state.currentPatientProfileTab = 'visitDetails';
    openModal(getPatientProfileHTML(state.patients.find(p => p.id === patientId)), true);
    break;
}
case 'import-patients-form': {
const fileInput = document.getElementById('csv-file-input');
const statusEl = document.getElementById('import-status');
if (!fileInput.files || fileInput.files.length === 0) {
statusEl.textContent = "Please select a file.";
statusEl.className = "text-red-500";
return;
}
const file = fileInput.files[0];
statusEl.textContent = "Processing...";
statusEl.className = "text-blue-500";

const reader = new FileReader();
reader.onload = async (event) => {
try {
const csv = event.target.result;
const lines = csv.split('\n').filter(line => line.trim() !== '');
const headers = lines[0].split(',').map(h => h.trim());
const patientsToImport = [];

for (let i = 1; i < lines.length; i++) {
    if (!lines[i]) continue;
    const values = lines[i].split(',');
    const patientData = {};
    headers.forEach((header, index) => {
        if (header) { // Ensure header is not empty
            patientData[header] = values[index]?.trim() || '';
        }
    });

    const existingPatient = state.patients.find(p =>
        p.firstName.toLowerCase() === patientData.firstName.toLowerCase() &&
        p.lastName.toLowerCase() === patientData.lastName.toLowerCase() &&
        p.dob === patientData.dob
    );

    if (existingPatient) {
        console.log(`Skipping existing patient: ${patientData.firstName} ${patientData.lastName}`);
        continue;
    }

    const finalPatient = patientTemplate();
    Object.keys(finalPatient).forEach(key => {
        if (patientData[key] !== undefined) {
            finalPatient[key] = patientData[key];
        }
    });

    finalPatient.globalId = generateShortId();
    finalPatient.age = calculateAge(finalPatient.dob);
    
    if (patientData.studyId && patientData.siteId) {
        finalPatient.enrollments.push({
            studyId: patientData.studyId,
            siteId: patientData.siteId,
            status: 'current',
            enrolledDate: new Date().toISOString()
        });
    }
    
    patientsToImport.push(finalPatient);
}

const batch = writeBatch(db);
patientsToImport.forEach(patient => {
    const newPatientRef = doc(collection(db, "patients"));
    batch.set(newPatientRef, patient);
});
await batch.commit();
statusEl.textContent = `Successfully imported ${patientsToImport.length} new patients.`;
statusEl.className = "text-green-500";
setTimeout(closeModal, 2000);
} catch (error) {
console.error("CSV Import Error:", error);
statusEl.textContent = "Error importing file. Check console for details.";
statusEl.className = "text-red-500";
}
};
reader.readAsText(file);
break;
}
case 'take-survey-form': {
const { survey, patient, currentQuestionIndex, answers } = state.currentSurveyState;
const question = survey.questions[currentQuestionIndex];
const selectedOption = form.querySelector('input[name="answer"]:checked');
if (!selectedOption) {
console.error('Please select an option.');
return;
}
const answer = selectedOption.value;
answers.push({ question: question.text, answer });

const nextQuestionTarget = selectedOption.dataset.next;

const endSurvey = async (outcome) => {
const surveyResult = {
surveyId: survey.id,
surveyTitle: survey.title,
completedAt: new Date().toISOString(),
answers: answers,
outcome: outcome
};
const patientRef = doc(db, "patients", patient.id);
const updates = { surveyResults: arrayUnion(surveyResult) };
if (outcome === 'Pass') {
    updates.status = 'Pre-Screening';
} else if (outcome === 'Fail') {
    updates.status = 'Screen Fail';
}
await updateDoc(patientRef, updates);
closeModal();
};

if (nextQuestionTarget === 'pass') {
await endSurvey('Pass');
} else if (nextQuestionTarget === 'fail') {
await endSurvey('Fail');
} else if (nextQuestionTarget === 'submit') {
await endSurvey('Completed');
} else if (nextQuestionTarget && !isNaN(nextQuestionTarget)) {
const nextIndex = parseInt(nextQuestionTarget) - 1;
if (nextIndex >= 0 && nextIndex < survey.questions.length) {
state.currentSurveyState.currentQuestionIndex = nextIndex;
openModal(getTakeSurveyModalHTML());
} else {
await endSurvey('Completed'); // Fallback for invalid index
}
} else if (currentQuestionIndex < survey.questions.length - 1) {
state.currentSurveyState.currentQuestionIndex++;
openModal(getTakeSurveyModalHTML());
} else {
await endSurvey('Completed');
}
break;
}
case 'update-capacity-form': {
const { scheduleId, slotId } = form.dataset;
const newCapacity = parseInt(data.capacity);
const schedule = state.schedules.find(s => s.id === scheduleId);
const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
if (slotIndex > -1) {
schedule.slots[slotIndex].capacity = newCapacity;
await updateDoc(doc(db, "schedules", scheduleId), { slots: schedule.slots });
}
closeModal();
break;
}
case 'edit-patient-form': {
const patientId = form.dataset.id;
const patient = state.patients.find(p => p.id === patientId);
const updatedPatient = { ...patient }; // Start with existing data

Object.keys(patientTemplate()).forEach(key => {
    if (data[key] !== undefined && key !== 'enrollments') {
        updatedPatient[key] = data[key] || null;
    }
});
updatedPatient.age = data.age ? parseInt(data.age) : null;

const currentEnrollment = updatedPatient.enrollments?.find(e => e.status === 'current');

// If study or site has changed
if (data.studyId && (currentEnrollment?.studyId !== data.studyId || currentEnrollment?.siteId !== data.siteId)) {
    const newEnrollments = updatedPatient.enrollments ? [...updatedPatient.enrollments] : [];
    const oldEnrollmentIndex = newEnrollments.findIndex(e => e.status === 'current');
    
    // Mark old one as past
    if (oldEnrollmentIndex > -1) {
        newEnrollments[oldEnrollmentIndex].status = 'past';
        newEnrollments[oldEnrollmentIndex].exitedDate = new Date().toISOString();
    }
    
    // Add new one as current
    newEnrollments.push({
        studyId: data.studyId,
        siteId: data.siteId,
        status: 'current',
        enrolledDate: new Date().toISOString(),
        exitedDate: null
    });
    updatedPatient.enrollments = newEnrollments;
}

await updateDoc(doc(db, "patients", patientId), updatedPatient);
closeModal();
break;
}
case 'edit-study-form': {
const studyId = form.dataset.id;
const updatedStudy = {
title: data.title,
protocolNumber: data.protocolNumber,
status: data.status,
target: parseInt(data.target)
};
await updateDoc(doc(db, "studies", studyId), updatedStudy);
closeModal();
break;
}
case 'edit-site-form': {
const siteId = form.dataset.id;
const updatedSite = { name: data.name, location: data.location, status: data.status };
await updateDoc(doc(db, "sites", siteId), updatedSite);
closeModal();
break;
}
case 'create-study-form': {
const newStudy = { 
title: data.title, 
protocolNumber: data.protocolNumber,
status: data.status, 
target: parseInt(data.target), 
enrolled: 0,
screenFails: 0 // Initialize screenFails count
};
await addDoc(getCollectionRef("studies"), newStudy);
closeModal();
break;
}
case 'schedule-creator-form': {
const days = {};
form.querySelectorAll('.day-btn.bg-blue-500').forEach(btn => { days[btn.dataset.day] = true; });

let slots = [];
let currentDate = new Date(data.startDate + 'T00:00:00');
const finalDate = new Date(data.endDate + 'T00:00:00');

while (currentDate <= finalDate) {
if (days[currentDate.getDay()]) {
const [startHour, startMinute] = data.startTime.split(':').map(Number);
const [endHour, endMinute] = data.endTime.split(':').map(Number);
let slotTime = new Date(currentDate);
slotTime.setHours(startHour, startMinute, 0, 0);
const endSlotTime = new Date(currentDate);
endSlotTime.setHours(endHour, endMinute, 0, 0);

while (slotTime < endSlotTime) {
slots.push({ id: `slot-${Date.now()}-${Math.random()}`, startTime: slotTime.toISOString(), booked: 0, capacity: parseInt(data.capacity) });
slotTime.setMinutes(slotTime.getMinutes() + parseInt(data.duration));
}
}
currentDate.setDate(currentDate.getDate() + 1);
}

const newSchedule = { 
siteId: data.siteId, 
studyId: data.studyId, 
visit: data.visit,
slots: slots 
};
await addDoc(getCollectionRef("schedules"), newSchedule);
form.reset();
break;
}
case 'add-site-form': {
const newSite = { name: data.siteName, location: data.location, status: 'Active' };
await addDoc(getCollectionRef("sites"), newSite);
form.reset();
break;
}
case 'quick-add-patient-form': {
const isDuplicate = state.patients.some(p => 
p.firstName.toLowerCase() === data.firstName.toLowerCase() &&
p.lastName.toLowerCase() === data.lastName.toLowerCase() &&
p.dob === data.dob
);

if (isDuplicate) {
openModal(`
                                        <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Duplicate Patient</h2>
                                        <p class="dark:text-gray-300">A patient with the same first name, last name, and date of birth already exists.</p>
                                        <div class="flex justify-end mt-8">
                                            <button data-action="close-modal" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">OK</button>
                                        </div>
                                    `);
return;
}

const newPatient = patientTemplate();
Object.keys(newPatient).forEach(key => {
if (data[key] !== undefined) {
newPatient[key] = data[key] || null;
}
});
newPatient.globalId = generateShortId();
newPatient.age = data.age ? parseInt(data.age) : null;
if (data.studyId && data.siteId) {
    newPatient.enrollments.push({
        studyId: data.studyId,
        siteId: data.siteId,
        status: 'current',
        enrolledDate: new Date().toISOString(),
        exitedDate: null
    });
}
await addDoc(getCollectionRef("patients"), newPatient);
closeModal();
break;
}
case 'survey-creator-form': {
const questions = [];
const questionElements = form.querySelectorAll('#questions-container > div');
questionElements.forEach((qEl, index) => {
const qId = qEl.id;
const text = form.querySelector(`input[name="${qId}-text"]`).value;
const type = form.querySelector(`select[name="${qId}-type"]`).value;
const options = [];
qEl.querySelectorAll(`div[data-options-for="${qId}"] > div`).forEach(optEl => {
options.push({
text: optEl.querySelector(`input[name*="-option-text"]`).value,
next: optEl.querySelector(`select[name*="-option-next"]`)?.value || 'submit',
});
});
questions.push({ id: index + 1, text, type, options });
});
const newSurvey = { title: data.title, studyId: data.studyId, questions };
await addDoc(getCollectionRef("surveys"), newSurvey);
form.reset();
document.getElementById('questions-container').innerHTML = '';
addQuestionToSurveyForm(); 
break;
}
case 'report-filter-form': {
let filteredPatients = [...state.patients];

// Apply filters
if (data.studyId !== 'all') {
    filteredPatients = filteredPatients.filter(p => p.enrollments?.some(e => e.studyId === data.studyId));
}
if (data.siteId !== 'all') {
    filteredPatients = filteredPatients.filter(p => p.enrollments?.some(e => e.siteId === data.siteId));
}
if (data.status !== 'all') {
    filteredPatients = filteredPatients.filter(p => p.status === data.status);
}
if (data.source !== 'all') {
    filteredPatients = filteredPatients.filter(p => p.source === data.source);
}
if (data.minAge) {
    filteredPatients = filteredPatients.filter(p => p.age >= parseInt(data.minAge));
}
if (data.maxAge) {
    filteredPatients = filteredPatients.filter(p => p.age <= parseInt(data.maxAge));
}
if (data.schedulingStatus === 'scheduled') {
    filteredPatients = filteredPatients.filter(p => p.appointment);
}
if (data.schedulingStatus === 'not-scheduled') {
    filteredPatients = filteredPatients.filter(p => !p.appointment);
}
if (form.querySelector('[name="surveyCompleted"]').checked) {
    filteredPatients = filteredPatients.filter(p => p.surveyResults && p.surveyResults.length > 0);
}
if (data.surveyOutcome !== 'all') {
    filteredPatients = filteredPatients.filter(p => p.surveyResults?.some(sr => sr.outcome === data.surveyOutcome));
}
if (data.startDate) {
    filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) >= new Date(data.startDate));
}
if (data.endDate) {
    filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) <= new Date(data.endDate));
}

state.lastReportData = filteredPatients;
const exportBtn = document.getElementById('export-csv-btn');
const exportSurveysBtn = document.getElementById('export-surveys-btn');
const resultsBody = document.getElementById('report-results-body');

if(filteredPatients.length > 0) {
    resultsBody.innerHTML = filteredPatients.map(p => {
        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
        const lastSurvey = p.surveyResults && p.surveyResults.length > 0 ? p.surveyResults[p.surveyResults.length - 1] : null;
        const outcome = lastSurvey ? lastSurvey.outcome : 'N/A';
        const outcomeColor = outcome === 'Pass' ? 'text-green-500' : outcome === 'Fail' ? 'text-red-500' : '';

        return `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">${p.firstName} ${p.lastName}</td>
                <td class="px-6 py-4 whitespace-nowrap">${p.age || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${p.status || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${p.appointment ? new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'Not Scheduled'}</td>
                <td class="px-6 py-4 whitespace-nowrap font-semibold ${outcomeColor}">${outcome}</td>
            </tr>
        `;
    }).join('');
    if (exportBtn) exportBtn.disabled = false;
    if (exportSurveysBtn) exportSurveysBtn.disabled = false;
} else {
    resultsBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 dark:text-gray-400 py-8">No patients match the selected criteria.</td></tr>`;
    if (exportBtn) exportBtn.disabled = true;
    if (exportSurveysBtn) exportSurveysBtn.disabled = true;
}

// Calculate and display metrics
const metricsContainer = document.getElementById('report-metrics');
const total = filteredPatients.length;
const avgAge = total > 0 ? (filteredPatients.reduce((sum, p) => sum + (p.age || 0), 0) / filteredPatients.filter(p => p.age).length).toFixed(1) : 'N/A';
const scheduled = filteredPatients.filter(p => p.appointment).length;
metricsContainer.innerHTML = `
                                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Total Patients</p><p class="text-2xl font-bold dark:text-white">${total}</p></div>
                                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Average Age</p><p class="text-2xl font-bold dark:text-white">${avgAge}</p></div>
                                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Scheduled</p><p class="text-2xl font-bold dark:text-white">${scheduled}</p></div>
                                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Not Scheduled</p><p class="text-2xl font-bold dark:text-white">${total - scheduled}</p></div>
                                        `;
lucide.createIcons();
break;
}
case 'edit-past-enrollment-form': {
    const { patientId, enrollmentIndex } = form.dataset;
    const patient = state.patients.find(p => p.id === patientId);
    if (patient && patient.enrollments[enrollmentIndex]) {
        const updatedEnrollments = [...patient.enrollments];
        updatedEnrollments[enrollmentIndex] = {
            ...updatedEnrollments[enrollmentIndex],
            studyId: data.studyId,
            siteId: data.siteId,
            enrolledDate: data.enrolledDate ? new Date(data.enrolledDate).toISOString() : null,
            exitedDate: data.exitedDate ? new Date(data.exitedDate).toISOString() : null,
        };
        await updateDoc(doc(db, "patients", patientId), { enrollments: updatedEnrollments });
        closeModal();
    }
    break;
}
}
});

// --- SURVEY LOGIC ---
const updateBranchingLogicDropdowns = () => {
const questionsContainer = document.getElementById('questions-container');
if (!questionsContainer) return;
const questionElements = questionsContainer.querySelectorAll('.question-block');
const questionOptions = Array.from(questionElements).map((el, index) => {
return { value: index + 1, text: `Question ${index + 1}` };
});

const allDropdowns = questionsContainer.querySelectorAll('select[name$="-option-next"]');
allDropdowns.forEach(dropdown => {
const currentValue = dropdown.value;
dropdown.innerHTML = `
                                                <option value="submit">End - Completed</option>
                                                <option value="pass">End - Pass</option>
                                                <option value="fail">End - Fail</option>
                                            `;
questionOptions.forEach(opt => {
dropdown.innerHTML += `<option value="${opt.value}">${opt.text}</option>`;
});
dropdown.value = currentValue;
});
};

const addQuestionToSurveyForm = () => {
const container = document.getElementById('questions-container');
if (!container) return;
const qId = `q-${Date.now()}`;
const questionIndex = container.children.length + 1;
const questionHTML = `
                                        <div id="${qId}" class="p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-700 relative question-block">
                                            <button type="button" data-action="remove-question" data-q-id="${qId}" class="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
                                            <label class="font-medium dark:text-white">Question ${questionIndex}</label>
                                            <input type="text" name="${qId}-text" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white mb-2" placeholder="Question Text" required/>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Question Type</label>
                                                <select name="${qId}-type" class="mt-1 block w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                                    <option value="single-select">Single Select (with branching)</option>
                                                    <option value="multi-select">Multi-Select</option>
                                                    <option value="dropdown">Dropdown</option>
                                                    <option value="open-text">Open Text</option>
                                                </select>
                                            </div>
                                            <div class="mt-2 space-y-2 pl-4" data-options-for="${qId}">
                                                <label class="text-sm font-medium text-gray-600 dark:text-gray-400">Options</label>
                                            </div>
                                            <button type="button" data-action="add-option" data-q-id="${qId}" data-type="single-select" class="text-sm text-blue-600 dark:text-blue-400 hover:underline mt-2">+ Add Option</button>
                                        </div>`;
container.insertAdjacentHTML('beforeend', questionHTML);
addOptionToQuestion(qId, 'single-select'); // Add an initial option, default to single-select type logic
updateBranchingLogicDropdowns();
lucide.createIcons();
};

const addOptionToQuestion = (qId, type) => {
const optionsContainer = document.querySelector(`div[data-options-for="${qId}"]`);
if (!optionsContainer) return;

let optionHTML = `
                                                <div class="flex items-center gap-2">
                                                    <input type="text" name="${qId}-option-text" class="flex-grow p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white" placeholder="Option Text" required/>
                                               `;

// Only show the next question dropdown for single-select type
if (type === 'single-select') {
optionHTML += `<select name="${qId}-option-next" class="w-48 p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-white"></select>`;
}
// Multi-select and Dropdown don't need 'next' branching in the creator UI for simplicity, as they proceed linearly

optionHTML += `
                                                    <button type="button" data-action="remove-option" class="p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                                </div>`;
optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
updateBranchingLogicDropdowns();
lucide.createIcons();
};

// --- CALENDAR LOGIC ---
const renderCalendar = () => {
const container = document.getElementById('calendar-container');
if (!container) return;

const date = state.calendarDate;
const month = date.getMonth();
const year = date.getFullYear();

const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const daysInMonth = lastDay.getDate();
const startDayOfWeek = firstDay.getDay();

const monthName = date.toLocaleString('default', { month: 'long' });

// Apply site and study filters
let filteredSchedules = state.schedules;
if (state.schedulingSiteFilter !== 'all') {
    filteredSchedules = filteredSchedules.filter(s => s.siteId === state.schedulingSiteFilter);
}
if (state.schedulingStudyFilter !== 'all') {
    filteredSchedules = filteredSchedules.filter(s => s.studyId === state.schedulingStudyFilter);
}


let calendarHTML = `
                                                <div class="flex justify-between items-center mb-4 dark:text-white">
                                                    <button data-action="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
                                                    <h3 class="text-xl font-semibold">${monthName} ${year}</h3>
                                                    <button data-action="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
                                                </div>
                                                <div class="grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                                                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<div class="text-center font-semibold text-sm py-2 bg-gray-50 dark:bg-gray-700 dark:text-gray-300">${day}</div>`).join('')}
                                                `;

for (let i = 0; i < startDayOfWeek; i++) {
calendarHTML += `<div class="bg-gray-50 dark:bg-gray-700/50"></div>`;
}

for (let day = 1; day <= daysInMonth; day++) {
const currentDate = new Date(year, month, day);
const dateString = currentDate.toISOString().split('T')[0];

let appointmentsHTML = '';
filteredSchedules.forEach(schedule => {
schedule.slots.forEach(slot => {
const slotDate = new Date(slot.startTime);
if (slotDate.toISOString().split('T')[0] === dateString) {
const study = state.studies.find(s => s.id === schedule.studyId);
const bookedCount = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id).length;
const isFull = bookedCount >= slot.capacity;
appointmentsHTML += `
                                                    <div data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="appointment-slot p-1.5 mb-1 rounded-md text-xs cursor-pointer ${isFull ? 'bg-red-200 dark:bg-red-800 text-red-900 dark:text-red-100' : 'bg-blue-100 dark:bg-blue-800 hover:bg-blue-200 dark:hover:bg-blue-700 text-blue-900 dark:text-blue-100'}">
                                                        <p class="font-semibold truncate dark:text-white">${schedule.visit || 'General'}: ${study?.title || 'No Title'}</p>
                                                        <p class="dark:text-gray-300">${slotDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${bookedCount}/${slot.capacity})</p>
                                                    </div>
                                                `;
}
});
});

calendarHTML += `
                                                <div class="calendar-day p-2 bg-white dark:bg-gray-800 relative cursor-pointer" data-date="${dateString}">
                                                    <span class="font-medium text-gray-800 dark:text-gray-200">${day}</span>
                                                    <div class="mt-2 overflow-y-auto max-h-24">${appointmentsHTML}</div>
                                                </div>
                                            `;
}
calendarHTML += `</div>`;
container.innerHTML = calendarHTML;
lucide.createIcons();
};

const renderDayView = () => {
const container = document.getElementById('day-view-container');
if (!container) return;
const date = state.calendarDate;
const dateString = date.toISOString().split('T')[0];
const dayName = date.toLocaleDateString('default', { weekday: 'long', month: 'long', day: 'numeric' });

let filteredSchedules = state.schedules;
if (state.schedulingSiteFilter !== 'all') {
    filteredSchedules = filteredSchedules.filter(s => s.siteId === state.schedulingSiteFilter);
}
if (state.schedulingStudyFilter !== 'all') {
    filteredSchedules = filteredSchedules.filter(s => s.studyId === state.schedulingStudyFilter);
}

const slotsForDay = [];
filteredSchedules.forEach(schedule => {
schedule.slots.forEach(slot => {
if (new Date(slot.startTime).toISOString().split('T')[0] === dateString) {
slotsForDay.push({schedule, slot});
}
});
});
slotsForDay.sort((a,b) => new Date(a.slot.startTime) - new Date(b.slot.startTime));

let dayHTML = `
                                                <div class="flex justify-between items-center mb-4 dark:text-white">
                                                    <button data-action="prev-day" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button>
                                                    <h3 class="text-xl font-semibold">${dayName}</h3>
                                                    <button data-action="next-day" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button>
                                                </div>
                                                <div class="space-y-4">
                                                `;

if (slotsForDay.length > 0) {
slotsForDay.forEach(({schedule, slot}) => {
const study = state.studies.find(s => s.id === schedule.studyId);
const patientsInSlot = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id);
dayHTML += `
                                                    <div class="p-4 border dark:border-gray-700 rounded-lg">
                                                        <p class="font-bold dark:text-white">${new Date(slot.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                                        <p class="text-sm text-gray-600 dark:text-gray-400">${schedule.visit || 'General'}: ${study?.title || 'N/A'}</p>
                                                        <div class="mt-2 text-sm">
                                                            ${patientsInSlot.length > 0 ? patientsInSlot.map(p => `<p class="dark:text-gray-300">${p.firstName} ${p.lastName}</p>`).join('') : '<p class="text-gray-500 dark:text-gray-500">Open Slot</p>'}
                                                        </div>
                                                    </div>
                                                `;
});
} else {
dayHTML += `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No appointments scheduled for this day.</p>`;
}

dayHTML += `</div>`;
container.innerHTML = dayHTML;
lucide.createIcons();
};

const renderBookedAppointmentsView = () => {
const container = document.getElementById('booked-view-container');
if(!container) return;

let bookedAppointments = [];
state.patients.forEach(p => {
if(p.appointment) {
const schedule = state.schedules.find(s => s.id === p.appointment.scheduleId);
if (schedule) {
const slot = schedule.slots.find(s => s.id === p.appointment.slotId);
if(slot) {
bookedAppointments.push({patient: p, schedule, slot});
}
}
}
});

if (state.schedulingSiteFilter !== 'all') {
    bookedAppointments = bookedAppointments.filter(({ patient }) => {
        const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
        return currentEnrollment?.siteId === state.schedulingSiteFilter;
    });
}
if (state.schedulingStudyFilter !== 'all') {
    bookedAppointments = bookedAppointments.filter(({ patient }) => {
        const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
        return currentEnrollment?.studyId === state.schedulingStudyFilter;
    });
}


bookedAppointments.sort((a,b) => new Date(a.slot.startTime) - new Date(b.slot.startTime));

let bookedHTML = `<h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">All Booked Appointments</h3>`;
if (bookedAppointments.length > 0) {
bookedHTML += `
                                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                                    <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Date & Time</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Patient</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Visit Type</th>
                                                    </tr></thead>
                                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                    ${bookedAppointments.map(({patient, schedule, slot}) => `
                                                        <tr class="dark:text-gray-300">
                                                            <td class="px-6 py-4">${new Date(slot.startTime).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })}</td>
                                                            <td class="px-6 py-4"><button data-action="view-patient" data-id="${patient.id}" class="text-blue-600 dark:text-blue-400 hover:underline">${patient.firstName} ${patient.lastName}</button></td>
                                                            <td class="px-6 py-4">${state.studies.find(s => s.id === schedule.studyId)?.title || 'N/A'}</td>
                                                            <td class="px-6 py-4">${schedule.visit || 'General'}</td>
                                                        </tr>
                                                    `).join('')}
                                                    </tbody>
                                                </table>
                                            `;
} else {
bookedHTML += `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No appointments have been booked with the current filters.</p>`;
}
container.innerHTML = bookedHTML;
lucide.createIcons();
};

// --- REPORTING & DUPLICATE UTILITIES ---
const findDuplicates = () => {
const potentialDuplicates = new Map();
state.patients.forEach(patient => {
if (!patient.lastName || !patient.dob || !patient.firstName) {
return;
}
// Normalize first name to its first 3 letters for fuzzy matching
const firstNameKey = patient.firstName.toLowerCase().substring(0, 3);
const key = `${patient.lastName.toLowerCase()}|${patient.dob}|${firstNameKey}`;

if (!potentialDuplicates.has(key)) {
potentialDuplicates.set(key, []);
}
potentialDuplicates.get(key).push(patient);
});

const actualDuplicates = [];
// A second pass to catch variations like Matt/Matthew
for (const group of potentialDuplicates.values()) {
if (group.length > 1) {
actualDuplicates.push(group);
}
}
return actualDuplicates;
};

const renderDuplicateResults = (duplicateGroups) => {
const container = document.getElementById('duplicate-results-container');
if (!container) return;

if (duplicateGroups.length === 0) {
container.innerHTML = `<div class="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 text-green-700 dark:text-green-300 p-4" role="alert"><p class="font-bold">Scan Complete</p><p>No potential duplicates found.</p></div>`;
return;
}

container.innerHTML = duplicateGroups.map((group, index) => `
                                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                                                    <div class="p-4 bg-red-100 dark:bg-red-900 border-l-4 border-red-500 flex justify-between items-center">
                                                        <h3 class="font-bold text-lg text-red-800 dark:text-red-200">Potential Duplicate Group ${index + 1}</h3>
                                                        <button data-action="combine-duplicates" data-group-ids='${JSON.stringify(group.map(p => p.id))}' class="bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600">Combine</button>
                                                    </div>
                                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                                        <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">DOB</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Email</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                                        </tr></thead>
                                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                            ${group.map(p => `
                                                                <tr class="dark:text-gray-300">
                                                                    <td class="px-6 py-4">${p.firstName} ${p.lastName}</td>
                                                                    <td class="px-6 py-4">${p.dob}</td>
                                                                    <td class="px-6 py-4">${p.email || 'N/A'}</td>
                                                                    <td class="px-6 py-4 flex items-center gap-2">
                                                                        <button data-action="view-patient" data-id="${p.id}" class="text-blue-600 dark:text-blue-400 hover:underline">View</button>
                                                                        <button data-action="delete-patient" data-id="${p.id}" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                                    </td>
                                                                </tr>`).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            `).join('');
lucide.createIcons();
};

const exportToCSV = () => {
try {
const patients = state.lastReportData;
if (!patients || patients.length === 0) {
showNotification("Please generate a report before exporting.", "info");
return;
}

const headers = Object.keys(patientTemplate());
headers.splice(headers.indexOf('surveyResults'), 1); // remove complex object
headers.splice(headers.indexOf('appointment'), 1);
headers.splice(headers.indexOf('enrollments'), 1);
headers.push("appointmentDate", "currentStudy", "currentSite");

const csvRows = [headers.join(',')];

for (const p of patients) {
const row = headers.map(header => {
let value;
const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
if (header === 'appointmentDate') {
value = p.appointment ? new Date(p.appointment.time).toISOString() : '';
} else if (header === 'currentStudy') {
value = currentEnrollment ? state.studies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A';
} else if (header === 'currentSite') {
value = currentEnrollment ? state.sites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A';
} else {
    value = p[header];
}
return `"${(value || '').toString().replace(/"/g, '""')}"`;
});
csvRows.push(row.join(','));
}

const csvString = csvRows.join('\n');
const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
const link = document.createElement("a");
const url = URL.createObjectURL(blob);
link.setAttribute("href", url);
const date = new Date().toISOString().split('T')[0];
link.setAttribute("download", `report_${date}.csv`);
link.style.visibility = 'hidden';
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
showNotification("Report exported successfully!", "success");
} catch (error) {
console.error("Failed to export report CSV:", error);
showNotification("Failed to export report. See console for details.", "error");
}
};

const exportSurveysToCSV = () => {
try {
const patients = state.lastReportData;
if (!patients || patients.length === 0) {
showNotification("Please generate a report before exporting survey results.", "info");
return;
}

const headers = ["PatientID", "PatientName", "SurveyTitle", "CompletionDate", "Outcome", "Question", "Answer"];
const csvRows = [headers.join(',')];

for (const p of patients) {
if (p.surveyResults && p.surveyResults.length > 0) {
for (const result of p.surveyResults) {
if (result.answers && result.answers.length > 0) {
for (const answer of result.answers) {
csvRows.push([
`"${p.id}"`,
`"${p.firstName} ${p.lastName}"`,
`"${(result.surveyTitle || '').replace(/"/g, '""')}"`,
`"${new Date(result.completedAt).toISOString()}"`,
`"${(result.outcome || 'N/A').replace(/"/g, '""')}"`,
`"${(answer.question || '').replace(/"/g, '""')}"`,
`"${(answer.answer || '').replace(/"/g, '""')}"`
].join(','));
}
} else {
csvRows.push([
`"${p.id}"`,
`"${p.firstName} ${p.lastName}"`,
`"${(result.surveyTitle || '').replace(/"/g, '""')}"`,
`"${new Date(result.completedAt).toISOString()}"`,
`"${(result.outcome || 'N/A').replace(/"/g, '""')}"`,
`"N/A"`,
`"N/A"`
].join(','));
}
}
}
}

if (csvRows.length <= 1) {
showNotification("No survey results found for the patients in the current report.", "info");
return;
}

const csvString = csvRows.join('\n');
const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);

const link = document.createElement("a");
link.setAttribute("href", url);
const date = new Date().toISOString().split('T')[0];
const filename = `survey_results_${date}.csv`;
link.setAttribute("download", filename);
link.style.visibility = 'hidden';
document.body.appendChild(link);

try {
link.click();
showNotification(`CSV generated. Download '${filename}' should begin.`, "success");
} catch (clickError) {
console.error("Error triggering download link click:", clickError);
showNotification("Could not trigger download. Please check browser console.", "error");
}

document.body.removeChild(link);
URL.revokeObjectURL(url); 
} catch (error) {
console.error("Failed to export survey CSV:", error);
showNotification("Failed to export surveys. See console for details.", "error");
}
};

/// --- FIREBASE DATA INTERACTIONS ---
const setupRealtimeListeners = (userId) => {
    const collectionsToFetch = {
        "studies": query(collection(db, "studies"), where("status", "in", ["Recruiting", "Enrolling", "Active"])),
        "sites": collection(db, "sites"),
        "patients": collection(db, "patients"),
        "schedules": collection(db, "schedules"),
        "surveys": collection(db, "surveys")
    };

    Object.entries(collectionsToFetch).forEach(([colName, queryOrRef]) => {
        onSnapshot(queryOrRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            if (data.length > 0 && (data[0].firstName || data[0].lastName)) {
                data.sort((a, b) => `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`));
            } else if (data.length > 0 && (data[0].title || data[0].name)) {
                data.sort((a, b) => (a.title || a.name).localeCompare(b.title || b.name));
            }

            state[colName] = data;
            render(); 
        }, (error) => {
            console.error(`Error listening to ${colName}:`, error);
            if (error.code === 'failed-precondition') {
                 showNotification(`Query for ${colName} requires a Firestore index. Please create it in your Firebase console.`, 'error');
            }
        });
    });
};

// --- CTMS INTEGRATION ---
/**
 * Handles incoming messages from the CTMS window to update study data.
 * @param {MessageEvent} event The message event from the other window.
 */
const handleCtmsMessage = async (event) => {
    // In a real application, you would check event.origin for security.
    // For example: if (event.origin !== 'https://mhillora.github.io') return;

    const { type, payload } = event.data;

    if (type === 'CTMS_DATA_UPDATE' && payload) {
        const { studyId, enrolled, screenFails } = payload;
        
        if (!studyId || typeof enrolled === 'undefined' || typeof screenFails === 'undefined') {
            console.warn("Received invalid CTMS data payload:", payload);
            return;
        }

        const studyRef = doc(db, "studies", studyId);
        try {
            await updateDoc(studyRef, {
                enrolled: parseInt(enrolled, 10),
                screenFails: parseInt(screenFails, 10)
            });
            const studyTitle = state.studies.find(s => s.id === studyId)?.title || 'a study';
            showNotification(`Data for ${studyTitle} updated from CTMS.`, 'success');
        } catch (error) {
            console.error("Error updating study data from CTMS:", error);
            showNotification("Failed to update study data from CTMS.", "error");
        }
    }
};


// --- INITIALIZATION ---
const init = async () => {
document.getElementById('logo-container').innerHTML = `
                                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                                <g>
                                                    <circle class="logo-bg" cx="50" cy="50" r="48" />
                                                    <path class="logo-swoosh" d="M 5,60 C 40,85 60,85 95,60" stroke-width="12" fill="none" stroke-linecap="round"/>
                                                    <circle class="logo-inner-circle" cx="50" cy="50" r="22" />
                                                    <circle class="logo-dot" cx="59" cy="41" r="7" />
                                                </g>
                                            </svg>`;
document.getElementById('mobile-logo-container').innerHTML = document.getElementById('logo-container').innerHTML;

document.getElementById('dark-mode-toggle').addEventListener('click', toggleTheme);
overlay.addEventListener('click', () => {
    closeSidePanel();
    if (sidebar.classList.contains('-translate-x-full') === false) {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('opacity-0', 'pointer-events-none');
    }
});
mobileMenuButton.addEventListener('click', () => {
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('opacity-0');
    overlay.classList.toggle('pointer-events-none');
    overlay.classList.add('bg-opacity-60'); // Ensure mobile overlay is visible
});
loadTheme(); // Apply theme on load

// Listen for messages from other windows (i.e., the CTMS)
window.addEventListener('message', handleCtmsMessage, false);

onAuthStateChanged(auth, (user) => {
if (user) {
if (!state.authReady) {
state.userId = user.uid;
state.authReady = true;
setupRealtimeListeners(user.uid);
}
} else {
state.authReady = false;
state.userId = null;
setState({ patients: [], sites: [], studies: [], schedules: [], surveys: []});
}
});

try {
if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
await signInWithCustomToken(auth, __initial_auth_token);
} else {
await signInAnonymously(auth);
}
} catch (error) {
console.error("Authentication failed:", error);
let errorMessage = "Error: Could not authenticate with the server. Please refresh the page.";
if (error.code === 'auth/operation-not-allowed') {
errorMessage = `<div class='text-center'><h3 class='font-bold text-lg'>Authentication Error</h3><p class='mt-2'>Anonymous sign-in is not enabled for this project.</p><p class='mt-4 text-sm text-gray-600'><strong>Action Required:</strong> Go to your Firebase project's Authentication settings, select the "Sign-in method" tab, and enable the "Anonymous" provider.</p></div>`;
}
mainContent.innerHTML = `<div class="p-4 bg-red-100 rounded-md text-red-700">${errorMessage}</div>`;
}
};

window.onload = init;

</script>
</body>
</html>
