<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.A.S.A. - Not Another Scheduling Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .calendar-day {
            min-height: 120px;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: #f9fafb;
        }
        .appointment-slot {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .appointment-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* Custom scrollbar for modal content */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white p-4 border-r border-gray-200 h-screen sticky top-0 flex flex-col">
            <div class="flex items-center mb-8">
                <div id="logo-container" class="h-10 w-10"></div>
                <h1 class="text-xl font-bold ml-2 text-gray-800">N.A.S.A.</h1>
            </div>
            <nav id="nav-menu" class="space-y-2 flex-grow">
                <!-- Nav items will be injected by JS -->
            </nav>
            <div class="border-t pt-4">
                <p class="text-xs text-gray-500 px-4">Not Another Scheduling Application</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-8 bg-gray-50">
            <!-- Content will be injected by JS -->
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex justify-center items-center p-4"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Use latest Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, setDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJYn2wp6Vrlz-DVMwyZwsHrXSJJrXL3f0",
            authDomain: "nasa-27896.firebaseapp.com",
            projectId: "nasa-27896",
            storageBucket: "nasa-27896.appspot.com",
            messagingSenderId: "407765833759",
            appId: "1:407765833759:web:cef776a5e24a6fa92e5d2a",
            measurementId: "G-JXT99BHXMQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE & CONSTANTS ---
        let state = {
            authReady: false,
            userId: null,
            activeTab: 'dashboard',
            patientSearchTerm: '',
            schedulingView: 'calendar', // 'creator' or 'calendar' - Default to calendar
            calendarDate: new Date(),
            studies: [],
            patients: [],
            sites: [],
            surveys: [],
            schedules: [],
            lastReportData: [], // To store data for CSV export
            // For survey taking
            currentSurveyState: null, 
        };

        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const navMenu = document.getElementById('nav-menu');
        const modalContainer = document.getElementById('modal-container');

        // --- RENDER & STATE MANAGEMENT ---
        const setState = (newState) => {
            state = { ...state, ...newState };
            render();
        };

        const render = () => {
            if (!state.authReady) {
                 mainContent.innerHTML = `<div class="flex items-center justify-center h-full"><div class="text-gray-500">Authenticating...</div></div>`;
                return;
            }
            renderNav();
            renderContent();
            lucide.createIcons();
        };

        const renderNav = () => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'studies', label: 'Studies', icon: 'file-text' },
                { id: 'patients', label: 'Patients', icon: 'users' },
                { id: 'sites', label: 'Sites', icon: 'building' },
                { id: 'surveys', label: 'Surveys', icon: 'clipboard-list' },
                { id: 'scheduling', label: 'Scheduling', icon: 'calendar' },
                { id: 'reporting', label: 'Reporting', icon: 'trending-up' },
            ];
            navMenu.innerHTML = navItems.map(item => `
                <button data-tab="${item.id}" class="nav-item w-full flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors ${state.activeTab === item.id ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'}">
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    <span class="ml-3">${item.label}</span>
                </button>
            `).join('');
        };

        const renderContent = () => {
            const contentMap = {
                dashboard: getDashboardHTML,
                studies: getStudiesHTML,
                patients: getPatientsHTML,
                sites: getSitesHTML,
                surveys: getSurveysHTML,
                scheduling: getSchedulingHTML,
                reporting: getReportingHTML,
            };
            mainContent.innerHTML = contentMap[state.activeTab]();
            if (state.activeTab === 'patients') {
                 // After rendering the main structure, populate the table
                renderPatientTable();
            }
            if (state.activeTab === 'surveys' && !document.getElementById('questions-container')?.children.length) {
                addQuestionToSurveyForm();
            }
            if (state.activeTab === 'scheduling' && state.schedulingView === 'calendar') {
                renderCalendar();
            }
        };

        // --- MODAL HANDLING ---
        const openModal = (content, fullWidth = false) => {
            const maxWidthClass = fullWidth ? 'max-w-4xl' : 'max-w-2xl';
            modalContainer.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-2xl w-full ${maxWidthClass} relative max-h-[90vh]">
                    <div class="modal-content overflow-y-auto max-h-[calc(90vh-100px)] pr-4">
                        ${content}
                    </div>
                     <button data-action="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                        <i data-lucide="x"></i>
                    </button>
                </div>`;
            modalContainer.classList.remove('hidden');
            lucide.createIcons();
        };

        const closeModal = () => {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
            state.currentSurveyState = null; // Clear survey state on modal close
        };

        // --- HTML GETTERS FOR EACH PAGE ---

        const getDashboardHTML = () => {
            const totalEnrolled = state.studies.reduce((sum, study) => sum + (study.enrolled || 0), 0);
            const recruitingStudies = state.studies.filter(s => s.status === 'Recruiting').length;
            const totalPatients = state.patients.length;
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-blue-500"><i data-lucide="users" class="text-white"></i></div><div><p class="text-sm text-gray-500">Total Patients Enrolled</p><p class="text-2xl font-bold">${totalEnrolled}</p></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-green-500"><i data-lucide="file-text" class="text-white"></i></div><div><p class="text-sm text-gray-500">Active Recruiting Studies</p><p class="text-2xl font-bold">${recruitingStudies}</p></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center"><div class="p-3 rounded-full mr-4 bg-indigo-500"><i data-lucide="users" class="text-white"></i></div><div><p class="text-sm text-gray-500">Potential Candidates</p><p class="text-2xl font-bold">${totalPatients}</p></div></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-700 mb-4">Recruitment Funnel</h3><div id="chart-container" class="flex items-center justify-center h-64 text-gray-500">Charting library placeholder.</div></div>`;
        };

        const getStudiesHTML = () => `
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-3xl font-bold text-gray-800">Clinical Studies</h2>
                 <button data-action="create-study-modal" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Create New Study
                 </button>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Enrollment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${state.studies.map(study => `<tr><td class="px-6 py-4">${study.title}</td><td class="px-6 py-4">${study.status}</td><td class="px-6 py-4">${study.enrolled || 0} / ${study.target}</td><td class="px-6 py-4 flex items-center gap-4"><button data-action="view-study-patients" data-id="${study.id}" class="text-green-600 hover:underline">View Patients</button><button data-action="edit-study" data-id="${study.id}" class="text-blue-600 hover:underline">Edit</button></td></tr>`).join('')}</tbody>
                </table>
            </div>`;

        const getPatientsHTML = () => {
            return `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Patients</h2>
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="patient-search" value="${state.patientSearchTerm}" class="p-2 border rounded-md md:col-span-2" placeholder="Search patients by name...">
                    <button data-action="quick-add-patient-modal" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Quick Add Patient</button>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Appointment</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                        <tbody id="patient-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>`;
        };
        
        const renderPatientTable = () => {
            const tableBody = document.getElementById('patient-table-body');
            if (!tableBody) return;
            const filteredPatients = state.patients.filter(p => p.name.toLowerCase().includes(state.patientSearchTerm.toLowerCase()));
            tableBody.innerHTML = filteredPatients.map(p => `<tr><td class="px-6 py-4"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 hover:underline font-medium">${p.name}</button></td><td class="px-6 py-4">${state.sites.find(s => s.id === p.siteId)?.name || 'N/A'}</td><td class="px-6 py-4">${state.studies.find(s => s.id === p.studyId)?.title || 'N/A'}</td><td class="px-6 py-4">${p.appointment ? new Date(p.appointment.time).toLocaleString() : 'Not Scheduled'}</td><td class="px-6 py-4 flex items-center gap-4"><button data-action="survey-patient" data-id="${p.id}" class="text-green-600 hover:underline">Survey</button><button data-action="schedule-patient" data-id="${p.id}" ${p.appointment ? 'disabled' : ''} class="text-blue-600 hover:underline disabled:text-gray-400 disabled:no-underline">Schedule</button><button data-action="edit-patient" data-id="${p.id}" class="text-gray-500 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button></td></tr>`).join('');
            lucide.createIcons();
        };

        const getSitesHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Clinical Sites</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Add New Site</h3>
                <form id="add-site-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label for="siteName" class="block text-sm font-medium text-gray-700">Site Name</label><input type="text" id="siteName" name="siteName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="e.g., Andover"></div>
                    <div><label for="siteLocation" class="block text-sm font-medium text-gray-700">Location</label><input type="text" id="siteLocation" name="siteLocation" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="e.g., Andover, MA"></div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center justify-center h-10"><i data-lucide="plus-circle" class="mr-2"></i> Add Site</button>
                </form>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <h3 class="text-xl font-semibold text-gray-700 p-6">Current Sites</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">${state.sites.map(site => `<tr><td class="px-6 py-4">${site.name}</td><td class="px-6 py-4">${site.location}</td><td class="px-6 py-4"><button data-action="edit-site" data-id="${site.id}" class="text-blue-600 hover:underline">Edit</button></td></tr>`).join('')}</tbody>
                </table>
            </div>`;

        const getSurveysHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Surveys with Branching Logic</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Create New Survey</h3>
                <form id="survey-creator-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Survey Title</label><input type="text" name="title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., Patient Intake Survey" required /></div>
                        <div><label class="block text-sm font-medium text-gray-700">Assign to Study</label><select name="studyId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white" required><option value="" disabled selected>Select a study</option>${state.studies.map(study => `<option value="${study.id}">${study.title}</option>`).join('')}</select></div>
                    </div>
                    <div id="questions-container" class="space-y-4"></div>
                    <button type="button" data-action="add-question" class="text-sm font-medium text-blue-600 p-2 hover:bg-blue-50 rounded-md">+ Add Question</button>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Create Survey</button>
                </form>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <h3 class="text-xl font-semibold text-gray-700 p-6">Existing Surveys</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead>
                    <tbody>${state.surveys.map(s => `<tr><td class="px-6 py-4">${s.title}</td><td class="px-6 py-4">${state.studies.find(study => study.id == s.studyId)?.title || 'N/A'}</td><td class="px-6 py-4"><button data-action="view-survey" data-id="${s.id}" class="text-blue-600 hover:underline">View Survey</button></td></tr>`).join('')}${state.surveys.length === 0 ? `<tr><td colspan="3" class="text-center text-gray-500 py-8">No surveys created yet.</td></tr>` : ''}</tbody>
                </table>
            </div>`;

        const getReportingHTML = () => `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Reporting & Analytics</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Report Filters</h3>
                <form id="report-filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <select name="studyId" class="p-2 border rounded bg-white"><option value="all">All Studies</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select>
                    <select name="siteId" class="p-2 border rounded bg-white"><option value="all">All Sites</option>${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                    <select name="status" class="p-2 border rounded bg-white"><option value="all">All Statuses</option>${['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'].map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                    <input type="text" name="condition" placeholder="Filter by Condition" class="p-2 border rounded"/>
                    <div class="flex items-center gap-2">
                        <input type="number" name="minAge" placeholder="Min Age" class="w-full p-2 border rounded"/>
                        <span>-</span>
                        <input type="number" name="maxAge" placeholder="Max Age" class="w-full p-2 border rounded"/>
                    </div>
                    <input type="date" name="startDate" class="p-2 border rounded"/>
                    <input type="date" name="endDate" class="p-2 border rounded"/>
                    <button type="submit" class="bg-blue-600 text-white rounded-md h-10 col-span-full lg:col-span-1">Generate Report</button>
                </form>
            </div>
            <div id="report-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="flex justify-between items-center p-6">
                    <h3 class="text-xl font-semibold text-gray-700">Report Results</h3>
                    <div class="flex gap-2">
                        <button id="export-csv-btn" data-action="export-csv" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center disabled:bg-gray-400" disabled>
                            <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Report
                        </button>
                        <button id="export-surveys-btn" data-action="export-surveys-csv" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center disabled:bg-gray-400" disabled>
                            <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Survey Results
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Age</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Condition</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Appointment</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Surveys</th>
                            </tr>
                        </thead>
                        <tbody id="report-results-body"><tr><td colspan="8" class="text-center text-gray-500 py-8">Generate a report to see results.</td></tr></tbody>
                    </table>
                </div>
            </div>`;

        const getSchedulingHTML = () => {
             const creatorView = `
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Create Appointment Schedule</h3>
                    <form id="schedule-creator-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Site</label><select name="siteId" required class="mt-1 block w-full p-2 border rounded border-gray-300 bg-white"><option value="">Select a Site</option>${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Study</label><select name="studyId" required class="mt-1 block w-full p-2 border rounded border-gray-300 bg-white"><option value="">Select a Study</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Start Date</label><input type="date" name="startDate" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                            <div><label class="block text-sm font-medium text-gray-700">End Date</label><input type="date" name="endDate" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                        </div>
                        <div><label class="font-medium">Days of the Week</label><div class="flex flex-wrap gap-2 mt-1">${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `<button type="button" data-day="${i}" class="day-btn p-2 rounded border w-12 bg-gray-200">${day}</button>`).join('')}</div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Start Time</label><input type="time" name="startTime" value="09:00" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                            <div><label class="block text-sm font-medium text-gray-700">End Time</label><input type="time" name="endTime" value="17:00" required class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                            <div><label class="block text-sm font-medium text-gray-700">Duration (mins)</label><input type="number" name="duration" value="60" required placeholder="e.g., 60" class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                            <div><label class="block text-sm font-medium text-gray-700">Capacity</label><input type="number" name="capacity" value="1" required placeholder="e.g., 1" class="mt-1 block w-full p-2 border rounded border-gray-300"/></div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Generate Schedule</button>
                    </form>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Generated Schedules</h3>
                    <div id="schedules-list" class="space-y-4">${state.schedules.length === 0 ? '<p class="text-center text-gray-500 py-8">No schedules created yet.</p>' : state.schedules.map(s => {
                        const totalCapacity = s.slots.reduce((sum, slot) => sum + slot.capacity, 0);
                        const totalBooked = s.slots.reduce((sum, slot) => sum + slot.booked, 0);
                        const availableSlots = totalCapacity - totalBooked;
                        return `<div class="p-4 border rounded-lg"><h4 class="font-bold">${state.studies.find(study => study.id == s.studyId)?.title || 'N/A'} at ${state.sites.find(site => site.id == s.siteId)?.name || 'N/A'}</h4><p>${availableSlots} of ${totalCapacity} total slots available.</p></div>`
                    }).join('')}</div>
                </div>
            `;
            const calendarView = `<div id="calendar-container" class="bg-white p-6 rounded-lg shadow-md"></div>`;

            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Scheduling</h2>
                    <div class="flex items-center gap-2">
                        <button data-action="set-scheduling-view" data-view="creator" class="${state.schedulingView === 'creator' ? 'bg-blue-600 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md text-sm font-medium">Creator</button>
                        <button data-action="set-scheduling-view" data-view="calendar" class="${state.schedulingView === 'calendar' ? 'bg-blue-600 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md text-sm font-medium">Calendar View</button>
                    </div>
                </div>
                ${state.schedulingView === 'calendar' ? calendarView : creatorView}
            `;
        };
        
        // --- MODAL HTML GETTERS ---
        const getPatientProfileHTML = (patient) => {
            if (!patient) return `<h2>Patient not found</h2>`;
            const study = state.studies.find(s => s.id === patient.studyId);
            const site = state.sites.find(s => s.id === patient.siteId);
            
            let surveyResultsHTML = '<p class="text-gray-500">No survey results found.</p>';
            if (patient.surveyResults && patient.surveyResults.length > 0) {
                surveyResultsHTML = patient.surveyResults.map(result => `
                    <div class="mt-4 p-3 border rounded-lg">
                        <h4 class="font-semibold">${result.surveyTitle}</h4>
                        <p class="text-sm text-gray-500 mb-2">Completed on: ${new Date(result.completedAt).toLocaleString()}</p>
                        <ul class="list-disc pl-5 text-sm">
                            ${result.answers.map(ans => `<li><strong>${ans.question}</strong>: ${ans.answer}</li>`).join('')}
                        </ul>
                    </div>
                `).join('');
            }

            let appointmentHTML = '<p><strong>Appointment:</strong> Not Scheduled</p>';
            if (patient.appointment) {
                appointmentHTML = `
                    <p><strong>Appointment:</strong> ${new Date(patient.appointment.time).toLocaleString()}</p>
                    <div class="flex gap-2 mt-2">
                        <button data-action="change-appointment" data-patient-id="${patient.id}" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Change</button>
                        <button data-action="cancel-appointment" data-patient-id="${patient.id}" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Cancel</button>
                    </div>
                `;
            }

            return `
                <h2 class="text-2xl font-bold mb-4">${patient.name}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-2 border-b pb-1">Patient Details</h3>
                        <div class="space-y-2">
                            <p><strong>Age:</strong> ${patient.age || 'N/A'}</p>
                            <p><strong>Condition:</strong> ${patient.condition || 'N/A'}</p>
                            <p><strong>Status:</strong> ${patient.status || 'N/A'}</p>
                            <p><strong>Assigned Study:</strong> ${study?.title || 'N/A'}</p>
                            <p><strong>Assigned Site:</strong> ${site?.name || 'N/A'}</p>
                            ${appointmentHTML}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2 border-b pb-1">Survey History</h3>
                        ${surveyResultsHTML}
                    </div>
                </div>
            `;
        };

        const getBookingModalHTML = (patient) => {
             if (!patient) return `<h2>Patient not found</h2>`;
             const availableSchedules = state.schedules.filter(s => s.siteId === patient.siteId && s.studyId === patient.studyId);
             if (availableSchedules.length === 0) {
                 return `
                    <h2 class="text-2xl font-bold mb-4">Schedule for ${patient.name}</h2>
                    <p class="text-red-500">No available schedules match the patient's assigned site and study.</p>
                 `;
             }
             let slotsHTML = '';
             availableSchedules.forEach(schedule => {
                 const availableSlots = schedule.slots.filter(slot => slot.booked < slot.capacity);
                 if (availableSlots.length > 0) {
                     slotsHTML += `<h4 class="font-semibold mt-4 mb-2">Available Slots:</h4>`;
                     slotsHTML += availableSlots.map(slot => `
                        <button data-action="book-appointment" data-patient-id="${patient.id}" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="w-full text-left p-2 border rounded hover:bg-gray-100 mb-2">
                            ${new Date(slot.startTime).toLocaleString()}
                        </button>
                     `).join('');
                 }
             });

             if (slotsHTML === '') {
                 slotsHTML = `<p class="text-yellow-600 mt-4">All slots for this patient's study and site are fully booked.</p>`;
             }

             return `
                <h2 class="text-2xl font-bold mb-4">Schedule for ${patient.name}</h2>
                <p><strong>Study:</strong> ${state.studies.find(s => s.id === patient.studyId)?.title}</p>
                <p><strong>Site:</strong> ${state.sites.find(s => s.id === patient.siteId)?.name}</p>
                ${slotsHTML}
             `;
        };

        const getQuickAddPatientHTML = () => {
             return `
                <h2 class="text-2xl font-bold mb-4">Quick Add Patient</h2>
                <form id="quick-add-patient-form" class="space-y-4">
                    <div><label class="block text-sm font-medium">Full Name</label><input type="text" name="name" required class="mt-1 w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-medium">Age</label><input type="number" name="age" class="mt-1 w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-medium">Condition</label><input type="text" name="condition" class="mt-1 w-full p-2 border rounded"></div>
                    <div>
                        <label class="block text-sm font-medium">Status</label>
                        <select name="status" class="mt-1 w-full p-2 border rounded bg-white">
                            <option>Candidate</option>
                            <option>Enrolled</option>
                            <option>Pre-Screening</option>
                            <option>Screen Fail</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium">Assign to Study</label><select name="studyId" class="mt-1 w-full p-2 border rounded bg-white"><option value="">None</option>${state.studies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium">Assign to Site</label><select name="siteId" class="mt-1 w-full p-2 border rounded bg-white"><option value="">None</option>${state.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Add Patient</button>
                </form>
             `;
        };
        
        const getCreateStudyModalHTML = () => {
            return `
                <h2 class="text-2xl font-bold mb-4">Create New Clinical Study</h2>
                <form id="create-study-form" class="space-y-4">
                    <div><label class="block text-sm font-medium">Study Title</label><input type="text" name="title" required class="mt-1 w-full p-2 border rounded" placeholder="e.g., Phase 3 Aspirin Trial"></div>
                    <div><label class="block text-sm font-medium">Status</label><select name="status" class="mt-1 w-full p-2 border rounded bg-white"><option>Recruiting</option><option>Enrolling</option><option>Active</option><option>Closed</option></select></div>
                    <div><label class="block text-sm font-medium">Enrollment Target</label><input type="number" name="target" required class="mt-1 w-full p-2 border rounded" placeholder="e.g., 100"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Create Study</button>
                </form>
            `;
        };

        const getEditStudyModalHTML = (study) => {
            return `
                <h2 class="text-2xl font-bold mb-4">Edit Clinical Study</h2>
                <form id="edit-study-form" data-id="${study.id}" class="space-y-4">
                    <div><label class="block text-sm font-medium">Study Title</label><input type="text" name="title" required class="mt-1 w-full p-2 border rounded" value="${study.title}"></div>
                    <div><label class="block text-sm font-medium">Status</label><select name="status" class="mt-1 w-full p-2 border rounded bg-white">${['Recruiting', 'Enrolling', 'Active', 'Closed'].map(s => `<option ${study.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium">Enrollment Target</label><input type="number" name="target" required class="mt-1 w-full p-2 border rounded" value="${study.target}"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                </form>
            `;
        };

        const getEditSiteModalHTML = (site) => {
            return `
                <h2 class="text-2xl font-bold mb-4">Edit Site</h2>
                <form id="edit-site-form" data-id="${site.id}" class="space-y-4">
                    <div><label class="block text-sm font-medium">Site Name</label><input type="text" name="name" required class="mt-1 w-full p-2 border rounded" value="${site.name}"></div>
                    <div><label class="block text-sm font-medium">Location</label><input type="text" name="location" required class="mt-1 w-full p-2 border rounded" value="${site.location}"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                </form>
            `;
        };

        const getEditPatientModalHTML = (patient) => {
             const statuses = ['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'];
             return `
                <h2 class="text-2xl font-bold mb-4">Edit Patient</h2>
                <form id="edit-patient-form" data-id="${patient.id}" class="space-y-4">
                    <div><label class="block text-sm font-medium">Full Name</label><input type="text" name="name" required class="mt-1 w-full p-2 border rounded" value="${patient.name}"></div>
                    <div><label class="block text-sm font-medium">Age</label><input type="number" name="age" class="mt-1 w-full p-2 border rounded" value="${patient.age || ''}"></div>
                    <div><label class="block text-sm font-medium">Condition</label><input type="text" name="condition" class="mt-1 w-full p-2 border rounded" value="${patient.condition || ''}"></div>
                    <div>
                        <label class="block text-sm font-medium">Status</label>
                        <select name="status" class="mt-1 w-full p-2 border rounded bg-white">
                            ${statuses.map(s => `<option ${patient.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium">Assign to Study</label><select name="studyId" class="mt-1 w-full p-2 border rounded bg-white"><option value="">None</option>${state.studies.map(s => `<option value="${s.id}" ${patient.studyId === s.id ? 'selected' : ''}>${s.title}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium">Assign to Site</label><select name="siteId" class="mt-1 w-full p-2 border rounded bg-white"><option value="">None</option>${state.sites.map(s => `<option value="${s.id}" ${patient.siteId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}</select></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                </form>
             `;
        };

        const getAppointmentDetailsModalHTML = (schedule, slot) => {
            const scheduledPatients = state.patients.filter(p => p.appointment && p.appointment.slotId === slot.id);
            const study = state.studies.find(s => s.id === schedule.studyId);

            return `
                <h2 class="text-2xl font-bold mb-2">Appointment Details</h2>
                <p class="text-gray-600 mb-4">${new Date(slot.startTime).toLocaleString()}</p>
                <p><strong>Study:</strong> ${study?.title || 'N/A'}</p>
                
                <form id="update-capacity-form" data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="my-4 flex items-end gap-2">
                    <div>
                        <label for="capacity" class="block text-sm font-medium">Capacity</label>
                        <input type="number" name="capacity" class="w-24 p-2 border rounded" value="${slot.capacity}">
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm">Update</button>
                </form>

                <h3 class="font-semibold mt-6 mb-2">Scheduled Participants (${scheduledPatients.length}/${slot.capacity})</h3>
                ${scheduledPatients.length > 0 ? `
                    <ul class="list-disc pl-5">
                        ${scheduledPatients.map(p => `<li>${p.name}</li>`).join('')}
                    </ul>
                ` : '<p class="text-gray-500">No participants scheduled for this slot.</p>'}
            `;
        };

        const getViewSurveyModalHTML = (survey) => {
            if (!survey) return `<h2>Survey not found</h2>`;
            const study = state.studies.find(s => s.id === survey.studyId);
            let questionsHTML = survey.questions.map((q, index) => {
                let optionsHTML = q.options.map(opt => `
                    <li class="ml-4 list-disc">
                        ${opt.text} &rarr; (Next: ${opt.next})
                    </li>
                `).join('');
                return `
                    <div class="mt-4 p-2 border-t">
                        <p class="font-semibold">Q${index + 1}: ${q.text}</p>
                        <ul class="mt-1">
                            ${optionsHTML}
                        </ul>
                    </div>
                `;
            }).join('');

            return `
                <h2 class="text-2xl font-bold mb-2">${survey.title}</h2>
                <p class="text-sm text-gray-600 mb-4">For Study: ${study?.title || 'N/A'}</p>
                <div>${questionsHTML}</div>
            `;
        };
        
        const getSelectSurveyModalHTML = (patient) => {
            const availableSurveys = state.surveys.filter(s => s.studyId === patient.studyId);
            if (availableSurveys.length === 0) {
                return `<h2 class="text-2xl font-bold mb-4">Survey ${patient.name}</h2><p>No surveys available for the patient's assigned study.</p>`;
            }
            return `
                <h2 class="text-2xl font-bold mb-4">Select Survey for ${patient.name}</h2>
                <div class="space-y-2">
                    ${availableSurveys.map(s => `<button data-action="start-survey" data-patient-id="${patient.id}" data-survey-id="${s.id}" class="w-full text-left p-3 border rounded-md hover:bg-gray-100">${s.title}</button>`).join('')}
                </div>
            `;
        };

        const getTakeSurveyModalHTML = () => {
            const { survey, patient, currentQuestionIndex, answers } = state.currentSurveyState;
            const question = survey.questions[currentQuestionIndex];
            
            return `
                <h2 class="text-2xl font-bold mb-2">${survey.title}</h2>
                <p class="text-sm text-gray-600 mb-6">Question ${currentQuestionIndex + 1} of ${survey.questions.length}</p>
                <form id="take-survey-form">
                    <p class="text-lg font-semibold mb-4">${question.text}</p>
                    <div class="space-y-3">
                        ${question.options.map((opt, index) => `
                            <div>
                                <input type="radio" id="option-${index}" name="answer" value="${opt.text}" data-next="${opt.next}" required class="mr-2">
                                <label for="option-${index}">${opt.text}</label>
                            </div>
                        `).join('')}
                    </div>
                    <button type="submit" class="mt-8 w-full bg-blue-600 text-white py-2 rounded-md">Next</button>
                </form>
            `;
        };
        
        const getViewStudyPatientsModalHTML = (study) => {
            if (!study) return `<h2>Study not found</h2>`;
            const studyPatients = state.patients.filter(p => p.studyId === study.id);

            let patientsHTML = `<p class="text-gray-500">No patients are currently assigned to this study.</p>`;
            if (studyPatients.length > 0) {
                patientsHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Appointment</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${studyPatients.map(p => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 hover:underline">${p.name}</button></td>
                                    <td class="px-6 py-4 whitespace-nowrap">${p.status}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${p.appointment ? new Date(p.appointment.time).toLocaleString() : 'Not Scheduled'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            return `
                <h2 class="text-2xl font-bold mb-4">Patients in: ${study.title}</h2>
                ${patientsHTML}
            `;
        };

        // --- APPOINTMENT UTILITIES ---
        const cancelAppointment = async (patientId) => {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient || !patient.appointment) return;

            const { scheduleId, slotId } = patient.appointment;
            const schedule = state.schedules.find(s => s.id === scheduleId);
            if (!schedule) return;

            const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
            if (slotIndex > -1 && schedule.slots[slotIndex].booked > 0) {
                schedule.slots[slotIndex].booked -= 1;
                const scheduleRef = doc(db, "schedules", scheduleId);
                await updateDoc(scheduleRef, { slots: schedule.slots });
            }

            const studyRef = doc(db, "studies", patient.studyId);
            await updateDoc(studyRef, { enrolled: increment(-1) });

            const patientRef = doc(db, "patients", patientId);
            await updateDoc(patientRef, { appointment: null });
        };


        // --- EVENT HANDLERS ---
        document.addEventListener('click', async (e) => {
            const navButton = e.target.closest('.nav-item');
            if (navButton) setState({ activeTab: navButton.dataset.tab });

            const dayButton = e.target.closest('.day-btn');
            if (dayButton) {
                dayButton.classList.toggle('bg-blue-500');
                dayButton.classList.toggle('text-white');
                dayButton.classList.toggle('bg-gray-200');
            }
            
            const appointmentSlot = e.target.closest('.appointment-slot');
            if (appointmentSlot) {
                const { scheduleId, slotId } = appointmentSlot.dataset;
                const schedule = state.schedules.find(s => s.id === scheduleId);
                const slot = schedule.slots.find(s => s.id === slotId);
                openModal(getAppointmentDetailsModalHTML(schedule, slot));
            }

            const actionButton = e.target.closest('button[data-action]');
            if (actionButton) {
                const { action, id, view, patientId, surveyId, qId } = actionButton.dataset;
                switch (action) {
                    case 'close-modal': closeModal(); break;
                    case 'create-study-modal': openModal(getCreateStudyModalHTML()); break;
                    case 'set-scheduling-view': setState({ schedulingView: view }); break;
                    case 'prev-month': state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); render(); break;
                    case 'next-month': state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); render(); break;
                    case 'view-patient': openModal(getPatientProfileHTML(state.patients.find(p => p.id === id)), true); break;
                    case 'view-study-patients': openModal(getViewStudyPatientsModalHTML(state.studies.find(s => s.id === id)), true); break;
                    case 'edit-patient': openModal(getEditPatientModalHTML(state.patients.find(p => p.id === id))); break;
                    case 'edit-study': openModal(getEditStudyModalHTML(state.studies.find(s => s.id === id))); break;
                    case 'edit-site': openModal(getEditSiteModalHTML(state.sites.find(s => s.id === id))); break;
                    case 'schedule-patient': openModal(getBookingModalHTML(state.patients.find(p => p.id === id))); break;
                    case 'survey-patient': openModal(getSelectSurveyModalHTML(state.patients.find(p => p.id === id))); break;
                    case 'cancel-appointment': 
                        await cancelAppointment(patientId);
                        closeModal();
                        break;
                    case 'change-appointment':
                        await cancelAppointment(patientId);
                        openModal(getBookingModalHTML(state.patients.find(p => p.id === patientId)));
                        break;
                    case 'start-survey': {
                        state.currentSurveyState = {
                            patient: state.patients.find(p => p.id === patientId),
                            survey: state.surveys.find(s => s.id === surveyId),
                            currentQuestionIndex: 0,
                            answers: []
                        };
                        openModal(getTakeSurveyModalHTML());
                        break;
                    }
                    case 'book-appointment': {
                        const { patientId, scheduleId, slotId } = actionButton.dataset;
                        const patient = state.patients.find(p => p.id === patientId);
                        const schedule = state.schedules.find(s => s.id === scheduleId);
                        const slot = schedule.slots.find(s => s.id === slotId);
                        slot.booked += 1;
                        
                        const scheduleRef = doc(db, "schedules", scheduleId);
                        await updateDoc(scheduleRef, { slots: schedule.slots });

                        const patientRef = doc(db, "patients", patientId);
                        await updateDoc(patientRef, { appointment: { scheduleId, slotId, time: slot.startTime } });

                        const studyRef = doc(db, "studies", patient.studyId);
                        await updateDoc(studyRef, { enrolled: increment(1) });

                        closeModal();
                        break;
                    }
                    case 'quick-add-patient-modal': openModal(getQuickAddPatientHTML()); break;
                    case 'add-question': addQuestionToSurveyForm(); break;
                    case 'add-option': addOptionToQuestion(actionButton.dataset.qId); break;
                    case 'remove-question': 
                        document.getElementById(qId).remove();
                        updateBranchingLogicDropdowns();
                        break;
                    case 'remove-option': 
                        actionButton.parentElement.remove();
                        break;
                    case 'view-survey': openModal(getViewSurveyModalHTML(state.surveys.find(s => s.id === id))); break;
                    case 'export-csv': exportToCSV(); break;
                    case 'export-surveys-csv': exportSurveysToCSV(); break;
                }
            }
        });
        
        document.addEventListener('input', (e) => {
            if (e.target.id === 'patient-search') {
                state.patientSearchTerm = e.target.value;
                renderPatientTable();
            }
        });

        document.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const getCollectionRef = (name) => collection(db, name);

            switch (form.id) {
                case 'take-survey-form': {
                    const { survey, patient, currentQuestionIndex, answers } = state.currentSurveyState;
                    const question = survey.questions[currentQuestionIndex];
                    const selectedOption = form.querySelector('input[name="answer"]:checked');
                    const answer = selectedOption.value;
                    const nextQuestionTarget = selectedOption.dataset.next;

                    answers.push({ question: question.text, answer });

                    if (nextQuestionTarget.toLowerCase() === 'submit' || answers.length === survey.questions.length) {
                        // Survey finished, save results
                        const surveyResult = {
                            surveyId: survey.id,
                            surveyTitle: survey.title,
                            completedAt: new Date().toISOString(),
                            answers: answers
                        };
                        const patientRef = doc(db, "patients", patient.id);
                        await updateDoc(patientRef, {
                            surveyResults: arrayUnion(surveyResult)
                        });
                        closeModal();
                    } else {
                        // Go to next question
                        const nextIndex = parseInt(nextQuestionTarget) - 1;
                        state.currentSurveyState.currentQuestionIndex = nextIndex;
                        openModal(getTakeSurveyModalHTML());
                    }
                    break;
                }
                case 'update-capacity-form': {
                    const { scheduleId, slotId } = form.dataset;
                    const newCapacity = parseInt(data.capacity);
                    const schedule = state.schedules.find(s => s.id === scheduleId);
                    const slotIndex = schedule.slots.findIndex(s => s.id === slotId);
                    if (slotIndex > -1) {
                        schedule.slots[slotIndex].capacity = newCapacity;
                        await updateDoc(doc(db, "schedules", scheduleId), { slots: schedule.slots });
                    }
                    closeModal();
                    break;
                }
                case 'edit-patient-form': {
                    const patientId = form.dataset.id;
                    const updatedPatient = {
                        name: data.name,
                        age: data.age ? parseInt(data.age) : null,
                        condition: data.condition,
                        status: data.status,
                        studyId: data.studyId || null,
                        siteId: data.siteId || null,
                    };
                    await updateDoc(doc(db, "patients", patientId), updatedPatient);
                    closeModal();
                    break;
                }
                case 'edit-study-form': {
                    const studyId = form.dataset.id;
                    const updatedStudy = {
                        title: data.title,
                        status: data.status,
                        target: parseInt(data.target)
                    };
                    await updateDoc(doc(db, "studies", studyId), updatedStudy);
                    closeModal();
                    break;
                }
                 case 'edit-site-form': {
                    const siteId = form.dataset.id;
                    const updatedSite = { name: data.name, location: data.location };
                    await updateDoc(doc(db, "sites", siteId), updatedSite);
                    closeModal();
                    break;
                }
                case 'create-study-form': {
                    const newStudy = { title: data.title, status: data.status, target: parseInt(data.target), enrolled: 0 };
                    await addDoc(getCollectionRef("studies"), newStudy);
                    closeModal();
                    break;
                }
                case 'schedule-creator-form': {
                    const days = {};
                    form.querySelectorAll('.day-btn.bg-blue-500').forEach(btn => { days[btn.dataset.day] = true; });
                    
                    let slots = [];
                    let currentDate = new Date(data.startDate + 'T00:00:00');
                    const finalDate = new Date(data.endDate + 'T00:00:00');

                    while (currentDate <= finalDate) {
                        if (days[currentDate.getDay()]) {
                            const [startHour, startMinute] = data.startTime.split(':').map(Number);
                            const [endHour, endMinute] = data.endTime.split(':').map(Number);
                            let slotTime = new Date(currentDate);
                            slotTime.setHours(startHour, startMinute, 0, 0);
                            const endSlotTime = new Date(currentDate);
                            endSlotTime.setHours(endHour, endMinute, 0, 0);

                            while (slotTime < endSlotTime) {
                                slots.push({ id: `slot-${Date.now()}-${Math.random()}`, startTime: slotTime.toISOString(), booked: 0, capacity: parseInt(data.capacity) });
                                slotTime.setMinutes(slotTime.getMinutes() + parseInt(data.duration));
                            }
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    const newSchedule = { siteId: data.siteId, studyId: data.studyId, slots: slots };
                    await addDoc(getCollectionRef("schedules"), newSchedule);
                    form.reset();
                    break;
                }
                case 'add-site-form': {
                    const newSite = { name: data.siteName, location: data.siteLocation };
                    await addDoc(getCollectionRef("sites"), newSite);
                    form.reset();
                    break;
                }
                case 'quick-add-patient-form': {
                    const newPatient = {
                        name: data.name,
                        age: data.age ? parseInt(data.age) : null,
                        condition: data.condition,
                        status: data.status,
                        studyId: data.studyId || null,
                        siteId: data.siteId || null,
                        appointment: null,
                    };
                    await addDoc(getCollectionRef("patients"), newPatient);
                    closeModal();
                    break;
                }
                case 'survey-creator-form': {
                    const questions = [];
                    const questionElements = form.querySelectorAll('#questions-container > div');
                    questionElements.forEach((qEl, index) => {
                        const qId = qEl.id;
                        const text = form.querySelector(`input[name="${qId}-text"]`).value;
                        const options = [];
                        qEl.querySelectorAll(`div[data-options-for="${qId}"] > div`).forEach(optEl => {
                            options.push({
                                text: optEl.querySelector(`input[name="${qId}-option-text"]`).value,
                                next: optEl.querySelector(`select[name="${qId}-option-next"]`).value,
                            });
                        });
                        questions.push({ id: index + 1, text, options });
                    });
                    const newSurvey = { title: data.title, studyId: data.studyId, questions };
                    await addDoc(getCollectionRef("surveys"), newSurvey);
                    form.reset();
                    addQuestionToSurveyForm(); 
                    break;
                }
                case 'report-filter-form': {
                    let q = collection(db, "patients");
                    const constraints = [];
                    if (data.studyId !== 'all') constraints.push(where("studyId", "==", data.studyId));
                    if (data.siteId !== 'all') constraints.push(where("siteId", "==", data.siteId));
                    if (data.status !== 'all') constraints.push(where("status", "==", data.status));
                    if (data.condition) constraints.push(where("condition", "==", data.condition));
                    if (data.minAge) constraints.push(where("age", ">=", parseInt(data.minAge)));
                    if (data.maxAge) constraints.push(where("age", "<=", parseInt(data.maxAge)));
                    
                    if (constraints.length > 0) {
                        q = query(q, ...constraints);
                    }

                    const querySnapshot = await getDocs(q);
                    let filteredPatients = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                    if (data.startDate) filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) >= new Date(data.startDate));
                    if (data.endDate) filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) <= new Date(data.endDate));
                    
                    state.lastReportData = filteredPatients; // Save for CSV export
                    const exportBtn = document.getElementById('export-csv-btn');
                    const exportSurveysBtn = document.getElementById('export-surveys-btn');

                    const resultsBody = document.getElementById('report-results-body');
                    if(filteredPatients.length > 0) {
                        resultsBody.innerHTML = filteredPatients.map(p => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">${p.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${p.age || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${p.condition || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${p.status || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${state.studies.find(s => s.id === p.studyId)?.title || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${state.sites.find(s => s.id === p.siteId)?.name || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${p.appointment ? new Date(p.appointment.time).toLocaleString() : 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap"><button data-action="view-patient" data-id="${p.id}" class="text-blue-600 hover:underline">View Surveys (${p.surveyResults?.length || 0})</button></td>
                            </tr>
                        `).join('');
                        if (exportBtn) exportBtn.disabled = false;
                        if (exportSurveysBtn) exportSurveysBtn.disabled = false;
                    } else {
                        resultsBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-8">No patients match the selected criteria.</td></tr>`;
                        if (exportBtn) exportBtn.disabled = true;
                        if (exportSurveysBtn) exportSurveysBtn.disabled = true;
                    }

                    // Calculate and display metrics
                    const metricsContainer = document.getElementById('report-metrics');
                    const total = filteredPatients.length;
                    const avgAge = total > 0 ? (filteredPatients.reduce((sum, p) => sum + (p.age || 0), 0) / filteredPatients.filter(p => p.age).length).toFixed(1) : 'N/A';
                    const scheduled = filteredPatients.filter(p => p.appointment).length;
                    metricsContainer.innerHTML = `
                        <div class="bg-white p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500">Total Patients</p><p class="text-2xl font-bold">${total}</p></div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500">Average Age</p><p class="text-2xl font-bold">${avgAge}</p></div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500">Scheduled</p><p class="text-2xl font-bold">${scheduled}</p></div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500">Not Scheduled</p><p class="text-2xl font-bold">${total - scheduled}</p></div>
                    `;
                    lucide.createIcons();
                    break;
                }
            }
        });

        // --- SURVEY LOGIC ---
        const updateBranchingLogicDropdowns = () => {
            const questionsContainer = document.getElementById('questions-container');
            if (!questionsContainer) return;
            const questionElements = questionsContainer.querySelectorAll('.question-block');
            const options = Array.from(questionElements).map((el, index) => {
                return { value: index + 1, text: `Question ${index + 1}` };
            });

            const allDropdowns = questionsContainer.querySelectorAll('select[name$="-option-next"]');
            allDropdowns.forEach(dropdown => {
                const currentValue = dropdown.value;
                dropdown.innerHTML = `<option value="submit">Submit</option>`;
                options.forEach(opt => {
                    dropdown.innerHTML += `<option value="${opt.value}" ${currentValue == opt.value ? 'selected' : ''}>${opt.text}</option>`;
                });
            });
        };

        const addQuestionToSurveyForm = () => {
            const container = document.getElementById('questions-container');
            if (!container) return;
            const qId = `q-${Date.now()}`;
            const questionIndex = container.children.length + 1;
            const questionHTML = `
                <div id="${qId}" class="p-4 border rounded-lg bg-gray-50 relative question-block">
                    <button type="button" data-action="remove-question" data-q-id="${qId}" class="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
                    <label class="font-medium">Question ${questionIndex}</label>
                    <input type="text" name="${qId}-text" class="w-full p-2 border rounded" placeholder="Question Text" required/>
                    <div class="mt-2 space-y-2 pl-4" data-options-for="${qId}">
                        <label class="text-sm font-medium text-gray-600">Options</label>
                    </div>
                    <button type="button" data-action="add-option" data-q-id="${qId}" class="text-sm text-blue-600 hover:underline mt-2">+ Add Option</button>
                </div>`;
            container.insertAdjacentHTML('beforeend', questionHTML);
            addOptionToQuestion(qId);
            updateBranchingLogicDropdowns();
            lucide.createIcons();
        };

        const addOptionToQuestion = (qId) => {
            const optionsContainer = document.querySelector(`div[data-options-for="${qId}"]`);
            if (!optionsContainer) return;
            const optionHTML = `
                <div class="flex items-center gap-2">
                    <input type="text" name="${qId}-option-text" class="flex-grow p-2 border rounded" placeholder="Option Text" required/>
                    <select name="${qId}-option-next" class="w-48 p-2 border rounded bg-white"></select>
                    <button type="button" data-action="remove-option" class="p-1 text-red-500 hover:bg-red-100 rounded-full"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                </div>`;
            optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
            updateBranchingLogicDropdowns();
            lucide.createIcons();
        };

        // --- CALENDAR LOGIC ---
        const renderCalendar = () => {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            const date = state.calendarDate;
            const month = date.getMonth();
            const year = date.getFullYear();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            const monthName = date.toLocaleString('default', { month: 'long' });

            let calendarHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button data-action="prev-month" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="chevron-left"></i></button>
                    <h3 class="text-xl font-semibold">${monthName} ${year}</h3>
                    <button data-action="next-month" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<div class="text-center font-semibold text-sm py-2 bg-gray-50">${day}</div>`).join('')}
            `;
            
            for (let i = 0; i < startDayOfWeek; i++) {
                calendarHTML += `<div class="bg-gray-50"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateString = currentDate.toISOString().split('T')[0];
                
                let appointmentsHTML = '';
                state.schedules.forEach(schedule => {
                    schedule.slots.forEach(slot => {
                        const slotDate = new Date(slot.startTime);
                        if (slotDate.toISOString().split('T')[0] === dateString) {
                            const study = state.studies.find(s => s.id === schedule.studyId);
                            const isFull = slot.booked >= slot.capacity;
                            appointmentsHTML += `
                                <div data-schedule-id="${schedule.id}" data-slot-id="${slot.id}" class="appointment-slot p-1.5 mb-1 rounded-md text-xs cursor-pointer ${isFull ? 'bg-red-200' : 'bg-blue-100 hover:bg-blue-200'}">
                                    <p class="font-semibold truncate">${study?.title || 'No Title'}</p>
                                    <p>${slotDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${slot.booked}/${slot.capacity})</p>
                                </div>
                            `;
                        }
                    });
                });

                calendarHTML += `
                    <div class="calendar-day p-2 bg-white relative">
                        <span class="font-medium text-gray-800">${day}</span>
                        <div class="mt-2 overflow-y-auto max-h-24">${appointmentsHTML}</div>
                    </div>
                `;
            }
            calendarHTML += `</div>`;
            container.innerHTML = calendarHTML;
            lucide.createIcons();
        };
        
        // --- REPORTING UTILITIES ---
        const exportToCSV = () => {
            const patients = state.lastReportData;
            if (!patients || patients.length === 0) return;

            const headers = [
                "PatientID", "PatientName", "Age", "Condition", "Status", 
                "StudyTitle", "SiteName", "AppointmentDate", "SurveyResults"
            ];

            const csvRows = [headers.join(',')];

            for (const p of patients) {
                const patientId = p.id;
                const patientName = `"${p.name}"`;
                const age = p.age || '';
                const condition = `"${p.condition || ''}"`;
                const status = p.status || '';
                const studyTitle = `"${state.studies.find(s => s.id === p.studyId)?.title || 'N/A'}"`;
                const siteName = `"${state.sites.find(s => s.id === p.siteId)?.name || 'N/A'}"`;
                const appointmentDate = p.appointment ? new Date(p.appointment.time).toISOString() : '';
                
                let surveyData = '';
                if (p.surveyResults && p.surveyResults.length > 0) {
                    surveyData = p.surveyResults.map(res => {
                        const answers = res.answers.map(a => `${a.question.replace(/"/g, '""')}: ${a.answer.replace(/"/g, '""')}`).join('; ');
                        return `Survey: ${res.surveyTitle.replace(/"/g, '""')} (${new Date(res.completedAt).toLocaleDateString()}) -> ${answers}`;
                    }).join(' | ');
                }
                
                csvRows.push([
                    patientId, patientName, age, condition, status, studyTitle, 
                    siteName, appointmentDate, `"${surveyData.replace(/"/g, '""')}"`
                ].join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `report_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        const exportSurveysToCSV = () => {
            const patients = state.lastReportData;
            if (!patients || patients.length === 0) return;

            const headers = ["PatientID", "PatientName", "SurveyTitle", "CompletionDate", "Question", "Answer"];
            const csvRows = [headers.join(',')];

            for (const p of patients) {
                if (p.surveyResults && p.surveyResults.length > 0) {
                    for (const result of p.surveyResults) {
                        for (const answer of result.answers) {
                            csvRows.push([
                                p.id,
                                `"${p.name}"`,
                                `"${result.surveyTitle.replace(/"/g, '""')}"`,
                                new Date(result.completedAt).toISOString(),
                                `"${answer.question.replace(/"/g, '""')}"`,
                                `"${answer.answer.replace(/"/g, '""')}"`
                            ].join(','));
                        }
                    }
                }
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `survey_results_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- FIREBASE DATA INTERACTIONS ---
        const setupRealtimeListeners = (userId) => {
            const collections = ["studies", "patients", "sites", "schedules", "surveys"];
            collections.forEach(colName => {
                const collectionRef = collection(db, colName);
                onSnapshot(collectionRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (data.length > 0 && data[0].name) data.sort((a, b) => a.name.localeCompare(b.name));
                    else if (data.length > 0 && data[0].title) data.sort((a, b) => a.title.localeCompare(b.title));
                    
                    state[colName] = data;
                    render();
                }, (error) => {
                    console.error(`Error listening to ${colName}:`, error);
                });
            });
        };

        // --- INITIALIZATION ---
        const init = async () => {
            document.getElementById('logo-container').innerHTML = `
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <circle cx="50" cy="50" r="48" fill="#3B82F6" />
                        <path d="M 5,60 C 40,85 60,85 95,60" stroke="#EF4444" strokeWidth="12" fill="none" strokeLinecap="round"/>
                        <circle cx="50" cy="50" r="22" fill="#1F2937" />
                        <circle cx="59" cy="41" r="7" fill="white" />
                    </g>
                </svg>`;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (!state.authReady) {
                        state.userId = user.uid;
                        state.authReady = true;
                        setupRealtimeListeners(user.uid);
                    }
                } else {
                    state.authReady = false;
                    state.userId = null;
                    setState({ patients: [], sites: [], studies: [], schedules: [], surveys: [] });
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                let errorMessage = "Error: Could not authenticate with the server. Please refresh the page.";
                if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = `<div class='text-center'><h3 class='font-bold text-lg'>Authentication Error</h3><p class='mt-2'>Anonymous sign-in is not enabled for this project.</p><p class='mt-4 text-sm text-gray-600'><strong>Action Required:</strong> Go to your Firebase project's Authentication settings, select the "Sign-in method" tab, and enable the "Anonymous" provider.</p></div>`;
                }
                mainContent.innerHTML = `<div class="p-4 bg-red-100 rounded-md text-red-700">${errorMessage}</div>`;
            }
        };

        window.onload = init;

    </script>
</body>
</html>
