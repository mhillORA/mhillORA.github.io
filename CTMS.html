<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Trial Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply base font to the body */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style for the study cards to give them a modern look */
        .study-card {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }

        .study-card:hover {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        /* Custom styles for modal transitions */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-content {
            background-color: white;
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            width: 100%;
            max-width: 32rem; /* 512px for study modal */
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .import-modal-content {
             max-width: 48rem; /* 768px for import modal */
        }
        
        .site-modal-content {
            max-width: 48rem; /* 768px for site modal */
        }

        .confirm-modal-content {
            max-width: 28rem; /* 448px for confirm modal */
        }
        
        .progress-bar {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            background-color: #4f46e5; /* indigo-600 */
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <div id="app-container">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 1.5m1-1.5l1 1.5m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605" />
                    </svg>
                    <span class="ml-2">Clinical Trial Management System</span>
                </h1>
                <div id="header-buttons">
                    <!-- Header buttons will be rendered here -->
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div id="main-content-area">
                <!-- Content will be injected here -->
            </div>
            <div id="loading-indicator" class="flex items-center justify-center h-screen">
                <div class="text-xl font-semibold">Loading CTMS Dashboard...</div>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, writeBatch, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        // FIX: Reverted to the user's original Firebase configuration.
        // This connects the application directly to their personal Firebase project.
        const firebaseConfig = {
            apiKey: "AIzaSyBiXVUUzeLT3mae0N6sdjICdevmRicdk5g",
            authDomain: "nasa2-0.firebaseapp.com",
            projectId: "nasa2-0",
            storageBucket: "nasa2-0.appspot.com",
            messagingSenderId: "735088252433",
            appId: "1:735088252433:web:1b6733520226e27f5843b0",
            measurementId: "G-SNHQZXKCL4"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);


        // --- DOM Elements ---
        const mainContentArea = document.getElementById('main-content-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const modalContainer = document.getElementById('modal-container');
        const headerButtons = document.getElementById('header-buttons');

        // --- Global State ---
        let allStudies = [];
        let allSites = [];
        let allPatients = [];
        let user = null;
        let activeTab = 'dashboard'; // 'dashboard', 'studies', 'sites', or 'reporting'
        const indicationOptions = [...new Set([
            "Allergy", "Blepharitis", "Dry Eye", "Glaucoma", "AMD (Wet/Dry)", "Anterior Uveitis", 
            "Cataracts", "Cataract Surgical", "Choroideremia", "Contact Lenses", "Corneal Disorders", 
            "Diabetic Macular Edema", "Diabetic Retinopathy", "Diagnostic Equipment", "Dry Eye Device", 
            "Eyelid Disorders", "Eye Redness", "Food Allergy", "Geographic Atrophy", "Glaucoma Devices", 
            "Glaucoma - IOP", "Glaucoma - Neuroprotection", "Infectious Conjunctivitis", "IRD", "IRD Devices", 
            "Keratoconus", "Neuromuscular Eye Disorders", "Neurotrophic Keratitis", "Ocular Allergy", 
            "Ocular Graft Versus Host Disease", "Ocular Melanoma", "Ocular PK", "Other Ocular Uveitis", 
            "Other Ophthalmic Surgery", "Posterior Uveitis", "Refractive - Hyperopia/Myopia/Presbyopia", 
            "Refractive Surgical", "Retina", "Retinal Vein Occlusion", "Retina Surgical", "Sjogren's Syndrome", 
            "Stargardt's Disease", "Thyroid Eye Disease", "Allergic Rhinitis", "Anti-Infective"
        ])].sort();
        let lastReportData = []; // To store filtered data for CSV export
        let enrollmentChart = null;
        let siteDistributionChart = null;

        // --- Helper & Icon Functions ---
        const getIcon = (name) => {
            const icons = {
                edit: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`,
                trash: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`,
                building: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375M9 12h6.375m-6.375 5.25h6.375M5.25 3h13.5v18h-13.5z" /></svg>`,
                exclamation: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`,
                upload: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>`
            };
            return icons[name] || '';
        };

        // --- Render Functions ---
        const render = () => {
            renderHeaderButtons();
            if (activeTab === 'dashboard') {
                mainContentArea.innerHTML = getDashboardHTML();
                renderDashboardCharts();
            } else if (activeTab === 'studies') {
                mainContentArea.innerHTML = getStudiesHTML();
                renderAllStudies();
            } else if (activeTab === 'sites') {
                mainContentArea.innerHTML = getSitesHTML();
                renderAllSites();
            } else if (activeTab === 'reporting') {
                mainContentArea.innerHTML = getReportingHTML();
                renderReportTables();
            }
        };

        const renderHeaderButtons = () => {
             headerButtons.innerHTML = `
                <div class="flex items-center space-x-2">
                    <button id="dashboard-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'dashboard' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500 hover:bg-gray-100'}">Dashboard</button>
                    <button id="studies-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'studies' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500 hover:bg-gray-100'}">Studies</button>
                    <button id="sites-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'sites' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500 hover:bg-gray-100'}">Sites</button>
                    <button id="reporting-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'reporting' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-500 hover:bg-gray-100'}">Reporting</button>
                    <button id="import-data-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                        ${getIcon('upload')}
                        Import Data
                    </button>
                    <button id="add-study-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span class="ml-2">New Study</span>
                    </button>
                </div>
            `;
        };

        const getDashboardHTML = () => {
             const totalStudies = allStudies.length;
            const totalSites = allSites.length;
            const totalEnrolled = allPatients.filter(p => p.status === 'Enrolled').length;

            return `
                 <div class="px-4 py-6 sm:px-0 space-y-8">
                     <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                     <!-- Stat Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         <div class="bg-white p-6 rounded-lg shadow-md text-center">
                             <p class="text-sm text-gray-500">Total Studies</p>
                             <p class="text-3xl font-bold text-indigo-600">${totalStudies}</p>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow-md text-center">
                             <p class="text-sm text-gray-500">Total Sites</p>
                             <p class="text-3xl font-bold text-indigo-600">${totalSites}</p>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow-md text-center">
                             <p class="text-sm text-gray-500">Total Enrolled Patients</p>
                             <p class="text-3xl font-bold text-indigo-600">${totalEnrolled}</p>
                         </div>
                     </div>
                     
                     <!-- Filters -->
                     <div id="dashboard-filters" class="bg-white p-4 rounded-lg shadow-md">
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                             <div>
                                 <label for="dash-study-filter" class="block text-sm font-medium text-gray-700">Filter by Study</label>
                                 <select id="dash-study-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">All Studies</option>
                                     ${allStudies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}
                                 </select>
                             </div>
                              <div>
                                 <label for="dash-site-filter" class="block text-sm font-medium text-gray-700">Filter by Site</label>
                                 <select id="dash-site-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">All Sites</option>
                                     ${allSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                 </select>
                             </div>
                             <div>
                                 <label for="dash-indication-filter" class="block text-sm font-medium text-gray-700">Filter by Indication</label>
                                 <select id="dash-indication-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">All Indications</option>
                                     ${indicationOptions.map(ind => `<option value="${ind}">${ind}</option>`).join('')}
                                 </select>
                             </div>
                             <div>
                                 <button id="generate-dashboard-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Apply Filters</button>
                             </div>
                         </div>
                     </div>
                     
                     <!-- Charts -->
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold text-gray-700 mb-4">Enrollment Progress</h3>
                             <canvas id="enrollment-chart"></canvas>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold text-gray-700 mb-4">Enrollment by Site</h3>
                             <canvas id="site-distribution-chart"></canvas>
                         </div>
                     </div>
                 </div>
            `;
        };

        const getStudiesHTML = () => `
            <div class="px-4 py-6 sm:px-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Studies</h2>
                </div>
                <div id="studies-container" class="grid grid-cols-1 gap-8"></div>
            </div>
        `;
        
        const getSitesHTML = () => `
            <div class="px-4 py-6 sm:px-0 space-y-8">
                 <div class="flex justify-between items-center">
                     <h2 class="text-3xl font-bold text-gray-800">Site Management</h2>
                     <div class="flex items-center space-x-2">
                         <button id="bulk-delete-site-btn" class="hidden inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-red-100 hover:bg-red-200">
                             ${getIcon('trash')}
                             <span class="ml-2">Delete Selected</span>
                         </button>
                         <button id="add-site-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                             Add New Site
                         </button>
                     </div>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"><input type="checkbox" id="select-all-sites-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600"></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">PI</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Indication</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sites-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Site rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        const getReportingHTML = () => {
            const totalStudies = allStudies.length;
            const totalSites = allSites.length;
            const totalEnrolled = allPatients.filter(p => p.status === 'Enrolled').length;

            return `
                <div class="px-4 py-6 sm:px-0 space-y-8">
                    <!-- Overall Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <p class="text-sm text-gray-500">Total Studies</p>
                            <p class="text-3xl font-bold text-indigo-600">${totalStudies}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <p class="text-sm text-gray-500">Total Sites</p>
                            <p class="text-3xl font-bold text-indigo-600">${totalSites}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <p class="text-sm text-gray-500">Total Enrolled Patients</p>
                            <p class="text-3xl font-bold text-indigo-600">${totalEnrolled}</p>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="report-study-filter" class="block text-sm font-medium text-gray-700">Filter by Study</label>
                                <select id="report-study-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="all">All Studies</option>
                                    ${allStudies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}
                                </select>
                            </div>
                             <div>
                                <label for="report-site-filter" class="block text-sm font-medium text-gray-700">Filter by Site</label>
                                <select id="report-site-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="all">All Sites</option>
                                    ${allSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="report-indication-filter" class="block text-sm font-medium text-gray-700">Filter by Indication</label>
                                <select id="report-indication-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="all">All Indications</option>
                                    ${indicationOptions.map(ind => `<option value="${ind}">${ind}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <button id="generate-report-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Generate Report</button>
                            </div>
                        </div>
                    </div>

                    <!-- Site Performance Table -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <h3 class="text-xl font-semibold text-gray-700 p-6">Site Performance</h3>
                        <div id="report-sites-table-container"></div>
                    </div>

                    <!-- Study Progress Table -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="flex justify-between items-center p-6">
                            <h3 class="text-xl font-semibold text-gray-700">Study Progress</h3>
                            <button id="export-study-stats-btn" class="text-sm bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 disabled:bg-gray-400" disabled>Export CSV</button>
                        </div>
                        <div id="report-studies-table-container"></div>
                    </div>
                </div>
            `;
        };

        const renderStudyCard = (study) => {
            const enrolledPatients = allPatients.filter(p => p.studyId === study.id && p.status === 'Enrolled').length;
            const target = study.target || 0;
            const enrollmentPercentage = target > 0 ? Math.round((enrolledPatients / target) * 100) : 0;
            const sitesInStudy = allSites.filter(site => (study.siteIds || []).includes(site.id));
            const statusColor = study.status === 'Recruiting' || study.status === 'Active' ? 'text-green-600' : 'text-yellow-600';
            const startDate = study.startDate ? new Date(study.startDate).toLocaleDateString() : 'N/A';
            const endDate = study.endDate ? new Date(study.endDate).toLocaleDateString() : 'N/A';

            return `
                <div class="study-card" data-study-id="${study.id}">
                    <div class="p-6 bg-gradient-to-r from-gray-800 to-gray-700 text-white flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">${study.title}</h2>
                            <p class="text-sm opacity-80">Protocol #: ${study.protocolNumber || 'N/A'}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button data-action="edit" class="p-2 rounded-full hover:bg-gray-600 transition-colors">${getIcon('edit')}</button>
                            <button data-action="delete" class="p-2 rounded-full hover:bg-red-500 transition-colors">${getIcon('trash')}</button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4 text-sm text-gray-600">
                            <strong>Dates:</strong> ${startDate} - ${endDate}
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800">Overall Statistics</h3>
                            <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <p class="text-sm text-gray-500">Enrollment</p>
                                    <p class="text-2xl font-bold text-indigo-600">${enrolledPatients} / ${target}</p>
                                    <div class="mt-2 h-2 w-full progress-bar">
                                        <div class="progress-bar-fill" style="width: ${enrollmentPercentage}%;"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">${enrollmentPercentage}% of Goal</p>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg flex flex-col justify-center">
                                    <p class="text-sm text-gray-500">Number of Sites</p>
                                    <p class="text-2xl font-bold text-indigo-600">${sitesInStudy.length}</p>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg flex flex-col justify-center">
                                    <p class="text-sm text-gray-500">Status</p>
                                    <p class="text-2xl font-bold ${statusColor}">${study.status}</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                                ${getIcon('building')}
                                <span class="ml-2">Participating Sites</span>
                            </h3>
                            <div class="space-y-4">
                                ${sitesInStudy.length > 0 ? sitesInStudy.map(site => `
                                    <div class="p-4 border rounded-lg bg-white">
                                        <div class="flex flex-wrap justify-between items-start">
                                            <div class="mb-2 md:mb-0">
                                                <p class="font-bold text-gray-900">${site.name}</p>
                                                <div class="flex flex-wrap gap-1 mt-1">
                                                    ${(site.indication || []).map(ind => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${ind}</span>`).join('')}
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm text-gray-600">Enrollment at Site</p>
                                                <p class="font-semibold text-lg text-indigo-600">${allPatients.filter(p => p.siteId === site.id && p.studyId === study.id && p.status === 'Enrolled').length}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-sm text-gray-500 italic mt-3">No sites are assigned to this study yet. Edit the study to add sites.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderAllSites = () => {
            const sitesTableBody = document.getElementById('sites-table-body');
            if(sitesTableBody) {
                sitesTableBody.innerHTML = allSites.map(site => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap"><input type="checkbox" data-id="${site.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 site-checkbox"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${site.status || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${site.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${site.pi || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex flex-wrap gap-1">
                                ${(site.indication || []).map(ind => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${ind}</span>`).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                            <button data-action="edit-site" data-id="${site.id}" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                            <button data-action="delete-site" data-id="${site.id}" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }
        };

        const renderAllStudies = () => {
            const studiesContainer = document.getElementById('studies-container');
            if (studiesContainer) {
                if (allStudies.length > 0) {
                    studiesContainer.innerHTML = allStudies.map(renderStudyCard).join('');
                } else {
                    studiesContainer.innerHTML = `
                        <div class="text-center py-12 bg-white rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700">No studies found.</h3>
                            <p class="mt-1 text-sm text-gray-500">Get started by adding a new clinical study.</p>
                        </div>
                    `;
                }
            }
        };
        
        // --- Dashboard Chart Functions ---
        const renderDashboardCharts = () => {
            const studyFilterId = document.getElementById('dash-study-filter')?.value;
            const siteFilterId = document.getElementById('dash-site-filter')?.value;
            const indicationFilter = document.getElementById('dash-indication-filter')?.value;

            if (!studyFilterId) return; // Exit if filters are not on the page

            // --- Filter Data ---
            let relevantStudies = allStudies;
            if (studyFilterId !== 'all') {
                relevantStudies = relevantStudies.filter(s => s.id === studyFilterId);
            }
            if (siteFilterId !== 'all') {
                 relevantStudies = relevantStudies.filter(s => (s.siteIds || []).includes(siteFilterId));
            }
             if (indicationFilter !== 'all') {
                const sitesWithIndication = new Set(allSites.filter(s => (s.indication || []).includes(indicationFilter)).map(s => s.id));
                relevantStudies = relevantStudies.filter(s => (s.siteIds || []).some(siteId => sitesWithIndication.has(siteId)));
            }
            
            const relevantStudyIds = new Set(relevantStudies.map(s => s.id));
            
            let relevantSites = allSites;
            if(siteFilterId !== 'all') {
                relevantSites = relevantSites.filter(s => s.id === siteFilterId);
            } else if (studyFilterId !== 'all') {
                const study = allStudies.find(s => s.id === studyFilterId);
                relevantSites = relevantSites.filter(s => (study.siteIds || []).includes(s.id));
            }
            
            const relevantSiteIds = new Set(relevantSites.map(s => s.id));
            
            const relevantPatients = allPatients.filter(p => p.status === 'Enrolled' && relevantStudyIds.has(p.studyId) && relevantSiteIds.has(p.siteId));

            // --- Enrollment Progress Chart (Bar) ---
            const enrollmentCtx = document.getElementById('enrollment-chart')?.getContext('2d');
            if (enrollmentCtx) {
                if (enrollmentChart) enrollmentChart.destroy();
                
                const chartLabels = relevantStudies.map(s => s.title);
                const enrolledData = relevantStudies.map(s => allPatients.filter(p => p.studyId === s.id && p.status === 'Enrolled').length);
                const targetData = relevantStudies.map(s => s.target || 0);

                enrollmentChart = new Chart(enrollmentCtx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: 'Enrolled',
                                data: enrolledData,
                                backgroundColor: 'rgba(79, 70, 229, 0.8)', // indigo-600
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 1
                            },
                             {
                                label: 'Target',
                                data: targetData,
                                backgroundColor: 'rgba(229, 231, 235, 0.8)', // gray-200
                                borderColor: 'rgba(156, 163, 175, 1)', // gray-400
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        responsive: true
                    }
                });
            }

            // --- Site Distribution Chart (Doughnut) ---
            const siteDistributionCtx = document.getElementById('site-distribution-chart')?.getContext('2d');
            if (siteDistributionCtx) {
                if (siteDistributionChart) siteDistributionChart.destroy();
                
                const siteEnrollment = {};
                relevantSites.forEach(site => {
                    siteEnrollment[site.name] = relevantPatients.filter(p => p.siteId === site.id).length;
                });
                
                siteDistributionChart = new Chart(siteDistributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(siteEnrollment),
                        datasets: [{
                            label: 'Patients per Site',
                            data: Object.values(siteEnrollment),
                            backgroundColor: [
                                'rgba(79, 70, 229, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 
                                'rgba(245, 158, 11, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(139, 92, 246, 0.8)'
                            ],
                            hoverOffset: 4
                        }]
                    },
                     options: {
                        responsive: true
                    }
                });
            }
        };

        // --- Reporting Functions ---
        const renderReportTables = () => {
            const studyFilterId = document.getElementById('report-study-filter')?.value;
            const siteFilterId = document.getElementById('report-site-filter')?.value;
            const indicationFilter = document.getElementById('report-indication-filter')?.value;
            
            if (!studyFilterId) { // Function might be called before reporting tab is rendered
                return;
            }

            // Filter studies
            let filteredStudies = allStudies;
            if (studyFilterId !== 'all') {
                filteredStudies = filteredStudies.filter(s => s.id === studyFilterId);
            }
            if (siteFilterId !== 'all') {
                filteredStudies = filteredStudies.filter(s => (s.siteIds || []).includes(siteFilterId));
            }
             if (indicationFilter !== 'all') {
                const sitesWithIndication = new Set(allSites.filter(s => (s.indication || []).includes(indicationFilter)).map(s => s.id));
                filteredStudies = filteredStudies.filter(s => (s.siteIds || []).some(siteId => sitesWithIndication.has(siteId)));
            }
            
            // Filter sites
            let filteredSites = allSites;
            if (siteFilterId !== 'all') {
                filteredSites = filteredSites.filter(s => s.id === siteFilterId);
            }
            if (indicationFilter !== 'all') {
                filteredSites = filteredSites.filter(s => (s.indication || []).includes(indicationFilter));
            }
            if (studyFilterId !== 'all') {
                const study = allStudies.find(s => s.id === studyFilterId);
                const siteIdsInStudy = study ? study.siteIds || [] : [];
                filteredSites = filteredSites.filter(s => siteIdsInStudy.includes(s.id));
            }

            // Render Study Progress Table
            const studiesTableContainer = document.getElementById('report-studies-table-container');
            if (studiesTableContainer) {
                if (filteredStudies.length > 0) {
                    studiesTableContainer.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Study</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Enrollment</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredStudies.map(study => {
                                    const enrolled = allPatients.filter(p => p.studyId === study.id && p.status === 'Enrolled').length;
                                    const target = study.target || 0;
                                    const percentage = target > 0 ? Math.round((enrolled / target) * 100) : 0;
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${study.title}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500">${study.status}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500">${enrolled} / ${target}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500">
                                                <div class="w-full progress-bar h-4">
                                                    <div class="progress-bar-fill flex items-center justify-center text-xs text-white" style="width: ${percentage}%">${percentage}%</div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    lastReportData = filteredStudies; // Save for export
                    document.getElementById('export-study-stats-btn').disabled = false;
                } else {
                    studiesTableContainer.innerHTML = `<p class="text-center text-gray-500 py-8">No study data matches the selected filters.</p>`;
                    lastReportData = [];
                    document.getElementById('export-study-stats-btn').disabled = true;
                }
            }
            
            // Render Site Performance Table
            const sitesTableContainer = document.getElementById('report-sites-table-container');
            if (sitesTableContainer) {
                if (filteredSites.length > 0) {
                    sitesTableContainer.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Site</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Enrolled</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Active Studies</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredSites.map(site => {
                                    const enrolled = allPatients.filter(p => p.siteId === site.id && p.status === 'Enrolled').length;
                                    const activeStudies = new Set(allPatients.filter(p => p.siteId === site.id && p.studyId).map(p => p.studyId)).size;
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${site.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500">${enrolled}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500">${activeStudies}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    sitesTableContainer.innerHTML = `<p class="text-center text-gray-500 py-8">No site data matches the selected filters.</p>`;
                }
            }
        };
        
        const exportReportToCSV = () => {
            if (lastReportData.length === 0) {
                console.log("No data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Study Title", "Protocol Number", "Status", "Start Date", "End Date", "Enrolled Patients", "Target Enrollment", "Enrollment Percentage"];
            csvContent += headers.join(",") + "\r\n";

            lastReportData.forEach(study => {
                const enrolled = allPatients.filter(p => p.studyId === study.id && p.status === 'Enrolled').length;
                const target = study.target || 0;
                const percentage = target > 0 ? Math.round((enrolled / target) * 100) : 0;
                const row = [
                    `"${study.title}"`,
                    `"${study.protocolNumber || 'N/A'}"`,
                    study.status,
                    study.startDate || 'N/A',
                    study.endDate || 'N/A',
                    enrolled,
                    target,
                    `${percentage}%`
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "study_progress_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };


        // --- Modal Functions ---
        const showModal = (content) => {
            modalContainer.innerHTML = content;
            if (modalContainer.firstChild) {
                modalContainer.firstChild.style.display = 'flex';
            }
        };

        const closeModal = () => {
            modalContainer.innerHTML = '';
        };

        const createStudyModal = (study = null) => {
            const isEdit = study !== null;
            const title = isEdit ? 'Edit Study' : 'Add New Study';
            const buttonText = isEdit ? 'Save Changes' : 'Create Study';
            const statusOptions = ['Recruiting', 'Enrolling', 'Active', 'Closed'];

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content">
                        <form id="study-form" data-id="${isEdit ? study.id : ''}">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-900">${title}</h2>
                                <div class="mt-4 grid grid-cols-1 gap-4">
                                    <div>
                                        <label for="title" class="block text-sm font-medium text-gray-700">Study Title</label>
                                        <input type="text" name="title" id="title" value="${study?.title || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required />
                                    </div>
                                    <div>
                                        <label for="protocolNumber" class="block text-sm font-medium text-gray-700">Protocol Number</label>
                                        <input type="text" name="protocolNumber" id="protocolNumber" value="${study?.protocolNumber || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" />
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
                                            <input type="date" name="startDate" id="startDate" value="${study?.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"/>
                                        </div>
                                        <div>
                                            <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
                                            <input type="date" name="endDate" id="endDate" value="${study?.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"/>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                            <select name="status" id="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                                ${statusOptions.map(s => `<option ${study?.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label for="target" class="block text-sm font-medium text-gray-700">Enrollment Target</label>
                                            <input type="number" name="target" id="target" value="${study?.target || 0}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required />
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Assign Sites</label>
                                        <div class="mt-2 max-h-40 overflow-y-auto border rounded-md p-2 space-y-2">
                                            ${allSites.length > 0 ? allSites.map(site => `
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="siteIds" value="${site.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600" ${(study?.siteIds || []).includes(site.id) ? 'checked' : ''}>
                                                    <span class="ml-2 text-sm text-gray-600">${site.name}</span>
                                                </label>
                                            `).join('') : '<p class="text-xs text-gray-500">No sites available. Please add sites first.</p>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">${buttonText}</button>
                                <button type="button" data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            showModal(modalHTML);
        };

        const createSiteModal = (site = null) => {
            const isEdit = site !== null;
            const title = isEdit ? 'Edit Site' : 'Add New Site';
            const buttonText = isEdit ? 'Save Changes' : 'Create Site';

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content site-modal-content">
                        <form id="site-form" data-id="${isEdit ? site.id : ''}">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-900">${title}</h2>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label for="name" class="block text-sm font-medium text-gray-700">Site Name</label>
                                        <input type="text" name="name" id="name" value="${site?.name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
                                    </div>
                                     <div>
                                        <label for="siteNameAbbreviation" class="block text-sm font-medium text-gray-700">Site Name Abbreviation</label>
                                        <input type="text" name="siteNameAbbreviation" id="siteNameAbbreviation" value="${site?.siteNameAbbreviation || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                    <div>
                                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                        <input type="text" name="status" id="status" value="${site?.status || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="address1" class="block text-sm font-medium text-gray-700">Address Line 1</label>
                                        <input type="text" name="address1" id="address1" value="${site?.address1 || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                     <div class="md:col-span-2">
                                        <label for="address2" class="block text-sm font-medium text-gray-700">Address Line 2</label>
                                        <input type="text" name="address2" id="address2" value="${site?.address2 || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                    <div>
                                        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                                        <input type="text" name="city" id="city" value="${site?.city || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                    <div>
                                        <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                                        <input type="text" name="state" id="state" value="${site?.state || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                     <div>
                                        <label for="zipCode" class="block text-sm font-medium text-gray-700">Zip Code</label>
                                        <input type="text" name="zipCode" id="zipCode" value="${site?.zipCode || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                    <div>
                                        <label for="country" class="block text-sm font-medium text-gray-700">Country</label>
                                        <input type="text" name="country" id="country" value="${site?.country || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                     <div>
                                        <label for="pi" class="block text-sm font-medium text-gray-700">PI</label>
                                        <input type="text" name="pi" id="pi" value="${site?.pi || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                     <div>
                                        <label for="piEmail" class="block text-sm font-medium text-gray-700">PI Email</label>
                                        <input type="email" name="piEmail" id="piEmail" value="${site?.piEmail || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                     <div>
                                        <label for="siteCoordinator" class="block text-sm font-medium text-gray-700">Site Coordinator</label>
                                        <input type="text" name="siteCoordinator" id="siteCoordinator" value="${site?.siteCoordinator || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                     <div>
                                        <label for="siteCoordinatorEmail" class="block text-sm font-medium text-gray-700">Site Coordinator Email</label>
                                        <input type="email" name="siteCoordinatorEmail" id="siteCoordinatorEmail" value="${site?.siteCoordinatorEmail || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                                    </div>
                                     <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700">Indication</label>
                                        <div class="mt-2 max-h-40 overflow-y-auto border rounded-md p-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                            ${indicationOptions.map(ind => `
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="indication" value="${ind}" class="h-4 w-4 rounded border-gray-300 text-indigo-600" ${(site?.indication || []).includes(ind) ? 'checked' : ''}>
                                                    <span class="ml-2 text-sm text-gray-600">${ind}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">${buttonText}</button>
                                <button type="button" data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            showModal(modalHTML);
        };

        const createConfirmModal = (ids, type) => {
            const isBulk = Array.isArray(ids);
            const title = type === 'study' ? 'Delete Study' : `Delete ${isBulk ? ids.length : ''} Site(s)`;
            const message = type === 'study' 
                ? 'Are you sure you want to delete this study? This will also remove the study assignment from all associated patients. This action cannot be undone.'
                : `Are you sure you want to delete ${isBulk ? 'these sites' : 'this site'}? This will remove the site(s) from all studies and unlink any patients assigned to them. This action cannot be undone.`;
            
            const buttonId = type === 'study' ? 'confirm-delete-study-btn' : 'confirm-delete-site-btn';

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content confirm-modal-content">
                        <div class="p-6">
                            <div class="flex items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">${getIcon('exclamation')}</div>
                                <div class="ml-4 text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900">${title}</h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500">${message}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-3 flex flex-row-reverse">
                            <button id="${buttonId}" data-id='${JSON.stringify(ids)}' class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Delete</button>
                            <button data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHTML);
        };
        
        const createImportModal = () => {
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content import-modal-content">
                        <div class="p-6">
                            <h2 class="text-xl font-bold text-gray-900">Import Data from CSV</h2>
                            <p class="text-sm text-gray-500 mt-1">Select the type of data to import and upload a CSV file with the correct format.</p>
                            
                            <div class="mt-4">
                                <fieldset>
                                    <legend class="text-base font-medium text-gray-900">Select Import Type</legend>
                                    <div class="mt-4 space-y-4">
                                        <div class="flex items-center">
                                            <input id="import-type-studies" name="import-type" type="radio" value="studies" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                            <label for="import-type-studies" class="ml-3 block text-sm font-medium text-gray-700">Studies</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="import-type-sites" name="import-type" type="radio" value="sites" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                            <label for="import-type-sites" class="ml-3 block text-sm font-medium text-gray-700">Sites</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="import-type-enrollment" name="import-type" type="radio" value="enrollment" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                            <label for="import-type-enrollment" class="ml-3 block text-sm font-medium text-gray-700">Patient Enrollment (Ties Studies to Sites)</label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>

                            <div id="import-instructions" class="mt-6 p-4 bg-gray-100 rounded-lg"></div>
                            
                             <div class="mt-4">
                                <label for="csv-file-input" class="block text-sm font-medium text-gray-700">Upload CSV File</label>
                                <input type="file" id="csv-file-input" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            </div>
                            <div id="import-feedback" class="mt-4 text-sm"></div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button id="start-import-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm" disabled>Import</button>
                            <button type="button" data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHTML);
            updateImportInstructions();
        };

        // --- Firebase Logic ---
        const handleSaveStudy = async (e) => {
            e.preventDefault();
            const form = e.target;
            const studyId = form.dataset.id;
            const selectedSiteIds = Array.from(form.querySelectorAll('input[name="siteIds"]:checked')).map(cb => cb.value);

            const studyData = {
                title: form.title.value,
                protocolNumber: form.protocolNumber.value,
                status: form.status.value,
                target: parseInt(form.target.value, 10) || 0,
                startDate: form.startDate.value,
                endDate: form.endDate.value,
                siteIds: selectedSiteIds
            };
            
            try {
                const docRef = studyId ? doc(db, 'studies', studyId) : doc(collection(db, 'studies'));
                await setDoc(docRef, studyData, { merge: true });
                console.log('Study saved successfully');
                closeModal();
            } catch (error) {
                console.error('Error saving study: ', error);
            }
        };

        const handleSaveSite = async (e) => {
            e.preventDefault();
            const form = e.target;
            const siteId = form.dataset.id;
            const selectedIndications = Array.from(form.querySelectorAll('input[name="indication"]:checked')).map(cb => cb.value);
            
            const siteData = {
                name: form.name.value,
                siteNameAbbreviation: form.siteNameAbbreviation.value,
                status: form.status.value,
                address1: form.address1.value,
                address2: form.address2.value,
                city: form.city.value,
                state: form.state.value,
                zipCode: form.zipCode.value,
                country: form.country.value,
                pi: form.pi.value,
                piEmail: form.piEmail.value,
                siteCoordinator: form.siteCoordinator.value,
                siteCoordinatorEmail: form.siteCoordinatorEmail.value,
                indication: selectedIndications,
            };

            try {
                const docRef = siteId ? doc(db, 'sites', siteId) : doc(collection(db, 'sites'));
                await setDoc(docRef, siteData, { merge: true });
                console.log('Site saved successfully');
                closeModal();
            } catch (error) {
                console.error('Error saving site: ', error);
            }
        };

        const handleDeleteStudy = async (studyId) => {
            try {
                const batch = writeBatch(db);
                const studyRef = doc(db, 'studies', studyId);
                batch.delete(studyRef);

                const patientsToUpdate = allPatients.filter(p => p.studyId === studyId);
                patientsToUpdate.forEach(p => {
                    const patientRef = doc(db, 'patients', p.id);
                    batch.update(patientRef, { studyId: null, siteId: null });
                });
                
                await batch.commit();
                console.log('Study and associated patient links deleted successfully');
            } catch (error) {
                console.error('Error deleting study: ', error);
            } finally {
                closeModal();
            }
        };

        const handleDeleteSite = async (siteIds) => {
            const idsToDelete = Array.isArray(siteIds) ? siteIds : [siteIds];
            try {
                const batch = writeBatch(db);
                
                idsToDelete.forEach(siteId => {
                    // 1. Delete the site document
                    const siteRef = doc(db, 'sites', siteId);
                    batch.delete(siteRef);

                    // 2. Unlink site from any studies
                    const studiesWithSite = allStudies.filter(s => (s.siteIds || []).includes(siteId));
                    studiesWithSite.forEach(study => {
                        const studyRef = doc(db, 'studies', study.id);
                        batch.update(studyRef, { siteIds: arrayRemove(siteId) });
                    });

                    // 3. Unlink site from any patients
                    const patientsAtSite = allPatients.filter(p => p.siteId === siteId);
                    patientsAtSite.forEach(patient => {
                        const patientRef = doc(db, 'patients', patient.id);
                        batch.update(patientRef, { siteId: null });
                    });
                });
                
                await batch.commit();
                console.log(`${idsToDelete.length} site(s) and all associated links deleted successfully`);
            } catch (error) {
                console.error('Error deleting site(s): ', error);
            } finally {
                closeModal();
            }
        };
        
        // --- Import Logic ---
        const updateImportInstructions = () => {
            const importType = document.querySelector('input[name="import-type"]:checked').value;
            const instructionsEl = document.getElementById('import-instructions');
            let instructionsHTML = '';

            if (importType === 'studies') {
                instructionsHTML = `
                    <p class="font-semibold">Required Columns for Studies:</p>
                    <code class="text-xs bg-gray-200 p-1 rounded">title,protocolNumber,status,target,startDate,endDate</code>
                    <p class="text-xs mt-1">Example: <code class="text-xs">"Phase 3 Study","P3-XYZ-01","Recruiting",150,2025-01-01,2026-12-31</code></p>
                `;
            } else if (importType === 'sites') {
                instructionsHTML = `
                    <p class="font-semibold">Required Columns for Sites:</p>
                    <code class="text-xs bg-gray-200 p-1 rounded">Status,Site Name,Site Name Abbreviation,Address line 1,Address Line 2,City,State,Zip Code,Country,PI,PI Email,Site Coordinator,Site Coordinator Email,Indication</code>
                    <p class="text-xs mt-1">For Indication, separate multiple values with a pipe (|).</p>
                    <p class="text-xs mt-1">Example: <code class="text-xs">"Active","City Eye Center","CEC","123 Main St","Suite 100","Anytown","CA","12345","USA","Dr. Smith","dr.smith@email.com","John Doe","j.doe@email.com","Dry Eye|Glaucoma"</code></p>
                `;
            } else if (importType === 'enrollment') {
                 instructionsHTML = `
                    <p class="font-semibold">Required Columns for Patient Enrollment:</p>
                    <code class="text-xs bg-gray-200 p-1 rounded">patientId,studyTitle,siteName,status,enrollmentDate</code>
                    <p class="text-xs mt-1">This will create or update patients to link them to existing studies and sites.</p>
                    <p class="text-xs mt-1">Example: <code class="text-xs">"PAT-001","Phase 3 Study","Central Clinic","Enrolled",2025-02-15</code></p>
                `;
            }
            instructionsEl.innerHTML = instructionsHTML;
        };
        
        const parseCSV = (text) => {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const entry = {};
                for (let j = 0; j < header.length; j++) {
                    entry[header[j]] = values[j] ? values[j].trim().replace(/"/g, '') : '';
                }
                data.push(entry);
            }
            return data;
        };
        
        const handleImport = async (file) => {
            const feedbackEl = document.getElementById('import-feedback');
            const startBtn = document.getElementById('start-import-btn');
            if (!file) {
                feedbackEl.innerHTML = `<p class="text-red-600">Please select a file to import.</p>`;
                return;
            }
            
            startBtn.disabled = true;
            feedbackEl.innerHTML = `<p class="text-blue-600">Reading file...</p>`;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvText = event.target.result;
                    const data = parseCSV(csvText);
                    const importType = document.querySelector('input[name="import-type"]:checked').value;
                    
                    feedbackEl.innerHTML = `<p class="text-blue-600">Processing ${data.length} records... Please wait.</p>`;
                    
                    const batch = writeBatch(db);
                    let errors = [];
                    let skippedCount = 0;
                    let importedCount = 0;

                    if (importType === 'studies') {
                        data.forEach((row, index) => {
                            if (!row.title || !row.target) {
                                errors.push(`Row ${index + 2}: Missing required fields 'title' or 'target'.`);
                                return;
                            }
                            const docRef = doc(collection(db, 'studies'));
                            batch.set(docRef, {
                                title: row.title,
                                protocolNumber: row.protocolNumber || '',
                                status: row.status || 'Recruiting',
                                target: parseInt(row.target, 10) || 0,
                                startDate: row.startDate || '',
                                endDate: row.endDate || '',
                                siteIds: []
                            });
                            importedCount++;
                        });
                    } else if (importType === 'sites') {
                        const existingSiteNames = new Set(allSites.map(s => s.name.toLowerCase()));
                        data.forEach((row, index) => {
                            const siteName = row['Site Name'];
                            if (!siteName) {
                                errors.push(`Row ${index + 2}: Missing required field 'Site Name'.`);
                                return;
                            }
                            if (existingSiteNames.has(siteName.toLowerCase())) {
                                skippedCount++;
                                return; // Skip duplicate
                            }

                            const docRef = doc(collection(db, 'sites'));
                            batch.set(docRef, {
                                status: row.Status || '',
                                name: siteName,
                                siteNameAbbreviation: row['Site Name Abbreviation'] || '',
                                address1: row['Address line 1'] || '',
                                address2: row['Address Line 2'] || '',
                                city: row.City || '',
                                state: row.State || '',
                                zipCode: row['Zip Code'] || '',
                                country: row.Country || '',
                                pi: row.PI || '',
                                piEmail: row['PI Email'] || '',
                                siteCoordinator: row['Site Coordinator'] || '',
                                siteCoordinatorEmail: row['Site Coordinator Email'] || '',
                                indication: row.Indication ? row.Indication.split('|').map(i => i.trim()) : [],
                            });
                            importedCount++;
                        });
                    } else if (importType === 'enrollment') {
                        data.forEach((row, index) => {
                             if (!row.patientId || !row.studyTitle || !row.siteName) {
                                errors.push(`Row ${index + 2}: Missing required fields 'patientId', 'studyTitle', or 'siteName'.`);
                                return;
                            }
                            const study = allStudies.find(s => s.title === row.studyTitle);
                            const site = allSites.find(s => s.name === row.siteName);

                            if (!study) { errors.push(`Row ${index + 2}: Study "${row.studyTitle}" not found.`); return; }
                            if (!site) { errors.push(`Row ${index + 2}: Site "${row.siteName}" not found.`); return; }
                            
                            const docRef = doc(db, 'patients', row.patientId); // Use patientId as document ID
                             batch.set(docRef, {
                                studyId: study.id,
                                siteId: site.id,
                                status: row.status || 'Screening',
                                enrollmentDate: row.enrollmentDate || '',
                                appointment: null // Default value
                            }, { merge: true });
                            importedCount++;
                        });
                    }
                    
                    if (errors.length > 0) {
                        feedbackEl.innerHTML = `<p class="text-red-600 font-bold">Import failed with ${errors.length} errors:</p><ul class="list-disc list-inside text-red-500 text-xs">${errors.slice(0, 10).map(e => `<li>${e}</li>`).join('')}</ul>`;
                    } else {
                        await batch.commit();
                        let successMessage = `<p class="text-green-600 font-bold">Successfully imported ${importedCount} records!</p>`;
                        if (skippedCount > 0) {
                            successMessage += `<p class="text-yellow-600">Skipped ${skippedCount} duplicate records.</p>`;
                        }
                        feedbackEl.innerHTML = successMessage;
                        setTimeout(closeModal, 3000);
                    }

                } catch (e) {
                    console.error(e);
                    feedbackEl.innerHTML = `<p class="text-red-600">An error occurred during import: ${e.message}</p>`;
                } finally {
                    startBtn.disabled = false;
                }
            };
            reader.readAsText(file);
        };


        // --- Event Listeners ---
        headerButtons.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            if (button.id === 'dashboard-tab-btn') {
                activeTab = 'dashboard';
                render();
            } else if (button.id === 'studies-tab-btn') {
                activeTab = 'studies';
                render();
            } else if (button.id === 'sites-tab-btn') {
                activeTab = 'sites';
                render();
            } else if (button.id === 'reporting-tab-btn') {
                activeTab = 'reporting';
                render();
            } else if (button.id === 'add-study-btn') {
                createStudyModal();
            } else if (button.id === 'import-data-btn') {
                createImportModal();
            }
        });

        modalContainer.addEventListener('click', (e) => {
            if (e.target.dataset.action === 'cancel') {
                closeModal();
            }
            if (e.target.id === 'confirm-delete-study-btn') {
                handleDeleteStudy(JSON.parse(e.target.dataset.id));
            }
            if (e.target.id === 'confirm-delete-site-btn') {
                handleDeleteSite(JSON.parse(e.target.dataset.id));
            }
            if (e.target.id === 'start-import-btn') {
                const fileInput = document.getElementById('csv-file-input');
                handleImport(fileInput.files[0]);
            }
        });
        
        modalContainer.addEventListener('change', (e) => {
            if (e.target.name === 'import-type') {
                updateImportInstructions();
            }
            if (e.target.id === 'csv-file-input') {
                document.getElementById('start-import-btn').disabled = e.target.files.length === 0;
            }
        });

        modalContainer.addEventListener('submit', (e) => {
            if (e.target.id === 'study-form') {
                handleSaveStudy(e);
            }
            if (e.target.id === 'site-form') {
                handleSaveSite(e);
            }
        });

        mainContentArea.addEventListener('click', (e) => {
            const card = e.target.closest('.study-card');
            if (card) {
                const studyId = card.dataset.studyId;
                const study = allStudies.find(s => s.id === studyId);
                if (e.target.closest('[data-action="edit"]')) {
                    createStudyModal(study);
                }
                if (e.target.closest('[data-action="delete"]')) {
                    createConfirmModal(studyId, 'study');
                }
            }
            
            if (e.target.id === 'add-site-btn') {
                createSiteModal();
            }
            
            const editSiteButton = e.target.closest('[data-action="edit-site"]');
            if (editSiteButton) {
                const siteId = editSiteButton.dataset.id;
                const site = allSites.find(s => s.id === siteId);
                createSiteModal(site);
            }

            const deleteSiteButton = e.target.closest('[data-action="delete-site"]');
            if (deleteSiteButton) {
                const siteId = deleteSiteButton.dataset.id;
                createConfirmModal(siteId, 'site');
            }

            if (e.target.id === 'bulk-delete-site-btn') {
                const selectedIds = Array.from(document.querySelectorAll('.site-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length > 0) {
                    createConfirmModal(selectedIds, 'site');
                }
            }

             if (e.target.id === 'export-study-stats-btn') {
                exportReportToCSV();
            }
            if (e.target.id === 'generate-report-btn') {
                renderReportTables();
            }
            if (e.target.id === 'generate-dashboard-btn') {
                renderDashboardCharts();
            }
        });

        mainContentArea.addEventListener('change', (e) => {
             if (e.target.classList.contains('site-checkbox') || e.target.id === 'select-all-sites-checkbox') {
                const checkboxes = document.querySelectorAll('.site-checkbox');
                const selectAll = document.getElementById('select-all-sites-checkbox');
                const bulkDeleteBtn = document.getElementById('bulk-delete-site-btn');

                if (e.target.id === 'select-all-sites-checkbox') {
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                }

                const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                if (anyChecked) {
                    bulkDeleteBtn.classList.remove('hidden');
                } else {
                    bulkDeleteBtn.classList.add('hidden');
                }
                
                selectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            }
        });
        
        // --- Initialization ---
        const init = () => {
            onAuthStateChanged(auth, (currentUser) => {
                if (currentUser) {
                    user = currentUser;
                    const collectionsToFetch = ['studies', 'sites', 'patients'];
                    let loadedCount = 0;

                    collectionsToFetch.forEach(colName => {
                        onSnapshot(collection(db, colName), (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (colName === 'studies') allStudies = data.sort((a,b) => (a.title > b.title) ? 1 : -1);
                            else if (colName === 'sites') allSites = data.sort((a,b) => (a.name > b.name) ? 1 : -1);
                            else if (colName === 'patients') allPatients = data;
                            
                            loadedCount++;
                            if (loadedCount === collectionsToFetch.length) {
                                loadingIndicator.style.display = 'none';
                                render();
                            }
                        }, (error) => {
                            console.error(`Error fetching ${colName}:`, error);
                            loadedCount++;
                             if (loadedCount === collectionsToFetch.length) {
                                loadingIndicator.innerHTML = `<div class="text-xl font-semibold text-red-500">Error loading data. Please check console and refresh.</div>`;
                            }
                        });
                    });
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });
        };

        // Run the app
        init();
    </script>
</body>
</html>
