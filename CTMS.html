<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARTEMIS - Clinical Trial Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS and JS for free maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply base font to the body */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Leaflet custom icon styles */
        .custom-div-icon {
            background: transparent;
            border: none;
        }

        /* Enhanced study cards with modern styling */
        .study-card {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .study-card:hover {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }

        .study-card.dark {
            background-color: #1f2937;
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Enhanced modal styling with better animations */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            width: 100%;
            max-width: 32rem; /* 512px for study modal */
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .import-modal-content {
            max-width: 48rem; /* 768px for import modal */
        }
        
        .site-modal-content {
            max-width: 48rem; /* 768px for site modal */
        }

        .confirm-modal-content {
            max-width: 28rem; /* 448px for confirm modal */
        }

        /* Dark mode modal styling */
        .modal-content.dark {
            background-color: #1f2937;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced progress bar styling */
        .progress-bar {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
            height: 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Dark mode progress bar */
        .dark .progress-bar {
            background-color: #374151;
        }

        .dark .progress-bar-fill {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
        }
    </style>
     <script>
        // Apply theme as early as possible to prevent Flash of Unstyled Content (FOUC)
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app-container">
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center">
                <button id="theme-toggle-logo-btn" class="flex items-center mb-4 sm:mb-0 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 rounded-full transition-transform duration-200 hover:scale-105">
                    <svg class="w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <circle id="logo-bg-circle" cx="50" cy="50" r="48" fill="#0B3D91"/>
                        <path id="logo-arc" d="M25,50 A40,40 0 0,1 75,50" fill="none" stroke="#FFFFFF" stroke-width="6"/>
                        <circle id="logo-center-circle" cx="50" cy="50" r="15" fill="#FFFFFF"/>
                        <circle id="logo-inner-dot" cx="50" cy="50" r="7" fill="#0B3D91"/>
                        <path d="M20 50 L80 50" stroke="#B31942" stroke-width="8" transform="rotate(-45 50 50)"/>
                    </svg>
                    <div class="ml-3 text-left">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-gray-100">ARTEMIS</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400 hidden md:block">Advanced Research & Trial Event Management Interface System</p>
                    </div>
                </button>
                <div id="header-buttons">
                    </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div id="main-content-area">
                </div>
            <div id="loading-indicator" class="flex items-center justify-center h-screen">
                <div class="text-xl font-semibold">Loading CTMS Dashboard...</div>
            </div>
        </main>
    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, writeBatch, arrayRemove, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBiXVUUzeLT3mae0N6sdjICdevmRicdk5g",
            authDomain: "nasa2-0.firebaseapp.com",
            projectId: "nasa2-0",
            storageBucket: "nasa2-0.appspot.com",
            messagingSenderId: "735088252433",
            appId: "1:735088252433:web:1b6733520226e27f5843b0",
            measurementId: "G-SNHQZXKCL4"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);


        // --- DOM Elements ---
        const mainContentArea = document.getElementById('main-content-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const modalContainer = document.getElementById('modal-container');
        const headerButtons = document.getElementById('header-buttons');

        // --- Global State ---
        let allStudies = [];
        let allSites = [];
        let allPatients = [];
        let user = null;
        let activeTab = 'dashboard'; // 'dashboard', 'studies', 'sites', or 'reporting'
        let lastReportData = [];

        // --- Utility Functions ---
        const ensureArray = (value) => {
            if (Array.isArray(value)) return value;
            if (value === null || value === undefined) return [];
            return [value];
        };

        const getAllWashoutPatients = (studies) => {
            const washoutPatients = [];
            
            studies.forEach(study => {
                const studyPatients = allPatients.filter(p => {
                    const pastEnrollments = p.enrollments?.filter(e => e.status === 'past') || [];
                    return pastEnrollments.some(e => e.studyId === study.id && e.exitedDate);
                });
                
                studyPatients.forEach(patient => {
                    const pastEnrollments = patient.enrollments?.filter(e => e.status === 'past') || [];
                    const enrollment = pastEnrollments.find(e => e.studyId === study.id && e.exitedDate);
                    
                    if (enrollment) {
                        const exitDate = new Date(enrollment.exitedDate);
                        const washoutCompleteDate = new Date(exitDate);
                        washoutCompleteDate.setDate(washoutCompleteDate.getDate() + (study.washoutDays || 30));
                        
                        const today = new Date();
                        const diffMs = washoutCompleteDate.getTime() - today.getTime();
                        const daysRemaining = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                        
                        // Include patients who are still in washout or recently became eligible (within last 7 days)
                        if (daysRemaining > -7) {
                            washoutPatients.push({
                                ...patient,
                                studyId: study.id,
                                exitDate: enrollment.exitedDate,
                                washoutCompleteDate: washoutCompleteDate.toISOString(),
                                daysRemaining: Math.max(0, daysRemaining)
                            });
                        }
                    }
                });
            });
            
            return washoutPatients;
        };

        const showNotification = (message, type = 'info') => {
            // Create a simple notification system
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'info' ? 'bg-blue-500 text-white' :
                'bg-gray-500 text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        };
        const indicationOptions = [...new Set([
            "Allergy", "Blepharitis", "Dry Eye", "Glaucoma", "AMD (Wet/Dry)", "Anterior Uveitis", 
            "Cataracts", "Cataract Surgical", "Choroideremia", "Contact Lenses", "Corneal Disorders", 
            "Diabetic Macular Edema", "Diabetic Retinopathy", "Diagnostic Equipment", "Dry Eye Device", 
            "Eyelid Disorders", "Eye Redness", "Food Allergy", "Geographic Atrophy", "Glaucoma Devices", 
            "Glaucoma - IOP", "Glaucoma - Neuroprotection", "Infectious Conjunctivitis", "IRD", "IRD Devices", 
            "Keratoconus", "Neuromuscular Eye Disorders", "Neurotrophic Keratitis", "Ocular Allergy", 
            "Ocular Graft Versus Host Disease", "Ocular Melanoma", "Ocular PK", "Other Ocular Uveitis", 
            "Other Ophthalmic Surgery", "Posterior Uveitis", "Refractive - Hyperopia/Myopia/Presbyopia", 
            "Refractive Surgical", "Retina", "Retinal Vein Occlusion", "Retina Surgical", "Sjogren's Syndrome", 
            "Stargardt's Disease", "Thyroid Eye Disease", "Allergic Rhinitis", "Anti-Infective"
        ])].sort();
        let enrollmentChart = null;
        let siteDistributionChart = null;
        let nasaWindow = window.opener; // Reference to the N.A.S.A. window

        // --- Helper & Icon Functions ---
        /**
         * Icon cache for better performance
         * @type {Object<string, string>}
         */
        const iconCache = {
            edit: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`,
            building: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375M9 12h6.375m-6.375 5.25h6.375M5.25 3h13.5v18h-13.5z" /></svg>`,
            exclamation: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`,
            upload: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>`,
            sync: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 10.5M20 20l-1.5-1.5A9 9 0 003.5 13.5" /></svg>`
        };

        /**
         * Get icon SVG by name with caching for better performance
         * @param {string} name - Icon name
         * @returns {string} SVG string or empty string if not found
         */
        const getIcon = (name) => iconCache[name] || '';


        // --- N.A.S.A. Communication ---
        /**
         * Notifies N.A.S.A. window of study data updates
         * @param {string} studyId - ID of the study to sync
         * @returns {boolean} Success status of the sync operation
         */
        const notifyNasaOfUpdate = (studyId) => {
            try {
                if (!nasaWindow || nasaWindow.closed) {
                    console.warn("N.A.S.A. window not available for sync.");
                    return false;
                }

                const study = allStudies.find(s => s.id === studyId);
                if (!study) {
                    console.warn(`Study with ID ${studyId} not found for sync.`);
                    return false;
                }

                const studyPatients = allPatients.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment?.studyId === study.id;
                });

                const enrolledCount = studyPatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
                const screenFailCount = studyPatients.filter(p => p.status && p.status.toLowerCase() === 'screen fail').length;

                const payload = {
                    studyId: study.id,
                    enrolled: enrolledCount,
                    screenFails: screenFailCount,
                    timestamp: new Date().toISOString()
                };
                
                nasaWindow.postMessage({ type: 'CTMS_DATA_UPDATE', payload }, '*');
                console.log(`Successfully synced study ${study.title} with N.A.S.A.:`, payload);
                return true;
            } catch (error) {
                console.error(`Failed to sync study ${studyId} with N.A.S.A.:`, error);
                return false;
            }
        };

        // --- THEME MANAGEMENT (Light/Dark Mode) ---
        /**
         * Applies theme to the application with logo color updates
         * @param {string} theme - Theme name ('light' or 'dark')
         */
        const applyTheme = (theme) => {
            try {
                const logoElements = {
                    bgCircle: document.getElementById('logo-bg-circle'),
                    arc: document.getElementById('logo-arc'),
                    centerCircle: document.getElementById('logo-center-circle'),
                    innerDot: document.getElementById('logo-inner-dot')
                };

                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    // Invert logo colors for dark mode
                    if (logoElements.bgCircle) logoElements.bgCircle.setAttribute('fill', '#FFFFFF');
                    if (logoElements.arc) logoElements.arc.setAttribute('stroke', '#0B3D91');
                    if (logoElements.centerCircle) logoElements.centerCircle.setAttribute('fill', '#0B3D91');
                    if (logoElements.innerDot) logoElements.innerDot.setAttribute('fill', '#FFFFFF');
                } else {
                    document.documentElement.classList.remove('dark');
                    // Set logo colors back to default for light mode
                    if (logoElements.bgCircle) logoElements.bgCircle.setAttribute('fill', '#0B3D91');
                    if (logoElements.arc) logoElements.arc.setAttribute('stroke', '#FFFFFF');
                    if (logoElements.centerCircle) logoElements.centerCircle.setAttribute('fill', '#FFFFFF');
                    if (logoElements.innerDot) logoElements.innerDot.setAttribute('fill', '#0B3D91');
                }
                updateChartDefaults(theme);
            } catch (error) {
                console.error('Error applying theme:', error);
            }
        };

        /**
         * Loads and applies the saved theme or system preference
         */
        const loadTheme = () => {
            try {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme && (savedTheme === 'light' || savedTheme === 'dark')) {
                    applyTheme(savedTheme);
                } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    applyTheme('dark');
                } else {
                    applyTheme('light');
                }
            } catch (error) {
                console.error('Error loading theme:', error);
                applyTheme('light'); // Fallback to light theme
            }
        };

        /**
         * Toggles between light and dark themes
         */
        const toggleTheme = () => {
            try {
                const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
                render(); // Re-render to apply chart color changes
            } catch (error) {
                console.error('Error toggling theme:', error);
            }
        };

        /**
         * Updates Chart.js defaults based on theme
         * @param {string} theme - Current theme ('light' or 'dark')
         */
        const updateChartDefaults = (theme) => {
            try {
                const isDark = theme === 'dark';
                const textColor = isDark ? 'rgba(255, 255, 255, 0.85)' : 'rgba(0, 0, 0, 0.85)';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                if (typeof Chart !== 'undefined') {
                    Chart.defaults.color = textColor;
                    Chart.defaults.borderColor = gridColor;
                }
            } catch (error) {
                console.error('Error updating chart defaults:', error);
            }
        };


        // --- Render Functions ---
        /**
         * Main render function that updates the UI based on active tab
         */
        const render = () => {
            try {
                renderHeaderButtons();
                
                switch (activeTab) {
                    case 'dashboard':
                        mainContentArea.innerHTML = getDashboardHTML();
                        renderDashboardCharts();
                        break;
                    case 'studies':
                        mainContentArea.innerHTML = getStudiesHTML();
                        renderAllStudies();
                        break;
                    case 'sites':
                        mainContentArea.innerHTML = getSitesHTML();
                        renderAllSites();
                        break;
                    case 'reporting':
                        mainContentArea.innerHTML = getReportingHTML();
                        renderReportTables();
                        break;
                    default:
                        console.warn(`Unknown active tab: ${activeTab}`);
                        activeTab = 'dashboard';
                        render();
                }
            } catch (error) {
                console.error('Error in render function:', error);
                // Show error message to user
                mainContentArea.innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-red-600 mb-2">Error Loading Content</h3>
                            <p class="text-gray-600 dark:text-gray-400">Please refresh the page or contact support.</p>
                        </div>
                    </div>
                `;
            }
        };

        const renderHeaderButtons = () => {
             headerButtons.innerHTML = `
                 <div class="flex flex-wrap justify-center sm:justify-end items-center space-x-2">
                     <button id="dashboard-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'dashboard' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">Dashboard</button>
                     <button id="studies-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'studies' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">Studies</button>
                     <button id="sites-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'sites' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">Sites</button>
                     <button id="reporting-tab-btn" class="px-3 py-2 text-sm font-medium rounded-md ${activeTab === 'reporting' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">Reporting</button>
                     <button id="sync-all-btn" title="Sync All Studies with N.A.S.A." class="mt-2 sm:mt-0 inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                         ${getIcon('sync')}
                         <span class="hidden sm:inline ml-2">Sync All</span>
                     </button>
                     <button id="import-data-btn" class="mt-2 sm:mt-0 inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                         ${getIcon('upload')}
                         <span class="hidden sm:inline ml-2">Import Data</span>
                     </button>
                     <button id="add-study-btn" class="mt-2 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                         <span class="hidden sm:inline ml-2">New Study</span>
                     </button>
                 </div>
             `;
        };

        const getDashboardHTML = () => {
            const totalStudies = allStudies.length;
            const totalSites = allSites.length;
            const totalEnrolled = allPatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
            const totalScreenFailed = allPatients.filter(p => p.status && p.status.toLowerCase() === 'screen fail').length;
            const totalScreened = totalEnrolled + totalScreenFailed;
            const screenFailRate = totalScreened > 0 ? Math.round((totalScreenFailed / totalScreened) * 100) : 0;

            // Calculate study phases distribution
            const studyPhases = allStudies.reduce((acc, study) => {
                const phase = study.phase || 'Unknown';
                acc[phase] = (acc[phase] || 0) + 1;
                return acc;
            }, {});

            // Calculate therapeutic areas
            const therapeuticAreas = allStudies.reduce((acc, study) => {
                const area = study.indication || 'Other';
                acc[area] = (acc[area] || 0) + 1;
                return acc;
            }, {});

            // Calculate study status distribution
            const studyStatuses = allStudies.reduce((acc, study) => {
                const status = study.status || 'Unknown';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            return `
                 <div class="px-4 py-6 sm:px-0 space-y-8">
                      <div class="flex justify-between items-center">
                          <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">R&D Clinical Operations Dashboard</h2>
                          <div class="text-sm text-gray-500 dark:text-gray-400">
                              Data updated: ${new Date().toLocaleDateString('en-US', { 
                                  month: 'long', 
                                  day: 'numeric', 
                                  year: 'numeric',
                                  hour: 'numeric',
                                  minute: '2-digit'
                              })} 
                              <span class="inline-block w-2 h-2 bg-green-500 rounded-full ml-2"></span>
                          </div>
                      </div>

                      <!-- Key Metrics Cards -->
                      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                           <div class="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-4 sm:p-6 rounded-lg shadow-md text-center border border-blue-200 dark:border-blue-700">
                               <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">Total Studies</p>
                               <p id="stat-total-studies" class="text-2xl sm:text-3xl font-bold text-blue-700 dark:text-blue-300">${totalStudies}</p>
                           </div>
                           <div class="bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-4 sm:p-6 rounded-lg shadow-md text-center border border-green-200 dark:border-green-700">
                               <p class="text-sm text-green-600 dark:text-green-400 font-medium">Total Sites</p>
                               <p id="stat-total-sites" class="text-2xl sm:text-3xl font-bold text-green-700 dark:text-green-300">${totalSites}</p>
                           </div>
                           <div class="bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-4 sm:p-6 rounded-lg shadow-md text-center border border-purple-200 dark:border-purple-700">
                               <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">Total Enrolled</p>
                               <p id="stat-total-enrolled" class="text-2xl sm:text-3xl font-bold text-purple-700 dark:text-purple-300">${totalEnrolled}</p>
                           </div>
                           <div class="bg-gradient-to-r from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 p-4 sm:p-6 rounded-lg shadow-md text-center border border-orange-200 dark:border-orange-700">
                               <p class="text-sm text-orange-600 dark:text-orange-400 font-medium">Screen Fail Rate</p>
                               <p id="stat-screen-fail-rate" class="text-2xl sm:text-3xl font-bold text-orange-700 dark:text-orange-300">${screenFailRate}%</p>
                           </div>
                      </div>

                      <!-- Dashboard Filters -->
                      <div id="dashboard-filters" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                           <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">Dashboard Filters</h3>
                           <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label for="dash-study-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Study</label>
                                    <select id="dash-study-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="all">All Studies</option>
                                        ${allStudies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}
                                    </select>
                                </div>
                                 <div>
                                    <label for="dash-site-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Site</label>
                                    <select id="dash-site-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="all">All Sites</option>
                                        ${allSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                    </select>
                                </div>
                                 <div>
                                    <label for="dash-indication-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Indication</label>
                                    <select id="dash-indication-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="all">All Indications</option>
                                        ${indicationOptions.map(ind => `<option value="${ind}">${ind}</option>`).join('')}
                                    </select>
                                </div>
                               <div>
                                    <button id="generate-dashboard-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Apply Filters</button>
                                </div>
                           </div>
                      </div>
                      
                      <!-- Main Charts Grid -->
                      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                           <!-- Studies by Phase -->
                           <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Studies by Phase</h3>
                               <div class="relative mx-auto h-64 w-64">
                                   <canvas id="studies-by-phase-chart"></canvas>
                               </div>
                           </div>

                           <!-- Studies by Therapeutic Area -->
                           <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Studies by Therapeutic Area</h3>
                               <div class="relative mx-auto h-64 w-64">
                                   <canvas id="studies-by-therapeutic-area-chart"></canvas>
                               </div>
                           </div>
                      </div>

                      <!-- Second Row of Charts -->
                      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                           <!-- Study Status Funnel -->
                           <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Studies by Status</h3>
                               <canvas id="study-status-chart"></canvas>
                           </div>

                           <!-- Enrollment by Site -->
                           <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Enrollments by Site</h3>
                               <canvas id="enrollment-by-site-chart"></canvas>
                           </div>
                      </div>

                      <!-- Third Row - Study Progress and Site Monitoring -->
                      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                           <!-- Study Progress -->
                           <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Study Progress</h3>
                               <canvas id="study-progress-chart"></canvas>
                           </div>

                           <!-- Site Monitoring -->
                           <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Site Monitoring</h3>
                               <div class="relative mx-auto h-48 w-48">
                                   <canvas id="site-monitoring-chart"></canvas>
                               </div>
                           </div>

                           <!-- Finances -->
                           <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Finances</h3>
                               <canvas id="finances-chart"></canvas>
                           </div>
                      </div>

                      <!-- Site and Study Map -->
                      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                           <div class="flex justify-between items-center mb-6">
                               <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Site Locations & Study Distribution</h3>
                               <div class="flex items-center space-x-4">
                                   <div class="flex items-center space-x-2">
                                       <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                                       <span class="text-sm text-gray-600 dark:text-gray-400">Active Sites</span>
                                   </div>
                                   <div class="flex items-center space-x-2">
                                       <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                       <span class="text-sm text-gray-600 dark:text-gray-400">Studies</span>
                                   </div>
                                   <div class="flex items-center space-x-2">
                                       <div class="w-4 h-4 bg-purple-500 rounded-full"></div>
                                       <span class="text-sm text-gray-600 dark:text-gray-400">Staffed</span>
                                   </div>
                               </div>
                           </div>
                           
                           <!-- Map Controls -->
                           <div class="mb-4 flex flex-wrap gap-4 items-center">
                               <div class="flex items-center space-x-2">
                                   <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Map Type:</label>
                                   <select id="map-type-selector" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white text-sm">
                                       <option value="leaflet">OpenStreetMap (Free)</option>
                                       <option value="google">Google Maps (API Key Required)</option>
                                       <option value="bing">Bing Maps (API Key Required)</option>
                                   </select>
                               </div>
                               <div class="flex items-center space-x-2">
                                   <label class="text-sm font-medium text-gray-700 dark:text-gray-300">View:</label>
                                   <select id="map-view-selector" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white text-sm">
                                       <option value="sites">Site Locations</option>
                                       <option value="studies">Study Distribution</option>
                                       <option value="staffing">Staffing Levels</option>
                                       <option value="combined">Combined View</option>
                                   </select>
                               </div>
                               <button id="refresh-map-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                   Refresh Map
                               </button>
                           </div>
                           
                           <!-- Map Container -->
                           <div id="site-study-map" class="w-full h-96 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 relative overflow-hidden">
                               <!-- Leaflet OpenStreetMap will be loaded here -->
                               <div id="leaflet-map" class="w-full h-full hidden"></div>
                               
                               <!-- Google Maps will be loaded here -->
                               <div id="google-map" class="w-full h-full hidden"></div>
                               
                               <!-- Bing Maps will be loaded here -->
                               <div id="bing-map" class="w-full h-full hidden"></div>
                               
                               <!-- Fallback content when maps are not available -->
                               <div id="map-fallback" class="w-full h-full flex items-center justify-center">
                                   <div class="text-center">
                                       <div class="text-gray-500 dark:text-gray-400 mb-2">
                                           <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                           </svg>
                                       </div>
                                       <p class="text-gray-600 dark:text-gray-400">Interactive map will load here</p>
                                       <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">Select map provider above</p>
                                   </div>
                               </div>
                           </div>
                           
                           <!-- Map Legend -->
                           <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                               <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                   <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Site Statistics</h4>
                                   <div class="space-y-1 text-sm">
                                       <div class="flex justify-between">
                                           <span class="text-blue-700 dark:text-blue-300">Total Sites:</span>
                                           <span class="font-medium text-blue-800 dark:text-blue-200">${totalSites}</span>
                                       </div>
                                       <div class="flex justify-between">
                                           <span class="text-blue-700 dark:text-blue-300">Active Studies:</span>
                                           <span class="font-medium text-blue-800 dark:text-blue-200">${totalStudies}</span>
                                       </div>
                                   </div>
                               </div>
                               
                               <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                   <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">Patient Metrics</h4>
                                   <div class="space-y-1 text-sm">
                                       <div class="flex justify-between">
                                           <span class="text-green-700 dark:text-green-300">Total Enrolled:</span>
                                           <span class="font-medium text-green-800 dark:text-green-200">${totalEnrolled}</span>
                                       </div>
                                       <div class="flex justify-between">
                                           <span class="text-green-700 dark:text-green-300">Screen Fail Rate:</span>
                                           <span class="font-medium text-green-800 dark:text-green-200">${screenFailRate}%</span>
                                       </div>
                                   </div>
                               </div>
                               
                               <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                                   <h4 class="font-semibold text-purple-800 dark:text-purple-200 mb-2">Study Coverage</h4>
                                   <div class="space-y-1 text-sm">
                                       <div class="flex justify-between">
                                           <span class="text-purple-700 dark:text-purple-300">Avg. Sites/Study:</span>
                                           <span class="font-medium text-purple-800 dark:text-purple-200">${totalStudies > 0 ? Math.round(totalSites / totalStudies) : 0}</span>
                                       </div>
                                       <div class="flex justify-between">
                                           <span class="text-purple-700 dark:text-purple-300">Enrollment/Study:</span>
                                           <span class="font-medium text-purple-800 dark:text-purple-200">${totalStudies > 0 ? Math.round(totalEnrolled / totalStudies) : 0}</span>
                                       </div>
                                   </div>
                               </div>
                           </div>
                      </div>
                 </div>
            `;
        };

        const updateDashboardStats = (studies, sites, patients) => {
            const totalStudies = studies.length;
            const totalSites = sites.length;
            const totalEnrolled = patients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
            const totalScreenFailed = patients.filter(p => p.status && p.status.toLowerCase() === 'screen fail').length;
            const totalScreened = totalEnrolled + totalScreenFailed;
            const screenFailRate = totalScreened > 0 ? Math.round((totalScreenFailed / totalScreened) * 100) : 0;

            const studiesEl = document.getElementById('stat-total-studies');
            const sitesEl = document.getElementById('stat-total-sites');
            const enrolledEl = document.getElementById('stat-total-enrolled');
            const screenFailEl = document.getElementById('stat-screen-fail-rate');

            if (studiesEl) studiesEl.textContent = totalStudies;
            if (sitesEl) sitesEl.textContent = totalSites;
            if (enrolledEl) enrolledEl.textContent = totalEnrolled;
            if (screenFailEl) screenFailEl.textContent = `${screenFailRate}%`;
        };

        const getStudiesHTML = () => `
            <div class="px-4 py-6 sm:px-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Studies</h2>
                </div>
                <div id="studies-container" class="grid grid-cols-1 gap-8"></div>
            </div>
        `;
        
        const getSitesHTML = () => `
            <div class="px-4 py-6 sm:px-0 space-y-8">
                 <div class="flex flex-col sm:flex-row justify-between items-center">
                      <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-4 sm:mb-0">Site Management</h2>
                      <div class="flex items-center space-x-2">
                          <button id="sync-all-coordinates-btn" class="inline-flex items-center px-4 py-2 border border-green-300 text-sm font-medium rounded-md shadow-sm text-green-700 bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:text-green-200 dark:border-green-700">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                              </svg>
                              <span class="ml-2">📍 Sync All Coordinates</span>
                          </button>
                          <button id="bulk-delete-site-btn" class="hidden inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-red-100 hover:bg-red-200">
                              ${getIcon('trash')}
                              <span class="ml-2">Delete Selected</span>
                          </button>
                          <button id="add-site-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                              Add New Site
                          </button>
                      </div>
                 </div>
                 <div class="mb-4">
                     <input type="text" id="site-search-input" placeholder="Search by site name..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 dark:text-gray-200">
                 </div>
                 <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                     <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                         <thead class="bg-gray-50 dark:bg-gray-700">
                             <tr>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase"><input type="checkbox" id="select-all-sites-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600"></th>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site Name</th>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">PI</th>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Indication</th>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">SF Rate</th>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                             </tr>
                         </thead>
                         <tbody id="sites-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                             </tbody>
                     </table>
                 </div>
            </div>
        `;

        const getReportingHTML = () => {
            const totalStudies = allStudies.length;
            const totalSites = allSites.length;
            const totalEnrolled = allPatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
            const sources = ['Facebook', 'Instagram', 'Reddit', 'Site', 'Marketing', 'Email'];

            return `
                 <div class="px-4 py-6 sm:px-0 space-y-8">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                             <p class="text-sm text-gray-500 dark:text-gray-400">Total Studies</p>
                             <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${totalStudies}</p>
                         </div>
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                             <p class="text-sm text-gray-500 dark:text-gray-400">Total Sites</p>
                             <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${totalSites}</p>
                         </div>
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                             <p class="text-sm text-gray-500 dark:text-gray-400">Total Enrolled Patients</p>
                             <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">${totalEnrolled}</p>
                         </div>
                     </div>

                     <!-- NASA-style Report Filters -->
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                         <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">Advanced Report Filters</h3>
                         <form id="report-filter-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
                             <select name="studyId" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                 <option value="all">All Studies</option>
                                 ${allStudies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}
                             </select>
                             <select name="siteId" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                 <option value="all">All Sites</option>
                                 ${allSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                             </select>
                             <select name="status" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                 <option value="all">All Statuses</option>
                                 ${['Candidate', 'Enrolled', 'Pre-Screening', 'Screen Fail'].map(s => `<option value="${s}">${s}</option>`).join('')}
                             </select>
                             <select name="source" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                 <option value="all">All Sources</option>
                                 ${sources.map(s => `<option value="${s}">${s}</option>`).join('')}
                             </select>
                             <select name="schedulingStatus" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                 <option value="all">All Scheduling Statuses</option>
                                 <option value="scheduled">Scheduled</option>
                                 <option value="not-scheduled">Not Scheduled</option>
                             </select>
                             <select name="surveyOutcome" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                                 <option value="all">All Survey Outcomes</option>
                                 <option value="Pass">Pass</option>
                                 <option value="Fail">Fail</option>
                             </select>
                             <div class="flex items-center gap-2">
                                 <input type="number" name="minAge" placeholder="Min Age" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                                 <span>-</span>
                                 <input type="number" name="maxAge" placeholder="Max Age" class="w-full p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                             </div>
                             <div class="flex items-center gap-2">
                                 <input type="checkbox" name="surveyCompleted" id="surveyCompleted" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                 <label for="surveyCompleted" class="text-sm text-gray-700 dark:text-gray-300">Survey Completed</label>
                             </div>
                             <input type="date" name="startDate" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                             <input type="date" name="endDate" class="p-2 border dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white"/>
                             <button type="submit" class="bg-blue-600 text-white rounded-md h-10 col-span-full lg:col-span-2">Generate Report</button>
                         </form>
                     </div>

                     <!-- Report Metrics -->
                     <div id="report-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>

                     <!-- NASA-style Report Results -->
                     <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                         <div class="flex justify-between items-center p-6">
                             <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Report Results</h3>
                             <div class="flex gap-2">
                                 <button id="export-csv-btn" data-action="export-csv" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center disabled:bg-gray-400" disabled>
                                     <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Report
                                 </button>
                                 <button id="export-surveys-btn" data-action="export-surveys-csv" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center disabled:bg-gray-400" disabled>
                                     <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Survey Results
                                 </button>
                             </div>
                         </div>
                         <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                 <thead class="bg-gray-50 dark:bg-gray-700">
                                     <tr>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Age</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Appointment</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Survey Outcome</th>
                                     </tr>
                                 </thead>
                                 <tbody id="report-results-body" class="dark:text-gray-300">
                                     <tr><td colspan="7" class="text-center text-gray-500 dark:text-gray-400 py-8">Generate a report to see results.</td></tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>

                     <!-- Original ARTEMIS Reporting Sections -->
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                             <div>
                                 <label for="report-study-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Study</label>
                                 <select id="report-study-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">All Studies</option>
                                     ${allStudies.map(s => `<option value="${s.id}">${s.title}</option>`).join('')}
                                 </select>
                             </div>
                             <div>
                                 <label for="report-site-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Site</label>
                                 <select id="report-site-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">All Sites</option>
                                     ${allSites.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                 </select>
                             </div>
                             <div>
                                 <label for="report-indication-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Indication</label>
                                 <select id="report-indication-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                     <option value="all">All Indications</option>
                                     ${indicationOptions.map(ind => `<option value="${ind}">${ind}</option>`).join('')}
                                 </select>
                             </div>
                             <div>
                                 <button id="generate-report-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Generate Report</button>
                             </div>
                         </div>
                     </div>

                     <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                         <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 p-6">Site Performance</h3>
                         <div id="report-sites-table-container"></div>
                     </div>

                     <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                         <div class="flex flex-col sm:flex-row justify-between items-center p-6">
                             <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4 sm:mb-0">Study Progress</h3>
                             <button id="export-study-stats-btn" class="text-sm bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 disabled:bg-gray-400" disabled>Export CSV</button>
                         </div>
                         <div id="report-studies-table-container"></div>
                     </div>

                     <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                         <div class="flex flex-col sm:flex-row justify-between items-center p-6">
                             <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4 sm:mb-0">Washout Patients</h3>
                             <button id="export-washout-btn" class="text-sm bg-yellow-600 text-white px-3 py-1.5 rounded-md hover:bg-yellow-700 disabled:bg-gray-400" disabled>Export Washout CSV</button>
                         </div>
                         <div id="report-washout-table-container"></div>
                     </div>

                     <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-x-auto">
                         <div class="flex flex-col sm:flex-row justify-between items-center p-6">
                             <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4 sm:mb-0">All Participants</h3>
                             <button id="export-participants-btn" class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 disabled:bg-gray-400" disabled>Export Participants CSV</button>
                         </div>
                         <div id="report-participants-table-container"></div>
                     </div>
                 </div>
            `;
        };

        const renderStudyCard = (study) => {
            const studyPatients = allPatients.filter(p => {
                const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                return currentEnrollment?.studyId === study.id;
            });
            const enrolledPatients = studyPatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
            const screenFailedPatients = studyPatients.filter(p => p.status && p.status.toLowerCase() === 'screen fail').length;
            const totalScreened = enrolledPatients + screenFailedPatients;
            const screenFailRate = totalScreened > 0 ? Math.round((screenFailedPatients / totalScreened) * 100) : 0;

            const target = study.target || 0;
            const enrollmentPercentage = target > 0 ? Math.round((enrolledPatients / target) * 100) : 0;
            const sitesInStudy = allSites.filter(site => (study.siteIds || []).includes(site.id));
            const statusColor = study.status === 'Recruiting' || study.status === 'Active' ? 'text-green-600' : 'text-yellow-600';
            const startDate = study.startDate ? new Date(study.startDate).toLocaleDateString() : 'N/A';
            const endDate = study.endDate ? new Date(study.endDate).toLocaleDateString() : 'N/A';

            return `
                <div class="study-card dark:bg-gray-800" data-study-id="${study.id}">
                    <div class="p-6 bg-gradient-to-r from-gray-800 to-gray-700 text-white flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">${study.title}</h2>
                            <p class="text-sm opacity-80">Protocol #: ${study.protocolNumber || 'N/A'}</p>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${ensureArray(study.indication).map(ind => `<span class="text-xs bg-indigo-500 text-white px-2 py-0.5 rounded-full">${ind}</span>`).join('')}
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button data-action="edit" class="p-2 rounded-full hover:bg-gray-600 transition-colors">${getIcon('edit')}</button>
                            <button data-action="delete" class="p-2 rounded-full hover:bg-red-500 transition-colors">${getIcon('trash')}</button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-4 text-sm text-gray-600 dark:text-gray-400">
                            <strong>Dates:</strong> ${startDate} - ${endDate}
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Overall Statistics</h3>
                            <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Enrollment</p>
                                    <p class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">${enrolledPatients} / ${target}</p>
                                    <div class="mt-2 h-2 w-full progress-bar">
                                        <div class="progress-bar-fill" style="width: ${enrollmentPercentage}%;"></div>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${enrollmentPercentage}% of Goal</p>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg flex flex-col justify-center">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Number of Sites</p>
                                    <p class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">${sitesInStudy.length}</p>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg flex flex-col justify-center">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Status</p>
                                    <p class="text-2xl font-bold ${statusColor}">${study.status}</p>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg flex flex-col justify-center">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Screen Fail Rate</p>
                                    <p class="text-2xl font-bold text-red-600 dark:text-red-400">${screenFailRate}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2 flex items-center">
                                ${getIcon('clock')}
                                <span class="ml-2">Washout Statistics</span>
                            </h3>
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                                <div id="washout-stats-${study.id}" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <!-- Washout statistics will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2 flex items-center">
                                ${getIcon('building')}
                                <span class="ml-2">Participating Sites</span>
                            </h3>
                            <div class="space-y-4">
                                ${sitesInStudy.length > 0 ? sitesInStudy.map(site => {
                                    const siteStudyPatients = allPatients.filter(p => {
                                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                                        return currentEnrollment?.siteId === site.id && currentEnrollment?.studyId === study.id;
                                    });
                                    const siteEnrolled = siteStudyPatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
                                    const siteScreenFailed = siteStudyPatients.filter(p => p.status && p.status.toLowerCase() === 'screen fail').length;
                                    const siteTotalScreened = siteEnrolled + siteScreenFailed;
                                    const siteScreenFailRate = siteTotalScreened > 0 ? Math.round((siteScreenFailed / siteTotalScreened) * 100) : 0;

                                    return `
                                    <div class="p-4 border dark:border-gray-700 rounded-lg bg-white dark:bg-gray-700/50">
                                        <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start">
                                            <div class="mb-2 md:mb-0">
                                                <p class="font-bold text-gray-900 dark:text-gray-100">${site.name}</p>
                                                <div class="flex flex-wrap gap-1 mt-1">
                                                    ${ensureArray(site.indication).map(ind => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${ind}</span>`).join('')}
                                                </div>
                                            </div>
                                            <div class="flex space-x-4 text-right">
                                                <div>
                                                    <p class="text-sm text-gray-600 dark:text-gray-400">Enrollment</p>
                                                    <p class="font-semibold text-lg text-indigo-600 dark:text-indigo-400">${siteEnrolled}</p>
                                                </div>
                                                <div>
                                                    <p class="text-sm text-gray-600 dark:text-gray-400">SF Rate</p>
                                                    <p class="font-semibold text-lg text-red-600 dark:text-red-400">${siteScreenFailRate}%</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `}).join('') : '<p class="text-sm text-gray-500 dark:text-gray-400 italic mt-3">No sites are assigned to this study yet. Edit the study to add sites.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const calculateWashoutInfo = (studyId) => {
            const study = allStudies.find(s => s.id === studyId);
            if (!study) return;

            const washoutDays = study.washoutDays || 30;
            
            // Get patients who have completed this study and are in washout
            const washoutPatients = allPatients.filter(p => {
                const pastEnrollments = p.enrollments?.filter(e => e.status === 'past') || [];
                const studyEnrollment = pastEnrollments.find(e => e.studyId === studyId);
                return studyEnrollment && studyEnrollment.exitedDate;
            });

            const washoutStatsContainer = document.getElementById(`washout-stats-${studyId}`);
            if (!washoutStatsContainer) return;

            if (washoutPatients.length === 0) {
                washoutStatsContainer.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 dark:text-gray-400">
                        <p>No patients in washout period</p>
                    </div>
                `;
                return;
            }

            // Calculate statistics
            const today = new Date();
            let inWashout = 0;
            let eligible = 0;
            let avgDaysRemaining = 0;
            let totalDaysRemaining = 0;

            washoutPatients.forEach(patient => {
                const pastEnrollments = patient.enrollments?.filter(e => e.status === 'past') || [];
                const studyEnrollment = pastEnrollments.find(e => e.studyId === studyId);
                
                if (studyEnrollment && studyEnrollment.exitedDate) {
                    const exitDate = new Date(studyEnrollment.exitedDate);
                    const washoutCompleteDate = new Date(exitDate);
                    washoutCompleteDate.setDate(washoutCompleteDate.getDate() + washoutDays);
                    
                    const diffMs = washoutCompleteDate.getTime() - today.getTime();
                    const daysRemaining = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (daysRemaining > 0) {
                        inWashout++;
                        totalDaysRemaining += daysRemaining;
                    } else {
                        eligible++;
                    }
                }
            });

            avgDaysRemaining = inWashout > 0 ? Math.round(totalDaysRemaining / inWashout) : 0;

            washoutStatsContainer.innerHTML = `
                <div class="text-center">
                    <p class="text-lg font-bold text-yellow-600 dark:text-yellow-400">${inWashout}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">In Washout</p>
                </div>
                <div class="text-center">
                    <p class="text-lg font-bold text-green-600 dark:text-green-400">${eligible}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Eligible</p>
                </div>
                <div class="text-center">
                    <p class="text-lg font-bold text-blue-600 dark:text-blue-400">${avgDaysRemaining}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Avg Days Left</p>
                </div>
                <div class="text-center">
                    <p class="text-lg font-bold text-purple-600 dark:text-purple-400">${washoutDays}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Washout Period</p>
                </div>
            `;
        };

        const updateAllWashoutInfo = () => {
            allStudies.forEach(study => {
                calculateWashoutInfo(study.id);
            });
        };


        // Function to check if a patient is eligible for a study based on washout status
        const isPatientEligibleForStudy = (patientId, studyId) => {
            const patient = allPatients.find(p => p.id === patientId);
            const study = allStudies.find(s => s.id === studyId);
            
            if (!patient || !study) return false;
            
            const washoutDays = study.washoutDays || 30;
            const pastEnrollments = patient.enrollments?.filter(e => e.status === 'past') || [];
            
            // Check if patient has any past enrollments that are still in washout
            for (const enrollment of pastEnrollments) {
                if (enrollment.exitedDate) {
                    const exitDate = new Date(enrollment.exitedDate);
                    const washoutCompleteDate = new Date(exitDate);
                    washoutCompleteDate.setDate(washoutCompleteDate.getDate() + washoutDays);
                    
                    const today = new Date();
                    if (today < washoutCompleteDate) {
                        return false; // Patient is still in washout
                    }
                }
            }
            
            return true; // Patient is eligible
        };
        
        const renderAllSites = (sitesToRender = allSites) => {
            const sitesTableBody = document.getElementById('sites-table-body');
            if(sitesTableBody) {
                if (sitesToRender.length === 0) {
                    sitesTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500 dark:text-gray-400">No sites found.</td></tr>`;
                    return;
                }
                sitesTableBody.innerHTML = sitesToRender.map(site => {
                    const sitePatients = allPatients.filter(p => {
                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                        return currentEnrollment?.siteId === site.id;
                    });
                    const enrolled = sitePatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
                    const screenFailed = sitePatients.filter(p => p.status && p.status.toLowerCase() === 'screen fail').length;
                    const totalScreened = enrolled + screenFailed;
                    const screenFailRate = totalScreened > 0 ? Math.round((screenFailed / totalScreened) * 100) : 0;

                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><input type="checkbox" data-id="${site.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 site-checkbox"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${site.status || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">${site.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${site.pi || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <div class="flex flex-wrap gap-1">
                                    ${ensureArray(site.indication).map(ind => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${ind}</span>`).join('')}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${screenFailRate}%</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                                <button data-action="edit-site" data-id="${site.id}" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">Edit</button>
                                <button data-action="delete-site" data-id="${site.id}" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        };

        const renderAllStudies = () => {
            const studiesContainer = document.getElementById('studies-container');
            if (studiesContainer) {
                if (allStudies.length > 0) {
                    studiesContainer.innerHTML = allStudies.map(renderStudyCard).join('');
                    // Update washout information after rendering
                    setTimeout(() => {
                        updateAllWashoutInfo();
                    }, 100);
                } else {
                    studiesContainer.innerHTML = `
                        <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">No studies found.</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding a new clinical study.</p>
                        </div>
                    `;
                }
            }
        };
        
        // --- Dashboard Chart Functions ---
        let studiesByPhaseChart = null;
        let studiesByTherapeuticAreaChart = null;
        let studyStatusChart = null;
        let enrollmentBySiteChart = null;
        let studyProgressChart = null;
        let siteMonitoringChart = null;
        let financesChart = null;

        const renderDashboardCharts = () => {
            const studyFilterId = document.getElementById('dash-study-filter')?.value;
            const siteFilterId = document.getElementById('dash-site-filter')?.value;
            const indicationFilter = document.getElementById('dash-indication-filter')?.value;

            if (!studyFilterId) return; // Exit if filters are not on the page

            // --- Filter Data ---
            let relevantStudies = allStudies;
            if (studyFilterId !== 'all') {
                relevantStudies = relevantStudies.filter(s => s.id === studyFilterId);
            }
            if (siteFilterId !== 'all') {
                 relevantStudies = relevantStudies.filter(s => (s.siteIds || []).includes(siteFilterId));
            }
             if (indicationFilter !== 'all') {
                const sitesWithIndication = new Set(allSites.filter(s => ensureArray(s.indication).includes(indicationFilter)).map(s => s.id));
                relevantStudies = relevantStudies.filter(s => 
                    ensureArray(s.indication).includes(indicationFilter) || 
                    (s.siteIds || []).some(siteId => sitesWithIndication.has(siteId))
                );
            }
            
            const relevantStudyIds = new Set(relevantStudies.map(s => s.id));
            
            let relevantSites = allSites;
             if (studyFilterId !== 'all') {
                const study = allStudies.find(s => s.id === studyFilterId);
                if(study) {
                    relevantSites = relevantSites.filter(s => (study.siteIds || []).includes(s.id));
                }
            }
            
            const relevantSiteIds = new Set(relevantSites.map(s => s.id));
            
            let patientsForCharts = allPatients.filter(p => {
                const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                return currentEnrollment && relevantStudyIds.has(currentEnrollment.studyId);
            });
            if(siteFilterId !== 'all'){
                 patientsForCharts = patientsForCharts.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment?.siteId === siteFilterId;
                });
            }


            updateDashboardStats(relevantStudies, relevantSites, patientsForCharts);

            // --- 1. Studies by Phase Chart (Doughnut) ---
            const studiesByPhaseCtx = document.getElementById('studies-by-phase-chart')?.getContext('2d');
            if (studiesByPhaseCtx) {
                if (studiesByPhaseChart) studiesByPhaseChart.destroy();
                
                const phaseData = relevantStudies.reduce((acc, study) => {
                    const phase = study.phase || 'Unknown';
                    acc[phase] = (acc[phase] || 0) + 1;
                    return acc;
                }, {});
                
                studiesByPhaseChart = new Chart(studiesByPhaseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(phaseData),
                        datasets: [{
                            data: Object.values(phaseData),
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(236, 72, 153, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // --- 2. Studies by Therapeutic Area Chart (Doughnut) ---
            const studiesByTherapeuticAreaCtx = document.getElementById('studies-by-therapeutic-area-chart')?.getContext('2d');
            if (studiesByTherapeuticAreaCtx) {
                if (studiesByTherapeuticAreaChart) studiesByTherapeuticAreaChart.destroy();
                
                const therapeuticAreaData = relevantStudies.reduce((acc, study) => {
                    const areas = ensureArray(study.indication);
                    areas.forEach(area => {
                        acc[area] = (acc[area] || 0) + 1;
                    });
                    return acc;
                }, {});
                
                studiesByTherapeuticAreaChart = new Chart(studiesByTherapeuticAreaCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(therapeuticAreaData),
                        datasets: [{
                            data: Object.values(therapeuticAreaData),
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(236, 72, 153, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // --- 3. Study Status Chart (Bar) ---
            const studyStatusCtx = document.getElementById('study-status-chart')?.getContext('2d');
            if (studyStatusCtx) {
                if (studyStatusChart) studyStatusChart.destroy();
                
                const statusData = relevantStudies.reduce((acc, study) => {
                    const status = study.status || 'Unknown';
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});
                
                studyStatusChart = new Chart(studyStatusCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(statusData),
                        datasets: [{
                            label: 'Number of Studies',
                            data: Object.values(statusData),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // --- 4. Enrollment by Site Chart (Bar) ---
            const enrollmentBySiteCtx = document.getElementById('enrollment-by-site-chart')?.getContext('2d');
            if (enrollmentBySiteCtx) {
                if (enrollmentBySiteChart) enrollmentBySiteChart.destroy();
                
                const siteEnrollmentData = relevantSites.map(site => {
                    return patientsForCharts.filter(p => {
                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                        return currentEnrollment?.siteId === site.id && p.status && p.status.toLowerCase() === 'enrolled';
                    }).length;
                });
                
                enrollmentBySiteChart = new Chart(enrollmentBySiteCtx, {
                    type: 'bar',
                    data: {
                        labels: relevantSites.map(s => s.name),
                        datasets: [{
                            label: 'Enrolled Patients',
                            data: siteEnrollmentData,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // --- 5. Study Progress Chart (Horizontal Bar) ---
            const studyProgressCtx = document.getElementById('study-progress-chart')?.getContext('2d');
            if (studyProgressCtx) {
                if (studyProgressChart) studyProgressChart.destroy();
                
                const studyProgressData = relevantStudies.map(study => {
                    const enrolled = patientsForCharts.filter(p => {
                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                        return currentEnrollment?.studyId === study.id && p.status && p.status.toLowerCase() === 'enrolled';
                    }).length;
                    const target = study.target || 100;
                    return Math.min((enrolled / target) * 100, 100);
                });
                
                studyProgressChart = new Chart(studyProgressCtx, {
                    type: 'bar',
                    data: {
                        labels: relevantStudies.map(s => s.title),
                        datasets: [{
                            label: 'Progress (%)',
                            data: studyProgressData,
                            backgroundColor: 'rgba(139, 92, 246, 0.8)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // --- 6. Site Monitoring Chart (Doughnut) ---
            const siteMonitoringCtx = document.getElementById('site-monitoring-chart')?.getContext('2d');
            if (siteMonitoringCtx) {
                if (siteMonitoringChart) siteMonitoringChart.destroy();
                
                const activeSites = relevantSites.filter(s => s.status === 'Active').length;
                const inactiveSites = relevantSites.filter(s => s.status === 'Inactive').length;
                
                siteMonitoringChart = new Chart(siteMonitoringCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active Sites', 'Inactive Sites'],
                        datasets: [{
                            data: [activeSites, inactiveSites],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(107, 114, 128, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // --- 7. Finances Chart (Bar) ---
            const financesCtx = document.getElementById('finances-chart')?.getContext('2d');
            if (financesCtx) {
                if (financesChart) financesChart.destroy();
                
                // Placeholder data - you can replace with actual financial data
                const budgetData = relevantStudies.map(study => study.budget || 0);
                const spentData = relevantStudies.map(study => study.spent || 0);
                
                financesChart = new Chart(financesCtx, {
                    type: 'bar',
                    data: {
                        labels: relevantStudies.map(s => s.title),
                        datasets: [
                            {
                                label: 'Budget',
                                data: budgetData,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)'
                            },
                            {
                                label: 'Spent',
                                data: spentData,
                                backgroundColor: 'rgba(239, 68, 68, 0.8)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // Initialize map when dashboard is rendered
            setTimeout(() => {
                setupMapEventHandlers();
                initializeMap();
            }, 100);
        };

        // --- Map Functionality ---
        let leafletMap = null;
        let googleMap = null;
        let bingMap = null;
        let currentMapType = 'leaflet';
        let currentMapView = 'sites';

        const initializeMap = () => {
            const mapType = document.getElementById('map-type-selector')?.value || 'leaflet';
            const mapView = document.getElementById('map-view-selector')?.value || 'sites';
            
            currentMapType = mapType;
            currentMapView = mapView;
            
            // Hide all map containers first
            document.getElementById('leaflet-map')?.classList.add('hidden');
            document.getElementById('google-map')?.classList.add('hidden');
            document.getElementById('bing-map')?.classList.add('hidden');
            document.getElementById('map-fallback')?.classList.add('hidden');
            
            if (mapType === 'leaflet') {
                initializeLeafletMap();
            } else if (mapType === 'google') {
                initializeGoogleMap();
            } else if (mapType === 'bing') {
                initializeBingMap();
            }
        };

        const initializeLeafletMap = () => {
            const leafletMapContainer = document.getElementById('leaflet-map');
            if (!leafletMapContainer) return;
            
            leafletMapContainer.classList.remove('hidden');
            
            // Initialize Leaflet map
            leafletMap = L.map('leaflet-map').setView([39.8283, -98.5795], 4);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(leafletMap);
            
            // Add dark mode tiles if in dark theme
            if (document.documentElement.classList.contains('dark')) {
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
                    maxZoom: 19,
                    subdomains: 'abcd'
                }).addTo(leafletMap);
            }
            
            loadMapMarkers();
        };

        const initializeGoogleMap = () => {
            const googleMapContainer = document.getElementById('google-map');
            if (!googleMapContainer) return;
            
            googleMapContainer.classList.remove('hidden');
            
            // Load Google Maps API if not already loaded
            if (typeof google === 'undefined' || !google.maps) {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initGoogleMap`;
                script.async = true;
                script.defer = true;
                window.initGoogleMap = initGoogleMap;
                document.head.appendChild(script);
            } else {
                initGoogleMap();
            }
        };

        const initGoogleMap = () => {
            const googleMapContainer = document.getElementById('google-map');
            if (!googleMapContainer || !google.maps) return;
            
            // Default center (you can modify this based on your sites)
            const defaultCenter = { lat: 39.8283, lng: -98.5795 }; // Center of USA
            
            googleMap = new google.maps.Map(googleMapContainer, {
                zoom: 4,
                center: defaultCenter,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: document.documentElement.classList.contains('dark') ? [
                    { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] }
                ] : []
            });
            
            loadMapMarkers();
        };

        const initializeBingMap = () => {
            const bingMapContainer = document.getElementById('bing-map');
            if (!bingMapContainer) return;
            
            bingMapContainer.classList.remove('hidden');
            
            // Load Bing Maps API if not already loaded
            if (typeof Microsoft === 'undefined' || !Microsoft.Maps) {
                const script = document.createElement('script');
                script.src = `https://www.bing.com/api/maps/mapcontrol?key=YOUR_BING_MAPS_API_KEY&callback=initBingMap`;
                script.async = true;
                script.defer = true;
                window.initBingMap = initBingMap;
                document.head.appendChild(script);
            } else {
                initBingMap();
            }
        };

        const initBingMap = () => {
            const bingMapContainer = document.getElementById('bing-map');
            if (!bingMapContainer || !Microsoft.Maps) return;
            
            bingMap = new Microsoft.Maps.Map(bingMapContainer, {
                credentials: 'YOUR_BING_MAPS_API_KEY',
                center: new Microsoft.Maps.Location(39.8283, -98.5795),
                zoom: 4,
                mapTypeId: Microsoft.Maps.MapTypeId.road
            });
            
            loadMapMarkers();
        };

        const loadMapMarkers = () => {
            if (!leafletMap && !googleMap && !bingMap) return;
            
            // Clear existing markers
            if (leafletMap) {
                leafletMap.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        leafletMap.removeLayer(layer);
                    }
                });
            }
            if (googleMap) {
                // Google Maps markers would be cleared here
            }
            if (bingMap) {
                // Bing Maps markers would be cleared here
            }
            
            const sites = allSites.filter(site => site.latitude && site.longitude);
            const markers = [];
            
            sites.forEach(site => {
                const lat = parseFloat(site.latitude);
                const lng = parseFloat(site.longitude);
                
                if (isNaN(lat) || isNaN(lng)) return;
                
                // Get site statistics
                const sitePatients = allPatients.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment?.siteId === site.id;
                });
                
                const enrolledCount = sitePatients.filter(p => p.status && p.status.toLowerCase() === 'enrolled').length;
                const studiesAtSite = allStudies.filter(s => (s.siteIds || []).includes(site.id));
                
                // Create marker based on map type
                if (leafletMap && currentMapType === 'leaflet') {
                    const marker = L.marker([lat, lng]).addTo(leafletMap);
                    
                    // Create custom icon for Leaflet
                    const iconHtml = createLeafletIcon(site, enrolledCount, studiesAtSite.length);
                    const customIcon = L.divIcon({
                        html: iconHtml,
                        className: 'custom-div-icon',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    marker.setIcon(customIcon);
                    
                    const popupContent = createInfoWindowContent(site, enrolledCount, studiesAtSite);
                    marker.bindPopup(popupContent);
                    
                    markers.push(marker);
                } else if (googleMap && currentMapType === 'google') {
                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        map: googleMap,
                        title: `${site.name} - ${enrolledCount} enrolled`,
                        icon: {
                            url: getMarkerIcon(site, enrolledCount, studiesAtSite.length),
                            scaledSize: new google.maps.Size(32, 32)
                        }
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: createInfoWindowContent(site, enrolledCount, studiesAtSite)
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(googleMap, marker);
                    });
                    
                    markers.push(marker);
                } else if (bingMap && currentMapType === 'bing') {
                    const marker = new Microsoft.Maps.Pushpin(
                        new Microsoft.Maps.Location(lat, lng),
                        {
                            title: `${site.name} - ${enrolledCount} enrolled`,
                            icon: getMarkerIcon(site, enrolledCount, studiesAtSite.length)
                        }
                    );
                    
                    Microsoft.Maps.Events.addHandler(marker, 'click', () => {
                        const infoBox = new Microsoft.Maps.Infobox(
                            new Microsoft.Maps.Location(lat, lng),
                            {
                                title: site.name,
                                description: createInfoWindowContent(site, enrolledCount, studiesAtSite)
                            }
                        );
                        infoBox.setMap(bingMap);
                    });
                    
                    bingMap.entities.push(marker);
                }
            });
            
            // Fit map to show all markers
            if (markers.length > 0) {
                if (leafletMap && currentMapType === 'leaflet') {
                    const group = new L.featureGroup(markers);
                    leafletMap.fitBounds(group.getBounds().pad(0.1));
                } else if (googleMap && currentMapType === 'google') {
                    const bounds = new google.maps.LatLngBounds();
                    markers.forEach(marker => bounds.extend(marker.getPosition()));
                    googleMap.fitBounds(bounds);
                }
            }
        };

        const createLeafletIcon = (site, enrolledCount, studyCount) => {
            // Return different colors based on current view
            let color = '#3b82f6'; // Default blue
            
            if (currentMapView === 'studies') {
                color = studyCount > 3 ? '#10b981' : studyCount > 1 ? '#f59e0b' : '#ef4444';
            } else if (currentMapView === 'staffing') {
                color = enrolledCount > 20 ? '#10b981' : enrolledCount > 10 ? '#f59e0b' : '#ef4444';
            } else if (currentMapView === 'combined') {
                color = '#8b5cf6'; // Purple for combined view
            }
            
            return `
                <div style="
                    background-color: ${color};
                    border: 2px solid white;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 10px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                ">
                    ${enrolledCount > 99 ? '99+' : enrolledCount}
                </div>
            `;
        };

        const getMarkerIcon = (site, enrolledCount, studyCount) => {
            // Return different icons based on current view
            let color = '#3b82f6'; // Default blue
            
            if (currentMapView === 'studies') {
                color = studyCount > 3 ? '#10b981' : studyCount > 1 ? '#f59e0b' : '#ef4444';
            } else if (currentMapView === 'staffing') {
                color = enrolledCount > 20 ? '#10b981' : enrolledCount > 10 ? '#f59e0b' : '#ef4444';
            } else if (currentMapView === 'combined') {
                color = '#8b5cf6'; // Purple for combined view
            }
            
            // Return a data URL for a colored circle marker
            return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
                <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="12" fill="${color}" stroke="white" stroke-width="2"/>
                    <text x="16" y="20" text-anchor="middle" fill="white" font-size="10" font-weight="bold">
                        ${enrolledCount > 99 ? '99+' : enrolledCount}
                    </text>
                </svg>
            `)}`;
        };

        const createInfoWindowContent = (site, enrolledCount, studies) => {
            const studyNames = studies.map(s => s.title).join(', ');
            return `
                <div class="p-2 max-w-xs">
                    <h3 class="font-semibold text-lg mb-2">${site.name}</h3>
                    <p class="text-sm text-gray-600 mb-1"><strong>Location:</strong> ${site.city || 'N/A'}, ${site.state || 'N/A'}</p>
                    <p class="text-sm text-gray-600 mb-1"><strong>Enrolled:</strong> ${enrolledCount}</p>
                    <p class="text-sm text-gray-600 mb-1"><strong>Studies:</strong> ${studies.length}</p>
                    ${studyNames ? `<p class="text-sm text-gray-600"><strong>Study Names:</strong> ${studyNames}</p>` : ''}
                </div>
            `;
        };

        // Map event handlers
        const setupMapEventHandlers = () => {
            const mapTypeSelector = document.getElementById('map-type-selector');
            const mapViewSelector = document.getElementById('map-view-selector');
            const refreshMapBtn = document.getElementById('refresh-map-btn');
            
            mapTypeSelector?.addEventListener('change', () => {
                initializeMap();
            });
            
            mapViewSelector?.addEventListener('change', () => {
                currentMapView = mapViewSelector.value;
                loadMapMarkers();
            });
            
            refreshMapBtn?.addEventListener('click', () => {
                initializeMap();
            });
        };

        // --- NASA-style Report Filter Handler ---
        const handleNasaStyleReportFilter = (formData) => {
            let filteredPatients = [...allPatients];
            
            // Apply filters
            if (formData.studyId !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.enrollments?.some(e => e.studyId === formData.studyId));
            }
            if (formData.siteId !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.enrollments?.some(e => e.siteId === formData.siteId));
            }
            if (formData.status !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.status === formData.status);
            }
            if (formData.source !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.source === formData.source);
            }
            if (formData.minAge) {
                filteredPatients = filteredPatients.filter(p => p.age >= parseInt(formData.minAge));
            }
            if (formData.maxAge) {
                filteredPatients = filteredPatients.filter(p => p.age <= parseInt(formData.maxAge));
            }
            if (formData.schedulingStatus === 'scheduled') {
                filteredPatients = filteredPatients.filter(p => p.appointment);
            }
            if (formData.schedulingStatus === 'not-scheduled') {
                filteredPatients = filteredPatients.filter(p => !p.appointment);
            }
            if (formData.surveyCompleted) {
                filteredPatients = filteredPatients.filter(p => p.surveyResults && p.surveyResults.length > 0);
            }
            if (formData.surveyOutcome !== 'all') {
                filteredPatients = filteredPatients.filter(p => p.surveyResults?.some(sr => sr.outcome === formData.surveyOutcome));
            }
            if (formData.startDate) {
                filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) >= new Date(formData.startDate));
            }
            if (formData.endDate) {
                filteredPatients = filteredPatients.filter(p => p.appointment && new Date(p.appointment.time) <= new Date(formData.endDate));
            }
            
            // Store filtered data for export
            lastReportData = filteredPatients;
            
            // Update report results table
            const resultsBody = document.getElementById('report-results-body');
            const exportBtn = document.getElementById('export-csv-btn');
            const exportSurveysBtn = document.getElementById('export-surveys-btn');
            
            if (filteredPatients.length > 0) {
                resultsBody.innerHTML = filteredPatients.map(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    const lastSurvey = p.surveyResults && p.surveyResults.length > 0 ? p.surveyResults[p.surveyResults.length - 1] : null;
                    const outcome = lastSurvey ? lastSurvey.outcome : 'N/A';
                    const outcomeColor = outcome === 'Pass' ? 'text-green-500' : outcome === 'Fail' ? 'text-red-500' : '';
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${p.firstName} ${p.lastName}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${p.age || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${p.status || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${currentEnrollment ? allStudies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${currentEnrollment ? allSites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${p.appointment ? new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'Not Scheduled'}</td>
                            <td class="px-6 py-4 whitespace-nowrap font-semibold ${outcomeColor}">${outcome}</td>
                        </tr>
                    `;
                }).join('');
                if (exportBtn) exportBtn.disabled = false;
                if (exportSurveysBtn) exportSurveysBtn.disabled = false;
            } else {
                resultsBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 dark:text-gray-400 py-8">No patients match the selected criteria.</td></tr>`;
                if (exportBtn) exportBtn.disabled = true;
                if (exportSurveysBtn) exportSurveysBtn.disabled = true;
            }
            
            // Calculate and display metrics
            const metricsContainer = document.getElementById('report-metrics');
            const total = filteredPatients.length;
            const avgAge = total > 0 ? (filteredPatients.reduce((sum, p) => sum + (p.age || 0), 0) / filteredPatients.filter(p => p.age).length).toFixed(1) : 'N/A';
            const scheduled = filteredPatients.filter(p => p.appointment).length;
            metricsContainer.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Total Patients</p><p class="text-2xl font-bold dark:text-white">${total}</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Average Age</p><p class="text-2xl font-bold dark:text-white">${avgAge}</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Scheduled</p><p class="text-2xl font-bold dark:text-white">${scheduled}</p></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Not Scheduled</p><p class="text-2xl font-bold dark:text-white">${total - scheduled}</p></div>
            `;
        };

        // --- Reporting Functions ---
        const renderReportTables = () => {
            const studyFilterId = document.getElementById('report-study-filter')?.value;
            const siteFilterId = document.getElementById('report-site-filter')?.value;
            const indicationFilter = document.getElementById('report-indication-filter')?.value;
            
            if (!studyFilterId) { // Function might be called before reporting tab is rendered
                return;
            }

            // Filter studies
            let filteredStudies = allStudies;
            if (studyFilterId !== 'all') {
                filteredStudies = filteredStudies.filter(s => s.id === studyFilterId);
            }
            if (siteFilterId !== 'all') {
                filteredStudies = filteredStudies.filter(s => (s.siteIds || []).includes(siteFilterId));
            }
             if (indicationFilter !== 'all') {
                filteredStudies = filteredStudies.filter(s => ensureArray(s.indication).includes(indicationFilter));
            }
            
            // Filter sites
            let filteredSites = allSites;
            if (siteFilterId !== 'all') {
                filteredSites = filteredSites.filter(s => s.id === siteFilterId);
            }
            if (indicationFilter !== 'all') {
                filteredSites = filteredSites.filter(s => ensureArray(s.indication).includes(indicationFilter));
            }
            if (studyFilterId !== 'all') {
                const study = allStudies.find(s => s.id === studyFilterId);
                const siteIdsInStudy = study ? study.siteIds || [] : [];
                filteredSites = filteredSites.filter(s => siteIdsInStudy.includes(s.id));
            }

            // Render Study Progress Table
            const studiesTableContainer = document.getElementById('report-studies-table-container');
            if (studiesTableContainer) {
                if (filteredStudies.length > 0) {
                    studiesTableContainer.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Enrollment</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Progress</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                ${filteredStudies.map(study => {
                                    const enrolled = allPatients.filter(p => {
                                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                                        return currentEnrollment?.studyId === study.id && p.status && p.status.toLowerCase() === 'enrolled';
                                    }).length;
                                    const target = study.target || 0;
                                    const percentage = target > 0 ? Math.round((enrolled / target) * 100) : 0;
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">${study.title}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${study.status}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${enrolled} / ${target}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">
                                                <div class="w-full progress-bar h-4">
                                                    <div class="progress-bar-fill flex items-center justify-center text-xs text-white" style="width: ${percentage}%">${percentage}%</div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    lastReportData = filteredStudies; // Save for export
                    document.getElementById('export-study-stats-btn').disabled = false;
                } else {
                    studiesTableContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No study data matches the selected filters.</p>`;
                    lastReportData = [];
                    document.getElementById('export-study-stats-btn').disabled = true;
                }
            }
            
            // Render Site Performance Table
            const sitesTableContainer = document.getElementById('report-sites-table-container');
            if (sitesTableContainer) {
                if (filteredSites.length > 0) {
                    sitesTableContainer.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Total Enrolled</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Active Studies</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                ${filteredSites.map(site => {
                                    const enrolled = allPatients.filter(p => {
                                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                                        return currentEnrollment?.siteId === site.id && p.status && p.status.toLowerCase() === 'enrolled';
                                    }).length;
                                    const activeStudies = new Set(allPatients.filter(p => {
                                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                                        return currentEnrollment?.siteId === site.id && currentEnrollment.studyId;
                                    }).map(p => p.enrollments.find(e => e.status === 'current').studyId)).size;
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">${site.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${enrolled}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${activeStudies}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    sitesTableContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No site data matches the selected filters.</p>`;
                }
            }

            // Render Washout Patients Table
            const washoutTableContainer = document.getElementById('report-washout-table-container');
            if (washoutTableContainer) {
                const washoutPatients = getAllWashoutPatients(filteredStudies);
                if (washoutPatients.length > 0) {
                    washoutTableContainer.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Exit Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Washout Complete</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Days Remaining</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                ${washoutPatients.map(patient => {
                                    const pastEnrollments = patient.enrollments?.filter(e => e.status === 'past') || [];
                                    const study = allStudies.find(s => s.id === patient.studyId);
                                    const enrollment = pastEnrollments.find(e => e.studyId === patient.studyId);
                                    
                                    const exitDate = new Date(enrollment.exitedDate);
                                    const washoutCompleteDate = new Date(exitDate);
                                    washoutCompleteDate.setDate(washoutCompleteDate.getDate() + (study.washoutDays || 30));
                                    
                                    const today = new Date();
                                    const diffMs = washoutCompleteDate.getTime() - today.getTime();
                                    const daysRemaining = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                                    
                                    const isEligible = daysRemaining <= 0;
                                    const statusColor = isEligible ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400';
                                    const statusText = isEligible ? 'Eligible' : `${daysRemaining} days`;
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">${patient.firstName} ${patient.lastName}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${study?.title || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${exitDate.toLocaleDateString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${washoutCompleteDate.toLocaleDateString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${Math.max(0, daysRemaining)}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="font-semibold ${statusColor}">${statusText}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('export-washout-btn').disabled = false;
                } else {
                    washoutTableContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No patients currently in washout period.</p>`;
                    document.getElementById('export-washout-btn').disabled = true;
                }
            }

            // Render All Participants Table
            const participantsTableContainer = document.getElementById('report-participants-table-container');
            if (participantsTableContainer) {
                // Create a set of relevant study IDs from filtered studies
                const relevantStudyIds = new Set(filteredStudies.map(s => s.id));
                const allParticipants = allPatients.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment && relevantStudyIds.has(currentEnrollment.studyId);
                });

                if (allParticipants.length > 0) {
                    participantsTableContainer.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Patient Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Study</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Site</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Enrolled Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Phone</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                ${allParticipants.map(patient => {
                                    const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
                                    const study = allStudies.find(s => s.id === currentEnrollment?.studyId);
                                    const site = allSites.find(s => s.id === currentEnrollment?.siteId);
                                    
                                    return `
                                        <tr class="dark:text-gray-300">
                                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-gray-100">${patient.firstName} ${patient.lastName}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${study?.title || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${site?.name || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${patient.status || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${currentEnrollment?.enrolledDate ? new Date(currentEnrollment.enrolledDate).toLocaleDateString() : 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${patient.email || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-400">${patient.phoneNumber || 'N/A'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('export-participants-btn').disabled = false;
                } else {
                    participantsTableContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-8">No participants found with the current filters.</p>`;
                    document.getElementById('export-participants-btn').disabled = true;
                }
            }
        };
        
        const exportReportToCSV = () => {
            if (lastReportData.length === 0) {
                console.log("No data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Study Title", "Protocol Number", "Status", "Indications", "Start Date", "End Date", "Enrolled Patients", "Target Enrollment", "Enrollment Percentage"];
            csvContent += headers.join(",") + "\r\n";

            lastReportData.forEach(study => {
                const enrolled = allPatients.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment?.studyId === study.id && p.status && p.status.toLowerCase() === 'enrolled';
                }).length;
                const target = study.target || 0;
                const percentage = target > 0 ? Math.round((enrolled / target) * 100) : 0;
                const row = [
                    `"${study.title}"`,
                    `"${study.protocolNumber || 'N/A'}"`,
                    study.status,
                    `"${ensureArray(study.indication).join('|')}"`,
                    study.startDate || 'N/A',
                    study.endDate || 'N/A',
                    enrolled,
                    target,
                    `${percentage}%`
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "study_progress_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const exportWashoutToCSV = () => {
            const washoutPatients = getAllWashoutPatients(allStudies);
            if (washoutPatients.length === 0) {
                console.log("No washout data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Patient Name", "Study", "Exit Date", "Washout Complete Date", "Days Remaining", "Status", "Email", "Phone"];
            csvContent += headers.join(",") + "\r\n";

            washoutPatients.forEach(patient => {
                const study = allStudies.find(s => s.id === patient.studyId);
                const exitDate = new Date(patient.exitDate);
                const washoutCompleteDate = new Date(patient.washoutCompleteDate);
                const isEligible = patient.daysRemaining <= 0;
                const status = isEligible ? 'Eligible' : `${patient.daysRemaining} days remaining`;
                
                const row = [
                    `"${patient.firstName} ${patient.lastName}"`,
                    `"${study?.title || 'N/A'}"`,
                    exitDate.toLocaleDateString(),
                    washoutCompleteDate.toLocaleDateString(),
                    patient.daysRemaining,
                    status,
                    `"${patient.email || 'N/A'}"`,
                    `"${patient.phoneNumber || 'N/A'}"`
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "washout_patients_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const exportParticipantsToCSV = () => {
            const allParticipants = allPatients.filter(p => {
                const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                return currentEnrollment;
            });

            if (allParticipants.length === 0) {
                console.log("No participants data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Patient Name", "Study", "Site", "Status", "Enrolled Date", "Email", "Phone", "DOB", "Age"];
            csvContent += headers.join(",") + "\r\n";

            allParticipants.forEach(patient => {
                const currentEnrollment = patient.enrollments?.find(e => e.status === 'current');
                const study = allStudies.find(s => s.id === currentEnrollment?.studyId);
                const site = allSites.find(s => s.id === currentEnrollment?.siteId);
                
                const row = [
                    `"${patient.firstName} ${patient.lastName}"`,
                    `"${study?.title || 'N/A'}"`,
                    `"${site?.name || 'N/A'}"`,
                    patient.status || 'N/A',
                    currentEnrollment?.enrolledDate ? new Date(currentEnrollment.enrolledDate).toLocaleDateString() : 'N/A',
                    `"${patient.email || 'N/A'}"`,
                    `"${patient.phoneNumber || 'N/A'}"`,
                    patient.dob || 'N/A',
                    patient.age || 'N/A'
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "participants_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- NASA-style Export Functions ---
        const exportToCSV = () => {
            try {
                const patients = lastReportData;
                if (!patients || patients.length === 0) {
                    showNotification("Please generate a report before exporting.", "info");
                    return;
                }
                
                const headers = ["Name", "Age", "Status", "Study", "Site", "Appointment", "Survey Outcome"];
                const csvRows = [headers.join(',')];
                
                for (const p of patients) {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    const lastSurvey = p.surveyResults && p.surveyResults.length > 0 ? p.surveyResults[p.surveyResults.length - 1] : null;
                    const outcome = lastSurvey ? lastSurvey.outcome : 'N/A';
                    
                    const row = [
                        `"${p.firstName} ${p.lastName}"`,
                        `"${p.age || 'N/A'}"`,
                        `"${p.status || 'N/A'}"`,
                        `"${currentEnrollment ? allStudies.find(s => s.id === currentEnrollment.studyId)?.title || 'N/A' : 'N/A'}"`,
                        `"${currentEnrollment ? allSites.find(s => s.id === currentEnrollment.siteId)?.name || 'N/A' : 'N/A'}"`,
                        `"${p.appointment ? new Date(p.appointment.time).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'Not Scheduled'}"`,
                        `"${outcome}"`
                    ];
                    csvRows.push(row.join(','));
                }
                
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const date = new Date().toISOString().split('T')[0];
                link.setAttribute("download", `report_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification("Report exported successfully!", "success");
            } catch (error) {
                console.error("Failed to export report CSV:", error);
                showNotification("Failed to export report. See console for details.", "error");
            }
        };

        const exportSurveysToCSV = () => {
            try {
                const patients = lastReportData;
                if (!patients || patients.length === 0) {
                    showNotification("Please generate a report before exporting survey results.", "info");
                    return;
                }
                
                const headers = ["PatientID", "PatientName", "SurveyTitle", "CompletionDate", "Outcome", "Question", "Answer"];
                const csvRows = [headers.join(',')];
                
                for (const p of patients) {
                    if (p.surveyResults && p.surveyResults.length > 0) {
                        for (const result of p.surveyResults) {
                            if (result.answers && result.answers.length > 0) {
                                for (const answer of result.answers) {
                                    csvRows.push([
                                        `"${p.id}"`,
                                        `"${p.firstName} ${p.lastName}"`,
                                        `"${(result.surveyTitle || '').replace(/"/g, '""')}"`,
                                        `"${new Date(result.completedAt).toISOString()}"`,
                                        `"${(result.outcome || 'N/A').replace(/"/g, '""')}"`,
                                        `"${(answer.question || '').replace(/"/g, '""')}"`,
                                        `"${(answer.answer || '').replace(/"/g, '""')}"`
                                    ].join(','));
                                }
                            } else {
                                csvRows.push([
                                    `"${p.id}"`,
                                    `"${p.firstName} ${p.lastName}"`,
                                    `"${(result.surveyTitle || '').replace(/"/g, '""')}"`,
                                    `"${new Date(result.completedAt).toISOString()}"`,
                                    `"${(result.outcome || 'N/A').replace(/"/g, '""')}"`,
                                    `"N/A"`,
                                    `"N/A"`
                                ].join(','));
                            }
                        }
                    }
                }
                
                if (csvRows.length <= 1) {
                    showNotification("No survey results found for the patients in the current report.", "info");
                    return;
                }
                
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                const date = new Date().toISOString().split('T')[0];
                const filename = `survey_results_${date}.csv`;
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                try {
                    link.click();
                    showNotification(`CSV generated. Download '${filename}' should begin.`, "success");
                } catch (clickError) {
                    console.error("Error triggering download link click:", clickError);
                    showNotification("Could not trigger download. Please check browser console.", "error");
                }
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Failed to export survey CSV:", error);
                showNotification("Failed to export surveys. See console for details.", "error");
            }
        };



        // --- Modal Functions ---
        const showModal = (content) => {
            modalContainer.innerHTML = content;
            if (modalContainer.firstChild) {
                modalContainer.firstChild.style.display = 'flex';
            }
        };

        const closeModal = () => {
            modalContainer.innerHTML = '';
        };

        const geocodeAddress = async () => {
            const address1 = document.getElementById('address1')?.value || '';
            const city = document.getElementById('city')?.value || '';
            const state = document.getElementById('state')?.value || '';
            const zipCode = document.getElementById('zipCode')?.value || '';
            const country = document.getElementById('country')?.value || 'USA';
            
            // Build the full address string
            const fullAddress = [address1, city, state, zipCode, country].filter(Boolean).join(', ');
            
            if (!fullAddress) {
                showNotification('Please fill in at least the address, city, or state fields first.', 'error');
                return;
            }
            
            const geocodeBtn = document.getElementById('geocode-address-btn');
            const originalText = geocodeBtn.innerHTML;
            geocodeBtn.innerHTML = '⏳ Getting coordinates...';
            geocodeBtn.disabled = true;
            
            try {
                // Use Nominatim (OpenStreetMap's free geocoding service)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`, {
                    headers: {
                        'User-Agent': 'ARTEMIS Clinical Trial Management System'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Geocoding service unavailable');
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const location = data[0];
                    document.getElementById('latitude').value = parseFloat(location.lat).toFixed(6);
                    document.getElementById('longitude').value = parseFloat(location.lon).toFixed(6);
                    showNotification(`✅ Coordinates found! Lat: ${location.lat}, Lon: ${location.lon}`, 'success');
                } else {
                    showNotification('Could not find coordinates for this address. Please enter them manually or try a different address format.', 'error');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                showNotification('Error getting coordinates. Please try again or enter them manually.', 'error');
            } finally {
                geocodeBtn.innerHTML = originalText;
                geocodeBtn.disabled = false;
            }
        };

        const syncAllSiteCoordinates = async () => {
            // Find all sites that have addresses but missing coordinates
            const sitesToSync = allSites.filter(site => {
                const hasAddress = (site.address1 || site.city || site.state);
                const missingCoords = !site.latitude || !site.longitude;
                return hasAddress && missingCoords;
            });
            
            if (sitesToSync.length === 0) {
                showNotification('All sites already have coordinates! 🎉', 'success');
                return;
            }
            
            const confirmed = confirm(`Found ${sitesToSync.length} site(s) without coordinates.\n\nThis will automatically geocode all of them using their addresses.\n\nNote: There will be a 1-second delay between each request to respect the geocoding service limits.\n\nContinue?`);
            
            if (!confirmed) return;
            
            showNotification(`Starting bulk geocoding for ${sitesToSync.length} sites...`, 'info');
            
            let successCount = 0;
            let failCount = 0;
            const results = [];
            
            for (let i = 0; i < sitesToSync.length; i++) {
                const site = sitesToSync[i];
                
                try {
                    // Build address string
                    const fullAddress = [
                        site.address1,
                        site.city,
                        site.state,
                        site.zipCode,
                        site.country || 'USA'
                    ].filter(Boolean).join(', ');
                    
                    showNotification(`Geocoding ${i + 1}/${sitesToSync.length}: ${site.name}...`, 'info');
                    
                    // Call geocoding service
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`, {
                        headers: {
                            'User-Agent': 'ARTEMIS Clinical Trial Management System'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Geocoding service unavailable');
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const location = data[0];
                        const latitude = parseFloat(location.lat);
                        const longitude = parseFloat(location.lon);
                        
                        // Update site in Firestore
                        const siteRef = doc(db, 'sites', site.id);
                        await setDoc(siteRef, {
                            latitude: latitude,
                            longitude: longitude
                        }, { merge: true });
                        
                        successCount++;
                        results.push({ site: site.name, status: 'success', lat: latitude, lon: longitude });
                    } else {
                        failCount++;
                        results.push({ site: site.name, status: 'failed', reason: 'No coordinates found' });
                    }
                    
                    // Wait 1 second between requests to respect rate limits
                    if (i < sitesToSync.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                } catch (error) {
                    console.error(`Error geocoding ${site.name}:`, error);
                    failCount++;
                    results.push({ site: site.name, status: 'failed', reason: error.message });
                }
            }
            
            // Show final results
            const resultMessage = `
Bulk Geocoding Complete!

✅ Success: ${successCount} site(s)
❌ Failed: ${failCount} site(s)

${results.map(r => {
    if (r.status === 'success') {
        return `✓ ${r.site}: ${r.lat.toFixed(4)}, ${r.lon.toFixed(4)}`;
    } else {
        return `✗ ${r.site}: ${r.reason}`;
    }
}).join('\n')}
            `.trim();
            
            if (successCount > 0) {
                showNotification(`✅ Successfully geocoded ${successCount} site(s)! Check the map on the Dashboard.`, 'success');
            }
            
            if (failCount > 0) {
                showNotification(`⚠️ ${failCount} site(s) could not be geocoded. Check console for details.`, 'error');
            }
            
            console.log('Bulk Geocoding Results:', resultMessage);
            alert(resultMessage);
        };

        const renderSiteAssignmentList = (selectedIndications = [], assignedSiteIds = []) => {
            const siteAssignmentContainer = document.getElementById('site-assignment-container');
            if (!siteAssignmentContainer) return;
            
            // Debug logging
            console.log('Rendering site assignment list with:', {
                selectedIndications,
                assignedSiteIds,
                allSites: allSites.length
            });

            const suggestedSites = [];
            const otherSites = [];

            // If no indications are selected, all sites are "other sites"
            if (selectedIndications.length === 0) {
                otherSites.push(...allSites);
            } else {
                allSites.forEach(site => {
                    const siteIndications = ensureArray(site.indication);
                    const isSuggested = selectedIndications.some(ind => siteIndications.includes(ind));
                    if (isSuggested) {
                        suggestedSites.push(site);
                    } else {
                        otherSites.push(site);
                    }
                });
            }

            const createSiteCheckbox = (site) => {
                const isChecked = assignedSiteIds.includes(site.id);
                console.log(`Site ${site.name} (${site.id}): checked=${isChecked}, assignedSiteIds=`, assignedSiteIds);
                return `
                    <label class="flex items-center">
                        <input type="checkbox" name="siteIds" value="${site.id}" class="site-checkbox h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600" ${isChecked ? 'checked' : ''}>
                        <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">${site.name}</span>
                    </label>
                `;
            };

            let html = '';
            if (suggestedSites.length > 0) {
                html += `<h4 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mt-2">Suggested Sites</h4>`;
                html += suggestedSites.map(createSiteCheckbox).join('');
            }

            if (otherSites.length > 0) {
                html += `<h4 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mt-2 ${suggestedSites.length > 0 ? 'pt-2 border-t dark:border-gray-600' : ''}">Other Sites</h4>`;
                html += otherSites.map(createSiteCheckbox).join('');
            }

            if (allSites.length === 0) {
                html = '<p class="text-xs text-gray-500 dark:text-gray-400">No sites available. Please add sites first.</p>';
            }

            siteAssignmentContainer.innerHTML = html;
            
            // Add event listeners for site checkboxes
            const siteCheckboxes = siteAssignmentContainer.querySelectorAll('.site-checkbox');
            siteCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSiteEnrollmentGoals);
            });
            
            // Update enrollment goals section
            updateSiteEnrollmentGoals();
        };

        const updateSiteEnrollmentGoals = () => {
            const siteEnrollmentSection = document.getElementById('site-enrollment-goals-section');
            const siteEnrollmentContainer = document.getElementById('site-enrollment-goals-container');
            const totalTargetInput = document.getElementById('target');
            const totalAllocatedSpan = document.getElementById('total-allocated');
            const totalTargetSpan = document.getElementById('total-target');
            
            if (!siteEnrollmentSection || !siteEnrollmentContainer || !totalTargetInput) return;
            
            // Get selected sites
            const selectedSites = Array.from(document.querySelectorAll('.site-checkbox:checked'))
                .map(checkbox => {
                    const site = allSites.find(s => s.id === checkbox.value);
                    return site;
                })
                .filter(Boolean);
            
            if (selectedSites.length === 0) {
                siteEnrollmentSection.classList.add('hidden');
                return;
            }
            
            siteEnrollmentSection.classList.remove('hidden');
            
            // Update total target display
            const totalTarget = parseInt(totalTargetInput.value) || 0;
            totalTargetSpan.textContent = totalTarget;
            
            // Get existing study data if editing
            const studyForm = document.getElementById('study-form');
            const studyId = studyForm?.dataset.id;
            const existingStudy = studyId ? allStudies.find(s => s.id === studyId) : null;
            const existingSiteGoals = existingStudy?.siteEnrollmentGoals || {};
            
            // Create enrollment goal inputs for each selected site
            const siteGoalsHTML = selectedSites.map(site => {
                const existingGoal = existingSiteGoals[site.id] || 0;
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-md">
                        <div class="flex-1">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">${site.name}</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="number" 
                                   name="siteEnrollmentGoal_${site.id}" 
                                   value="${existingGoal}"
                                   min="0" 
                                   max="${totalTarget}"
                                   class="site-goal-input w-20 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 dark:text-gray-200"
                                   data-site-id="${site.id}">
                            <span class="text-xs text-gray-500 dark:text-gray-400">patients</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            siteEnrollmentContainer.innerHTML = siteGoalsHTML;
            
            // Add event listeners for goal inputs
            const goalInputs = siteEnrollmentContainer.querySelectorAll('.site-goal-input');
            goalInputs.forEach(input => {
                input.addEventListener('input', updateTotalAllocated);
            });
            
            // Update total allocated
            updateTotalAllocated();
        };

        const updateTotalAllocated = () => {
            const totalAllocatedSpan = document.getElementById('total-allocated');
            const totalTargetSpan = document.getElementById('total-target');
            
            if (!totalAllocatedSpan || !totalTargetSpan) return;
            
            const goalInputs = document.querySelectorAll('.site-goal-input');
            const totalAllocated = Array.from(goalInputs)
                .reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            
            totalAllocatedSpan.textContent = totalAllocated;
            
            // Color code the total
            const totalTarget = parseInt(totalTargetSpan.textContent) || 0;
            if (totalAllocated > totalTarget) {
                totalAllocatedSpan.className = 'text-red-600 dark:text-red-400 font-semibold';
            } else if (totalAllocated === totalTarget) {
                totalAllocatedSpan.className = 'text-green-600 dark:text-green-400 font-semibold';
            } else {
                totalAllocatedSpan.className = 'text-yellow-600 dark:text-yellow-400 font-semibold';
            }
        };

        const createStudyModal = (study = null) => {
            const isEdit = study !== null;
            const title = isEdit ? 'Edit Study' : 'Add New Study';
            const buttonText = isEdit ? 'Save Changes' : 'Create Study';
            const statusOptions = ['Recruiting', 'Enrolling', 'Active', 'Closed'];
            const studyIndications = ensureArray(study?.indication);
            let assignedSiteIds = ensureArray(study?.siteIds);
            
            // If siteIds is empty but we have siteEnrollmentGoals, derive siteIds from that
            if (assignedSiteIds.length === 0 && study?.siteEnrollmentGoals) {
                assignedSiteIds = Object.keys(study.siteEnrollmentGoals);
                console.log('Derived site IDs from enrollment goals:', assignedSiteIds);
            }
            
            // Debug logging
            if (isEdit) {
                console.log('Editing study:', study);
                console.log('Assigned site IDs:', assignedSiteIds);
                console.log('Site enrollment goals:', study?.siteEnrollmentGoals);
            }

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content dark:bg-gray-800">
                        <form id="study-form" data-id="${isEdit ? study.id : ''}">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">${title}</h2>
                                <div class="mt-4 grid grid-cols-1 gap-y-6">
                                    <div>
                                        <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Study Title</label>
                                        <input type="text" name="title" id="title" value="${study?.title || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-200" required />
                                    </div>
                                    <div>
                                        <label for="protocolNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Protocol Number</label>
                                        <input type="text" name="protocolNumber" id="protocolNumber" value="${study?.protocolNumber || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="startDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                                            <input type="date" name="startDate" id="startDate" value="${study?.startDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200"/>
                                        </div>
                                        <div>
                                            <label for="endDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date</label>
                                            <input type="date" name="endDate" id="endDate" value="${study?.endDate || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200"/>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                                            <select name="status" id="status" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-200">
                                                ${statusOptions.map(s => `<option ${study?.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label for="target" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Total Enrollment Target</label>
                                            <input type="number" name="target" id="target" value="${study?.target || 0}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-200" required />
                                        </div>
                                    </div>
                                    <div>
                                        <label for="washoutDays" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Washout Period (Days)</label>
                                        <input type="number" name="washoutDays" id="washoutDays" value="${study?.washoutDays || 30}" min="0" max="365" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Number of days patients must wait before enrolling in another study (default: 30 days)</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Indication</label>
                                        <div id="study-indication-checkboxes" class="mt-2 max-h-40 overflow-y-auto border dark:border-gray-600 rounded-md p-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                            ${indicationOptions.map(ind => `
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="indication" value="${ind}" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600" ${studyIndications.includes(ind) ? 'checked' : ''}>
                                                    <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">${ind}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Assign Sites</label>
                                        <div id="site-assignment-container" class="mt-2 max-h-40 overflow-y-auto border dark:border-gray-600 rounded-md p-2 space-y-2">
                                            </div>
                                    </div>
                                    <div id="site-enrollment-goals-section" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Per-Site Enrollment Goals</label>
                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Distribute the total enrollment target across selected sites</p>
                                        <div id="site-enrollment-goals-container" class="mt-2 space-y-3">
                                            <!-- Site enrollment goals will be populated here -->
                                        </div>
                                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                            <span>Total allocated: </span>
                                            <span id="total-allocated">0</span>
                                            <span> / </span>
                                            <span id="total-target">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">${buttonText}</button>
                                <button type="button" data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            showModal(modalHTML);
            // Initial render of the site assignment list
            renderSiteAssignmentList(studyIndications, assignedSiteIds);
            
            // Add event listener for total target changes
            const totalTargetInput = document.getElementById('target');
            if (totalTargetInput) {
                totalTargetInput.addEventListener('input', updateSiteEnrollmentGoals);
            }
        };


        const createSiteModal = (site = null) => {
            const isEdit = site !== null;
            const title = isEdit ? 'Edit Site' : 'Add New Site';
            const buttonText = isEdit ? 'Save Changes' : 'Create Site';

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content site-modal-content dark:bg-gray-800">
                        <form id="site-form" data-id="${isEdit ? site.id : ''}">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">${title}</h2>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site Name</label>
                                        <input type="text" name="name" id="name" value="${site?.name || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" required />
                                    </div>
                                     <div>
                                        <label for="siteNameAbbreviation" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site Name Abbreviation</label>
                                        <input type="text" name="siteNameAbbreviation" id="siteNameAbbreviation" value="${site?.siteNameAbbreviation || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div>
                                        <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                                        <select name="status" id="status" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200">
                                            <option value="Active" ${site?.status === 'Active' || !site ? 'selected' : ''}>Active</option>
                                            <option value="Inactive" ${site?.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="address1" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Address Line 1</label>
                                        <input type="text" name="address1" id="address1" value="${site?.address1 || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                     <div class="md:col-span-2">
                                        <label for="address2" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Address Line 2</label>
                                        <input type="text" name="address2" id="address2" value="${site?.address2 || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div>
                                        <label for="city" class="block text-sm font-medium text-gray-700 dark:text-gray-300">City</label>
                                        <input type="text" name="city" id="city" value="${site?.city || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div>
                                        <label for="state" class="block text-sm font-medium text-gray-700 dark:text-gray-300">State</label>
                                        <input type="text" name="state" id="state" value="${site?.state || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                     <div>
                                        <label for="zipCode" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Zip Code</label>
                                        <input type="text" name="zipCode" id="zipCode" value="${site?.zipCode || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div>
                                        <label for="country" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Country</label>
                                        <input type="text" name="country" id="country" value="${site?.country || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div>
                                        <label for="latitude" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Latitude <span class="text-xs text-gray-500">(for map)</span></label>
                                        <input type="number" step="any" name="latitude" id="latitude" value="${site?.latitude || ''}" placeholder="e.g., 40.7128" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div>
                                        <label for="longitude" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Longitude <span class="text-xs text-gray-500">(for map)</span></label>
                                        <input type="number" step="any" name="longitude" id="longitude" value="${site?.longitude || ''}" placeholder="e.g., -74.0060" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                    <div class="md:col-span-2">
                                        <button type="button" id="geocode-address-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                                            📍 Auto-fill Coordinates from Address
                                        </button>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">
                                            Click to automatically get latitude/longitude from the address above
                                        </p>
                                    </div>
                                     <div>
                                        <label for="pi" class="block text-sm font-medium text-gray-700 dark:text-gray-300">PI</label>
                                        <input type="text" name="pi" id="pi" value="${site?.pi || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                     <div>
                                        <label for="piEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">PI Email</label>
                                        <input type="email" name="piEmail" id="piEmail" value="${site?.piEmail || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                     <div>
                                        <label for="siteCoordinator" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site Coordinator</label>
                                        <input type="text" name="siteCoordinator" id="siteCoordinator" value="${site?.siteCoordinator || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                     <div>
                                        <label for="siteCoordinatorEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Site Coordinator Email</label>
                                        <input type="email" name="siteCoordinatorEmail" id="siteCoordinatorEmail" value="${site?.siteCoordinatorEmail || ''}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-white dark:bg-gray-700 dark:text-gray-200" />
                                    </div>
                                     <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Indication</label>
                                        <div class="mt-2 max-h-40 overflow-y-auto border dark:border-gray-600 rounded-md p-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                            ${indicationOptions.map(ind => `
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="indication" value="${ind}" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600" ${ensureArray(site?.indication).includes(ind) ? 'checked' : ''}>
                                                    <span class="ml-2 text-sm text-gray-600 dark:text-gray-300">${ind}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">${buttonText}</button>
                                <button type="button" data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            showModal(modalHTML);
        };

        const createConfirmModal = (ids, type) => {
            const isBulk = Array.isArray(ids);
            const title = type === 'study' ? 'Delete Study' : `Delete ${isBulk ? ids.length : ''} Site(s)`;
            const message = type === 'study' 
                ? 'Are you sure you want to delete this study? This will also remove the study assignment from all associated patients. This action cannot be undone.'
                : `Are you sure you want to delete ${isBulk ? 'these sites' : 'this site'}? This will remove the site(s) from all studies and unlink any patients assigned to them. This action cannot be undone.`;
            
            const buttonId = type === 'study' ? 'confirm-delete-study-btn' : 'confirm-delete-site-btn';

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content confirm-modal-content dark:bg-gray-800">
                        <div class="p-6">
                            <div class="flex items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">${getIcon('exclamation')}</div>
                                <div class="ml-4 text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">${title}</h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${message}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 px-6 py-3 flex flex-row-reverse">
                            <button id="${buttonId}" data-id='${JSON.stringify(ids)}' class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Delete</button>
                            <button data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHTML);
        };
        
        const createImportModal = () => {
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content import-modal-content dark:bg-gray-800">
                        <div class="p-6">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Import Data from CSV</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Select the type of data to import and upload a CSV file with the correct format.</p>
                            
                            <div class="mt-4">
                                <fieldset>
                                    <legend class="text-base font-medium text-gray-900 dark:text-gray-100">Select Import Type</legend>
                                    <div class="mt-4 space-y-4">
                                        <div class="flex items-center">
                                            <input id="import-type-studies" name="import-type" type="radio" value="studies" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600" checked>
                                            <label for="import-type-studies" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">Studies</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="import-type-sites" name="import-type" type="radio" value="sites" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600">
                                            <label for="import-type-sites" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">Sites</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="import-type-enrollment" name="import-type" type="radio" value="enrollment" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600">
                                            <label for="import-type-enrollment" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">Patient Enrollment (Ties Studies to Sites)</label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>

                            <div id="import-instructions" class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg"></div>
                            
                             <div class="mt-4">
                                <label for="csv-file-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Upload CSV File</label>
                                <input type="file" id="csv-file-input" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 dark:file:bg-indigo-900 file:text-indigo-700 dark:file:text-indigo-200 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-800"/>
                            </div>
                            <div id="import-feedback" class="mt-4 text-sm"></div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button id="start-import-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm" disabled>Import</button>
                            <button type="button" data-action="cancel" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHTML);
            updateImportInstructions();
        };

        // --- Firebase Logic ---
        const handleSaveStudy = async (e) => {
            e.preventDefault();
            const form = e.target;
            const studyId = form.dataset.id;
            const selectedSiteIds = Array.from(form.querySelectorAll('input[name="siteIds"]:checked')).map(cb => cb.value);
            const selectedIndications = Array.from(form.querySelectorAll('input[name="indication"]:checked')).map(cb => cb.value);

            // Collect per-site enrollment goals
            const siteEnrollmentGoals = {};
            selectedSiteIds.forEach(siteId => {
                const goalInput = form.querySelector(`input[name="siteEnrollmentGoal_${siteId}"]`);
                if (goalInput) {
                    siteEnrollmentGoals[siteId] = parseInt(goalInput.value, 10) || 0;
                }
            });

            const studyData = {
                title: form.title.value,
                protocolNumber: form.protocolNumber.value,
                status: form.status.value,
                target: parseInt(form.target.value, 10) || 0,
                startDate: form.startDate.value,
                endDate: form.endDate.value,
                siteIds: selectedSiteIds,
                indication: selectedIndications,
                washoutDays: parseInt(form.washoutDays.value, 10) || 30,
                siteEnrollmentGoals: siteEnrollmentGoals
            };
            
            try {
                const docRef = studyId ? doc(db, 'studies', studyId) : doc(collection(db, 'studies'));
                await setDoc(docRef, studyData, { merge: true });
                console.log('Study saved successfully');
                closeModal();
            } catch (error) {
                console.error('Error saving study: ', error);
            }
        };

        const handleSaveSite = async (e) => {
            e.preventDefault();
            const form = e.target;
            const siteId = form.dataset.id;
            const selectedIndications = Array.from(form.querySelectorAll('input[name="indication"]:checked')).map(cb => cb.value);
            
            const siteData = {
                name: form.name.value,
                siteNameAbbreviation: form.siteNameAbbreviation.value,
                status: form.status.value,
                address1: form.address1.value,
                address2: form.address2.value,
                city: form.city.value,
                state: form.state.value,
                zipCode: form.zipCode.value,
                country: form.country.value,
                latitude: form.latitude.value ? parseFloat(form.latitude.value) : null,
                longitude: form.longitude.value ? parseFloat(form.longitude.value) : null,
                pi: form.pi.value,
                piEmail: form.piEmail.value,
                siteCoordinator: form.siteCoordinator.value,
                siteCoordinatorEmail: form.siteCoordinatorEmail.value,
                indication: selectedIndications,
            };

            try {
                const docRef = siteId ? doc(db, 'sites', siteId) : doc(collection(db, 'sites'));
                await setDoc(docRef, siteData, { merge: true });
                console.log('Site saved successfully');
                closeModal();
            } catch (error) {
                console.error('Error saving site: ', error);
            }
        };

        const handleDeleteStudy = async (studyId) => {
            try {
                const batch = writeBatch(db);
                const studyRef = doc(db, 'studies', studyId);
                batch.delete(studyRef);

                const patientsToUpdate = allPatients.filter(p => {
                    const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                    return currentEnrollment?.studyId === studyId;
                });

                patientsToUpdate.forEach(p => {
                    const patientRef = doc(db, 'patients', p.id);
                    const updatedEnrollments = p.enrollments.map(e => {
                        if (e.studyId === studyId && e.status === 'current') {
                            return { ...e, status: 'past', exitedDate: new Date().toISOString() };
                        }
                        return e;
                    });
                    batch.update(patientRef, { enrollments: updatedEnrollments });
                });
                
                await batch.commit();
                console.log('Study and associated patient links deleted successfully');
            } catch (error) {
                console.error('Error deleting study: ', error);
            } finally {
                closeModal();
            }
        };

        const handleDeleteSite = async (siteIds) => {
            const idsToDelete = Array.isArray(siteIds) ? siteIds : [siteIds];
            try {
                const batch = writeBatch(db);
                
                idsToDelete.forEach(siteId => {
                    // 1. Delete the site document
                    const siteRef = doc(db, 'sites', siteId);
                    batch.delete(siteRef);

                    // 2. Unlink site from any studies
                    const studiesWithSite = allStudies.filter(s => (s.siteIds || []).includes(siteId));
                    studiesWithSite.forEach(study => {
                        const studyRef = doc(db, 'studies', study.id);
                        batch.update(studyRef, { siteIds: arrayRemove(siteId) });
                    });

                    // 3. Unlink site from any patients
                    const patientsAtSite = allPatients.filter(p => {
                        const currentEnrollment = p.enrollments?.find(e => e.status === 'current');
                        return currentEnrollment?.siteId === siteId;
                    });
                    patientsAtSite.forEach(patient => {
                        const patientRef = doc(db, 'patients', patient.id);
                        const updatedEnrollments = patient.enrollments.map(e => {
                            if (e.siteId === siteId && e.status === 'current') {
                                return { ...e, status: 'past', exitedDate: new Date().toISOString() };
                            }
                            return e;
                        });
                        batch.update(patientRef, { enrollments: updatedEnrollments });
                    });
                });
                
                await batch.commit();
                console.log(`${idsToDelete.length} site(s) and all associated links deleted successfully`);
            } catch (error) {
                console.error('Error deleting site(s): ', error);
            } finally {
                closeModal();
            }
        };
        
        // --- Import Logic ---
        const updateImportInstructions = () => {
            const importType = document.querySelector('input[name="import-type"]:checked').value;
            const instructionsEl = document.getElementById('import-instructions');
            let instructionsHTML = '';

            if (importType === 'studies') {
                instructionsHTML = `
                    <p class="font-semibold">Required Columns for Studies:</p>
                    <code class="text-xs bg-gray-200 dark:bg-gray-600 p-1 rounded">title,protocolNumber,status,target,startDate,endDate,indication</code>
                    <p class="text-xs mt-1">For Indication, separate multiple values with a pipe (|).</p>
                    <p class="text-xs mt-1">Example: <code class="text-xs">"Phase 3 Study","P3-XYZ-01","Recruiting",150,2025-01-01,2026-12-31,"Dry Eye|Glaucoma"</code></p>
                `;
            } else if (importType === 'sites') {
                instructionsHTML = `
                    <p class="font-semibold">Required Columns for Sites:</p>
                    <code class="text-xs bg-gray-200 dark:bg-gray-600 p-1 rounded">Status,Site Name,Site Name Abbreviation,Address line 1,Address Line 2,City,State,Zip Code,Country,PI,PI Email,Site Coordinator,Site Coordinator Email,Indication</code>
                    <p class="text-xs mt-1">For Indication, separate multiple values with a pipe (|).</p>
                    <p class="text-xs mt-1">Example: <code class="text-xs">"Active","City Eye Center","CEC","123 Main St","Suite 100","Anytown","CA","12345","USA","Dr. Smith","dr.smith@email.com","John Doe","j.doe@email.com","Dry Eye|Glaucoma"</code></p>
                `;
            } else if (importType === 'enrollment') {
                 instructionsHTML = `
                    <p class="font-semibold">Required Columns for Patient Enrollment:</p>
                    <code class="text-xs bg-gray-200 dark:bg-gray-600 p-1 rounded">patientId,studyTitle,siteName,status,enrollmentDate</code>
                    <p class="text-xs mt-1">This will create or update patients to link them to existing studies and sites.</p>
                    <p class="text-xs mt-1">Example: <code class="text-xs">"PAT-001","Phase 3 Study","Central Clinic","Enrolled",2025-02-15</code></p>
                `;
            }
            instructionsEl.innerHTML = instructionsHTML;
        };
        
        const parseCSV = (text) => {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const header = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const entry = {};
                for (let j = 0; j < header.length; j++) {
                    entry[header[j]] = values[j] ? values[j].trim().replace(/"/g, '') : '';
                }
                data.push(entry);
            }
            return data;
        };
        
        const handleImport = async (file) => {
            const feedbackEl = document.getElementById('import-feedback');
            const startBtn = document.getElementById('start-import-btn');
            if (!file) {
                feedbackEl.innerHTML = `<p class="text-red-600">Please select a file to import.</p>`;
                return;
            }
            
            startBtn.disabled = true;
            feedbackEl.innerHTML = `<p class="text-blue-600">Reading file...</p>`;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvText = event.target.result;
                    const data = parseCSV(csvText);
                    const importType = document.querySelector('input[name="import-type"]:checked').value;
                    
                    feedbackEl.innerHTML = `<p class="text-blue-600">Processing ${data.length} records... Please wait.</p>`;
                    
                    const batch = writeBatch(db);
                    let errors = [];
                    let skippedCount = 0;
                    let importedCount = 0;
                    const affectedStudyIds = new Set(); // Keep track of studies to sync

                    if (importType === 'studies') {
                        data.forEach((row, index) => {
                            if (!row.title || !row.target) {
                                errors.push(`Row ${index + 2}: Missing required fields 'title' or 'target'.`);
                                return;
                            }
                            const docRef = doc(collection(db, 'studies'));
                            batch.set(docRef, {
                                title: row.title,
                                protocolNumber: row.protocolNumber || '',
                                status: row.status || 'Recruiting',
                                target: parseInt(row.target, 10) || 0,
                                startDate: row.startDate || '',
                                endDate: row.endDate || '',
                                siteIds: [],
                                indication: row.indication ? row.indication.split('|').map(i => i.trim()) : []
                            });
                            importedCount++;
                        });
                    } else if (importType === 'sites') {
                        const existingSiteNames = new Set(allSites.map(s => s.name.toLowerCase()));
                        data.forEach((row, index) => {
                            const siteName = row['Site Name'];
                            if (!siteName) {
                                errors.push(`Row ${index + 2}: Missing required field 'Site Name'.`);
                                return;
                            }
                            if (existingSiteNames.has(siteName.toLowerCase())) {
                                skippedCount++;
                                return; // Skip duplicate
                            }

                            const docRef = doc(collection(db, 'sites'));
                            batch.set(docRef, {
                                status: row.Status || '',
                                name: siteName,
                                siteNameAbbreviation: row['Site Name Abbreviation'] || '',
                                address1: row['Address line 1'] || '',
                                address2: row['Address Line 2'] || '',
                                city: row.City || '',
                                state: row.State || '',
                                zipCode: row['Zip Code'] || '',
                                country: row.Country || '',
                                pi: row.PI || '',
                                piEmail: row['PI Email'] || '',
                                siteCoordinator: row['Site Coordinator'] || '',
                                siteCoordinatorEmail: row['Site Coordinator Email'] || '',
                                indication: row.Indication ? row.Indication.split('|').map(i => i.trim()) : [],
                            });
                            importedCount++;
                        });
                    } else if (importType === 'enrollment') {
                        data.forEach((row, index) => {
                             if (!row.patientId || !row.studyTitle || !row.siteName) {
                                errors.push(`Row ${index + 2}: Missing required fields 'patientId', 'studyTitle', or 'siteName'.`);
                                return;
                            }
                            const study = allStudies.find(s => s.title === row.studyTitle);
                            const site = allSites.find(s => s.name === row.siteName);
                            const patient = allPatients.find(p => p.id === row.patientId);

                            if (!study) { errors.push(`Row ${index + 2}: Study "${row.studyTitle}" not found.`); return; }
                            if (!site) { errors.push(`Row ${index + 2}: Site "${row.siteName}" not found.`); return; }
                            if (!patient) { errors.push(`Row ${index + 2}: Patient with ID "${row.patientId}" not found.`); return; }
                            
                            const docRef = doc(db, 'patients', row.patientId);
                            const updatedEnrollments = (patient.enrollments || []).map(e => 
                                e.status === 'current' ? { ...e, status: 'past', exitedDate: new Date().toISOString() } : e
                            );

                            updatedEnrollments.push({
                                studyId: study.id,
                                siteId: site.id,
                                status: 'current',
                                enrolledDate: row.enrollmentDate ? new Date(row.enrollmentDate).toISOString() : new Date().toISOString(),
                                exitedDate: null
                            });

                             batch.update(docRef, {
                                status: row.status || 'Enrolled',
                                enrollments: updatedEnrollments
                            });
                            affectedStudyIds.add(study.id); // Add study ID for syncing
                            importedCount++;
                        });
                    }
                    
                    if (errors.length > 0) {
                        feedbackEl.innerHTML = `<p class="text-red-600 font-bold">Import failed with ${errors.length} errors:</p><ul class="list-disc list-inside text-red-500 text-xs">${errors.slice(0, 10).map(e => `<li>${e}</li>`).join('')}</ul>`;
                    } else {
                        await batch.commit();
                        let successMessage = `<p class="text-green-600 font-bold">Successfully imported ${importedCount} records!</p>`;
                        if (skippedCount > 0) {
                            successMessage += `<p class="text-yellow-600">Skipped ${skippedCount} duplicate records.</p>`;
                        }
                        feedbackEl.innerHTML = successMessage;

                        // After successful import, notify N.A.S.A. for each affected study
                        if (affectedStudyIds.size > 0) {
                            setTimeout(() => {
                                affectedStudyIds.forEach(studyId => notifyNasaOfUpdate(studyId));
                            }, 500); // Small delay to allow Firestore to propagate changes
                        }

                        setTimeout(closeModal, 3000);
                    }

                } catch (e) {
                    console.error(e);
                    feedbackEl.innerHTML = `<p class="text-red-600">An error occurred during import: ${e.message}</p>`;
                } finally {
                    startBtn.disabled = false;
                }
            };
            reader.readAsText(file);
        };


        // --- Event Listeners ---
        headerButtons.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            if (button.id === 'dashboard-tab-btn') {
                activeTab = 'dashboard';
                render();
            } else if (button.id === 'studies-tab-btn') {
                activeTab = 'studies';
                render();
            } else if (button.id === 'sites-tab-btn') {
                activeTab = 'sites';
                render();
            } else if (button.id === 'reporting-tab-btn') {
                activeTab = 'reporting';
                render();
            } else if (button.id === 'add-study-btn') {
                createStudyModal();
            } else if (button.id === 'import-data-btn') {
                createImportModal();
            } else if (button.id === 'sync-all-btn') {
                allStudies.forEach(study => notifyNasaOfUpdate(study.id));
                // You can add a visual confirmation here if you like
                alert('Syncing all studies with N.A.S.A.');
            }
        });

        modalContainer.addEventListener('click', (e) => {
            if (e.target.dataset.action === 'cancel') {
                closeModal();
            }
            if (e.target.id === 'confirm-delete-study-btn') {
                handleDeleteStudy(JSON.parse(e.target.dataset.id));
            }
            if (e.target.id === 'confirm-delete-site-btn') {
                handleDeleteSite(JSON.parse(e.target.dataset.id));
            }
            if (e.target.id === 'start-import-btn') {
                const fileInput = document.getElementById('csv-file-input');
                handleImport(fileInput.files[0]);
            }
            if (e.target.id === 'geocode-address-btn') {
                geocodeAddress();
            }
        });
        
        modalContainer.addEventListener('change', (e) => {
            if (e.target.name === 'import-type') {
                updateImportInstructions();
            }
            if (e.target.id === 'csv-file-input') {
                document.getElementById('start-import-btn').disabled = e.target.files.length === 0;
            }
            // Add listener for study indication changes to update site suggestions
            if (e.target.name === 'indication' && e.target.closest('#study-indication-checkboxes')) {
                const form = e.target.closest('form');
                const selectedIndications = Array.from(form.querySelectorAll('input[name="indication"]:checked')).map(cb => cb.value);
                const assignedSiteIds = Array.from(form.querySelectorAll('input[name="siteIds"]:checked')).map(cb => cb.value);
                renderSiteAssignmentList(selectedIndications, assignedSiteIds);
            }
        });

        modalContainer.addEventListener('submit', (e) => {
            if (e.target.id === 'study-form') {
                handleSaveStudy(e);
            }
            if (e.target.id === 'site-form') {
                handleSaveSite(e);
            }
        });

        // Add NASA-style report form handler to main content area
        mainContentArea.addEventListener('submit', (e) => {
            if (e.target.id === 'report-filter-form') {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                handleNasaStyleReportFilter(data);
            }
        });

        mainContentArea.addEventListener('click', (e) => {
            const card = e.target.closest('.study-card');
            if (card) {
                const studyId = card.dataset.studyId;
                const study = allStudies.find(s => s.id === studyId);
                if (e.target.closest('[data-action="edit"]')) {
                    createStudyModal(study);
                }
                if (e.target.closest('[data-action="delete"]')) {
                    createConfirmModal(studyId, 'study');
                }
            }
            
            if (e.target.id === 'add-site-btn') {
                createSiteModal();
            }
            
            if (e.target.id === 'sync-all-coordinates-btn') {
                syncAllSiteCoordinates();
            }
            
            const editSiteButton = e.target.closest('[data-action="edit-site"]');
            if (editSiteButton) {
                const siteId = editSiteButton.dataset.id;
                const site = allSites.find(s => s.id === siteId);
                createSiteModal(site);
            }

            const deleteSiteButton = e.target.closest('[data-action="delete-site"]');
            if (deleteSiteButton) {
                const siteId = deleteSiteButton.dataset.id;
                createConfirmModal(siteId, 'site');
            }

            if (e.target.id === 'bulk-delete-site-btn') {
                const selectedIds = Array.from(document.querySelectorAll('.site-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length > 0) {
                    createConfirmModal(selectedIds, 'site');
                }
            }

             if (e.target.id === 'export-study-stats-btn') {
                exportReportToCSV();
            }
            if (e.target.id === 'export-washout-btn') {
                exportWashoutToCSV();
            }
            if (e.target.id === 'export-participants-btn') {
                exportParticipantsToCSV();
            }
            if (e.target.id === 'generate-report-btn') {
                renderReportTables();
            }
            // NASA-style export buttons
            if (e.target.id === 'export-csv-btn') {
                exportToCSV();
            }
            if (e.target.id === 'export-surveys-btn') {
                exportSurveysToCSV();
            }
            if (e.target.id === 'generate-dashboard-btn') {
                renderDashboardCharts();
            }
        });

        mainContentArea.addEventListener('input', (e) => {
            if (e.target.id === 'site-search-input') {
                const searchTerm = e.target.value.toLowerCase();
                const filteredSites = allSites.filter(site => 
                    site.name.toLowerCase().includes(searchTerm)
                );
                renderAllSites(filteredSites);
            }
        });

        mainContentArea.addEventListener('change', (e) => {
             if (e.target.classList.contains('site-checkbox') || e.target.id === 'select-all-sites-checkbox') {
                const checkboxes = document.querySelectorAll('.site-checkbox');
                const selectAll = document.getElementById('select-all-sites-checkbox');
                const bulkDeleteBtn = document.getElementById('bulk-delete-site-btn');

                if (e.target.id === 'select-all-sites-checkbox') {
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                }

                const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                if (anyChecked) {
                    bulkDeleteBtn.classList.remove('hidden');
                } else {
                    bulkDeleteBtn.classList.add('hidden');
                }
                
                selectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            }
        });
        
        // --- Initialization ---
        /**
         * Initialize the application with error handling and user feedback
         */
        const init = () => {
            try {
                loadTheme();
                
                const themeToggleBtn = document.getElementById('theme-toggle-logo-btn');
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', toggleTheme);
                }

                onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        user = currentUser;
                        initializeFirebaseListeners();
                    } else {
                        handleAuthentication();
                    }
                });
            } catch (error) {
                console.error('Error during initialization:', error);
                showErrorToUser('Failed to initialize application. Please refresh the page.');
            }
        };

        /**
         * Initialize Firebase listeners with error handling
         */
        const initializeFirebaseListeners = () => {
            try {
                const collectionsToFetch = ['studies', 'sites', 'patients'];
                let loadedCount = 0;
                let initialDataLoaded = false;

                collectionsToFetch.forEach(colName => {
                    onSnapshot(collection(db, colName), (snapshot) => {
                        try {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                            if (colName === 'studies') {
                                allStudies = data.sort((a,b) => (a.title > b.title) ? 1 : -1);
                            } else if (colName === 'sites') {
                                allSites = data.sort((a,b) => (a.name > b.name) ? 1 : -1);
                            } else if (colName === 'patients') {
                                const previousPatients = [...allPatients];
                                allPatients = data;

                                // Real-time Sync Logic
                                if (initialDataLoaded) {
                                    handlePatientChanges(previousPatients, allPatients);
                                }
                            }
                            
                            if (!initialDataLoaded) {
                                loadedCount++;
                                if (loadedCount === collectionsToFetch.length) {
                                    initialDataLoaded = true;
                                    loadingIndicator.style.display = 'none';
                                    render();
                                }
                            } else {
                                render();
                            }
                        } catch (error) {
                            console.error(`Error processing ${colName} data:`, error);
                        }
                    }, (error) => {
                        console.error(`Error fetching ${colName}:`, error);
                        if (!initialDataLoaded) {
                            loadedCount++;
                            if (loadedCount === collectionsToFetch.length) {
                                showErrorToUser(`Error loading ${colName} data. Please check your connection and refresh.`);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error initializing Firebase listeners:', error);
                showErrorToUser('Failed to connect to database. Please refresh the page.');
            }
        };

        /**
         * Handle patient changes and sync with N.A.S.A.
         * @param {Array} previousPatients - Previous patient data
         * @param {Array} currentPatients - Current patient data
         */
        const handlePatientChanges = (previousPatients, currentPatients) => {
            try {
                const affectedStudyIds = new Set();
                const currentPatientMap = new Map(currentPatients.map(p => [p.id, p]));
                const previousPatientMap = new Map(previousPatients.map(p => [p.id, p]));

                // Check for changed or new patients
                currentPatientMap.forEach((currentPatient, patientId) => {
                    const previousPatient = previousPatientMap.get(patientId);
                    if (!previousPatient || 
                        JSON.stringify(currentPatient.status) !== JSON.stringify(previousPatient.status) || 
                        JSON.stringify(currentPatient.enrollments) !== JSON.stringify(previousPatient.enrollments)) {
                        
                        const currentEnrollment = currentPatient.enrollments?.find(e => e.status === 'current');
                        if (currentEnrollment?.studyId) {
                            affectedStudyIds.add(currentEnrollment.studyId);
                        }
                        
                        if (previousPatient) {
                            const previousEnrollment = previousPatient.enrollments?.find(e => e.status === 'current');
                            if (previousEnrollment?.studyId) {
                                affectedStudyIds.add(previousEnrollment.studyId);
                            }
                        }
                    }
                });

                // Check for deleted patients
                previousPatientMap.forEach((previousPatient, patientId) => {
                    if (!currentPatientMap.has(patientId)) {
                        const previousEnrollment = previousPatient.enrollments?.find(e => e.status === 'current');
                        if (previousEnrollment?.studyId) {
                            affectedStudyIds.add(previousEnrollment.studyId);
                        }
                    }
                });

                if (affectedStudyIds.size > 0) {
                    console.log(`Detected changes affecting ${affectedStudyIds.size} studies. Syncing with N.A.S.A...`);
                    affectedStudyIds.forEach(studyId => {
                        if (studyId) {
                            notifyNasaOfUpdate(studyId);
                        }
                    });
                }
            } catch (error) {
                console.error('Error handling patient changes:', error);
            }
        };

        /**
         * Handle authentication with error handling
         */
        const handleAuthentication = () => {
            signInAnonymously(auth)
                .then(() => {
                    console.log('Successfully signed in anonymously');
                })
                .catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    showErrorToUser('Failed to authenticate. Please refresh the page.');
                });
        };

        /**
         * Show error message to user
         * @param {string} message - Error message to display
         */
        const showErrorToUser = (message) => {
            loadingIndicator.innerHTML = `
                <div class="text-center">
                    <div class="text-xl font-semibold text-red-500 mb-2">Error</div>
                    <div class="text-gray-600 dark:text-gray-400">${message}</div>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Refresh Page
                    </button>
                </div>
            `;
        };

        // /Run the app
        init();
    </script>
</body>
</html>
